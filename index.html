<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1024" /> 
  <title>車流人流退場情報</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
/* =========== Design Tokens =========== */
:root{
  --primary-600:#1f6fe5; --primary-700:#165bd1; --primary-800:#1249ad;
  --success-600:#22c55e; --success-700:#16a34a; --success-800:#15803d;
  --danger-600:#ef4444;  --danger-700:#dc2626;  --danger-800:#b91c1c;
  --warn-600:#f59e0b;    --warn-700:#d97706;    
  --info-600:#06b6d4;    --info-700:#0891b2;
  --purple-600:#8b5cf6;  --purple-700:#7c3aed;
  --gray-50:#f8fafc;  --gray-100:#f1f5f9; --gray-200:#e5e7eb;
  --gray-300:#cbd5e1; --gray-400:#94a3b8; --gray-500:#64748b;
  --gray-600:#475569; --gray-700:#334155; --gray-800:#1f2937; --gray-900:#0f172a;

  --surface: rgba(255,255,255,.95);
  --page-bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
  --text-strong: var(--gray-900);
  --text: var(--gray-800);
  --text-muted: var(--gray-600);
  --border: rgba(148,163,184,0.35);
  
  /* 字級 */
  --fz-display:28px; --fz-title:18px; --fz-body:14px;

  --shadow-card:0 8px 24px rgba(0,0,0,.08);
}

/* =========== Base =========== */
body{
  margin:0; min-height:100vh;
  background:var(--page-bg); color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;
  min-width: 1024px; /* 強制最小寬度，保持電腦版排版 */
}
.wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
h1{margin:0 0 16px;font-size:var(--fz-display);font-weight:700;color:var(--text-strong);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-card);padding:16px;margin:12px 0;}
.hide{ display:none !important; }

/* =========== Topbar Grid =========== */
.topbar-grid{
  display:grid;
  grid-template-columns: 1fr auto;
  grid-template-rows: auto auto;
  gap:12px 20px;
  align-items:center;
  margin-bottom: 20px;
}
.left-title{ grid-area: 1 / 1 / 2 / 2; }
.topbar-grid .left-tabs{  grid-area: 2 / 1 / 3 / 2; }
.topbar-grid .right-user{
  grid-area: 1 / 2 / 2 / 3;
  display:flex; align-items:center; gap:12px; justify-content:flex-end;
}
.topbar-grid .right-refresh{ grid-area: 2 / 2 / 3 / 3; }

/* =========== Main Tabs (三顆主按鈕 - 彩色版) =========== */
.main-tabs{ display:flex; gap:12px; }
.main-tab{ 
  border-radius:10px; padding:10px 24px; font-size:15px; font-weight:700; cursor:pointer; white-space:nowrap; 
  transition: all 0.2s; border: 1px solid transparent;
  background: #fff; color: var(--text-strong); border-color: var(--border);
}
.main-tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

/* 1. 最新狀態 (藍) */
.main-tab[data-target="pane-dashboard2"].active { background: var(--primary-600); color: #fff; border-color: var(--primary-600); }
.main-tab[data-target="pane-dashboard2"]:hover { border-color: var(--primary-600); color: var(--primary-600); }
.main-tab[data-target="pane-dashboard2"].active:hover { color: #fff; }

/* 2. 個別情報 (綠) */
.main-tab[data-target="pane-single"].active { background: var(--success-600); color: #fff; border-color: var(--success-600); }
.main-tab[data-target="pane-single"]:hover { border-color: var(--success-600); color: var(--success-600); }
.main-tab[data-target="pane-single"].active:hover { color: #fff; }

/* 3. 登錄與修改 (橘) */
.main-tab[data-target="pane-punch"].active { background: var(--warn-600); color: #fff; border-color: var(--warn-600); }
.main-tab[data-target="pane-punch"]:hover { border-color: var(--warn-600); color: var(--warn-600); }
.main-tab[data-target="pane-punch"].active:hover { color: #fff; }

/* =========== Refresh Bar =========== */
.refresh-bar{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin:0; }
.clock{ font-weight:900; font-size: 20px; letter-spacing:.5px; font-variant-numeric: tabular-nums; margin-right: 12px; }
.seg-group{ display:flex; gap:8px; }
.seg-btn{
  background:#fff; color:var(--text);
  border:1px solid var(--border); border-radius:8px;
  padding:6px 14px; font-size:14px; font-weight:600; cursor:pointer; min-width:64px; text-align:center;
  transition: all 0.2s;
}
.seg-btn:hover{ border-color: var(--primary-600); color: var(--primary-600); }
.seg-btn.active{ background:var(--primary-600); color:#fff; border-color:var(--primary-600); }
.seg-btn[disabled]{ cursor:default; }

/* =========== Dashboard Tabs (五顆子按鈕 - 彩色版) =========== */
.sheet-tabs{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }
.btn-tab{
  border-radius:20px; padding:8px 20px; font-size:14px; font-weight:700; cursor:pointer; min-width:140px; text-align:center;
  transition: all 0.2s; border: 1px solid var(--border); background: #fff; color: var(--text);
}
.btn-tab:hover { transform: translateY(-1px); }

/* 1. 所有車輛 (深藍) */
.btn-tab:nth-child(1).active { background: var(--primary-700); color: #fff; border-color: var(--primary-700); }
.btn-tab:nth-child(1):hover { border-color: var(--primary-700); color: var(--primary-700); }
.btn-tab:nth-child(1).active:hover { color: #fff; }

/* 2. 遊覽車平台 (青) */
.btn-tab:nth-child(2).active { background: var(--info-600); color: #fff; border-color: var(--info-600); }
.btn-tab:nth-child(2):hover { border-color: var(--info-600); color: var(--info-600); }
.btn-tab:nth-child(2).active:hover { color: #fff; }

/* 3. 禪堂平台 (紫) */
.btn-tab:nth-child(3).active { background: var(--purple-600); color: #fff; border-color: var(--purple-600); }
.btn-tab:nth-child(3):hover { border-color: var(--purple-600); color: var(--purple-600); }
.btn-tab:nth-child(3).active:hover { color: #fff; }

/* 4. 水陸專車 (紅) */
.btn-tab:nth-child(4).active { background: var(--danger-600); color: #fff; border-color: var(--danger-600); }
.btn-tab:nth-child(4):hover { border-color: var(--danger-600); color: var(--danger-600); }
.btn-tab:nth-child(4).active:hover { color: #fff; }

/* 5. 288法青 (橘) */
.btn-tab:nth-child(5).active { background: var(--warn-600); color: #fff; border-color: var(--warn-600); }
.btn-tab:nth-child(5):hover { border-color: var(--warn-600); color: var(--warn-600); }
.btn-tab:nth-child(5).active:hover { color: #fff; }


/* =========== Cards & Layout =========== */
.veh-list{display:grid;grid-template-columns:repeat(auto-fit, minmax(480px,1fr));gap:12px;margin-top:16px;}
.veh-card{background:rgba(255,255,255,0.85);border-radius:var(--radius-lg);border:1px solid var(--border);padding:14px 14px 10px;display:flex;flex-direction:column;gap:10px;}
.veh-title-main{font-weight:700;font-size:var(--fz-title);color:var(--text-strong);}
.veh-title-sub{font-size:var(--fz-sub);color:var(--text-muted);}
.step-row{display:grid;grid-template-columns:180px 1fr auto;align-items:center;gap:10px;margin-bottom:6px;}
.step-time{font-size:var(--fz-label);font-weight:600;color:#2563eb;text-align:right;min-width:70px;font-feature-settings:"tnum" 1;}
.step-select{min-width:170px;padding:6px 8px;border-radius:var(--radius-sm);border:1px solid var(--border);background:#fff;font-size:var(--fz-body);}
.textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;background:#fff;font-size:var(--fz-body);}

/* Buttons */
.btn{ border:0;border-radius:8px;padding:8px 14px;background:#0f6efc;color:#fff;font-size:14px;font-weight:600;cursor:pointer; min-width:64px; text-align:center; }
.btn--sm{padding:6px 12px} .btn--secondary{background:#fff;color:var(--primary-600);border:1px solid var(--primary-600);} .btn--danger{background:var(--danger-600);} .btn--success{background:var(--success-600);}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}

/* Dashboard */
.dash-section{ margin:16px 0 24px; }
.dash-title{ font-size:18px; font-weight:800; color:var(--text-strong); margin:0 0 12px; padding-left: 8px; border-left: 4px solid var(--primary-600); }
.stat-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:12px; }
.stat-card{ border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.9); padding:12px; box-shadow:var(--shadow-card); }
.stat-head{ font-weight:800; margin-bottom:8px; color:var(--text-strong); text-align:center; }
.stat-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat-pill{ border:1px solid var(--border); border-radius:10px; padding:10px 8px; background:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; transition: all 0.2s; }
.stat-pill:hover{ transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
.stat-num{ font-size:32px; font-weight:900; line-height:1; }
.stat-num.done{ color:#2563eb; } .stat-num.todo{ color:#ef4444; }
.stat-label{ font-size:13px; color:var(--text-muted); margin-top:4px; font-weight: 600; }
.loc-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-top:8px; }
.loc-pill{ border:1px dashed var(--border); border-radius:12px; padding:10px; background:rgba(255,255,255,.85); display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer; }
.loc-name{ font-weight:700; font-size: 15px; } .loc-num{ font-size:32px; font-weight:900; color:#2563eb; }

/* Single Page */
.single-controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.single-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px; margin-top:16px;}
.single-card{ border:1px solid var(--border); background:rgba(255,255,255,.9); border-radius:12px; padding:16px; text-align:center; cursor:pointer; box-shadow:var(--shadow-card); transition: transform 0.2s; }
.single-card:hover{ transform: translateY(-3px); }
.single-line{ font-size:18px; font-weight:700; color:var(--text-strong); margin-bottom:6px; }

/* Modal */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: block; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 24px; border-radius: 16px; min-width: 320px; max-width: 90vw; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 10001; display: block; max-height: 90vh; overflow: auto; }
.modal .dash-close{ position:absolute; right:16px; top:12px; font-size:24px; cursor:pointer; opacity:.6; transition: opacity 0.2s; }
.modal .dash-close:hover{ opacity: 1; }
.detail-table{ width:100%; border-collapse:collapse; margin-top: 10px; }
.detail-table th, .detail-table td{ border:1px solid var(--border); padding:8px 10px; text-align:center; }
.detail-table th{ background:#0f172a; color:#fff; font-weight: 600; }
.list-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px 0; border-bottom:1px dashed var(--border); }

/* Login Page */
body.login{ height: 100vh; overflow: hidden; display: grid; place-items: center; }
body.login #tabs, body.login #content, body.login #userInfo, body.login .right-refresh, body.login .left-tabs, body.login #dashTabsBar, body.login #dashboard, body.login #dashTabsBar2, body.login #dashboard2 { display: none !important; }
body.login #signin{ display:block; }
body.login .topbar-grid{ display: flex; flex-direction: column; gap: 20px; width: 100%; }
body.login .left-title { text-align: center; }
body.login #signin-container { display: flex !important; flex-direction: column; align-items: center; gap: 20px; background: rgba(255,255,255,0.9); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); min-width: 300px; z-index: 10000; }

/* Misc */
.notif{position:fixed;right:20px;bottom:20px;background:rgba(15,23,42,.9);color:#fff;padding:12px 20px;border-radius:8px;opacity:0;transition:.2s;z-index:9990; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.notif.show{opacity:1;}
#loading.loading{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 2147483000; }
#loading.loading.show{ display: flex; }
.loading-box{ display:flex; align-items:center; gap:12px; background: #fff; color: var(--text); border-radius:12px; padding:16px 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
.spinner{ width:24px; height:24px; border-radius:50%; border:3px solid #cbd5e1; border-top-color: var(--primary-600); animation: spin 1s linear infinite; }
@keyframes spin{ to{ transform: rotate(360deg); } }

/* Helper classes */
.text-center { text-align: center; }
.mt-20 { margin-top: 20px; }
</style>
</head>
<body>

<div id="signin-container" style="display:none;">
  <h1 style="font-size:28px;margin-bottom:20px;">車流人流退場情報</h1>
  <div id="signin-btn-wrapper"></div>
</div>

<div class="wrap">
  <div class="topbar-grid">
    <div class="left-title">
      <h1 id="pageTitle">車流人流退場情報</h1>
    </div>
    <div class="right-user">
      <div id="signin"></div>
      <div id="userInfo" class="hide user-info" style="display:flex; align-items:center; gap:10px;">
        <span id="userDisplay" style="font-size:14px; font-weight:600;"></span>
        <button id="logoutBtn" class="btn btn--secondary btn--sm">登出</button>
      </div>
    </div>
    <div class="left-tabs">
      <div id="mainTabs" class="main-tabs">
        <button class="main-tab active" data-target="pane-dashboard2">最新狀態</button>
        <button class="main-tab" data-target="pane-single">個別情報</button>
        <button class="main-tab" data-target="pane-punch">登錄與修改</button>
      </div>
    </div>
    <div class="right-refresh">
      <div class="refresh-bar">
        <div class="clock" id="clockDisplay">--:--:--</div>
        <div class="seg-group" id="refreshControls"></div>
      </div>
    </div>
  </div>

  <div id="main-content-wrap">
    <div id="pane-dashboard2" class="tab-pane">
      <div class="card" id="dashTabsBar2" style="padding-bottom:6px;">
        <div class="sheet-tabs" id="dashboardTabs2"></div>
      </div>
      <div id="dashboard2"></div>
    </div>
    
    <div id="pane-punch" class="tab-pane hide">
      <div id="tabs" class="card" style="padding-bottom:6px;">
        <div class="sheet-tabs" id="sheetTabs"></div>
      </div>
      <div id="content">
        <div id="vehList" class="veh-list"></div>
      </div>
    </div>
    
    <div id="pane-single" class="tab-pane hide">
      <div class="card" style="padding-bottom:10px;">
        <div class="single-controls" id="singleControls">
           <select id="selSheet" class="step-select"><option value="">— Tab —</option></select>
           <select id="selArea" class="step-select"><option value="">— 區域 —</option></select>
           <select id="selCar" class="step-select"><option value="">— 車號 —</option></select>
        </div>
        <div style="display:flex; justify-content:flex-end; padding-top:10px; gap:10px;">
           <button id="btnQuery" class="btn btn--primary btn--sm">查詢</button>
           <button id="btnReset" class="btn btn--secondary btn--sm">全部重設</button>
        </div>
      </div>
      <div id="singleResults" class="single-list"></div>
    </div>
  </div>
</div>

<div id="notif" class="notif"></div>
<div id="loading" class="loading"><div class="loading-box"><div class="spinner"></div><div class="loading-text">讀取資料...</div></div></div>

<script>
const GOOGLE_CLIENT_ID = '368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxjGHiVKpNMG84OIHIvX4tGYgJ7gksxT0PItegG-7bpSeumnqgMPfwo-1Ocs1l9rMxC/exec';

const SHEET_CONFIGS = [
  { key:'地區專車退場（遊覽車平台）', sheet:'地區專車退場（遊覽車平台）', steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台','車第二次上遊覽車平台','車已離開遊覽車平台']},
  { key:'地區專車退場（禪堂平台）', sheet:'地區專車退場（禪堂平台）', steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','車已離開禪堂平台']},
  { key:'水陸專車退場', sheet:'水陸專車退場', steps:['已 Call 車排車隊','已排好車隊','退場人員已到齊','已 Call 車上遊覽車平台','車已上遊覽車平台','車暫停位置','車已離開遊覽車平台']},
  { key:'288法青退場', sheet:'288法青退場', steps:['退場人員已到齊','車已經上遊覽車平台','車已經離開遊覽車平台']}
];
const STOP_OPTIONS = ['禪堂平台','法心北路','法心南路（西）','法心南路（東）','法大路','雙環路到三門','三門到大停車場','靈山勝境石往外','雙環路至法大一橋'];

let currentUser = null;
let idToken = null;
let ALL_SHEETS = {}; 
let SINGLE_ITEMS = []; 
let dashTimer = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let currentDashFilter2 = 'ALL'; // 預設 Dashboard2 顯示全部
const REFRESH_PRESETS = [ { label:'5分', ms: 300000 }, { label:'2分', ms: 120000 }, { label:'60秒', ms: 60000 }, { label:'30秒', ms: 30000 } ];
let refreshMs = 120000;

window.onload = function(){
  startClock();
  buildRefreshControls();
  
  // 預設顯示 Dashboard 頁籤 (JS強制觸發一次)
  switchPane('pane-dashboard2');

  const saved = localStorage.getItem('ddcc_user_token');
  if(saved) {
    idToken = saved;
    verifyToken(saved);
  } else {
    initGoogleSignIn();
  }
  
  document.getElementById('logoutBtn').onclick = logout;
  document.getElementById('mainTabs').onclick = (e)=>{
     const btn=e.target.closest('.main-tab'); if(!btn) return; switchPane(btn.dataset.target);
  };
  document.getElementById('btnQuery').onclick = runSingleQuery;
  document.getElementById('btnReset').onclick = resetSingleUI;
  ['selSheet','selArea','selCar'].forEach(id => {
     document.getElementById(id).onchange = rebuildSelectOptions;
  });
  
  startAutoRefresh();
};

/* ========== Auth Logic ========== */
function initGoogleSignIn() {
  document.body.classList.add('login');
  document.getElementById('signin-container').style.display = 'flex';
  if(typeof google !== 'undefined' && google.accounts) {
      google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredential });
      google.accounts.id.renderButton(document.getElementById('signin-btn-wrapper'), { theme:'outline', size:'large' });
  } else { setTimeout(initGoogleSignIn, 500); }
}

function handleCredential(resp) {
  idToken = resp.credential;
  localStorage.setItem('ddcc_user_token', idToken);
  verifyToken(idToken);
}

async function verifyToken(token) {
  try {
    const r = await fetch(API_BASE + '?action=verify', { method:'POST', body:JSON.stringify({idToken: token}) });
    const j = await r.json();
    if(j.error) throw new Error(j.error);
    
    currentUser = j;
    document.body.classList.remove('login');
    document.getElementById('signin-container').style.display = 'none';
    document.getElementById('userInfo').classList.remove('hide');
    document.getElementById('userDisplay').innerHTML = `${j.name} (${j.permission})`;
    
    // 登入成功後，立刻載入所有資料
    loadAllSheetsForDesktop();
  } catch(e) {
    localStorage.removeItem('ddcc_user_token');
    initGoogleSignIn();
  }
}

function logout() {
  localStorage.removeItem('ddcc_user_token');
  location.reload();
}

/* ========== Core Data Loading ========== */
async function loadAllSheetsForDesktop(showLoad = true) {
  if(showLoad) showLoading();
  const reqs = SHEET_CONFIGS.map(c => fetchSingleSheet(c.key));
  await Promise.all(reqs);
  if(showLoad) hideLoading();
  
  if (SINGLE_ITEMS.length > 0) rebuildSelectOptions();
  
  const activeTab = document.querySelector('.main-tab.active');
  if (activeTab && activeTab.dataset.target === 'pane-dashboard2') {
      buildDashboardTabs2(); renderDashboard2();
  } else if (activeTab && activeTab.dataset.target === 'pane-punch') {
      loadSheetData(currentSheetKey);
  }
}

async function fetchSingleSheet(targetKey) {
  const cfg = SHEET_CONFIGS.find(c => c.key === targetKey);
  if(!cfg) return;
  try {
    const r = await fetch(`${API_BASE}?action=get&sheet=${encodeURIComponent(cfg.sheet)}&idToken=${encodeURIComponent(idToken||'')}&_t=${new Date().getTime()}`);
    const j = await r.json();
    if(j.error) { console.error(j.error); return; }

    const vals = j.values || [];
    let hIdx = vals.findIndex(r => Array.isArray(r) && (r.join('').includes('區域') || r.join('').includes('車號')));
    if(hIdx === -1) hIdx = 0;

    ALL_SHEETS[targetKey] = {
      cfg, header: vals[hIdx].map(String),
      rows: vals.slice(hIdx+1).filter(r => r[1]), 
      hIdx
    };
    
    // Update Single Search Pool
    SINGLE_ITEMS = SINGLE_ITEMS.filter(item => item.sheetKey !== targetKey);
    ALL_SHEETS[targetKey].rows.forEach(r => {
        SINGLE_ITEMS.push({ sheetKey: targetKey, cfg, header: ALL_SHEETS[targetKey].header, row: r });
    });

  } catch(e) { console.error(e); }
}

/* ========== Dashboard 2 (最新狀態) ========== */
function buildDashboardTabs2(){
  const box = document.getElementById('dashboardTabs2');
  if (!box) return; box.innerHTML = '';
  
  const mkBtn = (lbl, k) => {
      const b = document.createElement('button'); b.className='btn-tab '+(currentDashFilter2===k?'active':'');
      b.textContent=lbl; 
      b.onclick=()=>{ currentDashFilter2=k; buildDashboardTabs2(); renderDashboard2(); };
      box.appendChild(b);
  };
  mkBtn('所有車輛','ALL'); SHEET_CONFIGS.forEach(c=>mkBtn(c.key, c.key));
}

function renderDashboard2() {
  const box = document.getElementById('dashboard2');
  if(!box) return; box.innerHTML = '';
  
  if(Object.keys(ALL_SHEETS).length === 0) { box.innerHTML = '<div class="text-center mt-20">資料載入中...</div>'; return; }

  SHEET_CONFIGS.forEach(cfg => {
    if(currentDashFilter2!=='ALL' && currentDashFilter2!==cfg.key) return;
    const d = ALL_SHEETS[cfg.key]; if(!d) return; 
    
    const card = document.createElement('div'); card.className = 'dash-section card';
    card.innerHTML = `<div class="dash-title">${cfg.key}</div>`;
    
    let html = '<div class="stat-grid">';
    cfg.steps.filter(s=>s!=='車暫停位置').forEach(st => {
       const cIdx = d.header.indexOf(st); let done=0, todo=0;
       if(cIdx !== -1) d.rows.forEach(r => { const v = r[cIdx]; (v&&String(v).trim()!=='—'&&String(v).trim()!=='-')?done++:todo++; });
       html += `<div class="stat-card">
         <div class="stat-head">${st}</div>
         <div class="stat-row">
           <div class="stat-pill" onclick="openListModal('${cfg.key}','${st}','done')"><div class="stat-num done">${done}</div><div class="stat-label">完成</div></div>
           <div class="stat-pill" onclick="openListModal('${cfg.key}','${st}','todo')"><div class="stat-num todo">${todo}</div><div class="stat-label">未完成</div></div>
         </div></div>`;
    });
    html += '</div>';
    
    if(d.header.indexOf('車暫停位置') >= 0) {
       const sc = d.header.indexOf('車暫停位置'); const cc = {}; STOP_OPTIONS.forEach(x=>cc[x]=0);
       d.rows.forEach(r=>{ const v=String(r[sc]||'').trim(); if(cc[v]!==undefined) cc[v]++; });
       let lh = '<div class="dash-title" style="margin-top:16px;font-size:16px">停車位置</div><div class="loc-grid">';
       STOP_OPTIONS.forEach(x=>{ lh += `<div class="loc-pill" onclick="openListModal('${cfg.key}','車暫停位置','loc','${x}')"><div class="loc-name">${x}</div><div class="loc-num">${cc[x]}</div></div>`; });
       lh += '</div>'; html += lh;
    }
    card.innerHTML += html; box.appendChild(card);
  });
}

/* ========== 登錄與修改 ========== */
function loadSheetData(key) {
  currentSheetKey = key;
  document.getElementById('sheetTabs').innerHTML = SHEET_CONFIGS.map(c => 
    `<button class="btn-tab ${c.key===key?'active':''}" onclick="loadSheetData('${c.key}')">${c.key}</button>`
  ).join('');
  
  const d = ALL_SHEETS[key];
  if(!d) {
      document.getElementById('vehList').innerHTML = '載入中...';
      fetchSingleSheet(key).then(() => loadSheetData(key));
      return;
  }
  renderVehicles(d.cfg, d.rows, d.header);
}

function renderVehicles(cfg, rows, header) {
  const box = document.getElementById('vehList'); box.innerHTML = '';
  if(rows.length === 0) { box.innerHTML = '<div>無資料</div>'; return; }
  rows.forEach((r, idx) => {
      const area = r[1]; const car = r[2];
      const realRow = ALL_SHEETS[cfg.key].hIdx + 2 + idx;
      const card = document.createElement('div'); card.className = 'veh-card';
      let html = `<div><div class="veh-title-main">${area}</div><div class="veh-title-sub">${car}</div></div>`;
      cfg.steps.forEach(st => {
          if(st === '車暫停位置') {
               const cIdx = header.indexOf(st); const v = cIdx!==-1 ? r[cIdx] : '';
               html += `<div class="step-row"><div class="step-label">車暫停位置</div>
               <select class="step-select" onchange="onStopSelect('${cfg.key}', ${realRow}, '${st}', this.value)">
                 <option value="">請選擇</option>${STOP_OPTIONS.map(o => `<option value="${o}" ${o===v?'selected':''}>${o}</option>`).join('')}
               </select></div>`;
          } else {
               const cIdx = header.indexOf(st); const v = cIdx!==-1 ? r[cIdx] : '';
               const isDone = (v && String(v).trim()!=='—' && String(v).trim()!=='-');
               const time = isDone ? (v.match ? (v.match(/\d{1,2}:\d{2}/) || [v])[0] : v) : '—';
               if(isDone) {
                   html += `<div class="step-row"><div class="step-label">${st}</div>
                   <div style="display:flex;align-items:center;gap:5px;"><div class="step-time">${time}</div>
                     <button class="btn btn--sm btn--secondary" onclick="onEditTimeClick('${cfg.key}', ${realRow}, '${st}', '${time}')">修</button>
                     <button class="btn btn--sm btn--danger" onclick="onDeleteTimeClick('${cfg.key}', ${realRow}, '${st}')">刪</button>
                   </div></div>`;
               } else {
                   html += `<div class="step-row"><div class="step-label">${st}</div>
                   <button class="btn btn--sm" onclick="quickPunch('${cfg.key}', '${st}', '${area}', '${car}', this, ${realRow})">打卡</button></div>`;
               }
          }
      });
      card.innerHTML = html; box.appendChild(card);
  });
}

/* ========== 個別情報 ========== */
function initSinglePage() { rebuildSelectOptions(); }
function rebuildSelectOptions() {
    const selSheet = document.getElementById('selSheet');
    const selArea = document.getElementById('selArea');
    const selCar = document.getElementById('selCar');
    const sVal = selSheet.value; const aVal = selArea.value; const cVal = selCar.value;
    
    let filtered = SINGLE_ITEMS.filter(i => 
        (!sVal || i.sheetKey === sVal) && (!aVal || String(i.row[1]).trim() === aVal) && (!cVal || String(i.row[2]).trim() === cVal)
    );
    const sheets = [...new Set(filtered.map(i => i.sheetKey))].sort();
    const areas = [...new Set(filtered.map(i => String(i.row[1]).trim()))].sort();
    const cars = [...new Set(filtered.map(i => String(i.row[2]).trim()))].sort();
    
    updateSelect(selSheet, sheets, 'Tab', sVal);
    updateSelect(selArea, areas, '區域', aVal);
    updateSelect(selCar, cars, '車號', cVal);
}
function updateSelect(el, items, ph, cur) {
    el.innerHTML = `<option value="">— ${ph} —</option>` + items.map(i => `<option value="${i}">${i}</option>`).join('');
    if (items.includes(cur)) el.value = cur;
}
function runSingleQuery() {
    const sVal = document.getElementById('selSheet').value;
    const aVal = document.getElementById('selArea').value;
    const cVal = document.getElementById('selCar').value;
    const res = SINGLE_ITEMS.filter(i => 
        (!sVal || i.sheetKey === sVal) && (!aVal || String(i.row[1]).trim() === aVal) && (!cVal || String(i.row[2]).trim() === cVal)
    );
    renderSingleCards(res);
}
function resetSingleUI() {
    document.getElementById('selSheet').value = ''; document.getElementById('selArea').value = ''; document.getElementById('selCar').value = '';
    rebuildSelectOptions(); document.getElementById('singleResults').innerHTML = '';
}
function renderSingleCards(items) {
    const box = document.getElementById('singleResults'); box.innerHTML = '';
    if(items.length === 0) { box.innerHTML = '<div style="text-align:center;padding:20px;grid-column:1/-1">無符合資料</div>'; return; }
    items.forEach(it => {
        const card = document.createElement('div'); card.className = 'single-card';
        let latest = '尚未開始';
        for(let i=it.cfg.steps.length-1; i>=0; i--) {
            const st = it.cfg.steps[i]; const idx = it.header.indexOf(st); const v = it.row[idx];
            if(v && String(v).trim()!=='-' && String(v).trim()!=='—') { latest = (st==='車暫停位置') ? `停於：${v}` : st; break; }
        }
        card.innerHTML = `<div class="single-line">${it.row[1]}</div><div class="single-line">${it.row[2]}</div>
        <div class="single-line" style="color:#2563eb">${latest}</div><div style="margin-top:8px;font-size:12px;color:#666">${it.sheetKey}</div>`;
        card.onclick = () => openDetailModal(it.sheetKey, it.row); 
        box.appendChild(card);
    });
}

/* ========== 彈窗 (Lists & Detail) ========== */
function openListModal(key, step, type, val) {
  const d = ALL_SHEETS[key];
  const list = [];
  if(type==='loc') {
     const ci = d.header.indexOf('車暫停位置');
     d.rows.forEach(r=>{ if(String(r[ci]||'').trim()===val) list.push(r); });
  } else {
     const ci = d.header.indexOf(step);
     d.rows.forEach(r=>{ 
        const v=r[ci]; const done=(v&&String(v).trim()!=='—'&&String(v).trim()!=='-');
        if((type==='done'&&done)||(type==='todo'&&!done)) list.push(r);
     });
  }
  
  const box = document.createElement('div'); box.className = 'modal';
  box.innerHTML = `<div class="dash-close" onclick="this.parentElement.remove();document.querySelector('.modal-backdrop').remove()">✕</div>
  <h3>${key} - ${type==='loc'?val:step}</h3>
  <div style="max-height:60vh;overflow:auto">
  ${list.map(r=>`<div class="list-item">
     <div class="list-left"><div class="list-title">${r[1]}</div><div class="list-sub">${r[2]}</div></div>
     <button class="btn btn--sm btn--secondary" onclick="openDetailModal('${key}',['${r.join("','")}'])">詳情</button>
  </div>`).join('')}
  </div>`;
  
  const bd = document.createElement('div'); bd.className = 'modal-backdrop';
  bd.onclick = () => { bd.remove(); box.remove(); };
  document.body.appendChild(bd); document.body.appendChild(box);
}

function openDetailModal(key, row) {
    const d = ALL_SHEETS[key];
    // 這裡 row 傳進來可能被轉成 string array，需注意
    if(!Array.isArray(row)) row = row.split(',');
    
    const box = document.createElement('div'); box.className = 'modal';
    let html = `<div class="dash-close" onclick="this.parentElement.remove();document.querySelector('.modal-backdrop').remove()">✕</div>
    <h3>${row[1]} ${row[2]}</h3><table class="detail-table">`;
    
    d.cfg.steps.forEach(st => {
        const idx = d.header.indexOf(st);
        html += `<tr><th>${st}</th><td>${row[idx]||'—'}</td></tr>`;
    });
    html += `</table>`;
    box.innerHTML = html;
    
    const bd = document.createElement('div'); bd.className = 'modal-backdrop';
    bd.onclick = () => { bd.remove(); box.remove(); };
    document.body.appendChild(bd); document.body.appendChild(box);
}

/* ========== 通用互動與工具 ========== */
function switchPane(id) {
  if (!currentUser && id!=='pane-dashboard2') return showNotif('請先登入', true);
  
  document.querySelectorAll('.main-tab').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.main-tab[data-target="${id}"]`).classList.add('active');
  
  document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hide'));
  document.getElementById(id).classList.remove('hide');
  
  if (id === 'pane-dashboard2') {
      buildDashboardTabs2(); renderDashboard2(); startAutoRefresh();
  } else {
      stopAutoRefresh();
      if (id === 'pane-punch') loadSheetData(currentSheetKey);
      if (id === 'pane-single') initSinglePage();
  }
}

async function quickPunch(key, step, area, car, btn, specificRow) {
  if(!currentUser || currentUser.permission !== '全功能') return alert('權限不足');
  if(!confirm(`確認幫 ${car} 打卡？`)) return;
  
  const data = ALL_SHEETS[key];
  const col = data.header.indexOf(step) + 1;
  const now = getTaipeiHHMMSS();
  
  if(btn) { btn.textContent='...'; btn.disabled=true; }
  try {
    await fetch(API_BASE+'?action=update', { method: 'POST', body: JSON.stringify({ sheet:data.cfg.sheet, idToken, email:currentUser.email, writes:[{row:specificRow, col, value:now}] }) });
    loadAllSheetsForDesktop(false); // 靜默刷新
  } catch(e) { alert('失敗'); if(btn) { btn.textContent='打卡'; btn.disabled=false; } }
}

/* 其他互動函式 (onStopSelect, onEditTimeClick, onDeleteTimeClick) 因篇幅略，邏輯同 quickPunch */
// 請將這些函式補回，結構與 quickPunch 類似，只是 body 的 value 不同

async function onStopSelect(key, row, step, val) {
   if(!val) return;
   const data = ALL_SHEETS[key]; const col = data.header.indexOf(step) + 1;
   await withLoading(async () => {
       await fetch(API_BASE+'?action=update', { method: 'POST', body: JSON.stringify({ sheet:data.cfg.sheet, idToken, email:currentUser.email, writes:[{row, col, value:val}] }) });
       loadAllSheetsForDesktop(false);
   });
}

async function onEditTimeClick(key, row, step, oldVal) {
    const newVal = prompt("請輸入新時間 (HH:mm:ss)", oldVal);
    if(newVal === null || newVal === oldVal) return;
    const data = ALL_SHEETS[key]; const col = data.header.indexOf(step) + 1;
    await withLoading(async () => {
       await fetch(API_BASE+'?action=update', { method: 'POST', body: JSON.stringify({ sheet:data.cfg.sheet, idToken, email:currentUser.email, writes:[{row, col, value:newVal}] }) });
       loadAllSheetsForDesktop(false);
   });
}

async function onDeleteTimeClick(key, row, step) {
    if(!confirm("確定要刪除此時間嗎？")) return;
    const data = ALL_SHEETS[key]; const col = data.header.indexOf(step) + 1;
    await withLoading(async () => {
       await fetch(API_BASE+'?action=update', { method: 'POST', body: JSON.stringify({ sheet:data.cfg.sheet, idToken, email:currentUser.email, writes:[{row, col, value:""}] }) });
       loadAllSheetsForDesktop(false);
   });
}

function startAutoRefresh() {
  if(dashTimer) clearInterval(dashTimer);
  dashTimer = setInterval(() => { if(!document.getElementById('pane-dashboard2').classList.contains('hide')) loadAllSheetsForDesktop(false); }, refreshMs);
}
function stopAutoRefresh() { if(dashTimer) clearInterval(dashTimer); }
function startClock(){ setInterval(()=>{ document.getElementById('clockDisplay').textContent=getTaipeiHHMMSS(); },1000); }
function getTaipeiHHMMSS(){ return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date()); }
function showLoading(msg='讀取資料...'){ const el=document.getElementById('loading'); el.querySelector('.loading-text').textContent=msg; el.classList.add('show'); }
function hideLoading(){ document.getElementById('loading').classList.remove('show'); }
function showNotif(msg,isErr){ const n=document.getElementById('notif'); n.textContent=msg; n.style.opacity=1; setTimeout(()=>n.style.opacity=0,2000); }
function buildRefreshControls(){
  const box = document.getElementById('refreshControls'); if (!box) return; box.innerHTML = '';
  REFRESH_PRESETS.forEach(p=>{
    const btn = document.createElement('button'); btn.className = 'seg-btn '+(p.ms===refreshMs?'active':''); btn.textContent = p.label; 
    btn.onclick = ()=> { refreshMs=p.ms; startAutoRefresh(); buildRefreshControls(); }; box.appendChild(btn);
  });
  const nowBtn = document.createElement('button'); nowBtn.className = 'seg-btn'; nowBtn.textContent = '立即更新';
  nowBtn.onclick = ()=> loadAllSheetsForDesktop(true); box.appendChild(nowBtn);
}
</script>
</body>
</html>
