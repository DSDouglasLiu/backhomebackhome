<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ´»å‹•è»Šæµäººæµé€€å ´ç®¡ç†ç³»çµ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
      --card-bg: rgba(255,255,255,0.75);
      --text: #0f172a;
    }
    body.dark{
      --bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
      --card-bg: rgba(15,23,42,0.55);
      --text: #e2e8f0;
    }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      backdrop-filter: blur(14px);
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      color:var(--text);
    }
    .wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
    h1{margin:0 0 16px;}
    .card{background:var(--card-bg);border:1px solid rgba(255,255,255,0.3);border-radius:16px;padding:16px;margin:12px 0;}
    .hide{display:none;}

    /* tab åˆ— */
    .sheet-tabs{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-end;}
    .btn-tab{
      background:#e5e7eb;
      border:1px solid #cbd5f5;
      border-radius:4px;
      padding:6px 22px;
      font-size:.8rem;
      cursor:pointer;
      color:#000;
      min-width:170px;
      text-align:center;
    }
    .btn-tab.active{
      background:#1f6fe5;
      color:#fff;
      border-color:#1f6fe5;
    }
    #reloadBtn{
      margin-left:auto;
      background:#fff;
      border:1px solid #cbd5f5;
      border-radius:4px;
      padding:6px 22px;
      cursor:pointer;
    }

    /* è»Šå¡ç‰‡ï¼šä¸€åˆ—å…©è¼› */
    .veh-list{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(480px, 1fr));
      gap:12px;
      margin-top:16px;
    }
    .veh-card{
      background:rgba(255,255,255,0.85);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.25);
      padding:14px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    body.dark .veh-card{background:rgba(15,23,42,0.28);}
    .veh-title-main{font-weight:600;font-size:1rem;margin-bottom:2px;}
    .veh-title-sub{font-size:.85rem;opacity:.7;}

    .step-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:5px; /* ä¸Šä¸‹ 3px */
    }
    /* æœªæŒ‰éï¼šè—åº•ç™½å­— */
    .step-btn{
      border:0;
      border-radius:10px;
      padding:6px 12px 7px;
      background:#0f6efc;
      color:#fff;
      font-size:.74rem;
      cursor:pointer;
      flex:0 0 auto;
      min-width:170px;
      text-align:center;
    }
    /* å·²æŒ‰éï¼šç°è¦æ·±ä¸€é» */
    .step-btn.done{
      background:#cbd5e1;
      color:#0f172a;
      cursor:pointer;
    }
    /* é–ä½çš„å†æ·±ä¸€é» */
    .step-btn.locked{
      background:#94a3b8;
      color:#0f172a;
      opacity:.65;
      cursor:not-allowed;
    }
    .step-time{
      font-size:.7rem;
      color:rgba(15,23,42,.55);
      min-width:70px;
      text-align:right;
    }

    /* ä¸‹æ‹‰å¼çš„æ¨£å¼ */
    .step-select{
      min-width:170px;
      padding:5px 6px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      background:#fff;
      font-size:.74rem;
    }
    .step-select:disabled{
      background:#e2e8f0;
      cursor:not-allowed;
    }

    .notif{position:fixed;right:16px;bottom:16px;background:rgba(15,23,42,.85);color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transform:translateY(20px);transition:.2s;}
    .notif.show{opacity:1;transform:translateY(0);}

    @media(max-width:768px){
      .veh-list{grid-template-columns:1fr;}
      .sheet-tabs{gap:10px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
      <div>
        <h1>æ´»å‹•è»Šæµäººæµé€€å ´ç®¡ç†ç³»çµ±</h1>
      </div>
      <div id="signin"></div>
      <div id="userInfo" class="hide" style="font-size:.75rem;"></div>
    </div>

    <!-- tabs + é‡æ–°è¼‰å…¥ -->
    <div id="tabs" class="card hide" style="padding-bottom:6px;">
      <div class="sheet-tabs" id="sheetTabs"></div>
    </div>

    <div id="content" class="hide">
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <div id="notif" class="notif"></div>

<script>
const GOOGLE_CLIENT_ID = '368914333961-504cujbloe9n3v28p4bjsc8c1lh5pg0o.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxbeknXeJ2s2NnIqTwIwNdZnsbiI9UlGkQpSGfHq2TlmnITZ75Ub4ySwn6UGmJk3AXjNg/exec';

/* âœ… ä¸‰å¼µä½ èªªè¦ã€Œè»Šæš«åœä½ç½®ã€çš„è¡¨ï¼Œå…±ç”¨åŒä¸€çµ„åœ°é» */
const STOP_OPTIONS = [
  'ç¦ªå ‚å¹³å°',
  'æ³•å¤§è·¯ï¼ˆæ³•å¤§ä¸€æ©‹åˆ°æ³•å¿ƒå—è·¯é–“ï¼‰',
  'æ³•å¿ƒå—è·¯',
  'æ³•é¼“è·¯éˆå±±å‹å¢ƒçŸ³å¾€å¤–',
  'æ³•æ–°åŒ—è·¯'
];

const SHEET_CONFIGS = [
  {
    key: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰',
    sheet: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰',
    steps: [
      'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š',
      'Call è»Šä¸Šè¡Œæ',
      'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå‰å¾€æ’è»ŠéšŠ',
      'è»Šæš«åœä½ç½®',             // ä¸‹æ‹‰
      'é€€å ´äººå“¡å·²åˆ°é½Š',
      'å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°',
      'äººå·²å‰å¾€å¹³å°',
      'è»Šç¬¬äºŒæ¬¡ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
    ]
  },
  {
    key: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰',
    sheet: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰',
    steps: [
      'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š',
      'Call è»Šä¸Šè¡Œæ',
      'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå‰å¾€æ’è»ŠéšŠ',
      'è»Šæš«åœä½ç½®',             // ä¸‹æ‹‰
      'è»Šå·²é›¢é–‹ç¦ªå ‚å¹³å°'
    ]
  },
  {
    key: 'æ°´é™¸å°ˆè»Šé€€å ´',
    sheet: 'æ°´é™¸å°ˆè»Šé€€å ´',
    steps: [
      'å·² Call è»Šæ’è»ŠéšŠ',
      'å·²æ’å¥½è»ŠéšŠ',
      'é€€å ´äººå“¡å·²åˆ°é½Š',
      'å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šæš«åœä½ç½®',             // ä¸‹æ‹‰
      'è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
    ]
  },
  {
    key: '288æ³•é’é€€å ´',
    sheet: '288æ³•é’é€€å ´',
    steps: [
      'é€€å ´äººå“¡å·²åˆ°é½Š',
      'è»Šå·²ç¶“ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå·²ç¶“é›¢é–‹éŠè¦½è»Šå¹³å°'
    ]
  }
];


let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = [];

window.onload = function(){
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredential
  });
  google.accounts.id.renderButton(
    document.getElementById('signin'),
    { theme:'outline', size:'large' }
  );
  buildTabs();
};

function buildTabs(){
  const box = document.getElementById('sheetTabs');
  box.innerHTML = '';

  // 1) æ²’æœ‰ä»»ä½•åˆ†é å°±ç›´æ¥çµæŸï¼ˆä¹Ÿå¯é †ä¾¿éš±è— tabs/cardï¼‰
  if (!SHEET_CONFIGS.length) return;

  // 2) ä¿åº•ï¼šè‹¥ currentSheetKey ä¸å­˜åœ¨ï¼Œæ”¹ç”¨ç¬¬ä¸€å€‹
  const prevKey = currentSheetKey;
  if (!SHEET_CONFIGS.some(s => s.key === currentSheetKey)) {
    currentSheetKey = SHEET_CONFIGS[0].key; // â˜… fallback
  }
  const keyChanged = (prevKey !== currentSheetKey);

  // 3) ç”Ÿæˆåˆ†é æŒ‰éˆ•
  SHEET_CONFIGS.forEach(cfg=>{
    const b = document.createElement('button');
    b.className = 'btn-tab' + (cfg.key===currentSheetKey ? ' active' : '');
    b.textContent = cfg.key;
    b.onclick = () => {
      currentSheetKey = cfg.key;
      // â˜… æ”¹æˆåªæƒç®±å­è£¡çš„æŒ‰éˆ•ï¼Œé¿å…èª¤å‚·å…¶ä»–å…ƒç´ 
      box.querySelectorAll('.btn-tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      loadSheetData(currentSheetKey);
    };
    box.appendChild(b);
  });

  const reloadBtn = document.createElement('button');
  reloadBtn.id = 'reloadBtn';
  reloadBtn.textContent = 'é‡æ–°è¼‰å…¥';
  reloadBtn.onclick = reloadSheet;
  box.appendChild(reloadBtn);

  // 4) è‹¥å‰›å‰› fallback äº†ï¼Œè€Œä¸”å…§å®¹å€å·²ç¶“åœ¨é¡¯ç¤ºï¼Œå°±è‡ªå‹•è¼‰å…¥ä¸€æ¬¡
  const contentShown = !document.getElementById('content').classList.contains('hide');
  if (keyChanged && contentShown) {
    loadSheetData(currentSheetKey);
  }
}



async function handleCredential(resp){
  try {
    const r = await fetch(API_BASE + '?action=verify', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ idToken: resp.credential })
    });
    const j = await r.json();
    if (j.error) { showNotif('ç™»å…¥å¤±æ•—ï¼š' + j.error, true); return; }

    currentUser = j;

    document.getElementById('signin').classList.add('hide');
    const ui = document.getElementById('userInfo');
    ui.classList.remove('hide');
    ui.innerHTML = `${j.name||''} &lt;${j.email}&gt; ï½œ æ¬Šé™ï¼š<b>${j.permission}</b>`;
    document.getElementById('tabs').classList.remove('hide');
    document.getElementById('content').classList.remove('hide');

    // âœ… æ”¾åˆ° try è£¡ï¼šå”¯è®€æç¤º
    if (j.permission === 'æª¢è¦–') {
      showNotif('ç›®å‰ç‚ºã€Œæª¢è¦–ã€æ¬Šé™ï¼šæ‰€æœ‰æŒ‰éˆ•èˆ‡ä¸‹æ‹‰çš†ç‚ºå”¯è®€', false);
    }

    loadSheetData(currentSheetKey);
  } catch (err) {
    showNotif('ç™»å…¥éŒ¯èª¤ï¼š' + err.message, true);
  }
}

  
async function loadSheetData(key){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  document.getElementById('vehList').textContent = 'è®€å–ä¸­...';
  const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
  const j = await r.json();
  if (j.error){ document.getElementById('vehList').textContent = 'âŒ '+j.error; return; }
  sheetData = j.values || [];
  renderVehicles(cfg, sheetData);
}

/* æŠŠå„ç¨®æ™‚é–“ â†’ HH:mm:ssï¼ˆç•™è‘—ï¼Œçµ¦å…¶ä»–æŒ‰éˆ•ç”¨ï¼‰ */
function formatSheetTime(val){
  if (!val) return '';
  const s = String(val).trim();

  if (/^\d{1,2}:\d{2}:\d{2}$/.test(s)) {
    const parts = s.split(':');
    return parts.map(p=>p.padStart(2,'0')).join(':');
  }

  if (/^\d{4}\/\d{1,2}\/\d{1,2} \d{1,2}:\d{2}:\d{2}$/.test(s)) {
    return s.split(' ')[1].split(':').map(p=>p.padStart(2,'0')).join(':');
  }

  const m = s.match(/^(ä¸Šåˆ|ä¸‹åˆ)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (m){
    let h = parseInt(m[2],10);
    const mm = m[3];
    const ss = m[4] || '00';
    if (m[1] === 'ä¸‹åˆ' && h < 12) h += 12;
    if (m[1] === 'ä¸Šåˆ' && h === 12) h = 0;
    return `${String(h).padStart(2,'0')}:${mm}:${ss}`;
  }

  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(s)) {
    const d = new Date(s);
    const tw = new Date(d.getTime() + 8*60*60*1000);
    const hh = String(tw.getUTCHours()).padStart(2,'0');
    const mm = String(tw.getUTCMinutes()).padStart(2,'0');
    const ss = String(tw.getUTCSeconds()).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }

  return s;
}

function unlockNext(rowEl){
  const nextRow = rowEl?.nextElementSibling;
  if (!nextRow) return;
  const nextBtn = nextRow.querySelector('.step-btn');
  const nextSel = nextRow.querySelector('.step-select');
  if (nextBtn && !nextBtn.classList.contains('done')) {
    nextBtn.disabled = false;
    nextBtn.classList.remove('done');
  }
  if (nextSel) nextSel.disabled = false;
}

function lockFollowing(rowEl){
  let it = rowEl?.nextElementSibling;
  while (it){
    const b = it.querySelector('.step-btn');
    const s = it.querySelector('.step-select');
    if (b && !b.classList.contains('done')) { b.disabled = true; b.classList.add('done'); }
    if (s && !s.value) s.disabled = true;
    it = it.nextElementSibling;
  }
}

  
function getTaipeiHHMMSS() {
  const f = new Intl.DateTimeFormat('zh-TW', {
    timeZone: 'Asia/Taipei',
    hour12: false,
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
  return f.format(new Date()); // ä¾‹ï¼š'20:20:29'
}


function renderVehicles(cfg, data){
  const box = document.getElementById('vehList');
  box.innerHTML = '';

  // âœ… åªæœ‰å…¨åŠŸèƒ½å¯äº’å‹•ï¼›æª¢è¦–ä¸€å¾‹é–ä½
  const canWrite = (currentUser && currentUser.permission === 'å…¨åŠŸèƒ½');

  const headerRowIdx = data.findIndex(row =>
    Array.isArray(row) &&
    String(row[0] || '').trim() === 'ç·¨è™Ÿ' &&
    String(row[1] || '').trim().startsWith('å€åŸŸ') &&
    String(row[2] || '').trim() === 'è»Šè™Ÿ'
  );

  if (headerRowIdx === -1) {
    box.textContent = 'âŒ æ‰¾ä¸åˆ°è¡¨é ­';
    return;
  }

  const header = data[headerRowIdx].map(c => String(c || '').trim());
  const rows = data
    .slice(headerRowIdx + 1)
    .filter(r => {
      if (!Array.isArray(r)) return false;
      const no   = String(r[0] || '').trim();
      const area = String(r[1] || '').trim();
      const car  = String(r[2] || '').trim();
      return no && area && car;
    });

  if (!rows.length){
    box.textContent = '(é€™å¼µè¡¨ç›®å‰æ²’æœ‰è»Šè¼›è³‡æ–™)';
    return;
  }

  rows.forEach((row, idx) => {
    const area = String(row[1] || '').trim();
    const car  = String(row[2] || '').trim();

    const card = document.createElement('div');
    card.className = 'veh-card';

    const title = document.createElement('div');
    title.innerHTML = `
      <div class="veh-title-main">${area}</div>
      <div class="veh-title-sub">${car}</div>
    `;
    card.appendChild(title);

    const stepsBox = document.createElement('div');

    cfg.steps.forEach(st => {
      const colIdx = header.indexOf(st);
      const rowEl = document.createElement('div');
      rowEl.className = 'step-row';

      const rawVal = (colIdx !== -1 && row[colIdx]) ? String(row[colIdx]).trim() : '';

      /* âœ… é€™ä¸€æ®µï¼šå¦‚æœæ˜¯ã€Œè»Šæš«åœä½ç½®ã€å°±æ”¹æˆä¸‹æ‹‰å¼ */
      if (st === 'è»Šæš«åœä½ç½®') {
        const sel = document.createElement('select');
        sel.className = 'step-select';

        // é è¨­ä¸€å€‹ç©ºçš„ï¼Œå¯åšæ¸…ç©º
        const optEmpty = document.createElement('option');
        optEmpty.value = '';
        optEmpty.textContent = 'â€” è«‹é¸æ“‡ â€”';
        sel.appendChild(optEmpty);

        STOP_OPTIONS.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          sel.appendChild(o);
        });

        // æœ‰åŸæœ¬çš„å€¼ï¼Œå°±é¸èµ·ä¾†
        if (rawVal) sel.value = rawVal;

        // å³é‚Šé¡¯ç¤ºé¸åˆ°çš„æ–‡å­—
        const placeSpan = document.createElement('span');
        placeSpan.className = 'step-time';
        placeSpan.textContent = rawVal ? rawVal : '';

        // è·Ÿå…¶ä»–ä¸€æ¨£ï¼Œå‰ä¸€æ­¥æ²’åšå°±é–ä½
        const prevOk = prevDone(cfg, header, row, st);
        if (!prevOk && !rawVal) {
          sel.disabled = true;
        }

        const sheetRow = headerRowIdx + 1 + 1 + idx;

        sel.onchange = () => onStopSelect(
          cfg,
          sheetRow,
          header,
          st,
          sel.value,
          placeSpan
        );

        rowEl.appendChild(sel);
        rowEl.appendChild(placeSpan);
        stepsBox.appendChild(rowEl);
        return; // é€™ä¸€åˆ—çµæŸ
      }

      /* ä¸€èˆ¬æŒ‰éˆ•çš„æµç¨‹ */
      const btn = document.createElement('button');
      btn.className = 'step-btn';
      btn.textContent = st;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'step-time';

      const displayVal = rawVal ? formatSheetTime(rawVal) : '';

      if (rawVal) {
        btn.classList.add('done');
        timeSpan.textContent = displayVal;
      }

      const prevOk = prevDone(cfg, header, row, st);
      if (!prevOk && !rawVal) {
        btn.classList.add('done');
        btn.disabled = true;
      }

      const sheetRow = headerRowIdx + 1 + 1 + idx;
      btn.onclick = () => onStepClick(cfg, sheetRow, header, st, rawVal, btn, timeSpan);

      rowEl.appendChild(btn);
      rowEl.appendChild(timeSpan);
      stepsBox.appendChild(rowEl);
    });

    card.appendChild(stepsBox);
    box.appendChild(card);
  });
}

function prevDone(cfg, header, row, st){
  const idx = cfg.steps.indexOf(st);
  if (idx === 0) return true;
  const prevName = cfg.steps[idx-1];
  const colIdx = header.indexOf(prevName);
  if (colIdx === -1) return true;
  return !!row[colIdx];
}

/* âœ… ä¸‹æ‹‰å¼ã€Œè»Šæš«åœä½ç½®ã€å°ˆç”¨çš„å¯«å…¥ */
async function onStopSelect(cfg, rowNumber, header, st, value, span){
  if (!currentUser) return alert('è«‹å…ˆç™»å…¥');
  if (currentUser.permission !== 'å…¨åŠŸèƒ½') return alert('æ¬Šé™ä¸è¶³'); // â† åªå…è¨±å…¨åŠŸèƒ½
  
  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('æ­¤æ¬„ä½ä¸å­˜åœ¨ï¼š'+st);

  // ç›´æ¥æŠŠé¸åˆ°çš„æ–‡å­—å¯«é€²å»ï¼ˆæ²’æœ‰è¦è½‰æ™‚é–“æ ¼å¼ï¼‰
  const body = {
    sheet: cfg.sheet,
    email: currentUser.email,
    writes: [{ row: rowNumber, col: colIdx+1, value: value }]
  };

  const r = await fetch(API_BASE + '?action=update', {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(body)
  });
  const j = await r.json();
  if (!j.ok){
    showNotif('å¯«å…¥å¤±æ•—ï¼š'+(j.error||'unknown'), true);
    return;
  }

// å‰ç«¯æ›´æ–°
span.textContent = value || '';

const rowEl = span.closest('.step-row');
if (value) {
  unlockNext(rowEl);
  showNotif('å·²æ›´æ–°è»Šæš«åœä½ç½®', false);
} else {
  lockFollowing(rowEl);
  showNotif('å·²æ¸…é™¤è»Šæš«åœä½ç½®', false);
}
  /* âœ… è¼•é‡åŒæ­¥ */
setTimeout(()=>reloadSheet(), 300);

}

/* åŸæœ¬æŒ‰éˆ•çš„å¯«å…¥ï¼ˆæ™‚é–“ï¼‰ */
async function onStepClick(cfg, rowNumber, header, st, oldRawVal, btn, span){
  if (!currentUser) return alert('è«‹å…ˆç™»å…¥');
  if (currentUser.permission !== 'å…¨åŠŸèƒ½') return alert('æ¬Šé™ä¸è¶³'); // â† åªå…è¨±å…¨åŠŸèƒ½

  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('æ­¤æ¬„ä½ä¸å­˜åœ¨ï¼š'+st);

  const nowHHMMSS = getTaipeiHHMMSS();
  let userInput;

  if (oldRawVal) {
    userInput = prompt('æ­¤ç‹€æ…‹å·²æœ‰æ™‚é–“ï¼Œè¦ä¿®æ”¹å—ï¼Ÿï¼ˆç•™ç©ºâ†’æ¸…é™¤ï¼‰', nowHHMMSS);
    if (userInput === null) return;
    userInput = userInput.trim();
  } else {
    userInput = nowHHMMSS;
  }

    let valueToWrite = '';

  if (userInput === '') {
    valueToWrite = '';
  } else if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(userInput)) {
    const [h,m,s='00'] = userInput.split(':');
    const hh = String(h).padStart(2,'0');
    const mm = String(m).padStart(2,'0');
    const ss = String(s).padStart(2,'0');
    valueToWrite = `${hh}:${mm}:${ss}`;   // â† ç›´æ¥å¯«ã€Œ20:20:29ã€
  } else {
    valueToWrite = userInput;             // å…¶ä»–æ‰‹å‹•è¼¸å…¥å°±åŸæ¨£å¯«å…¥
  }


  const body = {
    sheet: cfg.sheet,
    email: currentUser.email,
    writes: [{ row: rowNumber, col: colIdx+1, value: valueToWrite }]
  };

  const r = await fetch(API_BASE + '?action=update', {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(body)
  });
  const j = await r.json();
  if (!j.ok){
    showNotif('å¯«å…¥å¤±æ•—ï¼š'+(j.error||'unknown'), true);
    return;
  }

if (userInput === '') {
  // æ¸…ç©º
  span.textContent = '';
  btn.classList.remove('done');

  // ğŸ”’ æ¸…ç©ºå¾ŒæŠŠå¾Œé¢æœªå®Œæˆæ­¥é©Ÿé–å›å»
  const rowEl = btn.closest('.step-row');
  lockFollowing(rowEl);

  showNotif('å·²æ¸…é™¤ã€Œ' + st + 'ã€', false);
} else {
  // å¯«å…¥æ™‚é–“æˆåŠŸ
  span.textContent = formatSheetTime(valueToWrite);
  btn.classList.add('done');

  // ğŸ”“ å®Œæˆæ­¤æ­¥ -> ç«‹åˆ»è§£é–ä¸‹ä¸€æ­¥
  const rowEl = btn.closest('.step-row');
  unlockNext(rowEl);

  showNotif('å·²å¯«å…¥ã€Œ' + st + 'ã€', false);
}
/* âœ… è¼•é‡åŒæ­¥ï¼ˆå¤šäººåŒæ™‚æ“ä½œæ™‚å»ºè­°ï¼‰ */
setTimeout(()=>reloadSheet(), 300);
  
}

function reloadSheet(){ loadSheetData(currentSheetKey); }

function showNotif(msg, isErr){
  const box = document.getElementById('notif');
  box.textContent = msg;
  box.style.background = isErr ? 'rgba(248,113,113,.9)' : 'rgba(15,23,42,.85)';
  box.classList.add('show');
  setTimeout(()=>box.classList.remove('show'), 2500);
}

function unlockNext(rowEl){
  const nextRow = rowEl?.nextElementSibling;
  if (!nextRow) return;
  const nextBtn = nextRow.querySelector('.step-btn');
  const nextSel = nextRow.querySelector('.step-select');

  // åªè§£é–é‚„æ²’å®Œæˆçš„
  if (nextBtn && !nextBtn.classList.contains('done')) {
    nextBtn.disabled = false;
    nextBtn.classList.remove('done'); // é‚„åŸæˆè—è‰²
  }
  if (nextSel) nextSel.disabled = false;
}

function lockFollowing(rowEl){
  // å¾€å¾ŒæŠŠæ‰€æœ‰æœªå®Œæˆçš„æ­¥é©Ÿé–å›å»
  let it = rowEl?.nextElementSibling;
  while (it){
    const b = it.querySelector('.step-btn');
    const s = it.querySelector('.step-select');
    if (b && !b.classList.contains('done')) {
      b.disabled = true;
      b.classList.add('done'); // ç°æ‰
    }
    if (s && !s.value) s.disabled = true;
    it = it.nextElementSibling;
  }
}
  
  
</script>
</body>
</html>
