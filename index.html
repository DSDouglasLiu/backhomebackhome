<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>活動車流人流退場管理系統</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
      --card-bg: rgba(255,255,255,0.75);
      --text: #0f172a;

      /* === 按鈕色系變數（可自行調） === */
      --btn-punch-bg:#0f6efc; --btn-punch-fg:#fff;     /* 打卡 */
      --btn-edit-bg:#22c55e;  --btn-edit-fg:#fff;      /* 修改 */
      --btn-del-bg:#ef4444;   --btn-del-fg:#fff;       /* 刪除 */
      --btn-save-bg:#1f6fe5;  --btn-save-fg:#fff;      /* 儲存（備註/頂部） */
      --btn-disabled-bg:#cbd5e1; --btn-disabled-fg:#0f172a;
    }
    body.dark{
      --bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
      --card-bg: rgba(15,23,42,0.55);
      --text: #e2e8f0;
    }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      backdrop-filter: blur(14px);
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      color:var(--text);
    }
    .wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
    h1{margin:0 0 16px;}
    .card{background:var(--card-bg);border:1px solid rgba(255,255,255,0.3);border-radius:16px;padding:16px;margin:12px 0;}
    .hide{display:none;}

    /* tab 列 */
    .sheet-tabs{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-end;}
    .btn-tab{
      background:#e5e7eb;
      border:1px solid #cbd5f5;
      border-radius:4px;
      padding:6px 22px;
      font-size:.8rem;
      cursor:pointer;
      color:#000;
      min-width:170px;
      text-align:center;
    }
    .btn-tab.active{
      background:#1f6fe5;
      color:#fff;
      border-color:#1f6fe5;
    }
    #reloadBtn{
      margin-left:auto;
      background:#fff;
      border:1px solid #cbd5f5;
      border-radius:4px;
      padding:6px 22px;
      cursor:pointer;
    }

    /* 車卡片：一列兩輛 */
    .veh-list{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(480px, 1fr));
      gap:12px;
      margin-top:16px;
    }
    .veh-card{
      background:rgba(255,255,255,0.85);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.25);
      padding:14px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    body.dark .veh-card{background:rgba(15,23,42,0.28);}
    .veh-title-main{font-weight:600;font-size:1rem;margin-bottom:2px;}
    .veh-title-sub{font-size:.85rem;opacity:.7;}

    /* === 步驟列改為三欄：標題 / 值 / 操作 === */
    .step-row{
      display:grid;
      grid-template-columns: 180px 1fr auto;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .step-label{ font-size:.86rem; opacity:.95; }
    .step-time{
      font-size:.86rem;
      color:rgba(15,23,42,.8);
      text-align:left;
    }

    /* 下拉式的樣式 */
    .step-select{
      min-width:170px;
      padding:5px 6px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      background:#fff;
      font-size:.86rem;
    }
    .step-select:disabled{
      background:#e2e8f0;
      cursor:not-allowed;
    }

    .btn-group{ display:flex; gap:6px; }

    /* 共用按鈕 */
    .btn{ border:0; border-radius:10px; padding:6px 12px 7px; font-size:.8rem; cursor:pointer; }
    .btn:disabled{ background:var(--btn-disabled-bg); color:var(--btn-disabled-fg); cursor:not-allowed; }
    .btn-punch{ background:var(--btn-punch-bg); color:var(--btn-punch-fg); }
    .btn-edit{  background:var(--btn-edit-bg);  color:var(--btn-edit-fg);  }
    .btn-del{   background:var(--btn-del-bg);   color:var(--btn-del-fg);   }
    .btn-save{  background:var(--btn-save-bg);  color:var(--btn-save-fg);  }

    .notif{position:fixed;right:16px;bottom:16px;background:rgba(15,23,42,.85);color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transform:translateY(20px);transition:.2s;}
    .notif.show{opacity:1;transform:translateY(0);}

    /* 彈窗 */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      background:#fff; color:#0f172a; border-radius:14px; padding:16px; width:min(92vw,420px);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    body.dark .modal{ background:#0b1220; color:#e2e8f0; }
    .modal h3{ margin:0 0 12px; font-size:1rem; }
    .modal .row{ display:flex; gap:8px; align-items:center; margin:10px 0; }
    .modal input[type="text"]{
      width:70px; padding:6px 8px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; font-size:.9rem; text-align:center;
    }
    body.dark .modal input[type="text"]{ background:#111827; color:#e2e8f0; border-color:#334155; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .modal .btn{ border-radius:8px; }

    @media(max-width:768px){
      .veh-list{grid-template-columns:1fr;}
      .sheet-tabs{gap:10px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
      <div>
        <h1>活動車流人流退場管理系統</h1>
      </div>
      <div id="signin"></div>
      <div id="userInfo" class="hide" style="font-size:.75rem;"></div>
    </div>

    <!-- tabs + 重新載入 -->
    <div id="tabs" class="card hide" style="padding-bottom:6px;">
      <div class="sheet-tabs" id="sheetTabs"></div>
    </div>

    <div id="content" class="hide">
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <div id="notif" class="notif"></div>

<script>
const GOOGLE_CLIENT_ID = '368914333961-504cujbloe9n3v28p4bjsc8c1lh5pg0o.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxbeknXeJ2s2NnIqTwIwNdZnsbiI9UlGkQpSGfHq2TlmnITZ75Ub4ySwn6UGmJk3AXjNg/exec';

/* ✅ 三張你說要「車暫停位置」的表，共用同一組地點 */
const STOP_OPTIONS = [
  '禪堂平台',
  '法大路（法大一橋到法心南路間）',
  '法心南路',
  '法鼓路靈山勝境石往外',
  '法新北路'
];

const SHEET_CONFIGS = [
  {
    key: '地區專車退場（遊覽車平台）',
    sheet: '地區專車退場（遊覽車平台）',
    steps: [
      '車長通知行李到齊',
      'Call 車上行李',
      '車已上遊覽車平台',
      '車前往排車隊',
      '車暫停位置',             // 下拉
      '退場人員已到齊',
      '已 Call 車上遊覽車平台',
      '人已前往平台',
      '車第二次上遊覽車平台',
      '車已離開遊覽車平台'
    ]
  },
  {
    key: '地區專車退場（禪堂平台）',
    sheet: '地區專車退場（禪堂平台）',
    steps: [
      '車長通知行李到齊',
      'Call 車上行李',
      '車已上遊覽車平台',
      '車前往排車隊',
      '車暫停位置',             // 下拉
      '車已離開禪堂平台'
    ]
  },
  {
    key: '水陸專車退場',
    sheet: '水陸專車退場',
    steps: [
      '已 Call 車排車隊',
      '已排好車隊',
      '退場人員已到齊',
      '已 Call 車上遊覽車平台',
      '車已上遊覽車平台',
      '車暫停位置',             // 下拉
      '車已離開遊覽車平台'
    ]
  },
  {
    key: '288法青退場',
    sheet: '288法青退場',
    steps: [
      '退場人員已到齊',
      '車已經上遊覽車平台',
      '車已經離開遊覽車平台'
    ]
  }
];

let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = [];

window.onload = function(){
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredential
  });
  google.accounts.id.renderButton(
    document.getElementById('signin'),
    { theme:'outline', size:'large' }
  );
  buildTabs();
};

function buildTabs(){
  const box = document.getElementById('sheetTabs');
  box.innerHTML = '';
  if (!SHEET_CONFIGS.length) return;

  const prevKey = currentSheetKey;
  if (!SHEET_CONFIGS.some(s => s.key === currentSheetKey)) {
    currentSheetKey = SHEET_CONFIGS[0].key;
  }
  const keyChanged = (prevKey !== currentSheetKey);

  SHEET_CONFIGS.forEach(cfg=>{
    const b = document.createElement('button');
    b.className = 'btn-tab' + (cfg.key===currentSheetKey ? ' active' : '');
    b.textContent = cfg.key;
    b.onclick = () => {
      currentSheetKey = cfg.key;
      box.querySelectorAll('.btn-tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      loadSheetData(currentSheetKey);
    };
    box.appendChild(b);
  });

  const reloadBtn = document.createElement('button');
  reloadBtn.id = 'reloadBtn';
  reloadBtn.textContent = '重新載入';
  reloadBtn.onclick = reloadSheet;
  box.appendChild(reloadBtn);

  const contentShown = !document.getElementById('content').classList.contains('hide');
  if (keyChanged && contentShown) loadSheetData(currentSheetKey);
}

async function handleCredential(resp){
  try {
    const r = await fetch(API_BASE + '?action=verify', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ idToken: resp.credential })
    });
    const j = await r.json();
    if (j.error) { showNotif('登入失敗：' + j.error, true); return; }

    currentUser = j;

    document.getElementById('signin').classList.add('hide');
    const ui = document.getElementById('userInfo');
    ui.classList.remove('hide');
    ui.innerHTML = `${j.name||''} &lt;${j.email}&gt; ｜ 權限：<b>${j.permission}</b>`;
    document.getElementById('tabs').classList.remove('hide');
    document.getElementById('content').classList.remove('hide');

    if (j.permission === '檢視') {
      showNotif('目前為「檢視」權限：所有按鈕與下拉皆為唯讀', false);
    }
    loadSheetData(currentSheetKey);
  } catch (err) {
    showNotif('登入錯誤：' + err.message, true);
  }
}

async function loadSheetData(key){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  document.getElementById('vehList').textContent = '讀取中...';
  const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
  const j = await r.json();
  if (j.error){ document.getElementById('vehList').textContent = '❌ '+j.error; return; }
  sheetData = j.values || [];
  renderVehicles(cfg, sheetData);
}

/* 把各種時間 → HH:mm:ss */
function formatSheetTime(val){
  if (!val) return '';
  const s = String(val).trim();

  if (/^\d{1,2}:\d{2}:\d{2}$/.test(s)) {
    const parts = s.split(':');
    return parts.map(p=>p.padStart(2,'0')).join(':');
  }
  if (/^\d{4}\/\d{1,2}\/\d{1,2} \d{1,2}:\d{2}:\d{2}$/.test(s)) {
    return s.split(' ')[1].split(':').map(p=>p.padStart(2,'0')).join(':');
  }
  const m = s.match(/^(上午|下午)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (m){
    let h = parseInt(m[2],10);
    const mm = m[3];
    const ss = m[4] || '00';
    if (m[1] === '下午' && h < 12) h += 12;
    if (m[1] === '上午' && h === 12) h = 0;
    return `${String(h).padStart(2,'0')}:${mm}:${ss}`;
  }
  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(s)) {
    const d = new Date(s);
    const tw = new Date(d.getTime() + 8*60*60*1000);
    const hh = String(tw.getUTCHours()).padStart(2,'0');
    const mm = String(tw.getUTCMinutes()).padStart(2,'0');
    const ss = String(tw.getUTCSeconds()).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }
  return s;
}

function getTaipeiHHMMSS() {
  const f = new Intl.DateTimeFormat('zh-TW', {
    timeZone: 'Asia/Taipei',
    hour12: false,
    hour: '2-digit', minute: '2-digit', second: '2-digit'
  });
  return f.format(new Date()); // 例：'20:20:29'
}

/* ====== UI 輔助：彈窗與時間欄位 ====== */
const pad2 = n => String(n).padStart(2,'0');
const splitHMS = (val) => {
  const s = String(val||'').trim();
  const m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  return m ? [pad2(m[1]), m[2], m[3] ? m[3] : '00'] : ['','',''];
};
const isValidHMS = (h,m,s) => {
  const hh = Number(h), mm = Number(m), ss = Number(s);
  if (!/^\d{2}$/.test(h) || !/^\d{2}$/.test(m) || !/^\d{2}$/.test(s)) return false;
  return hh>=0 && hh<=23 && mm>=0 && mm<=59 && ss>=0 && ss<=59;
};
function openModal(element){
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  backdrop.appendChild(element);
  document.body.appendChild(backdrop);
  return () => backdrop.remove();
}
function openConfirmDialog(msg, onOK){
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3>確認刪除</h3>
    <div style="line-height:1.5;">${msg}</div>
    <div class="actions">
      <button class="btn" style="background:#e5e7eb;color:#111827;">取消</button>
      <button class="btn btn-del">確定</button>
    </div>`;
  const close = openModal(box);
  const [btnCancel, btnOK] = box.querySelectorAll('button');
  btnCancel.onclick = close;
  btnOK.onclick = ()=>{ try{ onOK&&onOK(); } finally{ close(); } };
}
function openEditTimeDialog(initialHHMMSS, onOK){
  const [h0,m0,s0] = splitHMS(initialHHMMSS);
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3>修改時間</h3>
    <div class="row">
      <label>HH</label><input id="hh" type="text" maxlength="2" value="${h0}">
      <label>MM</label><input id="mm" type="text" maxlength="2" value="${m0}">
      <label>SS</label><input id="ss" type="text" maxlength="2" value="${s0}">
    </div>
    <div style="font-size:.8rem;opacity:.7;">請輸入 2 位數（00–23 / 00–59 / 00–59）</div>
    <div class="actions">
      <button class="btn" style="background:#e5e7eb;color:#111827;">取消</button>
      <button class="btn btn-edit">確定</button>
    </div>`;
  const close = openModal(box);
  const hh = box.querySelector('#hh'), mm = box.querySelector('#mm'), ss = box.querySelector('#ss');
  const [btnCancel, btnOK] = box.querySelectorAll('button');
  btnCancel.onclick = close;
  btnOK.onclick = ()=>{
    const H = pad2(hh.value||''), M = pad2(mm.value||''), S = pad2(ss.value||'');
    if (!isValidHMS(H,M,S)){ showNotif('格式需為 HH(00–23) / MM(00–59) / SS(00–59)', true); return; }
    try{ onOK(`${H}:${M}:${S}`); } finally{ close(); }
  };
}

/* ====== 主渲染 ====== */
function renderVehicles(cfg, data){
  const box = document.getElementById('vehList');
  box.innerHTML = '';

  const canWrite = (currentUser && currentUser.permission === '全功能');

  const headerRowIdx = data.findIndex(row =>
    Array.isArray(row) &&
    String(row[0] || '').trim() === '編號' &&
    String(row[1] || '').trim().startsWith('區域') &&
    String(row[2] || '').trim() === '車號'
  );
  if (headerRowIdx === -1) { box.textContent = '❌ 找不到表頭'; return; }

  const header = data[headerRowIdx].map(c => String(c || '').trim());
  const rows = data
    .slice(headerRowIdx + 1)
    .filter(r => {
      if (!Array.isArray(r)) return false;
      const no   = String(r[0] || '').trim();
      const area = String(r[1] || '').trim();
      const car  = String(r[2] || '').trim();
      return no && area && car;
    });

  if (!rows.length){ box.textContent = '(這張表目前沒有車輛資料)'; return; }

  rows.forEach((row, idx) => {
    const area = String(row[1] || '').trim();
    const car  = String(row[2] || '').trim();

    const card = document.createElement('div');
    card.className = 'veh-card';

    const title = document.createElement('div');
    title.innerHTML = `
      <div class="veh-title-main">${area}</div>
      <div class="veh-title-sub">${car}</div>
    `;
    card.appendChild(title);

    const stepsBox = document.createElement('div');

    cfg.steps.forEach(st => {
      const colIdx = header.indexOf(st);
      const rowEl = document.createElement('div');
      rowEl.className = 'step-row';

      const rawVal = (colIdx !== -1 && row[colIdx]) ? String(row[colIdx]).trim() : '';
      const displayVal = rawVal ? formatSheetTime(rawVal) : '';

      // 第一欄：標題
      const labelEl = document.createElement('div');
      labelEl.className = 'step-label';
      labelEl.textContent = st;
      rowEl.appendChild(labelEl);

      /* 車暫停位置：維持下拉；無修改/刪除 */
      if (st === '車暫停位置') {
        const valueEl = document.createElement('div');
        const sel = document.createElement('select');
        sel.className = 'step-select';

        const optEmpty = document.createElement('option');
        optEmpty.value = '';
        optEmpty.textContent = '— 請選擇 —';
        sel.appendChild(optEmpty);

        STOP_OPTIONS.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          sel.appendChild(o);
        });

        if (rawVal) sel.value = rawVal;
        valueEl.appendChild(sel);
        rowEl.appendChild(valueEl);

        // 右側空群組（對齊）
        const btnG = document.createElement('div');
        btnG.className = 'btn-group';
        rowEl.appendChild(btnG);

        const sheetRow = headerRowIdx + 1 + 1 + idx;

        if (!canWrite) {
          sel.disabled = true;
          rowEl.classList.add('locked');
        } else {
          const prevOk = prevDone(cfg, header, row, st);
          if (!prevOk && !rawVal) sel.disabled = true;
          sel.onchange = () => onStopSelect(cfg, sheetRow, header, st, sel.value, document.createElement('span'));
        }

        stepsBox.appendChild(rowEl);
        return;
      }

      // 第二欄：時間顯示
      const timeSpan = document.createElement('span');
      timeSpan.className = 'step-time';
      timeSpan.textContent = displayVal;
      rowEl.appendChild(timeSpan);

      // 第三欄：操作按鈕群（打卡 / 修改 / 刪除）
      const btnG = document.createElement('div'); btnG.className = 'btn-group';

      const btnPunch = document.createElement('button');
      btnPunch.className = 'btn btn-punch';
      btnPunch.textContent = '打卡';

      const btnEdit = document.createElement('button');
      btnEdit.className  = 'btn btn-edit';
      btnEdit.textContent = '修改';

      const btnDel = document.createElement('button');
      btnDel.className   = 'btn btn-del';
      btnDel.textContent = '刪除';

      btnG.appendChild(btnPunch); btnG.appendChild(btnEdit); btnG.appendChild(btnDel);
      rowEl.appendChild(btnG);

      const sheetRow = headerRowIdx + 1 + 1 + idx;

      if (!canWrite) {
        btnPunch.disabled = true; btnEdit.disabled = true; btnDel.disabled = true;
        rowEl.classList.add('locked');
      } else {
        const prevOk = prevDone(cfg, header, row, st);
        if (!prevOk && !rawVal) {
          btnPunch.disabled = true; btnEdit.disabled = true; btnDel.disabled = true;
        } else {
          const hasVal = !!rawVal;
          btnPunch.disabled = hasVal;
          btnEdit.disabled  = !hasVal;
          btnDel.disabled   = !hasVal;

          btnPunch.onclick = () => onPunchClick(cfg, sheetRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl);
          btnEdit.onclick  = () => onEditTimeClick(cfg, sheetRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl, displayVal);
          btnDel.onclick   = () => onDeleteTimeClick(cfg, sheetRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl);
        }
      }

      stepsBox.appendChild(rowEl);
    });

    card.appendChild(stepsBox);

    /* === 備註區 === */
    const memoWrap = document.createElement('div');
    memoWrap.style.marginTop = '8px';
    const memoRow = document.createElement('div');
    memoRow.style.display = 'flex';
    memoRow.style.gap = '8px';
    memoRow.style.alignItems = 'stretch';

    const memoTA = document.createElement('textarea');
    memoTA.placeholder = '備註';
    memoTA.style.flex = '1';
    memoTA.style.minHeight = '84px';
    memoTA.style.padding = '8px';
    memoTA.style.border = '1px solid #cbd5e1';
    memoTA.style.borderRadius = '10px';
    memoTA.style.fontSize = '.9rem';
    memoTA.style.background = 'rgba(255,255,255,.9)';
    if (document.body.classList.contains('dark')) memoTA.style.background = 'rgba(15,23,42,.15)';

    // 備註欄位：找「備註」，找不到就用最後一欄
    let memoColIdx = header.indexOf('備註');
    if (memoColIdx === -1) memoColIdx = header.length - 1;
    const memoRaw = (memoColIdx !== -1 && row[memoColIdx]) ? String(row[memoColIdx]) : '';
    memoTA.value = memoRaw;

    const memoBtn = document.createElement('button');
    memoBtn.className = 'btn btn-save';
    memoBtn.textContent = '儲存';
    memoBtn.style.alignSelf = 'flex-start';
    if (!(currentUser && currentUser.permission === '全功能')) memoBtn.disabled = true;

    memoBtn.onclick = async ()=>{
      if (!currentUser) return alert('請先登入');
      if (currentUser.permission !== '全功能') return alert('權限不足');
      const sheetRow = headerRowIdx + 1 + 1 + idx;
      const body = { sheet: cfg.sheet, email: currentUser.email, writes: [{ row: sheetRow, col: memoColIdx+1, value: memoTA.value }] };
      const r = await fetch(API_BASE + '?action=update', { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body) });
      const j = await r.json();
      if (!j.ok){ showNotif('備註儲存失敗：'+(j.error||'unknown'), true); return; }
      showNotif('備註已儲存', false);
      setTimeout(()=>reloadSheet(), 300);
    };

    memoRow.appendChild(memoTA);
    memoRow.appendChild(memoBtn);
    memoWrap.appendChild(memoRow);
    card.appendChild(memoWrap);

    box.appendChild(card);
  });
}

function prevDone(cfg, header, row, st){
  const idx = cfg.steps.indexOf(st);
  if (idx === 0) return true;
  const prevName = cfg.steps[idx-1];
  const colIdx = header.indexOf(prevName);
  if (colIdx === -1) return true;
  return !!row[colIdx];
}

/* 下拉式「車暫停位置」專用寫入（選空 = 清除；選其他 = 修改） */
async function onStopSelect(cfg, rowNumber, header, st, value, span){
  if (!currentUser) return alert('請先登入');
  if (currentUser.permission !== '全功能') return alert('權限不足');

  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('此欄位不存在：'+st);

  const body = { sheet: cfg.sheet, email: currentUser.email, writes: [{ row: rowNumber, col: colIdx+1, value: value }] };
  const r = await fetch(API_BASE + '?action=update', { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(body) });
  const j = await r.json();
  if (!j.ok){ showNotif('寫入失敗：'+(j.error||'unknown'), true); return; }

  span.textContent = value || '';
  const rowEl = document.querySelector('.step-row'); // 不用顯示時間的行，僅提示/解鎖
  if (value) showNotif('已更新車暫停位置', false);
  else showNotif('已清除車暫停位置', false);
  setTimeout(()=>reloadSheet(), 300);
}

/* 打卡：只允許新增 */
async function onPunchClick(cfg, rowNumber, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl){
  if (!currentUser) return alert('請先登入');
  if (currentUser.permission !== '全功能') return alert('權限不足');

  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('此欄位不存在：'+st);

  if (timeSpan.textContent && timeSpan.textContent.trim()){
    showNotif('此步驟已有時間，請用「修改」或「刪除」', true);
    return;
  }

  const now = getTaipeiHHMMSS();
  const body = { sheet: cfg.sheet, email: currentUser.email, writes: [{ row: rowNumber, col: colIdx+1, value: now }] };
  const r = await fetch(API_BASE + '?action=update', { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body) });
  const j = await r.json();
  if (!j.ok){ showNotif('寫入失敗：'+(j.error||'unknown'), true); return; }

  timeSpan.textContent = formatSheetTime(now);
  btnPunch.disabled = true; btnEdit.disabled = false; btnDel.disabled = false;
  unlockNext(rowEl);
  showNotif('已打卡', false);
  setTimeout(()=>reloadSheet(), 300);
}

/* 修改（hh/mm/ss 三欄） */
async function onEditTimeClick(cfg, rowNumber, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl, currentVal){
  if (!currentUser) return alert('請先登入');
  if (currentUser.permission !== '全功能') return alert('權限不足');

  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('此欄位不存在：'+st);

  openEditTimeDialog(currentVal || timeSpan.textContent || getTaipeiHHMMSS(), async (newHHMMSS)=>{
    const body = { sheet: cfg.sheet, email: currentUser.email, writes: [{ row: rowNumber, col: colIdx+1, value: newHHMMSS }] };
    const r = await fetch(API_BASE + '?action=update', { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body) });
    const j = await r.json();
    if (!j.ok){ showNotif('修改失敗：'+(j.error||'unknown'), true); return; }

    const wasEmpty = !timeSpan.textContent;
    timeSpan.textContent = formatSheetTime(newHHMMSS);
    if (wasEmpty) unlockNext(rowEl);
    btnPunch.disabled = true; btnEdit.disabled = false; btnDel.disabled = false;

    showNotif('已修改時間', false);
    setTimeout(()=>reloadSheet(), 300);
  });
}

/* 刪除（確認對話框） */
async function onDeleteTimeClick(cfg, rowNumber, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl){
  if (!currentUser) return alert('請先登入');
  if (currentUser.permission !== '全功能') return alert('權限不足');

  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('此欄位不存在：'+st);

  openConfirmDialog('確定要刪除資料嗎？', async ()=>{
    const body = { sheet: cfg.sheet, email: currentUser.email, writes: [{ row: rowNumber, col: colIdx+1, value: '' }] };
    const r = await fetch(API_BASE + '?action=update', { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body) });
    const j = await r.json();
    if (!j.ok){ showNotif('刪除失敗：'+(j.error||'unknown'), true); return; }

    timeSpan.textContent = '';
    btnPunch.disabled = false; btnEdit.disabled = true; btnDel.disabled = true;
    lockFollowing(rowEl);
    showNotif('已刪除', false);
    setTimeout(()=>reloadSheet(), 300);
  });
}

/* 重新載入 */
function reloadSheet(){ loadSheetData(currentSheetKey); }

/* 通知 */
function showNotif(msg, isErr){
  const box = document.getElementById('notif');
  box.textContent = msg;
  box.style.background = isErr ? 'rgba(248,113,113,.9)' : 'rgba(15,23,42,.85)';
  box.classList.add('show');
  setTimeout(()=>box.classList.remove('show'), 2500);
}

/* 解鎖下一步 / 鎖回後續（新版：支援下拉與三鍵） */
function unlockNext(rowEl){
  const nextRow = rowEl?.nextElementSibling;
  if (!nextRow) return;

  const sel = nextRow.querySelector('.step-select');
  const timeSpan = nextRow.querySelector('.step-time');
  const btnPunch = nextRow.querySelector('.btn-punch');
  const btnEdit  = nextRow.querySelector('.btn-edit');
  const btnDel   = nextRow.querySelector('.btn-del');

  if (currentUser?.permission !== '全功能') return;

  if (sel){
    sel.disabled = false;
    return;
  }
  if (btnPunch){
    const hasVal = !!(timeSpan && timeSpan.textContent.trim());
    btnPunch.disabled = hasVal;
    if (btnEdit) btnEdit.disabled = !hasVal;
    if (btnDel)  btnDel.disabled  = !hasVal;
  }
}

function lockFollowing(rowEl){
  let it = rowEl?.nextElementSibling;
  while (it){
    const sel = it.querySelector('.step-select');
    const timeSpan = it.querySelector('.step-time');
    const btnPunch = it.querySelector('.btn-punch');
    const btnEdit  = it.querySelector('.btn-edit');
    const btnDel   = it.querySelector('.btn-del');

    if (sel && !sel.value) sel.disabled = true;

    if (btnPunch){
      const hasVal = !!(timeSpan && timeSpan.textContent.trim());
      if (!hasVal){
        btnPunch.disabled = true;
        if (btnEdit) btnEdit.disabled = true;
        if (btnDel)  btnDel.disabled  = true;
      }
    }
    it = it.nextElementSibling;
  }
}
</script>
</body>
</html>
