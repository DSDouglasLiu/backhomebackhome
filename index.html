<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>車流人流退場情報</title>
  <style>
    /* =========== Design Tokens =========== */
    :root{
      --primary-600:#1f6fe5; --primary-700:#165bd1;
      --success-600:#22c55e; --danger-600:#ef4444;
      --gray-100:#f1f5f9; --gray-200:#e5e7eb; --gray-500:#64748b;
      --gray-800:#1f2937; --gray-900:#0f172a;
      --surface: rgba(255,255,255,.95);
      --page-bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
      --text-strong: var(--gray-900);
      --text: var(--gray-800);
      --border: rgba(148,163,184,0.35);
      --shadow-card:0 8px 24px rgba(0,0,0,.08);
    }
    body{ margin:0; min-height:100vh; background:var(--page-bg); color:var(--text); font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-bottom: 40px; }
    .wrap{max-width:1080px;margin:0 auto;padding:16px;}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-card);padding:16px;margin:12px 0;}
    .hide{ display:none !important; }
    
    /* Login */
    body.login { display: grid; place-items: center; height: 100vh; overflow: hidden; }
    body.login #mobile-nav, body.login #mobile-status-view, body.login .topbar-grid, body.login #main-content-wrap { display: none !important; }
    body.login #signin-container { display: flex !important; flex-direction: column; align-items: center; gap: 20px; background: rgba(255,255,255,0.9); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); min-width: 300px; z-index: 10000; }

    /* Mobile Nav */
    #mobile-nav { position: fixed; top: 0; left: 0; right: 0; z-index: 9999; background: #fff; height: 50px; display: flex; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; }
    .m-nav-btn { flex: 1; border: none; background: transparent; font-size: 15px; font-weight: 700; color: var(--gray-500); border-right: 1px solid var(--gray-200); cursor: pointer; padding: 0; margin: 0; white-space: nowrap; }
    .m-nav-btn.active { background: var(--primary-600); color: #fff; }

    /* Mobile Content */
    #mobile-status-view { display: none; margin-top: 50px; padding: 16px; }
    .m-select { width: 100%; padding: 12px; font-size: 16px; font-weight: 700; border: 1px solid var(--primary-600); border-radius: 10px; background: #fff; color: var(--primary-600); margin-bottom: 16px; }
    .m-card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: var(--shadow-card); }
    .m-stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed var(--gray-200); }
    .m-pill { display: flex; flex-direction: column; align-items: center; min-width: 50px; padding: 4px 8px; border-radius: 8px; }
    .m-num { font-size: 22px; font-weight: 900; }
    .m-num.done { color: var(--primary-600); } .m-num.todo { color: var(--danger-600); }
    
    /* Desktop & Shared */
    .topbar-grid { display: grid; grid-template-columns: 1fr auto; grid-template-rows: auto auto; grid-template-areas: "title user" "tabs refresh"; gap: 10px 20px; align-items: center; margin-bottom: 16px; }
    .left-title { grid-area: title; } .right-user { grid-area: user; display: flex; justify-content: flex-end; gap: 10px; } .left-tabs { grid-area: tabs; } .right-refresh { grid-area: refresh; display: flex; justify-content: flex-end; }
    .main-tabs { display: flex; gap: 10px; }
    .main-tab { background: #fff; color: var(--primary-600); border: 1px solid var(--primary-600); border-radius: 10px; padding: 8px 20px; font-weight: 700; cursor: pointer; }
    .main-tab.active { background: var(--primary-600); color: #fff; }
    .btn { background: var(--primary-600); color: #fff; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn--secondary { background: #fff; color: var(--primary-600); border: 1px solid var(--primary-600); }
    
    /* RWD */
    @media (max-width: 767px) {
      body:not(.mode-web) #mobile-nav { display: flex; }
      body:not(.mode-web) #mobile-status-view { display: block; }
      body:not(.mode-web) .topbar-grid, body:not(.mode-web) #main-content-wrap { display: none !important; }
      body.mode-web #mobile-nav { display: none !important; }
      body.mode-web .topbar-grid { display: grid !important; margin-top: 0; }
      body.mode-web #main-content-wrap { display: block !important; }
    }
    @media (min-width: 768px) {
      #mobile-nav, #mobile-status-view { display: none !important; }
      .topbar-grid { display: grid !important; }
      #main-content-wrap { display: block !important; }
    }
  </style>
</head>
<body class="login"> <div id="signin-container">
  <h1 style="font-size:28px;margin-bottom:20px;">車流人流退場情報</h1>
  <div id="signin-btn-wrapper"></div>
  <div id="debug-msg" style="color:red;font-size:12px;margin-top:10px;"></div>
</div>

<nav id="mobile-nav">
  <button class="m-nav-btn active" id="btn-m-status" onclick="switchMobileMode('status')">最新狀態</button>
  <button class="m-nav-btn" onclick="forceRefreshMobile()">立即更新</button>
  <button class="m-nav-btn" id="btn-m-web" onclick="switchMobileMode('web')">網頁版</button>
  <button class="m-nav-btn" onclick="logout()">登出</button>
</nav>

<div id="mobile-status-view">
  <select id="mobile-sheet-select" class="m-select" onchange="onMobileSelectChange()">
    <option value="ALL">▼ 所有車輛</option>
  </select>
  <div id="mobile-cards-container" style="text-align:center;padding:40px;color:#666;">請稍候...</div>
</div>

<div class="wrap">
  <div class="topbar-grid">
    <div class="left-title"><h1 style="margin:0; font-size:24px;">車流人流退場情報</h1></div>
    <div class="right-user">
      <div id="userInfo" style="display:none; align-items:center; gap:10px;">
        <span id="userDisplay" style="font-size:14px;font-weight:bold;"></span>
        <button class="btn btn--secondary" style="padding:4px 10px;font-size:13px;" onclick="logout()">登出</button>
      </div>
    </div>
    <div class="left-tabs">
      <div id="mainTabs" class="main-tabs">
        <button class="main-tab active" data-target="pane-dashboard2">最新狀態</button>
        <button class="main-tab" data-target="pane-single">個別情報</button>
        <button class="main-tab" data-target="pane-punch">登錄與修改</button>
      </div>
    </div>
    <div class="right-refresh">
      <div id="clockDisplay" style="font-weight:900;font-size:20px;">--:--:--</div>
    </div>
  </div>
  <div id="main-content-wrap">
    <div id="pane-dashboard2" class="tab-pane"></div>
    <div id="pane-punch" class="tab-pane hide"></div>
    <div id="pane-single" class="tab-pane hide"></div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client"></script>
<script>
const GOOGLE_CLIENT_ID = '368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxjGHiVKpNMG84OIHIvX4tGYgJ7gksxT0PItegG-7bpSeumnqgMPfwo-1Ocs1l9rMxC/exec';
const SHEET_CONFIGS = [
  { key:'地區專車退場（遊覽車平台）', sheet:'地區專車退場（遊覽車平台）', steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台','車第二次上遊覽車平台','車已離開遊覽車平台']},
  { key:'地區專車退場（禪堂平台）', sheet:'地區專車退場（禪堂平台）', steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','車已離開禪堂平台']},
  { key:'水陸專車退場', sheet:'水陸專車退場', steps:['已 Call 車排車隊','已排好車隊','退場人員已到齊','已 Call 車上遊覽車平台','車已上遊覽車平台','車暫停位置','車已離開遊覽車平台']},
  { key:'288法青退場', sheet:'288法青退場', steps:['退場人員已到齊','車已經上遊覽車平台','車已經離開遊覽車平台']}
];

let idToken = null;
let ALL_SHEETS = {}; 

window.onload = function(){
  // 1. 初始化時鐘
  setInterval(() => {
    document.getElementById('clockDisplay').textContent = new Date().toLocaleTimeString('zh-TW', {hour12:false});
  }, 1000);

  // 2. 初始化下拉選單
  const ms = document.getElementById('mobile-sheet-select');
  ms.innerHTML = ''; 
  SHEET_CONFIGS.forEach(c => {
    let o = document.createElement('option'); o.value = c.key; o.textContent = c.key; ms.appendChild(o);
  });
  ms.value = SHEET_CONFIGS[0].key;

  // 3. 嘗試讀取 Token
  try {
      const saved = localStorage.getItem('ddcc_user_token');
      if(saved) {
        idToken = saved;
        console.log("Found token, verifying...");
        verifyToken(saved); // 驗證 Token
      } else {
        console.log("No token, init signin...");
        initGoogleSignIn(); // 沒 Token，顯示登入鈕
      }
  } catch(e) {
      console.error("LocalStorage Error:", e);
      initGoogleSignIn(); // 出錯也顯示登入鈕
  }
  
  // 4. 介面初始化 (手機/電腦)
  if(window.innerWidth <= 767) {
    switchMobileMode('status');
  } else {
    document.body.classList.add('mode-web');
  }
};

function initGoogleSignIn() {
  document.body.classList.add('login');
  document.getElementById('signin-container').style.display = 'flex';
  try {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredential
      });
      google.accounts.id.renderButton(document.getElementById('signin-btn-wrapper'), { theme:'outline', size:'large' });
  } catch(e) {
      document.getElementById('debug-msg').textContent = "GSI載入失敗，請重新整理";
  }
}

function handleCredential(resp) {
  idToken = resp.credential;
  localStorage.setItem('ddcc_user_token', idToken);
  verifyToken(idToken);
}

async function verifyToken(token) {
  try {
    const r = await fetch(API_BASE + '?action=verify', {
      method:'POST', body:JSON.stringify({idToken: token})
    });
    const j = await r.json();
    if(j.error) throw new Error(j.error);
    
    // 登入成功
    document.body.classList.remove('login');
    document.getElementById('signin-container').style.display = 'none';
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('userDisplay').innerHTML = `${j.name} (${j.permission})`;
    
    // 開始載入資料
    if(window.innerWidth <= 767 && !document.body.classList.contains('mode-web')) {
        onMobileSelectChange();
    } else {
        loadAllSheetsForDesktop();
    }
  } catch(e) {
    console.error("Verify Failed:", e);
    localStorage.removeItem('ddcc_user_token');
    initGoogleSignIn(); // 驗證失敗回登入頁
  }
}

/* 簡易版資料讀取 (確保有畫面) */
async function fetchSingleSheet(targetKey) {
  if(!idToken) return;
  const cfg = SHEET_CONFIGS.find(c => c.key === targetKey);
  try {
    const r = await fetch(`${API_BASE}?action=get&sheet=${encodeURIComponent(cfg.sheet)}&idToken=${encodeURIComponent(idToken)}&_t=${new Date().getTime()}`);
    const j = await r.json();
    if(j.error) { alert(j.error); return; }
    
    const vals = j.values || [];
    // 強力表頭搜尋
    let hIdx = vals.findIndex(r => Array.isArray(r) && r.join('').includes('車號'));
    if(hIdx === -1) hIdx = 0;

    ALL_SHEETS[targetKey] = { cfg, header: vals[hIdx].map(String), rows: vals.slice(hIdx+1), hIdx };
  } catch(e) { console.error(e); }
}

/* 手機版邏輯 */
async function onMobileSelectChange() {
  const key = document.getElementById('mobile-sheet-select').value;
  document.getElementById('mobile-cards-container').innerHTML = '載入中...';
  if(!ALL_SHEETS[key]) await fetchSingleSheet(key);
  renderMobileStats();
}

function renderMobileStats() {
  const container = document.getElementById('mobile-cards-container');
  const key = document.getElementById('mobile-sheet-select').value;
  const data = ALL_SHEETS[key];
  if(!data) { container.innerHTML = '無資料'; return; }

  container.innerHTML = '';
  const { cfg, header, rows } = data;
  const steps = cfg.steps.filter(s => s !== '車暫停位置');
  
  const card = document.createElement('div'); card.className = 'm-card';
  steps.forEach(step => {
    const colIdx = header.indexOf(step);
    let done=0, todo=0;
    if(colIdx!==-1) rows.forEach(r => { const v = r[colIdx]; (v && String(v).trim()!=='—' && String(v).trim()!=='-') ? done++ : todo++; });
    const div = document.createElement('div'); div.className = 'm-stat-row';
    div.innerHTML = `<div class="m-stat-label">${step}</div><div class="m-stat-nums">
      <div class="m-pill"><div class="m-num done">${done}</div><div class="m-sub">完成</div></div>
      <div class="m-pill"><div class="m-num todo">${todo}</div><div class="m-sub">未完成</div></div></div>`;
    card.appendChild(div);
  });
  container.appendChild(card);
}

function switchMobileMode(mode) {
  const btnStatus = document.getElementById('btn-m-status');
  const btnWeb = document.getElementById('btn-m-web');
  if (mode === 'status') {
    document.body.classList.remove('mode-web');
    btnStatus.classList.add('active'); btnWeb.classList.remove('active');
    onMobileSelectChange();
  } else {
    document.body.classList.add('mode-web');
    btnStatus.classList.remove('active'); btnWeb.classList.add('active');
    loadAllSheetsForDesktop();
  }
}

/* 電腦版邏輯 */
async function loadAllSheetsForDesktop() {
  const reqs = SHEET_CONFIGS.map(c => fetchSingleSheet(c.key));
  await Promise.all(reqs);
  // 這裡簡化處理，直接渲染文字證明有載入
  const box = document.getElementById('pane-dashboard2');
  box.innerHTML = '';
  SHEET_CONFIGS.forEach(cfg => {
      const d = ALL_SHEETS[cfg.key];
      if(d) box.innerHTML += `<div class="card" style="padding:20px"><h3>${cfg.key}</h3><p>資料已載入: ${d.rows.length} 筆</p></div>`;
  });
}

function logout() {
  localStorage.removeItem('ddcc_user_token');
  location.reload();
}
function forceRefreshMobile() { onMobileSelectChange(); }
</script>
</body>
</html>
