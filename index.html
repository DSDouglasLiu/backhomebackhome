<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>車流人流退場情報</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
/* =========== Design Tokens（Preferred 版） =========== */
:root{
  /* 半徑 */
  --radius-xs:6px;  --radius-sm:8px;  --radius-md:10px; --radius-lg:12px;

  /* 色票（light） */
  --primary-600:#1f6fe5; --primary-700:#165bd1; --primary-800:#1249ad;
  --success-600:#22c55e; --success-700:#16a34a; --success-800:#15803d;
  --danger-600:#ef4444;  --danger-700:#dc2626;  --danger-800:#b91c1c;
  --gray-50:#f8fafc;  --gray-100:#f1f5f9; --gray-200:#e5e7eb;
  --gray-300:#cbd5e1; --gray-400:#94a3b8; --gray-500:#64748b;
  --gray-600:#475569; --gray-700:#334155; --gray-800:#1f2937; --gray-900:#0f172a;

  --surface: rgba(255,255,255,.78);
  --page-bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
  --text-strong: var(--gray-900);
  --text: var(--gray-800);
  --text-muted: var(--gray-600);
  --border: rgba(148,163,184,0.35);
  --focus:#93c5fd;

  /* 字級（px/line-height, weight） */
  --fz-display:28px; --lh-display:36px; --fw-display:700;  /* 頁面大標題 */
  --fz-title:18px;   --lh-title:24px;   --fw-title:700;   /* 卡片主標 */
  --fz-sub:14px;     --lh-sub:20px;     --fw-sub:600;     /* 車牌/副標 */
  --fz-label:14px;   --lh-label:20px;   --fw-label:600;   /* 步驟/表頭 */
  --fz-body:14px;    --lh-body:20px;    --fw-body:400;    /* 內文/按鈕 */
  --fz-note:12px;    --lh-note:16px;    --fw-note:400;    /* 備註提示 */

  --shadow-card:0 8px 24px rgba(0,0,0,.08);
}
body.dark{
  --surface: rgba(15,23,42,.55);
  --page-bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
  --text-strong:#e5eaf3; --text:#e2e8f0; --text-muted:#93a3b5;
  --border: rgba(148,163,184,0.25);
  --shadow-card:0 8px 24px rgba(0,0,0,.35);
}

/* =========== Base =========== */
body{
  margin:0; min-height:100vh;
  background:var(--page-bg); color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;
}
.wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
h1{margin:0 0 16px;font-size:var(--fz-display);line-height:var(--lh-display);font-weight:var(--fw-display);color:var(--text-strong);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-card);padding:16px;margin:12px 0;}
.hide{display:none;}

/* =========== Segmented Tabs（上方工作表） =========== */
.sheet-tabs{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }
.tab,.btn-tab{
  background:#fff;color:var(--primary-600);
  border:1px solid var(--primary-600);border-radius:var(--radius-lg);
  padding:6px 18px;font-size:var(--fz-body);font-weight:600;cursor:pointer;min-width:170px;text-align:center;
}
body.dark .tab, body.dark .btn-tab{background:transparent}
.tab:hover,.btn-tab:hover{background:rgba(31,111,229,.06)}
.tab.active,.btn-tab.active{background:var(--primary-600);color:#fff;border-color:var(--primary-600)}
.tab:focus-visible,.btn-tab:focus-visible{outline:2px solid var(--focus);outline-offset:2px}

/* ======= 新增：上方時鐘 + 更新頻率 ======= */
.refresh-bar{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin:4px 0 6px; }
.clock{ font-weight:900; letter-spacing:.5px; font-variant-numeric: tabular-nums; }
.seg-group{ display:flex; gap:8px; flex-wrap:wrap; }
.seg-btn{
  background:#fff; color:var(--primary-600);
  border:1px solid var(--primary-600); border-radius:var(--radius-lg);
  padding:6px 14px; font-size:var(--fz-body); font-weight:700; cursor:pointer; min-width:72px; text-align:center;
}
body.dark .seg-btn{ background:transparent; }
.seg-btn:hover{ background:rgba(31,111,229,.06); }
.seg-btn.active{ background:var(--primary-600); color:#fff; border-color:var(--primary-600); }
.seg-btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }
.seg-btn[disabled]{ cursor:not-allowed; }

/* =========== 原「登錄」頁卡片 =========== */
.veh-list{display:grid;grid-template-columns:repeat(auto-fit, minmax(480px,1fr));gap:12px;margin-top:16px;}
.veh-card{background:rgba(255,255,255,0.85);border-radius:var(--radius-lg);border:1px solid var(--border);padding:14px 14px 10px;display:flex;flex-direction:column;gap:10px;}
body.dark .veh-card{background:rgba(15,23,42,0.28);}
.veh-title-main{font-weight:700;font-size:var(--fz-title);line-height:var(--lh-title);color:var(--text-strong);}
.veh-title-sub{font-size:var(--fz-sub);line-height:var(--lh-sub);color:var(--text-muted);}
.step-row{display:grid;grid-template-columns:180px 1fr auto;align-items:center;gap:10px;margin-bottom:6px;}
.step-time{font-size:var(--fz-label);line-height:var(--lh-label);font-weight:600;color:rgba(15,23,42,.75);text-align:right;min-width:70px;font-feature-settings:"tnum" 1, "lnum" 1; font-variant-numeric:tabular-nums lining-nums;}
body.dark .step-time{color:#cbd5e1}
.step-select{min-width:170px;padding:6px 8px;border-radius:var(--radius-sm);border:1px solid var(--border);background:#fff;font-size:var(--fz-body);}
.step-select:disabled{background:#e2e8f0;cursor:not-allowed;}
.textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;background:#fff;font-size:var(--fz-body);}
.textarea:focus-visible{outline:2px solid var(--focus);outline-offset:2px}

/* =========== Buttons =========== */
.btn,.step-btn{
  border:0;border-radius:var(--radius-md);padding:8px 14px;
  background:#0f6efc;color:#fff;font-size:var(--fz-body);font-weight:600;cursor:pointer;
  transition:background-color .12s ease,border-color .12s ease,filter .12s ease;
  min-width:64px;text-align:center;
}
.btn--sm{padding:6px 12px}
.btn--lg{padding:10px 18px;font-size:15px}
.btn:focus-visible,.step-btn:focus-visible{outline:2px solid var(--focus);outline-offset:2px;}
.btn[disabled],.step-btn[disabled]{background:var(--gray-300)!important;color:var(--gray-700)!important;cursor:not-allowed}
.btn--primary{background:var(--primary-600);} .btn--primary:hover{background:var(--primary-700);} .btn--primary:active{background:var(--primary-800);}
.btn--success{background:var(--success-600);} .btn--success:hover{background:var(--success-700);} .btn--success:active{background:var(--success-800);}
.btn--danger{background:var(--danger-600);}  .btn--danger:hover{background:var(--danger-700);}  .btn--danger:active{background:var(--danger-800);}
.btn--secondary{background:#fff;color:var(--primary-600);border:1px solid var(--primary-600);} 
body.dark .btn--secondary{background:transparent}
.btn--secondary:hover{background:rgba(31,111,229,.06)}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}

/* 通知 & Modal & Loading（原本） */
.notif{position:fixed;right:16px;bottom:16px;background:rgba(15,23,42,.85);color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transform:translateY(20px);transition:.2s;z-index:9990;}
.notif.show{opacity:1;transform:translateY(0);}
.modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: block; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 16px; border-radius: 12px; min-width: 280px; max-width: 90vw; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 10001; display: block; }
body.dark .modal{ background:#0b1325; color:#e2e8f0 }
.modal h3{ margin:0 0 10px; font-size:16px }
.modal .row{ display:flex; gap:8px; align-items:center; margin:8px 0 }
.modal input{ width:56px; padding:6px 8px; border:1px solid var(--border); border-radius:8px }
.modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
.modal .time-edit{ display:flex; align-items:center; justify-content:center; gap:10px; margin:8px 0 4px; }
.modal .time-input{ width:64px; text-align:center; padding:6px 8px; border:1px solid var(--border); border-radius:10px; font-weight:600; }
.modal .colon{ font-size:20px; line-height:1; opacity:.5; margin:0 2px; user-select:none; }
.modal .hint{ font-size:.9rem; line-height:1.6; opacity:.8; margin:2px 0; }
body.modal-open{ overflow:hidden; touch-action:none; }

/* Loading Overlay */
#loading.loading{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 2147483000; }
#loading.loading.show{ display: flex; }
.loading-box{ display:flex; align-items:center; gap:10px; background: var(--surface); color: var(--text); border:1px solid var(--border); border-radius:12px; padding:12px 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); backdrop-filter: blur(8px); }
.spinner{ width:20px; height:20px; border-radius:50%; border:2.5px solid #cbd5e1; border-top-color: var(--primary-600); animation: spin 1s linear infinite; }
@keyframes spin{ to{ transform: rotate(360deg); } }
@media (prefers-reduced-motion: reduce){ .spinner{ animation: none; border-top-color:#cbd5e1; } }
body.loading-open{ overflow:hidden; touch-action:none; overscroll-behavior: contain; }
@supports (height: 100dvh){ .modal-backdrop{ height: 100dvh; } }

/* ===== 登入畫面置中 ===== */
body.login .wrap{ min-height: 100dvh; display: grid; place-items: center; padding: 24px 16px; }
body.login .wrap > div:first-child{ display: grid !important; grid-auto-flow: row; gap: 16px; justify-items: center; text-align: center; width: 100%; }
body.login h1{ margin: 0; text-align: center; font-size: clamp(28px, 6vw, 56px); line-height: 1.2; }
body.login #tabs, body.login #content, body.login #userInfo{ display: none !important; }

/* 更完整的登入畫面（保持原設定） */
body.login{ height: 100dvh; overflow: hidden; }
body.login .wrap{ height: 100%; max-width: 1080px; margin: 0 auto; padding: 0 16px; display: grid; place-items: center; }
body.login .wrap > div:first-child{ display: flex !important; flex-direction: column; align-items: center; justify-content: center; gap: clamp(20px, 5vh, 100px); width: 100%; text-align: center; }
body.login h1{ margin: 0; text-align: center; font-size: clamp(36px, 8vw, 64px); line-height: 1.15; }
body.login #tabs, body.login #content, body.login #userInfo{ display: none !important; }
body.login #signin{ display: block; }
#logoutBtn { white-space: nowrap; }
#logoutBtn:hover { background:rgba(239,68,68,.1) !important; }  

/* ===== 頂層三頁 Tab ===== */
.main-tabs{ display:flex; gap:12px; margin:6px 0 8px; flex-wrap:wrap; }
.main-tab{ background:#fff; color:var(--primary-600); border:1px solid var(--primary-600); border-radius:var(--radius-lg); padding:8px 20px; font-size:15px; font-weight:700; cursor:pointer; min-width:120px; text-align:center; }
body.dark .main-tab{ background:transparent; }
.main-tab:hover{ background:rgba(31,111,229,.06) }
.main-tab.active{ background:var(--primary-600); color:#fff }
.tab-pane{ margin-top:8px; }
body.login #mainTabs{ display:none !important; }

/* ======= 新增：整體情報（儀表板）樣式 ======= */
.dash-section{ margin:16px 0 24px; }
.dash-title{ font-size:18px; font-weight:800; color:var(--text-strong); margin:0 0 8px; }
.stat-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:12px; }
.stat-card{ border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.9); padding:12px; box-shadow:var(--shadow-card); }
body.dark .stat-card{ background:rgba(15,23,42,.30); }
.stat-head{ font-weight:800; margin-bottom:8px; color:var(--text-strong); }
.stat-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat-pill{ border:1px solid var(--border); border-radius:10px; padding:10px 8px; background:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; }
body.dark .stat-pill{ background:rgba(2,6,23,.5); }
.stat-pill:hover{ filter:brightness(1.02); }
.stat-num{ font-size:26px; font-weight:800; line-height:1; }
.stat-num.done{ color:#2563eb; }
.stat-num.todo{ color:#ef4444; }
.stat-label{ font-size:12px; color:var(--text-muted); margin-top:4px; }

/* 停車位置卡片（單欄寬） */
.loc-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:10px; margin-top:8px; }
.loc-pill{ border:1px dashed var(--border); border-radius:12px; padding:10px; background:rgba(255,255,255,.85); display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer; }
body.dark .loc-pill{ background:rgba(15,23,42,.28); }
.loc-name{ font-weight:700; }
.loc-num{ font-size:22px; font-weight:900; color:#2563eb; }

/* 清單／詳情彈窗內部 */
.modal .dash-close{ position:absolute; right:10px; top:8px; font-size:22px; line-height:1; cursor:pointer; opacity:.7; }
.modal .dash-close:hover{ opacity:1; }
.list-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px dashed var(--border); }
.list-left{ display:flex; flex-direction:column; gap:2px; }
.list-title{ font-weight:800; }
.list-sub{ font-size:13px; opacity:.85; }
.detail-table{ width:100%; border-collapse:collapse; }
.detail-table th, .detail-table td{ border:1px solid var(--border); padding:8px 10px; text-align:center; }
.detail-table th{ background:#0f172a; color:#fff; }

/* RWD */
@media(max-width:768px){
  .veh-list{ grid-template-columns:1fr; }
  .sheet-tabs{ gap:10px; }
}
@media (max-width:480px){
  .modal .time-input{ width:56px; }
}
/* ====== 頂部兩欄排版（標題/分頁 ←→ 使用者/時鐘+更新） ====== */
.topbar-grid{
  display:grid;
  grid-template-columns: 1fr auto;   /* 左寬右窄 */
  grid-template-rows: auto auto;     /* 上：標題/使用者，下：分頁/時鐘 */
  gap:6px 12px;
  align-items:center;
}
.topbar-grid .left-title{ grid-area: 1 / 1 / 2 / 2; }
.topbar-grid .left-tabs{  grid-area: 2 / 1 / 3 / 2; }
.topbar-grid .right-user{
  grid-area: 1 / 2 / 2 / 3;
  display:flex; align-items:center; gap:12px; justify-content:flex-end;
}
.topbar-grid .right-refresh{ grid-area: 2 / 2 / 3 / 3; }

/* 讓時鐘與頻率鈕靠右，間距更緊一些 */
.refresh-bar{ margin:0; display:flex; gap:8px; align-items:center; justify-content:flex-end; }
.clock{ font-weight:800; font-variant-numeric: tabular-nums; letter-spacing:.5px; }

/* 登入頁不顯示右側的更新列 */
body.login .right-refresh{ display:none !important; }

/* 手機時改為直排 */
@media (max-width: 768px){
  .topbar-grid{
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto auto;
  }
  .topbar-grid .right-user,
  .topbar-grid .right-refresh{ justify-content:flex-start; }
}
/* 讓對話框不會超出可視高度，必要時內容自動滾動 */
.modal{
  max-height: calc(100dvh - 48px);
  overflow: auto;
}
@supports not (height: 100dvh){
  .modal{ max-height: 90vh; } /* 舊瀏覽器後備 */
}
/* 讓對話框不會超出可視高度，必要時內容自動滾動 */
.modal{
  max-height: calc(100dvh - 48px);
  overflow: auto;
}
@supports not (height: 100dvh){
  .modal{ max-height: 90vh; } /* 舊瀏覽器後備 */
}
/* ── 對話框加寬 + 預留關閉鈕空間 ── */
.modal{
  /* 原本就有 padding:16px; 這裡多預留右側空間避免文字被 ✕ 蓋住 */
  padding-right: 44px !important;
  max-width: 96vw !important;           /* 90vw -> 96vw 再寬一些 */
  border-radius: 12px;
}

/* 標題元素本身也預留右側空間（避免個別 h3 超過） */
.modal h3{ padding-right: 28px; }

/* 關閉鈕位置微調，與邊緣留點呼吸 */
.modal .dash-close{ right: 12px; top: 10px; }

/* 詳細資料表格的標題列改成站內主色系 */
.detail-table th{
  background: var(--primary-700) !important;  /* #165bd1 */
  color:#fff;
}
body.dark .detail-table th{
  background: var(--primary-600) !important;  /* #1f6fe5 在深色背景看更清楚 */
}

/* 表格邊線使用站內邊框色，整體更一致 */
.detail-table, .detail-table th, .detail-table td{
  border-color: var(--border);
}
.detail-table thead th:first-child{ border-top-left-radius:10px; }
.detail-table thead th:last-child{  border-top-right-radius:10px; }
  
</style>
</head>
<body>
<div class="wrap">
  <!-- 兩列兩欄的頂部排版 -->
  <div class="topbar-grid">
    <!-- 左上：標題 -->
    <div class="left-title">
      <h1>車流人流退場情報</h1>
    </div>

    <!-- 右上：登入資訊 -->
    <div class="right-user">
      <div id="signin"></div>
      <div id="userInfo" class="hide" style="display:flex; align-items:center; gap:12px; font-size:.875rem;">
        <span id="userDisplay"></span>
        <button id="logoutBtn" class="btn btn--secondary btn--sm" style="padding:6px 12px;">登出</button>
      </div>
    </div>

    <!-- 左下：三個主頁籤 -->
    <div class="left-tabs">
      <div id="mainTabs" class="main-tabs">
        <button class="main-tab active" data-target="pane-punch">登錄</button>
        <button class="main-tab" data-target="pane-dashboard">整體情報</button>
        <button class="main-tab" data-target="pane-single">個別情報</button>
      </div>
    </div>

    <!-- 右下：時鐘 + 自動更新頻率 -->
    <div class="right-refresh">
      <div class="refresh-bar">
        <div class="clock" id="clockDisplay" aria-live="polite">--:--:--</div>
        <div class="seg-group" id="refreshControls"></div>
      </div>
    </div>
  </div>

  <!-- 第 1 頁：沿用（打卡 + 車卡） -->
  <div id="pane-punch" class="tab-pane">
    <div id="tabs" class="card hide" style="padding-bottom:6px;">
      <div class="sheet-tabs" id="sheetTabs"></div>
    </div>
    <div id="content" class="hide">
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <!-- 第 2 頁：整體情報 -->
  <div id="pane-dashboard" class="tab-pane hide">
    <div id="dashboard"></div>
  </div>

  <!-- 第 3 頁：個別情報 -->
  <div id="pane-single" class="tab-pane hide">
    <div class="card" style="min-height:360px;display:flex;align-items:center;justify-content:center;">
      （個別情報頁：之後再補）
    </div>
  </div>
</div>

<div id="notif" class="notif"></div>

<!-- 全螢幕 Loading Overlay -->
<div id="loading" class="loading" role="status" aria-live="polite" aria-busy="true">
  <div class="loading-box">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text">處理中…</div>
  </div>
</div>
  

<script>
const GOOGLE_CLIENT_ID = '368914333961-504cujbloe9n3v28p4bjsc8c1lh5pg0o.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxbeknXeJ2s2NnIqTwIwNdZnsbiI9UlGkQpSGfHq2TlmnITZ75Ub4ySwn6UGmJk3AXjNg/exec';

/* 停車位置選單 */
const STOP_OPTIONS = [
  '禪堂平台','法心北路','法心南路（西）','法心南路（東）','法大路','雙環路到三門','三門到大停車場','靈山勝境石往外','雙環路至法大一橋'
];

/* 四個工作表 */
const SHEET_CONFIGS = [
  { key:'地區專車退場（遊覽車平台）', sheet:'地區專車退場（遊覽車平台）', steps:[
    '車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置',
    '退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台','車第二次上遊覽車平台','車已離開遊覽車平台'
  ]},
  { key:'地區專車退場（禪堂平台）', sheet:'地區專車退場（禪堂平台）', steps:[
    '車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','車已離開禪堂平台'
  ]},
  { key:'水陸專車退場', sheet:'水陸專車退場', steps:[
    '已 Call 車排車隊','已排好車隊','退場人員已到齊','已 Call 車上遊覽車平台','車已上遊覽車平台','車暫停位置','車已離開遊覽車平台'
  ]},
  { key:'288法青退場', sheet:'288法青退場', steps:[
    '退場人員已到齊','車已經上遊覽車平台','車已經離開遊覽車平台'
  ]}
];

/* ===== 新增：時鐘 + 自動更新頻率設定 ===== */
const REFRESH_PRESETS = [
  { label:'5分',  ms: 5*60*1000 },
  { label:'2分',  ms: 2*60*1000 },
  { label:'60秒', ms: 60*1000 },
  { label:'30秒', ms: 30*1000 }
];
const REFRESH_STORAGE_KEY = 'dash_refresh_ms';
let refreshMs = parseInt(localStorage.getItem(REFRESH_STORAGE_KEY) || '', 10);
if (!Number.isFinite(refreshMs) || refreshMs <= 0) refreshMs = 30*1000; // 預設 30 秒

/* 原本的 dashboard 計時器 */
let dashTimer = null;

let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = []; // 打卡頁使用
const TOKEN_STORAGE_KEY = 'ddcc_user_token';
let idToken = null;

/* ---------------- 初始登入與頁籤 ---------------- */
window.onload = function(){
  // 啟動時鐘 & 建立更新頻率控制列
  startClock();
  buildRefreshControls();

  const saved = localStorage.getItem(TOKEN_STORAGE_KEY);
  if (saved) {
    idToken = saved;
    fetch(API_BASE + '?action=verify', { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ idToken })})
    .then(r=>r.json())
    .then(j=>{
      if (j.error) throw new Error(j.error);
      currentUser = j;
      finishLoginUI();
      buildTabs();
      loadSheetData(currentSheetKey);
    }).catch(()=>{
      logout();
      initGoogleSignIn();
    });
  } else {
    initGoogleSignIn();
  }
  document.getElementById('logoutBtn').addEventListener('click', logout);
};

/* ===== 時鐘（時區 +8、hh:mm:ss） ===== */
function getTaipeiHHMMSS(){ return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date()); }
function startClock(){
  const el = document.getElementById('clockDisplay');
  const tick = ()=>{ if (el) el.textContent = getTaipeiHHMMSS(); };
  tick();
  setInterval(tick, 1000);
}

/* ===== 自動更新頻率控制列 ===== */
function buildRefreshControls(){
  const box = document.getElementById('refreshControls');
  if (!box) return;
  box.innerHTML = '';

  // 頻率按鈕
  REFRESH_PRESETS.forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'seg-btn';
    btn.textContent = p.label;
    btn.dataset.ms = String(p.ms);
    if (p.ms === refreshMs){
      btn.classList.add('active');
      btn.disabled = true; // 當前選擇：不可按、變色
    }
    btn.onclick = ()=> openRefreshSaveDialog(p.ms, p.label);
    box.appendChild(btn);
  });

  // 立即更新
  const nowBtn = document.createElement('button');
  nowBtn.className = 'seg-btn';
  nowBtn.textContent = '立即更新';
  nowBtn.title = '立刻重新整理整體情報';
  nowBtn.onclick = ()=> {
    if (isDashboardVisible()) buildDashboard(false);
    else showNotif('切到「整體情報」即可看到最新資料', false);
  };
  box.appendChild(nowBtn);
}

function openRefreshSaveDialog(ms, label){
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3>儲存自動更新頻率</h3>
    <div class="modal-msg" style="font-size:15px;line-height:1.7;margin:6px 0 10px;">
      將自動更新頻率設定為 <b>${label}</b>。按「儲存」後即刻生效。
    </div>
    <div class="actions">
      <button class="btn" style="background:#e5e7eb;color:#111827;">取消</button>
      <button class="btn btn--primary">儲存</button>
    </div>
  `;
  const close = openModal(box);
  const [btnCancel, btnOK] = box.querySelectorAll('button');
  btnCancel.onclick = close;
  btnOK.onclick = ()=>{
    try{
      refreshMs = ms;
      localStorage.setItem(REFRESH_STORAGE_KEY, String(refreshMs));
      updateRefreshButtonsUI();
      if (isDashboardVisible()){
        startDashboardAutoRefresh();     // 重啟定時（新頻率）
      }
      showNotif(`已設定為每 ${label} 自動更新`, false);
    } finally{ close(); }
  };
}

function updateRefreshButtonsUI(){
  const btns = document.querySelectorAll('#refreshControls .seg-btn');
  btns.forEach(btn=>{
    if (btn.textContent === '立即更新') return; // 永遠不變色
    const ms = parseInt(btn.dataset.ms||'0',10);
    const isActive = (ms === refreshMs);
    btn.classList.toggle('active', isActive);
    btn.disabled = isActive;
  });
}

/* ---------------- Google Sign-In（原） ---------------- */
function initGoogleSignIn() {
  document.body.classList.add('login');
  google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredential });
  google.accounts.id.renderButton(document.getElementById('signin'), { theme:'outline', size:'large' });
  buildTabs();
}
function buildTabs(){
  const box = document.getElementById('sheetTabs');
  box.innerHTML = '';
  if (!SHEET_CONFIGS.length) return;

  const prevKey = currentSheetKey;
  if (!SHEET_CONFIGS.some(s => s.key === currentSheetKey)) currentSheetKey = SHEET_CONFIGS[0].key;
  const keyChanged = (prevKey !== currentSheetKey);

  SHEET_CONFIGS.forEach(cfg => {
    const btn = document.createElement('button');
    btn.className = 'btn-tab tab' + (cfg.key === currentSheetKey ? ' active' : '');
    btn.textContent = cfg.key;
    btn.onclick = () => {
      currentSheetKey = cfg.key;
      box.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      loadSheetData(currentSheetKey);
    };
    box.appendChild(btn);
  });

  const contentShown = !document.getElementById('content').classList.contains('hide');
  if (keyChanged && contentShown) loadSheetData(currentSheetKey);
}
async function handleCredential(resp) {
  idToken = resp.credential;
  localStorage.setItem(TOKEN_STORAGE_KEY, idToken);
  try {
    const r = await fetch(API_BASE + '?action=verify', { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify({ idToken }) });
    const j = await r.json(); if (j.error) throw new Error(j.error);
    currentUser = j; finishLoginUI(); loadSheetData(currentSheetKey);
  } catch (err) { showNotif('登入失敗：' + err.message, true); logout(); }
}
function finishLoginUI() {
  document.body.classList.remove('login');
  document.getElementById('signin').classList.add('hide');
  const ui = document.getElementById('userInfo'); ui.classList.remove('hide');
  document.getElementById('userDisplay').innerHTML = `${currentUser.name||''} &lt;${currentUser.email}&gt; ｜ 權限：<b>${currentUser.permission}</b>`;
  document.getElementById('tabs').classList.remove('hide');
  document.getElementById('content').classList.remove('hide');
  if (currentUser.permission === '檢視') showNotif('目前為「檢視」權限：所有按鈕與下拉皆為唯讀', false);
}
function logout() {
  localStorage.removeItem(TOKEN_STORAGE_KEY); idToken = null; currentUser = null;
  const signinDiv = document.getElementById('signin'); signinDiv.innerHTML = '';
  google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredential });
  google.accounts.id.renderButton(signinDiv, { theme:'outline', size:'large' });
  document.body.classList.add('login');
  document.getElementById('userInfo').classList.add('hide');
  document.getElementById('tabs').classList.add('hide');
  document.getElementById('content').classList.add('hide');
  showNotif('已登出', false);
}

/* ---------------- 工具 ---------------- */
function formatSheetTime(val){
  if (!val) return '';
  const s = String(val).trim();
  if (/^\d{1,2}:\d{2}:\d{2}$/.test(s)) return s.split(':').map(p=>p.padStart(2,'0')).join(':');
  if (/^\d{4}\/\d{1,2}\/\d{1,2} \d{1,2}:\d{2}:\d{2}$/.test(s)) return s.split(' ')[1].split(':').map(p=>p.padStart(2,'0')).join(':');
  const m = s.match(/^(上午|下午)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (m){ let h=+m[2]; const mm=m[3], ss=m[4]||'00'; if (m[1]==='下午'&&h<12) h+=12; if (m[1]==='上午'&&h===12) h=0; return `${String(h).padStart(2,'0')}:${mm}:${ss}`;}
  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(s)){ const d=new Date(s); const tw=new Date(d.getTime()+8*3600*1000); const hh=String(tw.getUTCHours()).padStart(2,'0'); const mm=String(tw.getUTCMinutes()).padStart(2,'0'); const ss=String(tw.getUTCSeconds()).padStart(2,'0'); return `${hh}:${mm}:${ss}`;}
  return s;
}
const pad2 = n => String(n).padStart(2,'0');
const splitHMS = v => { const s=String(v||'').trim(); const m=s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/); return m?[pad2(m[1]),m[2],m[3]?m[3]:'00']:['','','']; };
const isValidHMS = (h,m,s) => (/^\d{2}$/.test(h)&&/^\d{2}$/.test(m)&&/^\d{2}$/.test(s) && +h<=23 && +m<=59 && +s<=59);
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
function showLoading(msg='處理中…'){ const el=document.getElementById('loading'); if(!el) return; const t=el.querySelector('.loading-text'); if(t) t.textContent=msg; el.classList.add('show'); document.body.classList.add('loading-open'); }
function hideLoading(){ const el=document.getElementById('loading'); if(!el) return; el.classList.remove('show'); document.body.classList.remove('loading-open'); }
async function withLoading(fn,msg='處理中…'){ showLoading(msg); try{ return await fn(); } finally{ hideLoading(); } }
function showNotif(msg,isErr){ const box=document.getElementById('notif'); box.textContent=msg; box.style.background=isErr?'rgba(248,113,113,.9)':'rgba(15,23,42,.85)'; box.classList.add('show'); setTimeout(()=>box.classList.remove('show'), 2500); }

/* Modal：覆蓋頁 */
function closeAllModals(){ document.querySelectorAll('.modal, .modal-backdrop').forEach(el=>{ try{el.remove()}catch{} }); document.body.classList.remove('modal-open'); }
function openModal(element){
  const MAX_Z = 2147483647; // 最高層
  const layer = document.createElement('div');

  // 全螢幕覆蓋層：固定在可視區、置中顯示
  Object.assign(layer.style, {
    position:'fixed',
    inset:'0',
    width:'100vw',
    height:'100vh',
    background:'rgba(0,0,0,.45)',
    zIndex: String(MAX_Z),
    display:'grid',
    placeItems:'center'
  });

  // 對話框本體：使用相對定位、限制最大尺寸
  element.classList.add('modal');
  Object.assign(element.style, {
    position:'relative',
    top:'auto',
    left:'auto',
    transform:'none',
    margin:'0',
    maxWidth:'min(1280px,96vw)'
    maxHeight:'min(86dvh, 640px)',
    overflow:'auto'
  });

  // 插入 DOM
  layer.appendChild(element);
  document.body.appendChild(layer);
  document.body.classList.add('modal-open');

  // 針對行動裝置鍵盤/動態視口：跟隨 VisualViewport
  function syncToVisualViewport(){
    const vv = window.visualViewport;
    if(!vv) return;
    layer.style.width  = vv.width + 'px';
    layer.style.height = vv.height + 'px';
    layer.style.left   = vv.offsetLeft + 'px';
    layer.style.top    = vv.offsetTop + 'px';
  }
  if (window.visualViewport){
    syncToVisualViewport();
    window.visualViewport.addEventListener('resize', syncToVisualViewport);
    window.visualViewport.addEventListener('scroll', syncToVisualViewport);
  }

  // Esc 關閉
  const onEsc = e => { if (e.key === 'Escape') cleanup(); };
  document.addEventListener('keydown', onEsc);

  function cleanup(){
    document.body.classList.remove('modal-open');
    document.removeEventListener('keydown', onEsc);
    if (window.visualViewport){
      window.visualViewport.removeEventListener('resize', syncToVisualViewport);
      window.visualViewport.removeEventListener('scroll', syncToVisualViewport);
    }
    try{ layer.remove(); }catch{}
  }
  return cleanup;
}



/* ---------------- 打卡頁：載入資料 & 渲染（原本） ---------------- */
async function loadSheetData(key){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  document.getElementById('vehList').textContent = '讀取中...';
  const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
  const j = await r.json();
  if (j.error){ document.getElementById('vehList').textContent = '❌ '+j.error; return; }
  sheetData = j.values || [];
  renderVehicles(cfg, sheetData);
}
function isCompletedValue(v){ if (v==null) return false; const s=String(v).trim(); return !!s && s!=='—' && s!=='-'; }

/* ====== 打卡頁 renderVehicles（原樣） ====== */
function renderVehicles(cfg, data) {
  const box = document.getElementById('vehList'); box.innerHTML = '';
  const canWrite = currentUser?.permission === '全功能';
  const headerRowIdx = data.findIndex(row => Array.isArray(row) && String(row[0]||'').trim()==='編號' && String(row[1]||'').trim().startsWith('區域') && String(row[2]||'').trim()==='車號');
  if (headerRowIdx === -1){ box.textContent='找不到表頭'; return; }
  const header = data[headerRowIdx].map(c=>String(c||'').trim());
  const rows = data.slice(headerRowIdx+1).filter(r => Array.isArray(r) && String(r[0]||'').trim() && String(r[1]||'').trim() && String(r[2]||'').trim());
  if (!rows.length){ box.textContent='(這張表目前沒有車輛資料)'; return; }

  const cards=[];
  rows.forEach((row, idx) => {
    const area=String(row[1]||'').trim(); const car=String(row[2]||'').trim(); const baseRow = headerRowIdx+2+idx;
    const {completed,total} = computeCompletion(cfg, header, row);
    const card = document.createElement('div'); card.className='veh-card';
    card.innerHTML = `<div><div class="veh-title-main">${area}</div><div class="veh-title-sub">${car}</div></div>`;
    const stepsBox=document.createElement('div');

    cfg.steps.forEach(st=>{
      const colIdx=header.indexOf(st);
      const rawVal = (colIdx!==-1 && row[colIdx]!=null) ? String(row[colIdx]).trim(): '';
      const displayVal = rawVal?formatSheetTime(rawVal):'';
      const rowEl=document.createElement('div'); rowEl.className='step-row';
      const labelEl=document.createElement('div'); labelEl.className='step-label'; labelEl.textContent=st; rowEl.appendChild(labelEl);

      if (st==='車暫停位置'){
        const valueEl=document.createElement('div');
        const sel=document.createElement('select'); sel.className='step-select select';
        const optEmpty=document.createElement('option'); optEmpty.value=''; optEmpty.textContent='— 請選擇 —'; sel.appendChild(optEmpty);
        STOP_OPTIONS.forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; sel.appendChild(o); });
        if (rawVal) sel.value=rawVal;
        const ghost=document.createElement('span'); ghost.style.display='none';
        valueEl.appendChild(sel); valueEl.appendChild(ghost); rowEl.appendChild(valueEl);
        const btnG=document.createElement('div'); btnG.className='btn-group'; rowEl.appendChild(btnG);
        if (!canWrite){ sel.disabled=true; rowEl.classList.add('locked'); }
        else {
          const prevOk=prevDone(cfg, header, row, st); if (!prevOk && !rawVal) sel.disabled=true;
          sel.onchange=()=>onStopSelect(cfg, baseRow, header, st, sel.value, ghost);
        }
        stepsBox.appendChild(rowEl); return;
      }

      const timeSpan=document.createElement('span'); timeSpan.className='step-time'; timeSpan.textContent=displayVal||'—'; rowEl.appendChild(timeSpan);
      const btnG=document.createElement('div'); btnG.className='btn-group';
      const btnPunch=document.createElement('button'); btnPunch.className='btn btn--primary btn--sm btn-punch'; btnPunch.textContent='打卡';
      const btnEdit=document.createElement('button'); btnEdit.className='btn btn--success btn--sm btn-edit'; btnEdit.textContent='修改';
      const btnDel=document.createElement('button'); btnDel.className='btn btn--danger btn--sm btn-del'; btnDel.textContent='刪除';
      btnG.appendChild(btnPunch); btnG.appendChild(btnEdit); btnG.appendChild(btnDel); rowEl.appendChild(btnG);

      if (!canWrite){ btnPunch.disabled=btnEdit.disabled=btnDel.disabled=true; rowEl.classList.add('locked'); }
      else{
        const prevOk=prevDone(cfg, header, row, st); const hasVal=!!rawVal;
        if (!prevOk && !hasVal){ btnPunch.disabled=btnEdit.disabled=btnDel.disabled=true; }
        else{
          btnPunch.disabled=hasVal; btnEdit.disabled=btnDel.disabled=!hasVal;
          btnPunch.onclick=()=>onPunchClick(cfg, baseRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl);
          btnEdit.onclick =()=>onEditTimeClick(cfg, baseRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl, displayVal);
          btnDel.onclick  =()=>onDeleteTimeClick(cfg, baseRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl);
        }
      }
      stepsBox.appendChild(rowEl);
    });

    card.appendChild(stepsBox);

    // 備註
    const memoWrap=document.createElement('div'); memoWrap.style.marginTop='8px';
    const memoRow=document.createElement('div'); memoRow.style.cssText='display:flex;gap:8px;align-items:flex-start;';
    const memoTA=document.createElement('textarea'); memoTA.className='textarea'; memoTA.placeholder='備註'; memoTA.style.flex='1';
    let memoColIdx=header.indexOf('備註'); if (memoColIdx===-1) memoColIdx=header.length-1;
    memoTA.value=(memoColIdx!==-1 && row[memoColIdx]) ? String(row[memoColIdx]):'';
    const memoBtn=document.createElement('button'); memoBtn.className='btn btn--primary'; memoBtn.textContent='儲存'; memoBtn.disabled=!canWrite;
    memoBtn.onclick=async()=>{ if(!canWrite) return; await withLoading(async()=>{
      const body={sheet:cfg.sheet, email:currentUser.email, writes:[{row:baseRow,col:memoColIdx+1,value:memoTA.value}]};
      const r=await fetch(API_BASE+'?action=update',{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(body)});
      const j=await r.json(); if(!j.ok) throw new Error(j.error||'unknown'); await sleep(250); await reloadSheet();
    },'儲存備註…'); showNotif('備註已儲存',false); };
    memoRow.appendChild(memoTA); memoRow.appendChild(memoBtn); memoWrap.appendChild(memoRow); card.appendChild(memoWrap);

    cards.push({ el:card, completed, total, origOrder:idx });
  });

  cards.sort((a,b)=> (a.completed!==b.completed ? a.completed-b.completed : a.origOrder-b.origOrder));
  cards.forEach(c=>box.appendChild(c.el));
}
function prevDone(cfg, header, row, st){ const idx=cfg.steps.indexOf(st); if (idx===0) return true; const prev=cfg.steps[idx-1]; const col=header.indexOf(prev); if (col===-1) return true; return !!row[col]; }
async function onStopSelect(cfg,rowNumber,header,st,value,span){
  if (!currentUser) return alert('請先登入'); if (currentUser.permission!=='全功能') return alert('權限不足');
  const colIdx=header.indexOf(st); if (colIdx===-1) return alert('此欄位不存在：'+st);
  await withLoading(async()=>{
    const body={sheet:cfg.sheet,email:currentUser.email,writes:[{row:rowNumber,col:colIdx+1,value}]};
    const r=await fetch(API_BASE+'?action=update',{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(body)});
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'unknown'); await sleep(200); await reloadSheet();
  },'更新中…'); span.textContent=value||''; showNotif(value?'已更新車暫停位置':'已清除車暫停位置',false);
}
async function onPunchClick(cfg,rowNumber,header,st,timeSpan,btnPunch,btnEdit,btnDel,rowEl){
  if (!currentUser) return alert('請先登入'); if (currentUser.permission!=='全功能') return alert('權限不足');
  const colIdx=header.indexOf(st); if (colIdx===-1) return alert('此欄位不存在：'+st);
  if (timeSpan.textContent && timeSpan.textContent.trim() && timeSpan.textContent.trim()!=='—'){ showNotif('此步驟已有時間，請用「修改」或「刪除」',true); return; }
  const now=getTaipeiHHMMSS();
  await withLoading(async()=>{
    const body={sheet:cfg.sheet,email:currentUser.email,writes:[{row:rowNumber,col:colIdx+1,value:now}]};
    const r=await fetch(API_BASE+'?action=update',{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(body)});
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'unknown'); await sleep(200); await reloadSheet();
  },'打卡中…');
  timeSpan.textContent=formatSheetTime(now); btnPunch.disabled=true; btnEdit.disabled=false; btnDel.disabled=false; unlockNext(rowEl); showNotif('已打卡',false);
}
async function onEditTimeClick(cfg,rowNumber,header,st,timeSpan,btnPunch,btnEdit,btnDel,rowEl,currentVal){
  if (!currentUser) return alert('請先登入'); if (currentUser.permission!=='全功能') return alert('權限不足');
  const colIdx=header.indexOf(st); if (colIdx===-1) return alert('此欄位不存在：'+st);
  openEditTimeDialog(currentVal || timeSpan.textContent || getTaipeiHHMMSS(), async (newHHMMSS)=>{
    await withLoading(async()=>{
      const body={sheet:cfg.sheet,email:currentUser.email,writes:[{row:rowNumber,col:colIdx+1,value:newHHMMSS}]};
      const r=await fetch(API_BASE+'?action=update',{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(body)});
      const j=await r.json(); if(!j.ok) throw new Error(j.error||'unknown'); await sleep(250); await reloadSheet();
    },'儲存中…');
    const wasEmpty=!timeSpan.textContent || timeSpan.textContent.trim()==='—';
    timeSpan.textContent=formatSheetTime(newHHMMSS); if (wasEmpty) unlockNext(rowEl);
    btnPunch.disabled=true; btnEdit.disabled=false; btnDel.disabled=false; showNotif('已修改時間',false);
  });
}
async function onDeleteTimeClick(cfg,rowNumber,header,st,timeSpan,btnPunch,btnEdit,btnDel,rowEl){
  if (!currentUser) return alert('請先登入'); if (currentUser.permission!=='全功能') return alert('權限不足');
  const colIdx=header.indexOf(st); if (colIdx===-1) return alert('此欄位不存在：'+st);
  openConfirmDialog('確定要刪除時間資料嗎？', async ()=>{
    await withLoading(async()=>{
      const body={sheet:cfg.sheet,email:currentUser.email,writes:[{row:rowNumber,col:colIdx+1,value:''}]};
      const r=await fetch(API_BASE+'?action=update',{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(body)});
      const j=await r.json(); if(!j.ok) throw new Error(j.error||'unknown'); await sleep(250); await reloadSheet();
    },'刪除中…');
    timeSpan.textContent=''; btnPunch.disabled=false; btnEdit.disabled=true; btnDel.disabled=true; lockFollowing(rowEl); showNotif('已刪除',false);
  });
}
function reloadSheet(){ loadSheetData(currentSheetKey); }
function unlockNext(rowEl){
  const nextRow=rowEl?.nextElementSibling; if(!nextRow) return;
  const sel=nextRow.querySelector('.step-select'); const timeSpan=nextRow.querySelector('.step-time');
  const btnPunch=nextRow.querySelector('.btn-punch'); const btnEdit=nextRow.querySelector('.btn-edit'); const btnDel=nextRow.querySelector('.btn-del');
  if (currentUser?.permission!=='全功能') return;
  if (sel){ sel.disabled=false; return; }
  if (btnPunch){ const hasVal=!!(timeSpan && timeSpan.textContent.trim() && timeSpan.textContent.trim()!=='—'); btnPunch.disabled=hasVal; if(btnEdit) btnEdit.disabled=!hasVal; if(btnDel) btnDel.disabled=!hasVal; }
}
function lockFollowing(rowEl){
  let it=rowEl?.nextElementSibling;
  while(it){
    const sel=it.querySelector('.step-select'); const timeSpan=it.querySelector('.step-time');
    const btnPunch=it.querySelector('.btn-punch'); const btnEdit=it.querySelector('.btn-edit'); const btnDel=it.querySelector('.btn-del');
    if (sel && !sel.value) sel.disabled=true;
    if (btnPunch){ const hasVal=!!(timeSpan && timeSpan.textContent.trim() && timeSpan.textContent.trim()!=='—'); if(!hasVal){ btnPunch.disabled=true; if(btnEdit) btnEdit.disabled=true; if(btnDel) btnDel.disabled=true; } }
    it=it.nextElementSibling;
  }
}
function computeCompletion(cfg, header, row) {
  const usableSteps = cfg.steps.filter(st => header.indexOf(st) !== -1);
  let completed = 0;
  for (const st of usableSteps) {
    const colIdx = header.indexOf(st);
    const val = (colIdx !== -1 && colIdx < row.length) ? row[colIdx] : '';
    if (isCompletedValue(val)) completed++;
  }
  return { completed, total: usableSteps.length };
}

/* ===== 頂層三頁切換 ===== */
const PANE_IDS=['pane-punch','pane-dashboard','pane-single'];
function switchPane(targetId){
  document.querySelectorAll('#mainTabs .main-tab')
    .forEach(btn => btn.classList.toggle('active', btn.dataset.target === targetId));
  PANE_IDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.toggle('hide', id !== targetId);
  });

  // 進出整體情報時控制自動刷新
  if (targetId === 'pane-dashboard') {
    buildDashboard(false);      // 首次切入：帶 Loading
    startDashboardAutoRefresh();
  } else {
    stopDashboardAutoRefresh();
  }
}

function isDashboardVisible() {
  return !document.getElementById('pane-dashboard').classList.contains('hide');
}
function startDashboardAutoRefresh() {
  stopDashboardAutoRefresh();
  dashTimer = setInterval(() => {
    if (isDashboardVisible()) buildDashboard(true); // 靜默刷新
  }, refreshMs);
}
function stopDashboardAutoRefresh() {
  if (dashTimer) { clearInterval(dashTimer); dashTimer = null; }
}
// 頁面可見性切換時自動暫停/恢復
document.addEventListener('visibilitychange', () => {
  if (document.hidden) stopDashboardAutoRefresh();
  else if (isDashboardVisible()) startDashboardAutoRefresh();
});

document.getElementById('mainTabs').addEventListener('click', (e)=>{
  const btn=e.target.closest('.main-tab'); if(!btn) return; switchPane(btn.dataset.target);
});

/* ======================= 整體情報 ======================= */
let ALL_SHEETS = {}; // { key: { cfg, headerIdx, header, rows } }

// 支援靜默刷新：buildDashboard(true) 會不顯示 Loading
async function buildDashboard(silent = false){
  const dash = document.getElementById('dashboard');
  dash.innerHTML = '';

  const work = async () => {
    // 取回四張表
    const results = await Promise.all(
      SHEET_CONFIGS.map(async cfg => {
        const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
        const j = await r.json();
        const values = j.values || [];
        const headerIdx = values.findIndex(
          r => Array.isArray(r) &&
               String(r[0]||'').trim() === '編號' &&
               String(r[1]||'').trim().startsWith('區域') &&
               String(r[2]||'').trim() === '車號'
        );
        const header = headerIdx >= 0 ? values[headerIdx].map(c => String(c||'').trim()) : [];
        const rows   = headerIdx >= 0 ? values.slice(headerIdx+1)
                          .filter(r => String(r[0]||'').trim() && String(r[1]||'').trim() && String(r[2]||'').trim())
                          : [];
        return { key: cfg.key, cfg, headerIdx, header, rows };
      })
    );

    // 給清單/明細用
    ALL_SHEETS = {};
    results.forEach(x => ALL_SHEETS[x.key] = x);

    // 逐張表生成區塊
    results.forEach(({ cfg, header, rows }) => {
      const sec   = document.createElement('section'); sec.className = 'dash-section card';
      const title = document.createElement('div');     title.className = 'dash-title'; title.textContent = cfg.key;
      sec.appendChild(title);

      // 1) 步驟完成/未完成統計（「車暫停位置」不在此統計）
      const statWrap = document.createElement('div'); statWrap.className = 'stat-grid';
      const stepsForCount = cfg.steps.filter(st => st !== '車暫停位置');
      stepsForCount.forEach(st => {
        const col = header.indexOf(st);
        let done = 0, todo = 0;
        rows.forEach(r => {
          const v = col >= 0 ? r[col] : '';
          isCompletedValue(v) ? done++ : todo++;
        });

        const card = document.createElement('div'); card.className = 'stat-card';
        card.innerHTML = `
          <div class="stat-head">${st}</div>
          <div class="stat-row">
            <div class="stat-pill" data-type="done">
              <div class="stat-num done">${done}</div>
              <div class="stat-label">完成</div>
            </div>
            <div class="stat-pill" data-type="todo">
              <div class="stat-num todo">${todo}</div>
              <div class="stat-label">未完成</div>
            </div>
          </div>`;
        // 點完成/未完成 → 開清單
        card.querySelectorAll('.stat-pill').forEach(pill => {
          pill.addEventListener('click', () => openListModal(cfg.key, st, pill.dataset.type));
        });
        statWrap.appendChild(card);
      });
      sec.appendChild(statWrap);

      // 2) 停車位置分佈（只有表頭含「車暫停位置」才顯示）
      const stopCol = header.indexOf('車暫停位置');
      if (stopCol >= 0) {
        const locTitle = document.createElement('div');
        locTitle.className = 'dash-title';
        locTitle.style.marginTop = '12px';
        locTitle.textContent = '停車位置';
        sec.appendChild(locTitle);

        const locWrap = document.createElement('div'); locWrap.className = 'loc-grid';

        const counter = new Map();
        STOP_OPTIONS.forEach(n => counter.set(n, 0));

        rows.forEach(r => {
          const v = String(r[stopCol] || '').trim();
          if (counter.has(v)) counter.set(v, counter.get(v) + 1);
        });

        STOP_OPTIONS.forEach(name => {
          const n = counter.get(name) || 0;
          const pill = document.createElement('div'); pill.className = 'loc-pill';
          pill.innerHTML = `
            <div class="loc-name">${name}</div>
            <div class="loc-num">${n}</div>
            <div class="stat-label">台</div>`;
          pill.addEventListener('click', () =>
            openListModal(cfg.key, '車暫停位置', 'loc', name)
          );
          locWrap.appendChild(pill);
        });
        sec.appendChild(locWrap);
      }

      dash.appendChild(sec);
    });
  };

  if (silent) { await work(); }
  else { await withLoading(work, '整理整體情報…'); }
}


/* 取得一台車目前「最新狀態」 */
function getLatestStatus(cfg, header, row){
  for (let i=cfg.steps.length-1; i>=0; i--){
    const st=cfg.steps[i]; const col=header.indexOf(st);
    if (col>=0 && isCompletedValue(row[col])) {
      if (st==='車暫停位置') return `車暫停位置：${row[col]}`;
      return st;
    }
  }
  return '尚未開始';
}

/* --------------- Overlay 1：清單 --------------- */
function openListModal(sheetKey, step, type, locValue){
  const {cfg, header, rows} = ALL_SHEETS[sheetKey];
  const list = [];

  if (type==='loc'){ // 停車位置
    const c = header.indexOf('車暫停位置');
    rows.forEach(r=>{ if (c>=0 && String(r[c]||'').trim()===locValue) list.push(r); });
  } else if (type==='done' || type==='todo'){
    const c = header.indexOf(step);
    rows.forEach(r=>{
      const v = c>=0 ? r[c] : '';
      if ((type==='done' && isCompletedValue(v)) || (type==='todo' && !isCompletedValue(v))) list.push(r);
    });
  }

  const box=document.createElement('div');
  box.className='modal';
  const titleText = (type==='loc') ? `${sheetKey}：${step}＝${locValue}` : `${sheetKey}：${step}（${type==='done'?'完成':'未完成'}）`;
  box.innerHTML = `
    <div class="dash-close">✕</div>
    <h3 style="font-size:18px;margin:0 0 8px;">${titleText}</h3>
    <div style="max-height:70vh; overflow:auto; padding-right:6px;">
      ${list.length? '' : '<div style="opacity:.7">目前沒有資料</div>'}
    </div>
  `;
  const close = openModal(box);
  box.querySelector('.dash-close').onclick = close;

  const scroller = box.querySelector('div[style*="overflow:auto"]');
  list.forEach(r=>{
    const area=String(r[1]||'').trim(); const car=String(r[2]||'').trim();
    const latest = getLatestStatus(cfg, header, r);
    const row = document.createElement('div'); row.className='list-item';
    row.innerHTML = `
      <div class="list-left">
        <div class="list-title">${area}　<span style="font-weight:900">${car}</span></div>
        <div class="list-sub">最新狀態：${latest}</div>
      </div>
      <div><button class="btn btn--primary btn--sm">詳細資料</button></div>
    `;
    row.querySelector('button').onclick = ()=> openDetailModal(sheetKey, r);
    scroller.appendChild(row);
  });
}

/* --------------- Overlay 2：單車詳情 --------------- */
function openDetailModal(sheetKey, row){
  const {cfg, header} = ALL_SHEETS[sheetKey];
  const area=String(row[1]||'').trim(); const car=String(row[2]||'').trim();

  // 進 / 退 場分段：以「車暫停位置」為界，如果沒有就全部當一段
  const cutIdx = cfg.steps.indexOf('車暫停位置');
  const groups = [];
  if (cutIdx>=0){
    groups.push({ title:'進場', cols: cfg.steps.slice(0, cutIdx+1) });
    if (cutIdx+1 < cfg.steps.length) groups.push({ title:'退場', cols: cfg.steps.slice(cutIdx+1) });
  } else {
    groups.push({ title:'狀態', cols: cfg.steps });
  }

  const box=document.createElement('div'); box.className='modal';
  const head = `<div class="dash-close">✕</div>
    <div style="font-weight:900;margin-bottom:8px;">${sheetKey}</div>
    <div style="margin-bottom:10px;"><b>${area}</b>　<span style="font-weight:900">${car}</span></div>`;
  let html = head;

  groups.forEach(g=>{
    html += `<div style="font-weight:800;margin:6px 0 4px;">${g.title}</div>
      <table class="detail-table"><thead><tr>
      ${g.cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody><tr>
      ${g.cols.map(c=>{
        const idx=header.indexOf(c);
        const v = idx>=0 ? String(row[idx]||'').trim() : '';
        if (c==='車暫停位置') return `<td>${v||''}</td>`;
        return `<td>${v?formatSheetTime(v):''}</td>`;
      }).join('')}
      </tr></tbody></table>`;
  });

  box.innerHTML = html;
  const close = openModal(box);
  box.querySelector('.dash-close').onclick = close;
}

/* ====== 其餘舊有的「確認/修改時間」小視窗（原封不動） ====== */
function openConfirmDialog(msg, onOK){
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3>確認刪除</h3>
    <div class="modal-msg" style="font-size:15px;line-height:1.6;margin:4px 0 8px;">${msg}</div>
    <div class="actions">
      <button class="btn" style="background:#e5e7eb;color:#111827;">取消</button>
      <button class="btn btn-del">確定</button>
    </div>`;
  const close = openModal(box);
  const [btnCancel, btnOK] = box.querySelectorAll('button');
  setTimeout(()=>{ try{ hh.focus({ preventScroll:true }); }catch{} }, 80);
  btnCancel.onclick = close;
  btnOK.onclick = ()=>{ try{ onOK && onOK(); } finally{ close(); } };
}
function openEditTimeDialog(initialHHMMSS, onOK){
  const [h0,m0,s0] = splitHMS(initialHHMMSS);
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3>修改時間</h3>
    <div class="time-edit">
      <input id="hh" class="time-input" type="text" inputmode="numeric" maxlength="2" value="${h0}" aria-label="小時">
      <span class="colon">:</span>
      <input id="mm" class="time-input" type="text" inputmode="numeric" maxlength="2" value="${m0}" aria-label="分鐘">
      <span class="colon">:</span>
      <input id="ss" class="time-input" type="text" inputmode="numeric" maxlength="2" value="${s0}" aria-label="秒">
    </div>
    <div class="hint">請輸入 2 位數！下午兩點請輸入 14。</div>
    <div class="actions">
      <button class="btn" style="background:#e5e7eb;color:#111827;">取消</button>
      <button class="btn btn-edit">確定</button>
    </div>`;
  const close = openModal(box);
  const hh = box.querySelector('#hh'), mm = box.querySelector('#mm'), ss = box.querySelector('#ss');
  const [btnCancel, btnOK] = box.querySelectorAll('button');
  setTimeout(()=>{ try{ hh.focus({ preventScroll:true }); }catch{} }, 80);

  [hh,mm,ss].forEach(inp=>inp.addEventListener('input', ()=>{ inp.value = inp.value.replace(/\D/g,'').slice(0,2); }));
  btnCancel.onclick = close;
  btnOK.onclick = ()=>{
    const H = pad2(hh.value||''), M = pad2(mm.value||''), S = pad2(ss.value||'');
    if (!isValidHMS(H,M,S)){ showNotif('格式需為 HH(00–23) / MM(00–59) / SS(00–59)', true); return; }
    try{ onOK(`${H}:${M}:${S}`); } finally{ close(); }
  };
}
</script>
</body>
</html>
