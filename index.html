<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>活動車流人流退場管理系統</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
      --card-bg: rgba(255,255,255,0.75);
      --text: #0f172a;
    }
    body.dark{
      --bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
      --card-bg: rgba(15,23,42,0.55);
      --text: #e2e8f0;
    }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      backdrop-filter: blur(14px);
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      color:var(--text);
    }
    .wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
    h1{margin:0 0 16px;}
    .card{background:var(--card-bg);border:1px solid rgba(255,255,255,0.3);border-radius:16px;padding:16px;margin:12px 0;}
    .hide{display:none;}
    .sheet-tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;}
    .btn-tab{background:transparent;border:1px solid rgba(255,255,255,0.2);border-radius:14px;padding:6px 10px;font-size:.78rem;cursor:pointer;color:inherit;}
    .btn-tab.active{background:rgba(255,255,255,.25);}
    .veh-list{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(480px, 1fr));
  gap:12px;
}
    .veh-card{
  background:rgba(255,255,255,0.85);
  border-radius:14px;
  border:1px solid rgba(148,163,184,0.25);
  padding:14px 14px 10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
    body.dark .veh-card{background:rgba(15,23,42,0.28);}
    .veh-title{font-weight:600;display:flex;justify-content:space-between;gap:6px;}
    .steps{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;}
    .step-btn{border:1px solid rgba(148,163,184,0.4);border-radius:12px;padding:3px 8px;background:rgba(255,255,255,0.7);font-size:.7rem;cursor:pointer;color:#000;}
    .step-btn.done{
  background:#d1d5db;
  color:#0f172a;
  cursor:not-allowed;
}
    .step-btn.locked{opacity:.4;pointer-events:none;}
    .step-time{
  font-size:.7rem;
  color:rgba(15,23,42,.55);
  min-width:90px;
  text-align:right;
}
    .notif{position:fixed;right:16px;bottom:16px;background:rgba(15,23,42,.85);color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transform:translateY(20px);transition:.2s;}
    .notif.show{opacity:1;transform:translateY(0);}
    @media(max-width:768px){
  .veh-list{grid-template-columns:1fr;}
}
    .step-row{
  display:flex;
  align-items:center;
  gap:8px;
}
    .step-btn{
  border:0;
  border-radius:10px;
  padding:6px 12px 7px;
  background:#0f6efc;
  color:#fff;
  font-size:.74rem;
  cursor:pointer;
  flex:0 0 auto;
  min-width:150px;
}
    .veh-title-main{
  font-weight:600;
  font-size:1rem;
  margin-bottom:2px;
}
.veh-title-sub{
  font-size:.85rem;
  opacity:.7;
}

  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
      <div>
        <h1>活動車流人流退場管理系統</h1>
        <div style="font-size:.7rem;opacity:.6;">(外部前端版，給 Google Sites 嵌 URL 用)</div>
      </div>
      <div id="signin"></div>
      <div id="userInfo" class="hide" style="font-size:.75rem;"></div>
    </div>

    <div id="tabs" class="card hide">
      <div class="sheet-tabs" id="sheetTabs"></div>
    </div>

    <div id="content" class="hide">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:.85rem;">目前工作表：<b id="currentSheet"></b></div>
          <div style="font-size:.7rem;opacity:.6;">點一下狀態＝寫入時間，有值再點會問你要不要改時間</div>
        </div>
        <button onclick="reloadSheet()">重新載入</button>
      </div>
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <div id="notif" class="notif"></div>

<script>
/* ① 這裡換成你的 client ID */
const GOOGLE_CLIENT_ID = '368914333961-504cujbloe9n3v28p4bjsc8c1lh5pg0o.apps.googleusercontent.com';
/* ② 這裡換成你部署出來的 Apps Script Web App URL */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxbeknXeJ2s2NnIqTwIwNdZnsbiI9UlGkQpSGfHq2TlmnITZ75Ub4ySwn6UGmJk3AXjNg/exec';

const SHEET_CONFIGS = [
  {
    // ✅ 跟你的 sheet 分頁名一模一樣
    key: '地區專車退場（遊覽車平台）',
    sheet: '地區專車退場（遊覽車平台）',
    // ✅ 跟你表頭一模一樣，照你截圖的順序
    steps: [
      '車長通知行李到齊',
      'Call 車上行李',
      '車已上遊覽車平台',
      '車前往排車隊',
      '車暫停位置',
      '退場人員已到齊',
      '已 Call 車上遊覽車平台',
      '人已前往平台',
      '車第二次上遊覽車平台',
      '車已離開遊覽車平台'
    ]
  },
  {
    key: '地區專車退場（禪堂平台）',
    sheet: '地區專車退場（禪堂平台）',
    steps: [
      '車長通知行李到齊',
      'Call 車上行李',
      '車已上遊覽車平台',
      '車前往排車隊',
      // 你如果禪堂這張也有「車暫停位置」欄位，就在這裡加一行
      '車已離開禪堂平台'
    ]
  },
  {
    key: '水陸專車退場',
    sheet: '水陸專車退場',
    steps: [
      '已 Call 車排車隊',
      '已排好車隊',
      '退場人員已到齊',
      '已 Call 車上遊覽車平台',
      '車已上遊覽車平台',
      '車已離開遊覽車平台'
    ]
  },
  {
    key: '國光號退場',
    sheet: '國光號退場',
    steps: [
      '是否經過長庚',
      '退場人員已到齊',
      '車已經上遊覽車平台',
      '車已經離開遊覽車平台',
      '上車人數'
    ]
  },
  {
    key: '288法青退場',
    sheet: '288法青退場',
    steps: [
      '退場人員已到齊',
      '車已經上遊覽車平台',
      '車已經離開遊覽車平台'
    ]
  }
];


let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = [];

window.onload = function(){
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredential
  });
  google.accounts.id.renderButton(
    document.getElementById('signin'),
    { theme:'outline', size:'large' }
  );
  buildTabs();
};

async function handleCredential(resp){
  try {
    const r = await fetch(API_BASE + '?action=verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8'
      },
      body: JSON.stringify({ idToken: resp.credential })
    });
    const j = await r.json();
    if (j.error) {
      showNotif('登入失敗：' + j.error, true);
      return;
    }
    currentUser = j;
    document.getElementById('signin').classList.add('hide');
    const ui = document.getElementById('userInfo');
    ui.classList.remove('hide');
    ui.innerHTML = `${j.name||''} &lt;${j.email}&gt; ｜ 權限：<b>${j.permission}</b>`;
    document.getElementById('tabs').classList.remove('hide');
    document.getElementById('content').classList.remove('hide');
    loadSheetData(currentSheetKey);
  } catch (err) {
    showNotif('登入錯誤：' + err.message, true);
  }
}


function buildTabs(){
  const box = document.getElementById('sheetTabs');
  box.innerHTML = '';
  SHEET_CONFIGS.forEach(cfg=>{
    const b = document.createElement('button');
    b.className = 'btn-tab' + (cfg.key===currentSheetKey?' active':'');
    b.textContent = cfg.key;
    b.onclick = () => {
      currentSheetKey = cfg.key;
      document.querySelectorAll('.btn-tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      loadSheetData(currentSheetKey);
    };
    box.appendChild(b);
  });
}

async function loadSheetData(key){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  document.getElementById('currentSheet').textContent = cfg.key;
  document.getElementById('vehList').textContent = '讀取中...';
  const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
  const j = await r.json();
  if (j.error){ document.getElementById('vehList').textContent = '❌ '+j.error; return; }
  sheetData = j.values || [];
  renderVehicles(cfg, sheetData);
}

// 把 Apps Script 回來的整張 data[] 拆成「表頭」+「真的有資料的列」
function parseSheetData(raw) {
  // 1. 找出第一個「不是全空白」的 row 當表頭
  const headerIndex = raw.findIndex(row =>
    Array.isArray(row) && row.some(cell => String(cell || '').trim() !== '')
  );
  if (headerIndex === -1) {
    return { header: [], rows: [] };
  }

  const header = raw[headerIndex].map(c => String(c || '').trim());

  // 2. 從表頭下一列開始，拿到真的有內容的列
  const rows = raw
    .slice(headerIndex + 1)
    .filter(row => Array.isArray(row) && row.some(cell => String(cell || '').trim() !== ''));

  return { header, rows };
}

// 把「第幾筆資料」換成「試算表實際 row 編號」
// rawData = Apps Script 回來的整張陣列
// header = 我們抓到的那一列
// rows = 真正有資料的列
// idx = rows 陣列裡的第幾筆 (0-based)
function headerIndexToRowNumber(rawData, header, rows, idx){
  // 找出表頭在原始 rawData 的哪一列
  const headerIdx = rawData.findIndex(row =>
    Array.isArray(row) &&
    row.length === header.length &&
    row.every((cell, i) => String(cell || '').trim() === header[i])
  );
  // 真正的試算表 row = 表頭的下一列 + idx
  return headerIdx + 1 + idx + 1; // +1 因為試算表是 1-based，再 +idx
}
  
  
function renderVehicles(cfg, data){
  // 先把 raw data 拆好
  const { header, rows } = parseSheetData(data);

  const box = document.getElementById('vehList');
  box.innerHTML = '';

  // 沒資料就直接顯示
  if (!rows.length) {
    box.textContent = '(無資料)';
    return;
  }

  rows.forEach((row, idx) => {
    // 你的表結構：A=編號, B=區域車次編號, C=車號, 後面才是狀態
    const no   = String(row[0] || '').trim(); // 編號
    const area = String(row[1] || '').trim(); // 區域車次編號
    const car  = String(row[2] || '').trim(); // 車號

    const card = document.createElement('div');
    card.className = 'veh-card';

    // ▶︎ 這裡改成你說的順序：第一列是區域車次編號，第二列是車號
    const title = document.createElement('div');
    title.innerHTML = `
      <div class="veh-title-main">${area || ('#' + (no || (idx+1)))}</div>
      <div class="veh-title-sub">${car || ''}</div>
    `;
    card.appendChild(title);

    const stepsBox = document.createElement('div');

    // 每一個狀態一列：按鈕 + 時間
    cfg.steps.forEach(st => {
      const colIdx = header.indexOf(st);   // 找出這個狀態在第幾欄
      const rowEl = document.createElement('div');
      rowEl.className = 'step-row';

      const btn = document.createElement('button');
      btn.className = 'step-btn';
      btn.textContent = st;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'step-time';

      // 這一列這一欄的目前值
      const curVal = (colIdx !== -1 && row[colIdx]) ? String(row[colIdx]).trim() : '';

      if (curVal) {
        // 有值 → 顯示時間、變灰
        btn.classList.add('done');
        timeSpan.textContent = curVal;
      }

      // 沿用你原本的「前一個沒做就鎖住後一個」
      const prevOk = prevDone(cfg, header, row, st);
      if (!prevOk && !curVal) {
        btn.classList.add('done');
        btn.disabled = true;
      }

      // 點擊時用你原本的 onStepClick（你說這段先不改）
      btn.onclick = () => onStepClick(cfg, headerIndexToRowNumber(data, header, rows, idx), header, st, curVal, btn, timeSpan);

      rowEl.appendChild(btn);
      rowEl.appendChild(timeSpan);
      stepsBox.appendChild(rowEl);
    });

    card.appendChild(stepsBox);
    box.appendChild(card);
  });
}



function prevDone(cfg, header, row, st){
  const idx = cfg.steps.indexOf(st);
  if (idx === 0) return true;
  const prevName = cfg.steps[idx-1];
  const colIdx = header.indexOf(prevName);
  if (colIdx === -1) return true;
  return !!row[colIdx];
}

async function onStepClick(cfg, rowNumber, header, st, oldVal, btn, span){
  if (!currentUser) return alert('請先登入');
  if (!['輸入','全功能'].includes(currentUser.permission)) return alert('權限不足');

  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('此欄位不存在：'+st);

  let valueToWrite;
  if (oldVal){
    const m = prompt('此狀態已有時間，要修改嗎？', oldVal);
    if (m===null || m==='') return;
    valueToWrite = m;
  }else{
    valueToWrite = new Date().toLocaleString('zh-TW',{hour12:false});
  }

  const body = {
    sheet: cfg.sheet,
    email: currentUser.email,
    writes: [{ row: rowNumber, col: colIdx+1, value: valueToWrite }]
  };
  const r = await fetch(API_BASE + '?action=update', {
  method: 'POST',
  headers: {
    'Content-Type': 'text/plain;charset=utf-8'
  },
  body: JSON.stringify(body)
});

  const j = await r.json();
  if (!j.ok){ showNotif('寫入失敗：'+(j.error||'unknown'), true); return; }
  span.textContent = valueToWrite;
  btn.classList.add('done');
  loadSheetData(currentSheetKey);
  showNotif('已寫入「'+st+'」', false);
}

function reloadSheet(){ loadSheetData(currentSheetKey); }

function showNotif(msg, isErr){
  const box = document.getElementById('notif');
  box.textContent = msg;
  box.style.background = isErr ? 'rgba(248,113,113,.9)' : 'rgba(15,23,42,.85)';
  box.classList.add('show');
  setTimeout(()=>box.classList.remove('show'), 2500);
}
</script>
</body>
</html>
