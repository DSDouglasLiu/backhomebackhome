<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>車流人流退場情報</title>
<style>
:root{
  --radius-xs:6px; --radius-sm:8px; --radius-md:10px; --radius-lg:12px;
  --primary-600:#1f6fe5; --primary-700:#165bd1; --primary-800:#1249ad;
  --success-600:#22c55e; --success-700:#16a34a; --success-800:#15803d;
  --danger-600:#ef4444; --danger-700:#dc2626; --danger-800:#b91c1c;
  --gray-50:#f8fafc; --gray-100:#f1f5f9; --gray-200:#e5e7eb; --gray-300:#cbd5e1;
  --gray-400:#94a3b8; --gray-500:#64748b; --gray-600:#475569; --gray-700:#334155;
  --gray-800:#1f2937; --gray-900:#0f172a;
  --surface:rgba(255,255,255,.78);
  --page-bg:linear-gradient(135deg,#eef2f3,#dfe9f3);
  --text-strong:var(--gray-900); --text:var(--gray-800); --text-muted:var(--gray-600);
  --border:rgba(148,163,184,.35);
  --shadow-card:0 8px 24px rgba(0,0,0,.08);
}
body{margin:0;min-height:100vh;background:var(--page-bg);color:var(--text);
  backdrop-filter:blur(14px);font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;}
.wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
h1{margin:0 0 12px;font-size:28px;line-height:36px;font-weight:700;color:var(--text-strong);}

/* 三大 Tab */
.main-tabs{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 8px;}
.main-tab{background:var(--surface);color:var(--primary-600);border:2px solid transparent;
  border-radius:12px;padding:10px 22px;font-weight:700;box-shadow:var(--shadow-card);
  cursor:pointer;min-width:160px;text-align:center;transition:.2s;}
.main-tab:hover{background:rgba(31,111,229,.08)}
.main-tab.active{background:var(--primary-600);color:#fff;border-color:var(--primary-600);transform:translateY(-2px)}

/* 共同卡片 */
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:var(--shadow-card);}
.grid{display:grid;gap:12px}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:8px}
.kpi .item{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.kpi .num{font-size:40px;font-weight:800;color:var(--primary-600);line-height:1}
.kpi .lbl{margin-top:6px;color:var(--text-muted)}

.prog{margin-top:6px}
.prog .head{display:flex;justify-content:space-between;margin-bottom:8px;font-weight:600}
.bar{height:20px;background:#e5e7eb;border-radius:10px;overflow:hidden}
.fill{height:100%;background:var(--primary-600);width:0%;transition:width .4s ease}

.stops{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
.stop{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center}
.stop .n{font-size:28px;font-weight:800;color:var(--primary-600);line-height:1}

.area{display:grid;gap:10px}
.area-row{display:grid;grid-template-columns:120px 1fr 60px;gap:10px;align-items:center}
.area-name{font-weight:700}
.area-bar{height:16px;background:#e5e7eb;border-radius:8px;overflow:hidden}
.area-fill{height:100%;background:var(--success-600);width:0%}

.rank{display:grid;gap:8px}
.rank-row{display:flex;justify-content:space-between;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px}

.hide{display:none}

/* 搜尋頁 */
.searchbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.searchbar input{flex:1;min-width:240px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px}
.btn{border:0;border-radius:10px;padding:10px 14px;background:var(--primary-600);color:#fff;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}

.result{display:grid;gap:12px}
.scard{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}
.shead{font-size:18px;font-weight:800;margin-bottom:8px}
.steps{display:grid;gap:6px}
.step{display:grid;grid-template-columns:200px 1fr;gap:10px}
.done{color:var(--success-700);font-weight:700}
.muted{color:var(--gray-500)}

.note{margin-top:18px;color:var(--gray-500);font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>車流人流退場情報</h1>

    <div class="main-tabs">
      <button class="main-tab active" data-tab="punch">打卡作業</button>
      <button class="main-tab" data-tab="dashboard">整體情報</button>
      <button class="main-tab" data-tab="single">個別情報</button>
    </div>

    <!-- 打卡作業（預覽用占位） -->
    <div id="punch" class="tab">
      <div class="card">
        <b>打卡作業</b><br/>這是預覽頁。等你要接回既有打卡 UI，我再把你原本的 renderVehicles(...) 串回來。
      </div>
    </div>

    <!-- 整體情報 -->
    <div id="dashboard" class="tab hide">
      <div class="grid">
        <div class="kpi">
          <div class="item"><div class="num" id="kTotal">–</div><div class="lbl">總車次</div></div>
          <div class="item"><div class="num" id="kDone">–</div><div class="lbl">已離場</div></div>
          <div class="item"><div class="num" id="kOn">–</div><div class="lbl">在上平台</div></div>
          <div class="item"><div class="num" id="kWait">–</div><div class="lbl">待 Call 上車</div></div>
        </div>

        <div class="card prog">
          <div class="head"><span>整體退場進度</span><span id="pTxt">0%</span></div>
          <div class="bar"><div id="pFill" class="fill"></div></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 10px">車暫停位置分布</h3>
          <div id="stopGrid" class="stops"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 10px">各區域進度</h3>
          <div id="areaProg" class="area"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 10px">目前瓶頸步驟（未離場）</h3>
          <div id="bottleneck" class="rank"></div>
          <div class="note">依各車「最後完成的步驟」彙整，顯示人數最多的步驟。</div>
        </div>
      </div>
    </div>

    <!-- 個別情報 -->
    <div id="single" class="tab hide">
      <div class="card">
        <div class="searchbar">
          <input id="kw" placeholder="輸入車號（支援關鍵字，例如 6917 或 KAA-）" />
          <button class="btn" id="btnSearch">搜尋</button>
          <button class="btn" id="btnClear" style="background:#64748b">清除</button>
        </div>
        <div id="sinfo" class="muted" style="margin:4px 2px 10px">輸入關鍵字即時顯示結果</div>
        <div id="sList" class="result"></div>
      </div>
    </div>
  </div>

<script>
/* ==== 你環境可改這行連到 Apps Script：總表 ==== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxbeknXeJ2s2NnIqTwIwNdZnsbiI9UlGkQpSGfHq2TlmnITZ75Ub4ySwn6UGmJk3AXjNg/exec';
const SUMMARY_SHEET = '總表';

/* ==== 定義步驟欄位（名稱以你表頭為準） ==== */
const STEP_ORDER = [
  '車長通知行李到齊',
  'Call 車上行李',
  '車已上遊覽車平台',
  '車前往排車隊',
  '車暫停位置',          // 文字
  '退場人員已到齊',
  '已 Call 車上遊覽',
  '人已前往平台',
  '車第二次上遊覽車平台',
  '車已離開遊覽車平台',
  '車已離開禪堂平台'
];
const FINAL_COLS = ['車已離開遊覽車平台','車已離開禪堂平台'];
const ON_PLATFORM_COLS = ['車已上遊覽車平台'];

/* ==== 狀態 ==== */
let header=[], map={}, rows=[];

/* ==== UI 切換 ==== */
document.querySelectorAll('.main-tab').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.main-tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('.tab').forEach(x=>x.classList.add('hide'));
    document.getElementById(b.dataset.tab).classList.remove('hide');
    if(b.dataset.tab==='dashboard') ensureDataThen(renderDashboard);
    if(b.dataset.tab==='single') ensureDataThen(initSearchTab);
  });
});

/* ==== 先載資料（讀不到就用假資料） ==== */
async function ensureDataThen(fn){
  if(rows.length){ fn(); return; }
  try{
    const r = await fetch(API_BASE+'?action=get&sheet='+encodeURIComponent(SUMMARY_SHEET));
    const j = await r.json();
    if(!j.values || !j.values.length) throw new Error('no data');
    header = j.values[0]; map = indexHeader(header);
    rows = j.values.slice(1).filter(r=> (r[map['車號']]||'').toString().trim() ).map(r=> toRow(r));
  }catch(e){
    // 假資料（預覽）
    header = ['編號','區域','車次編號','車號','最新狀態','車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽','人已前往平台','車第二次上遊覽車平台','車已離開遊覽車平台','備註'];
    map = indexHeader(header);
    const demo = [
      ['1','安和1車','1','KAA-9033','','18:52:55','21:54:13','','','法心南路','','','','','',''],
      ['2','安和7車','9','KAA-6917','','21:54:22','','21:55:40','','禪堂平台','','','','','',''],
      ['3','台中5車','5','KAA-5857','','','','21:40:10','','法鼓路靈山勝境石往外','','','','','',''],
      ['4','高雄1車','9','492-RR','','','','','','','','','','','21:58:02',''],
      ['5','台南2車','8','KAC-1857','','20:10:00','20:30:00','20:45:00','','禪堂平台','','','','','','']
    ];
    rows = demo.map(r=>toRow(r));
  }
  fn();
}

/* ==== 解析工具 ==== */
function indexHeader(h){ const m={}; h.forEach((t,i)=>{ m[String(t||'').trim()] = i; }); return m; }
function get(r, name){ const i = map[name]; return (i==null)?'': String(r[i]??'').trim(); }
function toRow(r){
  return {
    raw:r,
    區域:get(r,'區域'),
    車號:get(r,'車號'),
    暫停:get(r,'車暫停位置') || '',
    steps: STEP_ORDER.map(n=> ({ name:n, val:get(r,n) }) )
  };
}
function hasVal(v){ return v!=null && String(v).trim()!==''; }
function rowFinished(row){ return FINAL_COLS.some(c => hasVal(get(row.raw,c))); }
function rowOnPlatform(row){ return ON_PLATFORM_COLS.some(c => hasVal(get(row.raw,c))) && !rowFinished(row); }
function lastDoneStep(row){
  // 文字欄「車暫停位置」若有值也視為到達該步
  let idx=-1, t='';
  row.steps.forEach((s,i)=>{ if(hasVal(s.val)){ idx=i; t=s.val; } });
  return {idx, name: idx>=0? row.steps[idx].name : '尚未開始', time:t};
}
function pct(a,b){ return b? Math.round(a*1000/b)/10 : 0; }

/* ==== 儀表板 ==== */
function renderDashboard(){
  const total = rows.length;
  const finished = rows.filter(rowFinished).length;
  const onPlat = rows.filter(rowOnPlatform).length;
  // 待 Call: 「車長通知行李到齊」有值且「Call 車上行李」還沒
  const waitCall = rows.filter(r => hasVal(get(r.raw,'車長通知行李到齊')) && !hasVal(get(r.raw,'Call 車上行李')) && !rowFinished(r)).length;

  document.getElementById('kTotal').textContent = total;
  document.getElementById('kDone').textContent = finished;
  document.getElementById('kOn').textContent   = onPlat;
  document.getElementById('kWait').textContent = waitCall;

  const prog = pct(finished,total);
  document.getElementById('pTxt').textContent = prog+'%';
  document.getElementById('pFill').style.width = prog+'%';

  // 停等分布
  const stopCnt = {};
  rows.forEach(r=>{
    const k = r.暫停 || '未設定';
    stopCnt[k] = (stopCnt[k]||0)+1;
  });
  const stopGrid = document.getElementById('stopGrid');
  stopGrid.innerHTML = Object.keys(stopCnt).sort().map(k=>(
    `<div class="stop"><div class="n">${stopCnt[k]}</div><div class="muted">${k}</div></div>`
  )).join('') || '<div class="muted">目前沒有停等資料</div>';

  // 區域進度
  const areaMap = {};
  rows.forEach(r=>{
    const key=r.區域||'未分區';
    if(!areaMap[key]) areaMap[key]={total:0,done:0};
    areaMap[key].total++;
    if(rowFinished(r)) areaMap[key].done++;
  });
  const areaProg = document.getElementById('areaProg');
  areaProg.innerHTML = Object.entries(areaMap).sort((a,b)=>a[0].localeCompare(b[0])).map(([name,v])=>{
    const p = pct(v.done, v.total);
    return `<div class="area-row">
      <div class="area-name">${name}</div>
      <div class="area-bar"><div class="area-fill" style="width:${p}%"></div></div>
      <div class="muted">${v.done}/${v.total}</div>
    </div>`;
  }).join('');

  // 瓶頸：未離場，取 last step 名稱，群組排序
  const pend = rows.filter(r=>!rowFinished(r));
  const bmap = {};
  pend.forEach(r=>{
    const s = lastDoneStep(r).name;
    bmap[s] = (bmap[s]||0)+1;
  });
  const bottleneck = document.getElementById('bottleneck');
  const list = Object.entries(bmap).sort((a,b)=>b[1]-a[1]).slice(0,8);
  bottleneck.innerHTML = list.length
    ? list.map(([k,v])=>`<div class="rank-row"><div>${k}</div><b>${v}</b></div>`).join('')
    : '<div class="muted">全數已離場或尚未開始</div>';
}

/* ==== 個別情報 ==== */
function initSearchTab(){
  // 一次渲染即可；即時搜尋
  const $kw = document.getElementById('kw');
  const $list = document.getElementById('sList');
  const $info = document.getElementById('sinfo');

  function render(q){
    const kw = q.trim().toUpperCase();
    const filtered = kw ? rows.filter(r => (r.車號||'').toUpperCase().includes(kw)) : [];
    $info.textContent = kw ? `找到 ${filtered.length} 筆` : '輸入關鍵字即時顯示結果';
    if(!filtered.length){ $list.innerHTML=''; return; }

    // 排序：未離場優先；再依最後時間早→晚
    filtered.sort((a,b)=>{
      const da = rowFinished(a)?1:0, db=rowFinished(b)?1:0;
      if(da!==db) return da-db;
      const ta = lastDoneStep(a).time||'', tb=lastDoneStep(b).time||'';
      return ta.localeCompare(tb);
    });

    $list.innerHTML = filtered.map(r=>{
      const last = lastDoneStep(r);
      const state = rowFinished(r) ? '✅ 已離場' :
        (last.idx<0 ? '尚未開始' :
          (last.name==='車已上遊覽車平台' ? '已到平台，等待離場' : `已完成「${last.name}」`));
      const stepsHtml = STEP_ORDER
        .filter(n=> n!=='車已離開禪堂平台') // 同終點只顯示一種
        .map(n=>{
          const val = (r.steps.find(s=>s.name===n)||{}).val || '';
          const ok = hasVal(val);
          const valTxt = n==='車暫停位置' ? (ok? val : '—') : (ok? val : '—');
          return `<div class="step"><div class="${ok?'done':''}">${ok?'✓':''} ${n}</div><div>${valTxt}</div></div>`;
        }).join('');
      return `<div class="scard">
        <div class="shead">${r.區域||'未分區'} ｜ ${r.車號}</div>
        <div class="muted" style="margin-bottom:8px">${state}</div>
        <div class="steps">${stepsHtml}</div>
      </div>`;
    }).join('');
  }

  $kw.addEventListener('input',()=>render($kw.value));
  document.getElementById('btnSearch').onclick=()=>render($kw.value);
  document.getElementById('btnClear').onclick=()=>{ $kw.value=''; render(''); }
  // 若上次已輸入，保留
  render($kw.value||'');
}

/* 預設先展示整體情報以便你檢視畫面 */
ensureDataThen(renderDashboard);
document.querySelector('[data-tab="dashboard"]').click();
</script>
</body>
</html>
