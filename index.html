<!DOCTYPE html>
<html lang="zh-Hant">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>æ´»å‹•è»Šæµäººæµé€€å ´ç®¡ç†ç³»çµ±</title>
Â  <script src="https://accounts.google.com/gsi/client" async defer></script>
Â  <style>
Â  Â  :root{
Â  Â  Â  --bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
Â  Â  Â  --card-bg: rgba(255,255,255,0.75);
Â  Â  Â  --text: #0f172a;
Â  Â  }
Â  Â  body.dark{
Â  Â  Â  --bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
Â  Â  Â  --card-bg: rgba(15,23,42,0.55);
Â  Â  Â  --text: #e2e8f0;
Â  Â  }
Â  Â  body{
Â  Â  Â  margin:0;
Â  Â  Â  min-height:100vh;
Â  Â  Â  background:var(--bg);
Â  Â  Â  backdrop-filter: blur(14px);
Â  Â  Â  font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
Â  Â  Â  color:var(--text);
Â  Â  }
Â  Â  .wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
Â  Â  h1{margin:0 0 16px;}
Â  Â  .card{background:var(--card-bg);border:1px solid rgba(255,255,255,0.3);border-radius:16px;padding:16px;margin:12px 0;}
Â  Â  .hide{display:none;}

Â  Â  /* tab åˆ— */
Â  Â  .sheet-tabs{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-end;}
Â  Â  .btn-tab{
Â  Â  Â  background:#e5e7eb;
Â  Â  Â  border:1px solid #cbd5f5;
Â  Â  Â  border-radius:4px;
Â  Â  Â  padding:6px 22px;
Â  Â  Â  font-size:.8rem;
Â  Â  Â  cursor:pointer;
Â  Â  Â  color:#000;
Â  Â  Â  min-width:170px;
Â  Â  Â  text-align:center;
Â  Â  }
Â  Â  .btn-tab.active{
Â  Â  Â  background:#1f6fe5;
Â  Â  Â  color:#fff;
Â  Â  Â  border-color:#1f6fe5;
Â  Â  }
Â  Â  #reloadBtn{
Â  Â  Â  margin-left:auto;
Â  Â  Â  background:#fff;
Â  Â  Â  border:1px solid #cbd5f5;
Â  Â  Â  border-radius:4px;
Â  Â  Â  padding:6px 22px;
Â  Â  Â  cursor:pointer;
Â  Â  }

Â  Â  /* è»Šå¡ç‰‡ï¼šä¸€åˆ—å…©è¼› */
Â  Â  .veh-list{
Â  Â  Â  display:grid;
Â  Â  Â  grid-template-columns:repeat(auto-fit, minmax(480px, 1fr));
Â  Â  Â  gap:12px;
Â  Â  Â  margin-top:16px;
Â  Â  }
Â  Â  .veh-card{
Â  Â  Â  background:rgba(255,255,255,0.85);
Â  Â  Â  border-radius:14px;
Â  Â  Â  border:1px solid rgba(148,163,184,0.25);
Â  Â  Â  padding:14px 14px 10px;
Â  Â  Â  display:flex;
Â  Â  Â  flex-direction:column;
Â  Â  Â  gap:10px;
Â  Â  }
Â  Â  body.dark .veh-card{background:rgba(15,23,42,0.28);}
Â  Â  .veh-title-main{font-weight:600;font-size:1rem;margin-bottom:2px;}
Â  Â  .veh-title-sub{font-size:.85rem;opacity:.7;}

Â  Â  .step-row{
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  gap:8px;
Â  Â  Â  margin-bottom:3px; /* ä¸Šä¸‹ 3px */
Â  Â  }
Â  Â  /* æœªæŒ‰éï¼šè—åº•ç™½å­— */
Â  Â  .step-btn{
Â  Â  Â  border:0;
Â  Â  Â  border-radius:10px;
Â  Â  Â  padding:6px 12px 7px;
Â  Â  Â  background:#0f6efc;
Â  Â  Â  color:#fff;
Â  Â  Â  font-size:.74rem;
Â  Â  Â  cursor:pointer;
Â  Â  Â  flex:0 0 auto;
Â  Â  Â  min-width:170px;
Â  Â  Â  text-align:center;
Â  Â  }
Â  Â  /* å·²æŒ‰éï¼šç°è¦æ·±ä¸€é» */
Â  Â  .step-btn.done{
Â  Â  Â  background:#cbd5e1;
Â  Â  Â  color:#0f172a;
Â  Â  Â  cursor:pointer;
Â  Â  }
Â  Â  /* é–ä½çš„ (btn:disabled æœƒè‡ªå‹•å¥—ç”¨) */
Â  Â  .step-btn:disabled,
Â  Â  .step-btn.locked{
Â  Â  Â  background:#94a3b8;
Â  Â  Â  color:#0f172a;
Â  Â  Â  opacity:.65;
Â  Â  Â  cursor:not-allowed;
Â  Â  }
Â  Â  .step-time{
Â  Â  Â  font-size:.7rem;
Â  Â  Â  color:rgba(15,23,42,.55);
Â  Â  Â  min-width:70px;
Â  Â  Â  text-align:right;
Â  Â  }

Â  Â  /* ä¸‹æ‹‰ */
Â  Â  .step-select{
Â  Â  Â  min-width:170px;
Â  Â  Â  border-radius:8px;
Â  Â  Â  padding:5px 8px;
Â  Â  Â  border:1px solid #cbd5e1;
Â  Â  Â  background:#fff;
Â  Â  Â  font-size:.72rem;
Â  Â  }

Â  Â  .notif{position:fixed;right:16px;bottom:16px;background:rgba(15,23,42,.85);color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transform:translateY(20px);transition:.2s;}
Â  Â  .notif.show{opacity:1;transform:translateY(0);}

Â  Â  @media(max-width:768px){
Â  Â  Â  .veh-list{grid-template-columns:1fr;}
Â  Â  Â  .sheet-tabs{gap:10px;}
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="wrap">
Â  Â  <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
Â  Â  Â  <div>
Â  Â  Â  Â  <h1>æ´»å‹•è»Šæµäººæµé€€å ´ç®¡ç†ç³»çµ±</h1>
Â  Â  Â  </div>
Â  Â  Â  <div id="signin"></div>
Â  Â  Â  <div id="userInfo" class="hide" style="font-size:.75rem;"></div>
Â  Â  </div>

Â  Â  Â  Â  <div id="tabs" class="card hide" style="padding-bottom:6px;">
Â  Â  Â  <div class="sheet-tabs" id="sheetTabs"></div>
Â  Â  </div>

Â  Â  <div id="content" class="hide">
Â  Â  Â  <div id="vehList" class="veh-list"></div>
Â  Â  </div>
Â  </div>

Â  <div id="notif" class="notif"></div>

<script>
// --- ä¿®æ­£ï¼šæ‰€æœ‰ JS ç¨‹å¼ç¢¼åˆä½µåˆ°æ­¤å€å¡Š ---

const GOOGLE_CLIENT_ID = '368914333961-504cujbloe9n3v28p4bjsc8c1lh5pg0o.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxbeknXeJ2s2NnIqTwIwNdZnsbiI9UlGkQpSGfHq2TlmnITZ75Ub4ySwn6UGmJk3AXjNg/exec';

const SHEET_CONFIGS = [
Â  {
Â  Â  key: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰',
Â  Â  sheet: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰',
Â  Â  steps: [
Â  Â  Â  'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š',
Â  Â  Â  'Call è»Šä¸Šè¡Œæ',
Â  Â  Â  'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
Â  Â  Â  'è»Šå‰å¾€æ’è»ŠéšŠ',
Â  Â  Â  'è»Šæš«åœä½ç½®',Â  Â  Â  Â  Â  // â† é€™å€‹è¦è®Šä¸‹æ‹‰
Â  Â  Â  'é€€å ´äººå“¡å·²åˆ°é½Š',
Â  Â  Â  'å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°',
Â  Â  Â  'äººå·²å‰å¾€å¹³å°',
Â  Â  Â  'è»Šç¬¬äºŒæ¬¡ä¸ŠéŠè¦½è»Šå¹³å°',
Â  Â  Â  'è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
Â  Â  ]
Â  },
Â  {
Â  Â  key: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰',
Â  Â  sheet: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰',
Â  Â  steps: [
Â  Â  Â  'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š',
Â  Â  Â  'Call è»Šä¸Šè¡Œæ',
Â  Â  Â  'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
Â  Â  Â  'è»Šå‰å¾€æ’è»ŠéšŠ',
Â  Â  Â  'è»Šæš«åœä½ç½®',Â  Â  Â  Â  Â  // â† é€™å€‹è¦è®Šä¸‹æ‹‰
Â  Â  Â  'è»Šå·²é›¢é–‹ç¦ªå ‚å¹³å°'
Â  Â  ]
Â  },
Â  {
Â  Â  key: 'æ°´é™¸å°ˆè»Šé€€å ´',
Â  Â  sheet: 'æ°´é™¸å°ˆè»Šé€€å ´',
Â  Â  // --- ä¿®æ­£ï¼šã€Œæ°´é™¸å°ˆè»Šé€€å ´ã€çš„æ­¥é©Ÿé †åº ---
Â  Â  steps: [
Â  Â  Â  'å·² Call è»Šæ’è»ŠéšŠ',
Â  Â  Â  'å·²æ’å¥½è»ŠéšŠ',
Â  Â  Â  'è»Šæš«åœä½ç½®', Â  Â  Â  Â   // â† ç§»åˆ°ã€Œé€€å ´äººå“¡å·²åˆ°é½Šã€ä¹‹å‰
Â  Â  Â  'é€€å ´äººå“¡å·²åˆ°é½Š',
Â  Â  Â  'å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°',
Â  Â  Â  'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
Â  Â  Â  'è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
Â  Â  ]
Â  },
Â  {
Â  Â  key: 'åœ‹å…‰è™Ÿé€€å ´',
Â  Â  sheet: 'åœ‹å…‰è™Ÿé€€å ´',
Â  Â  steps: [
Â  Â  Â  'æ˜¯å¦ç¶“éé•·åºš',
Â  Â  Â  'é€€å ´äººå“¡å·²åˆ°é½Š',
Â  Â  Â  'è»Šå·²ç¶“ä¸ŠéŠè¦½è»Šå¹³å°',
Â  Â  Â  'è»Šå·²ç¶“é›¢é–‹éŠè¦½è»Šå¹³å°',
Â  Â  Â  'ä¸Šè»Šäººæ•¸'
Â  Â  ]
Â  },
Â  {
Â  Â  key: '288æ³•é’é€€å ´',
Â  Â  sheet: '288æ³•é’é€€å ´',
Â  Â  steps: [
Â  Â  Â  'é€€å ´äººå“¡å·²åˆ°é½Š',
Â  Â  Â  'è»Šå·²ç¶“ä¸ŠéŠè¦½è»Šå¹³å°',
Â  Â  Â  'è»Šå·²ç¶“é›¢é–‹éŠè¦½è»Šå¹³å°'
Â  Â  ]
Â  }
];

// ä¸‰å¼µè¡¨ç”¨åŒä¸€çµ„åœè»Šåœ°é»
const PARKING_OPTIONS = [
Â  'â€”è«‹é¸æ“‡â€”', // é è¨­å€¼
Â  'ç¦ªå ‚å¹³å°',
Â  'æ³•å¤§è·¯ï¼ˆæ³•å¤§ä¸€æ©‹åˆ°æ³•å¿ƒå—è·¯é–“ï¼‰',
Â  'æ³•å¿ƒå—è·¯',
Â  'æ³•é¼“è·¯éˆå±±å‹å¢ƒçŸ³å¾€å¤–',
Â  'æ³•æ–°åŒ—è·¯'
];

let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = [];

window.onload = function(){
Â  google.accounts.id.initialize({
Â  Â  client_id: GOOGLE_CLIENT_ID,
Â  Â  callback: handleCredential
Â  });
Â  google.accounts.id.renderButton(
Â  Â  document.getElementById('signin'),
Â  Â  { theme:'outline', size:'large' }
Â  );
Â  buildTabs();
};

function buildTabs(){
Â  const box = document.getElementById('sheetTabs');
Â  box.innerHTML = '';
Â  SHEET_CONFIGS.forEach(cfg=>{
Â  Â  const b = document.createElement('button');
Â  Â  b.className = 'btn-tab' + (cfg.key===currentSheetKey?' active':'');
Â  Â  b.textContent = cfg.key;
Â  Â  b.onclick = () => {
Â  Â  Â  currentSheetKey = cfg.key;
Â  Â  Â  document.querySelectorAll('.btn-tab').forEach(x=>x.classList.remove('active'));
Â  Â  Â  b.classList.add('active');
Â  Â  Â  loadSheetData(currentSheetKey);
Â  Â  };
Â  Â  box.appendChild(b);
Â  });
Â  const reloadBtn = document.createElement('button');
Â  reloadBtn.id = 'reloadBtn';
Â  reloadBtn.textContent = 'é‡æ–°è¼‰å…¥';
Â  reloadBtn.onclick = reloadSheet;
Â  box.appendChild(reloadBtn);
}

async function handleCredential(resp){
Â  try {
Â  Â  const r = await fetch(API_BASE + '?action=verify', {
Â  Â  Â  method: 'POST',
Â  Â  Â  headers: { 'Content-Type': 'text/plain;charset=utf-8' },
Â  Â  Â  body: JSON.stringify({ idToken: resp.credential })
Â  Â  });
Â  Â  const j = await r.json();
Â  Â  if (j.error) { showNotif('ç™»å…¥å¤±æ•—ï¼š' + j.error, true); return; }
Â  Â  currentUser = j;
Â  Â  document.getElementById('signin').classList.add('hide');
Â  Â  const ui = document.getElementById('userInfo');
Â  Â  ui.classList.remove('hide');
Â  Â  ui.innerHTML = `${j.name||''} &lt;${j.email}&gt; ï½œ æ¬Šé™ï¼š<b>${j.permission}</b>`;
Â  Â  document.getElementById('tabs').classList.remove('hide');
Â  Â  document.getElementById('content').classList.remove('hide');
Â  Â  loadSheetData(currentSheetKey);
Â  } catch (err) {
Â  Â  showNotif('ç™»å…¥éŒ¯èª¤ï¼š' + err.message, true);
Â  }
}

async function loadSheetData(key){
Â  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
Â  document.getElementById('vehList').textContent = 'è®€å–ä¸­...';
Â  const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
Â  const j = await r.json();
Â  if (j.error){ document.getElementById('vehList').textContent = 'âŒ '+j.error; return; }
Â  sheetData = j.values || [];
Â  renderVehicles(cfg, sheetData);
}

// æ‰¾å‡ºè¡¨é ­ + è³‡æ–™åˆ—
function parseSheetData(raw) {
Â  const headerRowIdx = raw.findIndex(row =>
Â  Â  Array.isArray(row) &&
Â  Â  String(row[0] || '').trim() === 'ç·¨è™Ÿ' &&
Â  Â  String(row[1] || '').trim().startsWith('å€åŸŸ') &&
Â  Â  String(row[2] || '').trim() === 'è»Šè™Ÿ'
Â  );
Â  if (headerRowIdx === -1) return { header: [], rows: [], headerRowIdx: -1 };

Â  const header = raw[headerRowIdx].map(c => String(c || '').trim());
Â  const rows = raw
Â  Â  .slice(headerRowIdx + 1)
Â  Â  .filter(r => {
Â  Â  Â  if (!Array.isArray(r)) return false;
Â  Â  Â  const noÂ  Â = String(r[0] || '').trim();
Â  Â  Â  const area = String(r[1] || '').trim();
Â  Â  Â  const carÂ  = String(r[2] || '').trim();
Â  Â  Â  return no && area && car;
Â  Â  });

Â  return { header, rows, headerRowIdx };
}

/* æŠŠ GAS å¯«çš„ ISO / æ—¥æœŸæ™‚é–“ â†’ hh:mm:ss (+8) */
function formatSheetTime(val){
Â  if (!val) return '';

Â  // å·²ç¶“æ˜¯ hh:mm:ss
Â  if (/^\d{1,2}:\d{2}:\d{2}$/.test(val)) {
Â  Â  const parts = val.split(':');
Â  Â  return parts.map(p=>p.padStart(2,'0')).join(':');
Â  }

Â  // 2025/11/2 18:38:24
Â  if (/^\d{4}\/\d{1,2}\/\d{1,2} \d{1,2}:\d{2}:\d{2}$/.test(val)) {
Â  Â  return val.split(' ')[1].split(':').map(p=>p.padStart(2,'0')).join(':');
Â  }

Â  // ISO
Â  const d = new Date(val);
Â  if (isNaN(d.getTime())) {
Â  Â  return val; // çµ¦ä½ åŸå­—ä¸²
Â  }
Â  const tw = new Date(d.getTime() + 8*60*60*1000);
Â  const hh = String(tw.getUTCHours()).padStart(2,'0');
Â  const mm = String(tw.getUTCMinutes()).padStart(2,'0');
Â  const ss = String(tw.getUTCSeconds()).padStart(2,'0');
Â  return `${hh}:${mm}:${ss}`;
}

function renderVehicles(cfg, data){
Â  const box = document.getElementById('vehList');
Â  box.innerHTML = '';

Â  const headerRowIdx = data.findIndex(row =>
Â  Â  Array.isArray(row) &&
Â  Â  String(row[0] || '').trim() === 'ç·¨è™Ÿ' &&
Â  Â  String(row[1] || '').trim().startsWith('å€åŸŸ') &&
Â  Â  String(row[2] || '').trim() === 'è»Šè™Ÿ'
Â  );

Â  if (headerRowIdx === -1) {
Â  Â  box.textContent = 'âŒ æ‰¾ä¸åˆ°è¡¨é ­ï¼ˆè¦æœ‰ã€Œç·¨è™Ÿ / å€åŸŸè»Šæ¬¡ç·¨è™Ÿ / è»Šè™Ÿã€é‚£ä¸€åˆ—ï¼‰';
Â  Â  return;
Â  }

Â  const header = data[headerRowIdx].map(c => String(c || '').trim());

Â  const rows = data
Â  Â  .slice(headerRowIdx + 1)
Â  Â  .filter(r => {
Â  Â  Â  if (!Array.isArray(r)) return false;
Â  Â  Â  const noÂ  Â = String(r[0] || '').trim();
Â  Â  Â  const area = String(r[1] || '').trim();
Â  Â  Â  const carÂ  = String(r[2] || '').trim();
Â  Â  Â  return no && area && car;
Â  Â  });

Â  if (!rows.length){
Â  Â  box.textContent = '(é€™å¼µè¡¨ç›®å‰æ²’æœ‰è»Šè¼›è³‡æ–™)';
Â  Â  return;
Â  }

Â  rows.forEach((row, idx) => {
Â  Â  const area = String(row[1] || '').trim();
Â  Â  const carÂ  = String(row[2] || '').trim();

Â  Â  const card = document.createElement('div');
Â  Â  card.className = 'veh-card';

Â  Â  const title = document.createElement('div');
Â  Â  title.innerHTML = `
Â  Â  Â  <div class="veh-title-main">${area}</div>
Â  Â  Â  <div class="veh-title-sub">${car}</div>
Â  Â  `;
Â  Â  card.appendChild(title);

Â  Â  const stepsBox = document.createElement('div');

Â  Â  cfg.steps.forEach(st => {
Â  Â  Â  const colIdx = header.indexOf(st);
Â  Â  Â  const rowEl = document.createElement('div');
Â  Â  Â  rowEl.className = 'step-row';

Â  Â  Â  // ğŸ”¹ è‹¥æ˜¯ã€Œè»Šæš«åœä½ç½®ã€â†’ ç”¨ä¸‹æ‹‰
Â  Â  Â  if (st === 'è»Šæš«åœä½ç½®') {
Â  Â  Â  Â  const sel = document.createElement('select');
Â  Â  Â  Â  sel.className = 'step-select'; // ä½¿ç”¨ CSS class

Â  Â  Â  Â  PARKING_OPTIONS.forEach(o => {
Â  Â  Â  Â  Â  const op = document.createElement('option');
Â  Â  Â  Â  Â  op.value = o === 'â€”è«‹é¸æ“‡â€”' ? '' : o;
Â  Â  Â  Â  Â  op.textContent = o;
Â  Â  Â  Â  Â  sel.appendChild(op);
Ã‚ Â  Â  Â  });

Â  Â  Â  Â  const curVal = (colIdx !== -1 && row[colIdx]) ? String(row[colIdx]).trim() : '';
Â  Â  Â  Â  if (curVal) sel.value = curVal;

Â  Â  Â  Â  const info = document.createElement('span');
Â  Â  Â  Â  info.className = 'step-time';
Â  Â  Â  Â  info.textContent = curVal || '';

Â  Â  Â  Â  sel.onchange = async () => {
Â  Â  Â  Â  Â  const v = sel.value.trim();
Â  Â  Â  Â  Â  if (colIdx === -1) {
Â  Â  Â  Â  Â  Â  alert('æ­¤å·¥ä½œè¡¨é‚„æ²’æœ‰ã€Œè»Šæš«åœä½ç½®ã€é€™ä¸€æ¬„ï¼Œè«‹å…ˆåœ¨ Google Sheet å»ºæ¬„ä½');
Â  Â  Â  Â  Â  Â  sel.value = '';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // --- ä¿®æ­£ï¼šå‹•æ…‹é–å®š/è§£é–ä¸‹ä¸€å€‹æŒ‰éˆ• ---
Â  Â  Â  Â  Â  const card = sel.closest('.veh-card');
Â  Â  Â  Â  Â  if (card) {
Â  Â  Â  Â  Â  Â  const thisStepIndex = cfg.steps.indexOf('è»Šæš«åœä½ç½®');
Â  Â  Â  Â  Â  Â  if (thisStepIndex > -1 && thisStepIndex + 1 < cfg.steps.length) {
Â  Â  Â  Â  Â  Â  Â  const nextStepName = cfg.steps[thisStepIndex + 1];
Â  Â  Â  Â  Â  Â  Â  // å°‹æ‰¾å…„å¼Ÿå…ƒç´ ä¸­çš„æŒ‰éˆ• (æ›´ç©©å¥çš„ä½œæ³•)
Â  Â  Â  Â  Â  Â  Â  let nextBtn = null;
Â  Â  Â  Â  Â  Â  Â  const allBtns = card.querySelectorAll('.step-btn');
Â  Â  Â  Â  Â  Â  Â  allBtns.forEach(b => {
Â  Â  Â  Â  Â  Â  Â  Â  if (b.textContent === nextStepName) nextBtn = b;
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  if (nextBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  if (v) { // å·²é¸æ“‡
Â  Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.classList.remove('done'); // è®Šè—è‰²
Â  Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  } else { // æœªé¸æ“‡
Â  Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.classList.add('done'); // è®Šç°è‰²
Â  Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // --- ä¿®æ­£ çµæŸ ---

Â  Â  Â  Â  Â  const sheetRow = headerRowIdx + 1 + 1 + idx;
Â  Â  Â  Â  Â  const body = {
Â  Â  Â  Â  Â  Â  sheet: cfg.sheet,
Â  Â  Â  Â  Â  Â  email: currentUser.email,
Â  Â  Â  Â  Â  Â  writes: [{ row: sheetRow, col: colIdx+1, value: v }]
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  const r = await fetch(API_BASE + '?action=update', {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'text/plain;charset=utf-8' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(body)
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const j = await r.json();
Â  Â  Â  Â  Â  if (!j.ok){
Â  Â  Â  Â  Â  Â  showNotif('å¯«å…¥å¤±æ•—ï¼š'+(j.error||'unknown'), true);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  info.textContent = v;
Â  Â  Â  Â  Â  showNotif('å·²å¯«å…¥ã€Œè»Šæš«åœä½ç½®ã€', false);
Â  Â  Â  Â  };

Â  Â  Â  Â  rowEl.appendChild(sel);
Â  Â  Â  Â  rowEl.appendChild(info);
Â  Â  Â  Â  stepsBox.appendChild(rowEl);
Â  Â  Â  Â  card.appendChild(stepsBox);
Â  Â  Â  Â  return; // â† é€™å€‹æ­¥é©ŸçµæŸï¼Œæ›ä¸‹ä¸€å€‹
Â  Â  Â  }

Â  Â  Â  // ğŸ”¹ å…¶ä»–æ­¥é©Ÿï¼šä¸€èˆ¬æŒ‰éˆ•
Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  btn.className = 'step-btn';
Â  Â  Â  btn.textContent = st;

Â  Â  Â  const timeSpan = document.createElement('span');
Â  Â  Â  timeSpan.className = 'step-time';

Â  Â  Â  const rawVal = (colIdx !== -1 && row[colIdx]) ? String(row[colIdx]).trim() : '';
Â  Â  Â  const displayVal = rawVal ? formatSheetTime(rawVal) : '';

Â  Â  Â  if (rawVal) {
Â  Â  Â  Â  btn.classList.add('done');
Â  Â  Â  Â  timeSpan.textContent = displayVal;
Â  Â  Â  }

Â  Â  Â  // ğŸ”’ æ‡‰ç”¨ prevDone é€²è¡Œã€Œåˆå§‹é–å®šã€
Â  Â  Â  const prevOk = prevDone(cfg, header, row, st);
Â  Â  Â  if (!prevOk && !rawVal) {
Â  Â  Â  Â  btn.classList.add('done'); // è®Šç°è‰²
Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  }

Â  Â  Â  const sheetRow = headerRowIdx + 1 + 1 + idx;
Â  Â  Â  btn.onclick = () =>
Â  Â  Â  Â  onStepClick(cfg, sheetRow, header, st, rawVal, btn, timeSpan);

Â  Â  Â  rowEl.appendChild(btn);
Â  Â  Â  rowEl.appendChild(timeSpan);
Â  Â  Â  stepsBox.appendChild(rowEl);
Â  Â  });

Â  Â  card.appendChild(stepsBox);
Â  Â  box.appendChild(card);
Â  });
}

/* æª¢æŸ¥ä¸Šä¸€æ­¥æ˜¯å¦å®Œæˆ */
function prevDone(cfg, header, row, st){
Â  const idx = cfg.steps.indexOf(st);
Â  if (idx === 0) return true;

Â  const prevName = cfg.steps[idx-1];
Â  const colIdx = header.indexOf(prevName);

Â  // ä¸Šä¸€å€‹æ­¥é©Ÿçš„æ¬„ä½åœ¨ Sheet ä¸­ä¸å­˜åœ¨
Â  if (colIdx === -1) {
Â  Â  return false;
Â  }
Â  
Â  // æª¢æŸ¥ Sheet è³‡æ–™ä¸­ï¼Œä¸Šä¸€å€‹æ­¥é©Ÿçš„æ¬„ä½æ˜¯å¦æœ‰å€¼
Â  return !!String(row[colIdx] || '').trim();
}


/* æŒ‰éˆ•å¯«å…¥æ™‚é–“ */
async function onStepClick(cfg, rowNumber, header, st, oldRawVal, btn, span){
Â  if (!currentUser) return alert('è«‹å…ˆç™»å…¥');
Â  if (!['è¼¸å…¥','å…¨åŠŸèƒ½'].includes(currentUser.permission)) return alert('æ¬Šé™ä¸è¶³');

Â  const colIdx = header.indexOf(st);
Â  if (colIdx === -1) return alert('æ­¤æ¬„ä½ä¸å­˜åœ¨ï¼š'+st);

Â  // ç¾åœ¨å°ç£æ™‚é–“ hh:mm:ss
Â  const now = new Date();
Â  const hh = String(now.getHours()).padStart(2,'0');
Â  const mm = String(now.getMinutes()).padStart(2,'0');
Â  const ss = String(now.getSeconds()).padStart(2,'0');
Â  const nowHHMMSS = `${hh}:${mm}:${ss}`;

Â  let userInput;
Â  if (oldRawVal) {
Â  Â  userInput = prompt('æ­¤ç‹€æ…‹å·²æœ‰æ™‚é–“ï¼Œè¦ä¿®æ”¹å—ï¼Ÿï¼ˆç•™ç©ºâ†’æ¸…é™¤ï¼‰', nowHHMMSS);
Â  Â  if (userInput === null) return;
Â  Â  userInput = userInput.trim();
Â  } else {
Â  Â  userInput = nowHHMMSS;
Â  }

Â  let valueToWrite = '';
Â  if (userInput === '') {
Â  Â  valueToWrite = '';
Â  } else if (/^\d{2}:\d{2}:\d{2}$/.test(userInput)) {
Â  Â  // åšæˆã€Œä»Šå¤©å°ç£çš„é€™å€‹æ™‚é–“ã€â†’ å¯«æˆ UTC ISO
Â  Â  const localDate = new Date(
Â  Â  Â  now.getFullYear(),
Â  Â  Â  now.getMonth(),
Â  Â  Â  now.getDate(),
Â  Â  Â  Number(userInput.slice(0,2)),
Â  Â  M Â  Number(userInput.slice(3,5)),
Â  Â  Â  Number(userInput.slice(6,8))
Â  Â  );
Â  Â  const utcMs = localDate.getTime() - 8 * 60 * 60 * 1000;
Â  Â  valueToWrite = new Date(utcMs).toISOString();
Â  } else {
Â  Â  valueToWrite = userInput;
Â  }

Â  const body = {
Â  Â  sheet: cfg.sheet,
Â  Â  email: currentUser.email,
Â  Â  writes: [{ row: rowNumber, col: colIdx+1, value: valueToWrite }]
Â  };

Â  const r = await fetch(API_BASE + '?action=update', {
Â  Â  method:'POST',
Â  Â  headers:{'Content-Type':'text/plain;charset=utf-8'},
Â  Â  body: JSON.stringify(body)
Â  });
Â  const j = await r.json();
Â  if (!j.ok){
Â  Â  showNotif('å¯«å…¥å¤±æ•—ï¼š'+(j.error||'unknown'), true);
Â  Â  return;
Â  }

Â  // å‰ç«¯åŒæ­¥
Â  if (userInput === '') {
Â  Â  span.textContent = '';
Â  Â  btn.classList.remove('done');
Â  } else {
Â  Â  span.textContent = formatSheetTime(valueToWrite);
Â  Â  btn.classList.add('done');
Â  }
Â  showNotif('å·²å¯«å…¥ã€Œ'+st+'ã€', false);
// --- âœ… ä¿®æ­£ï¼šç§»é™¤éŒ¯èª¤çš„ 'Route 6' æ–‡å­— ---
}

function reloadSheet(){ loadSheetData(currentSheetKey); }

function showNotif(msg, isErr){
Â  const box = document.getElementById('notif');
Â  box.textContent = msg;
Â  box.style.background = isErr ? 'rgba(248,113,113,.9)' : 'rgba(15,23,42,.85)';
Â  box.classList.add('show');
Â  setTimeout(()=>box.classList.remove('show'), 2500);
}
</script>
</body>
</html>
