<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>車流人流退場情報</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
/* =========== Design Tokens =========== */
:root{
  --radius-md:10px; --radius-lg:12px; --radius-pill: 50px; /* 增加 Pill 圓角 */

  /* 基礎色 */
  --primary-600:#1f6fe5;
  --gray-50:#f8fafc;  --gray-100:#f1f5f9; --gray-200:#e5e7eb;
  --gray-500:#64748b; --gray-800:#1f2937; --gray-900:#0f172a;

  --surface: rgba(255,255,255,.9); /* 讓背景稍微不透明一點，更有質感 */
  --page-bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
  --text-strong: var(--gray-900);
  --text: var(--gray-800);
  --text-muted: var(--gray-500);
  --border: rgba(148,163,184,0.4);
  --focus:#93c5fd;

  --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

  /* 字級 */
  --fz-display:28px; --lh-display:36px; --fw-display:700;
  --fz-title:18px;   --lh-title:24px;   --fw-title:700;
  --fz-sub:14px;     --lh-sub:20px;     --fw-sub:600;
  --fz-body:14px;    --lh-body:20px;    --fw-body:400;
}

body.dark{
  --surface: rgba(15,23,42,.65);
  --page-bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
  --text-strong:#e5eaf3; --text:#e2e8f0; --text-muted:#93a3b5;
  --border: rgba(148,163,184,0.25);
}

/* =========== Base =========== */
body{
  margin:0; min-height:100vh;
  background:var(--page-bg); color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;
}
.wrap{max-width:1200px; margin:0 auto; padding:16px 16px 48px;} /* 加寬一點讓按鈕好排 */
h1{margin:0;font-size:var(--fz-display);line-height:var(--lh-display);font-weight:var(--fw-display);color:var(--text-strong);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-card);padding:16px;margin:12px 0;}
.hide{ display:none !important; }

/* =========== 按鈕容器樣式 (新) =========== */
/* 這是包裹那一排 Button 的白色長條容器 */
.tab-container-styled {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: var(--radius-pill); /* 像圖片一樣的圓角長條 */
  padding: 6px 8px;
  display: inline-flex;
  gap: 8px;
  align-items: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  flex-wrap: wrap; /* 手機版自動折行 */
}
body.dark .tab-container-styled { background: rgba(30, 41, 59, 0.8); }

/* =========== 通用 Tab 按鈕樣式 (新) =========== */
.btn-tab {
  background: #fff;
  color: var(--gray-500);
  border: 1px solid transparent; /* 預設無邊框，或淺灰 */
  border-radius: var(--radius-pill);
  padding: 6px 16px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  min-width: 80px;
  text-align: center;
  transition: all 0.2s ease;
  white-space: nowrap;
}
body.dark .btn-tab { background: transparent; color: var(--gray-300); }

.btn-tab:hover {
  background: var(--gray-50);
  color: var(--primary-600);
}

/* 預設選中樣式 (藍色) */
.btn-tab.active {
  background: var(--primary-600);
  color: #fff;
  border-color: var(--primary-600);
  box-shadow: 0 2px 4px rgba(31, 111, 229, 0.3);
}

/* 上方 Main Tabs 的外框樣式 (藍框白底) */
.main-tab {
  background: #fff;
  color: var(--primary-600);
  border: 1px solid var(--primary-600);
  border-radius: var(--radius-pill);
  padding: 6px 18px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  min-width: 100px;
  text-align: center;
  transition: all 0.2s;
}
.main-tab:hover { background: rgba(31,111,229,0.05); }
.main-tab.active {
  background: var(--primary-600);
  color: #fff;
  box-shadow: 0 4px 6px rgba(31, 111, 229, 0.25);
}

/* =========== 多彩按鈕定義 (針對下方分類) =========== */
/* 定義顏色變數 */
.theme-teal   { --theme-color: #059669; } /* 綠色 */
.theme-orange { --theme-color: #d97706; } /* 橘色 */
.theme-purple { --theme-color: #7c3aed; } /* 紫色 */
.theme-pink   { --theme-color: #db2777; } /* 桃紅 */

/* 多彩按鈕的通用行為：未選中時是白底+有色邊框+有色文字 */
.btn-tab.colored-btn {
  color: var(--theme-color);
  border: 1px solid var(--theme-color);
  background: #fff;
}
body.dark .btn-tab.colored-btn { background: transparent; }

/* 多彩按鈕：Hover */
.btn-tab.colored-btn:hover {
  background: color-mix(in srgb, var(--theme-color), white 90%);
}

/* 多彩按鈕：Active (變成實心) */
.btn-tab.colored-btn.active {
  background: var(--theme-color);
  color: #fff;
  border-color: var(--theme-color);
  box-shadow: 0 4px 6px color-mix(in srgb, var(--theme-color), transparent 60%);
}


/* ======= Refresh Bar & Controls ======= */
.refresh-bar{ display:flex; gap:12px; align-items:center; justify-content:flex-end; }
.clock{ font-weight:800; font-variant-numeric: tabular-nums; letter-spacing:1px; font-size: 1.1rem; color: var(--text-strong); }
.seg-group{ display:flex; gap:6px; background: #fff; border:1px solid var(--border); padding:4px; border-radius: var(--radius-pill); }
body.dark .seg-group { background: rgba(0,0,0,0.2); }

.seg-btn{
  background:transparent; color:var(--text-muted);
  border:none; border-radius:var(--radius-pill);
  padding:4px 12px; font-size:13px; font-weight:600; cursor:pointer;
  transition: all 0.2s;
}
.seg-btn:hover{ color:var(--primary-600); background: rgba(31,111,229,.05); }
.seg-btn.active{ background: #fff; color:var(--primary-600); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
body.dark .seg-btn.active{ background: var(--gray-800); color: #fff; }

/* 立即更新按鈕特別樣式 */
.seg-btn.now-btn { color: var(--primary-600); border: 1px solid var(--primary-600); margin-left: 4px; }
.seg-btn.now-btn:hover { background: var(--primary-600); color: #fff; }


/* =========== Layout Grids =========== */
/* 頂部佈局：標題左，登入右；下一行 Tab 左，時間右 */
.topbar-grid {
  display: grid;
  grid-template-columns: auto 1fr;
  grid-template-rows: auto auto;
  gap: 12px 24px;
  align-items: center;
  margin-bottom: 8px;
}
.topbar-grid .left-title { grid-area: 1 / 1 / 2 / 2; }
.topbar-grid .right-user  { grid-area: 1 / 2 / 2 / 3; justify-self: end; display:flex; align-items:center; gap:12px; }
.topbar-grid .left-tabs   { grid-area: 2 / 1 / 3 / 3; } /* Tab 佔滿整行 */
.topbar-grid .right-clock { grid-area: 1 / 2 / 2 / 3; justify-self: end; display:flex; align-items:center; gap:16px; } 

/* 讓時間顯示在標題右側 (視窗夠寬時) */
@media (min-width: 768px) {
    .topbar-grid {
        grid-template-columns: auto 1fr auto;
        grid-template-rows: auto auto;
    }
    .topbar-grid .left-title { grid-area: 1 / 1 / 2 / 2; }
    .topbar-grid .right-clock { grid-area: 1 / 2 / 2 / 3; } /* 時間放第一行右邊 */
    .topbar-grid .right-user { grid-area: 1 / 3 / 2 / 4; }  /* 使用者放更右邊 */
    .topbar-grid .left-tabs { grid-area: 2 / 1 / 3 / 4; display: flex; justify-content: space-between; align-items: center; } /* Tabs 放第二行 */
}

/* =========== 內容卡片樣式 =========== */
.veh-list{display:grid;grid-template-columns:repeat(auto-fit, minmax(350px,1fr));gap:12px;margin-top:12px;}
.veh-card{
  background:#fff; border-radius:var(--radius-lg); border:1px solid var(--border); padding:16px;
  display:flex; flex-direction:column; gap:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}
body.dark .veh-card{background:rgba(15,23,42,0.4);}
.veh-title-main{font-weight:700;font-size:1.25rem; color:var(--text-strong);}
.veh-title-sub{font-size:0.95rem; color:var(--text-muted);}

/* 步驟列 */
.step-row{display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 4px 0; border-bottom: 1px dashed var(--gray-200); }
.step-row:last-child { border-bottom: none; }
.step-label { font-weight: 600; color: var(--text); flex: 1; }
.step-time{ font-family: monospace; font-size: 1rem; font-weight: 600; color: var(--primary-600); }
body.dark .step-time{color:#60a5fa}

/* Buttons inside cards */
.btn{
  border:0;border-radius:6px;padding:6px 12px;
  background:#0f6efc;color:#fff;font-size:14px;font-weight:500;cursor:pointer;
  transition:.2s;
}
.btn:hover{ filter: brightness(1.1); transform: translateY(-1px); }
.btn:active{ transform: translateY(0); }
.btn--secondary{background:#fff;color:var(--primary-600);border:1px solid var(--border);} 
.btn--sm{ padding: 4px 10px; font-size: 13px; }

/* Dashboard 統計卡片 */
.stat-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-top: 10px;}
.stat-card{ border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px; text-align: center; }
body.dark .stat-card{ background:rgba(15,23,42,.30); }
.stat-head{ font-weight:700; margin-bottom:8px; color:var(--text-strong); font-size: 1rem; }
.stat-row{ display:flex; gap:8px; justify-content: center; }
.stat-pill{
    flex: 1; border-radius: 8px; padding: 8px; cursor: pointer; background: var(--gray-50); border: 1px solid transparent;
    transition: all 0.2s;
}
.stat-pill:hover { border-color: var(--primary-600); background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.stat-num{ font-size: 28px; font-weight: 800; line-height: 1; }
.stat-num.done{ color:#2563eb; }
.stat-num.todo{ color:#ef4444; }
.stat-label{ font-size: 13px; color: var(--text-muted); margin-top: 4px; font-weight: 600; }

/* 停車位置 */
.loc-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-top:10px; }
.loc-pill{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; display:flex; flex-direction:column; align-items:center; cursor:pointer; position: relative; overflow: hidden; }
.loc-pill:hover { border-color: var(--primary-600); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
.loc-name{ font-weight:700; font-size: 15px; z-index: 1; }
.loc-num{ font-size:32px; font-weight:900; color:#2563eb; z-index: 1; margin: 4px 0; }

/* Modal */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); z-index: 9998; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 24px; border-radius: 16px; min-width: 320px; max-width: 90vw; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 9999; animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes modalIn { from { opacity: 0; transform: translate(-50%, -48%) scale(0.96); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
.modal .dash-close{ position:absolute; right:16px; top:16px; font-size:24px; color: var(--gray-400); cursor:pointer; padding: 4px; border-radius: 50%; transition: .2s; }
.modal .dash-close:hover { background: var(--gray-100); color: var(--gray-800); }

/* Loading */
#loading.loading{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(5px); z-index: 10000; }
#loading.loading.show{ display: flex; }
.spinner{ width:30px; height:30px; border:3px solid var(--gray-200); border-top-color: var(--primary-600); border-radius: 50%; animation: spin .8s linear infinite; }
@keyframes spin{ to{ transform: rotate(360deg); } }

/* =========== Login View (修正版) =========== */
/* 登入模式下，隱藏原本的 Topbar 和所有內容 */
body.login #dash-topbar,
body.login .tab-pane,
body.login .refresh-bar,
body.login #notif, 
body.login #userInfo {
  display: none !important;
}

/* 登入模式下，顯示並排版登入區塊 */
body.login #login-center {
  display: flex !important;
  height: 85vh; /* 讓登入框垂直置中 */
  align-items: center;
  justify-content: center;
}

/* 登入卡片美化 */
.login-card {
  background: rgba(255, 255, 255, 0.95);
  padding: 40px 60px;
  border-radius: 24px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 24px;
  backdrop-filter: blur(10px);
}

.login-title {
  font-size: 32px;
  color: var(--primary-600);
  margin: 0;
  font-weight: 800;
  letter-spacing: 1px;
}

/* 個別情報樣式 */
.indiv-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: var(--shadow-card); transition: transform .2s; cursor: pointer; }
.indiv-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-float); }
.single-line { text-align: center; margin-bottom: 6px; }

</style>
</head>
<body>

<div class="wrap">
  
  <div id="login-center" class="hide">
    <div class="login-card">
      <h1 class="login-title">車流人流退場情報</h1>
      <div id="signin"></div>
    </div>
  </div>

  <div class="topbar-grid" id="dash-topbar">
    <div class="left-title">
      <h1 id="pageTitle">車流人流退場情報</h1>
    </div>

    <div class="right-clock">
        <div class="clock" id="clockDisplay">--:--:--</div>
        <div id="userInfo" class="hide" style="font-size: 14px; text-align: right;">
           <span id="userDisplay"></span>
           <button id="logoutBtn" class="btn btn--secondary btn--sm" style="margin-left: 8px;">登出</button>
        </div>
    </div>

    <div class="left-tabs">
        <div class="tab-container-styled">
            <button class="main-tab active" data-target="pane-dashboard2">最新狀態</button>
            <button class="main-tab" data-target="pane-single">個別情報</button>
            <button class="main-tab" data-target="pane-punch">登錄與修改</button>
        </div>
        <div class="refresh-bar">
             <div class="seg-group" id="refreshControls"></div>
        </div>
    </div>
  </div>

  <div id="mainTabs" class="hide"></div> <div id="pane-punch" class="tab-pane hide">
    <div id="tabs" class="card" style="padding-bottom:6px;">
      <div class="sheet-tabs" id="sheetTabs"></div>
    </div>
    <div id="content" class="hide">
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <div id="pane-dashboard2" class="tab-pane hide">
    <div style="margin: 16px 0;">
        <div class="tab-container-styled" id="dashboardTabs2"></div>
    </div>
    <div id="dashboard2"></div>
  </div>

  <div id="pane-single" class="tab-pane hide">
    <div class="card" id="singleControlsCard">
      <div class="single-controls" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="selSheet" class="step-select" style="padding: 8px; border-radius: 8px; flex: 1; min-width: 150px;">
          <option value="">— 全部 Tab —</option>
        </select>
        <select id="selArea" class="step-select" style="padding: 8px; border-radius: 8px; flex: 1; min-width: 150px;">
          <option value="">— 全部 區域車次編號 —</option>
        </select>
        <select id="selCar" class="step-select" style="padding: 8px; border-radius: 8px; flex: 1; min-width: 150px;">
          <option value="">— 全部 車號 —</option>
        </select>
      </div>
      <div class="single-actions" style="margin-top: 12px; text-align: right;">
        <button id="btnQuery" class="btn btn--primary">查詢</button>
        <button id="btnReset" class="btn btn--secondary">全部重設</button>
      </div>
    </div>
    <div id="singleResults" class="single-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;"></div>
  </div>

  <div id="pane-dashboard" class="tab-pane hide">
    <div class="card"><div id="dashboardTabs"></div></div>
    <div id="dashboard"></div>
  </div>

</div>

<div id="notif" class="notif"></div>
<div id="loading" class="loading"><div class="spinner"></div></div>

<script>
/* ============ CONFIG & SETUP ============ */
const GOOGLE_CLIENT_ID = '368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxjGHiVKpNMG84OIHIvX4tGYgJ7gksxT0PItegG-7bpSeumnqgMPfwo-1Ocs1l9rMxC/exec';

const SHEET_CONFIGS = [
  { key:'地區專車退場（遊覽車平台）', sheet:'地區專車退場（遊覽車平台）', colorClass: 'theme-teal', steps:[
    '車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置',
    '退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台','車第二次上遊覽車平台','車已離開遊覽車平台'
  ]},
  { key:'地區專車退場（禪堂平台）', sheet:'地區專車退場（禪堂平台）', colorClass: 'theme-orange', steps:[
    '車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','車已離開禪堂平台'
  ]},
  { key:'水陸專車退場', sheet:'水陸專車退場', colorClass: 'theme-purple', steps:[
    '已 Call 車排車隊','已排好車隊','退場人員已到齊','已 Call 車上遊覽車平台','車已上遊覽車平台','車暫停位置','車已離開遊覽車平台'
  ]},
  { key:'288法青退場', sheet:'288法青退場', colorClass: 'theme-pink', steps:[
    '退場人員已到齊','車已經上遊覽車平台','車已經離開遊覽車平台'
  ]}
];
const STOP_OPTIONS = ['禪堂平台','法心北路','法心南路（西）','法心南路（東）','法大路'];

const REFRESH_PRESETS = [
  { label:'5分',  ms: 5*60*1000 },
  { label:'2分',  ms: 2*60*1000 },
  { label:'60秒', ms: 60*1000 },
  { label:'30秒', ms: 30*1000 }
];
const REFRESH_STORAGE_KEY = 'dash_refresh_ms';
let refreshMs = parseInt(localStorage.getItem(REFRESH_STORAGE_KEY) || (2*60*1000), 10);

let currentUser = null;
let idToken = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let currentDashFilter2 = 'ALL';
let dashTimer = null;
let ALL_SHEETS = {};
let activeTodoModals = new Set();
let SINGLE_ITEMS = [];

/* ============ INITIALIZATION ============ */
window.onload = function(){
  startClock();
  buildRefreshControls();
  updateRefreshButtonsUI();

  // Tab 切換事件綁定 (Top Buttons)
  document.querySelectorAll('.tab-container-styled .main-tab').forEach(btn => {
      btn.addEventListener('click', () => {
          switchPane(btn.dataset.target);
      });
  });

  const saved = localStorage.getItem('ddcc_user_token');
  if (saved) {
    idToken = saved;
    // 驗證 Token (簡化版, 實際應 call API)
    fetch(API_BASE + '?action=verify', {
      method: 'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify({ idToken })
    }).then(r=>r.json()).then(j=>{
       if(j.error) throw new Error(j.error);
       currentUser = j;
       finishLoginUI();
       loadSheetData(currentSheetKey); // 預載
    }).catch(e=>{
       logout();
       initGoogleSignIn();
    });
  } else {
    initGoogleSignIn();
  }
  
  document.getElementById('logoutBtn').addEventListener('click', logout);
};

/* ============ UI BUILDERS ============ */

/* ★★★ 重點修改：建立 5 個不同顏色的按鈕 ★★★ */
function buildDashboardTabs2(){
  const box = document.getElementById('dashboardTabs2');
  if (!box) return;
  box.innerHTML = '';

  // 1. 所有車輛 (藍色預設)
  const allBtn = document.createElement('button');
  allBtn.className = 'btn-tab active'; // 預設選中
  allBtn.textContent = '所有車輛';
  allBtn.dataset.key = 'ALL';
  allBtn.onclick = () => onDashTabClick(allBtn, 'ALL');
  box.appendChild(allBtn);

  // 2. 其他 4 個分類 (使用 SHEET_CONFIGS 中的顏色設定)
  SHEET_CONFIGS.forEach(cfg => {
    const btn = document.createElement('button');
    // 加入 colored-btn 和對應的 theme class
    btn.className = `btn-tab colored-btn ${cfg.colorClass || ''}`;
    btn.textContent = cfg.key;
    btn.dataset.key = cfg.key;
    btn.onclick = () => onDashTabClick(btn, cfg.key);
    box.appendChild(btn);
  });
}

function onDashTabClick(btn, key) {
    if (currentDashFilter2 === key) return;
    currentDashFilter2 = key;
    
    // 更新樣式
    const container = document.getElementById('dashboardTabs2');
    container.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    buildDashboard2(false);
}

function buildRefreshControls(){
  const box = document.getElementById('refreshControls');
  if(!box) return;
  box.innerHTML = '';
  
  REFRESH_PRESETS.forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'seg-btn';
    btn.textContent = p.label;
    btn.dataset.ms = p.ms;
    btn.onclick = ()=> {
        refreshMs = p.ms;
        localStorage.setItem(REFRESH_STORAGE_KEY, refreshMs);
        updateRefreshButtonsUI();
        if(isDashboardVisible()) startDashboardAutoRefresh();
        showNotif(`已設定更新頻率：${p.label}`, false);
    };
    box.appendChild(btn);
  });
  
  const nowBtn = document.createElement('button');
  nowBtn.className = 'seg-btn now-btn';
  nowBtn.textContent = '立即更新';
  nowBtn.onclick = () => {
      if(isDashboardVisible()) {
          buildDashboard2(true);
          refreshAllActiveTodoModals();
          showNotif('已重新整理', false);
      } else {
          showNotif('請先切換至「最新狀態」', true);
      }
  };
  box.appendChild(nowBtn);
}

function updateRefreshButtonsUI(){
    document.querySelectorAll('#refreshControls .seg-btn').forEach(b => {
        if(b.classList.contains('now-btn')) return;
        const ms = parseInt(b.dataset.ms);
        b.classList.toggle('active', ms === refreshMs);
    });
}

function startClock(){
  const el = document.getElementById('clockDisplay');
  setInterval(() => {
    const d = new Date();
    el.textContent = d.toLocaleTimeString('zh-TW', {hour12:false});
  }, 1000);
}

/* ============ CORE LOGIC ============ */

function switchPane(targetId){
  if(!currentUser) return;
  
  // 更新 Top Buttons 狀態
  document.querySelectorAll('.tab-container-styled .main-tab').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.target === targetId);
  });

  document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hide'));
  const target = document.getElementById(targetId);
  if(target) target.classList.remove('hide');

  if(targetId === 'pane-dashboard2'){
      if(!document.getElementById('dashboardTabs2').hasChildNodes()){
          buildDashboardTabs2();
      }
      buildDashboard2(false);
      startDashboardAutoRefresh();
  } else if (targetId === 'pane-punch') {
      stopDashboardAutoRefresh();
      buildTabs(); // 打卡頁 Tabs
      loadSheetData(currentSheetKey);
  } else if (targetId === 'pane-single') {
      stopDashboardAutoRefresh();
      initSinglePage();
  } else {
      stopDashboardAutoRefresh();
  }
}

function isDashboardVisible(){
    return !document.getElementById('pane-dashboard2').classList.contains('hide');
}

function startDashboardAutoRefresh(){
    stopDashboardAutoRefresh();
    dashTimer = setInterval(()=>{
        if(isDashboardVisible()){
            buildDashboard2(true);
            refreshAllActiveTodoModals();
        }
    }, refreshMs);
}
function stopDashboardAutoRefresh(){
    if(dashTimer) clearInterval(dashTimer);
}

/* ============ GOOGLE AUTH ============ */
function initGoogleSignIn() {
    // 加上 login class，CSS 會自動隱藏儀表板，顯示 login-center
    document.body.classList.add('login');
    
    // 確保登入按鈕容器是乾淨的
    const signinDiv = document.getElementById('signin');
    signinDiv.innerHTML = ''; 
    signinDiv.classList.remove('hide');

    // 重新渲染 Google 按鈕
    google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredential });
    google.accounts.id.renderButton(signinDiv, { theme:'outline', size:'large', shape:'pill' });
}
async function handleCredential(resp){
    idToken = resp.credential;
    localStorage.setItem('ddcc_user_token', idToken);
    try {
        const r = await fetch(API_BASE + '?action=verify', { method:'POST', body:JSON.stringify({idToken}) });
        const j = await r.json();
        if(j.error) throw new Error(j.error);
        currentUser = j;
        finishLoginUI();
    } catch(e) { showNotif(e.message, true); }
}
function finishLoginUI(){
    // 移除 login class，CSS 會自動隱藏 login-center，顯示儀表板
    document.body.classList.remove('login');
    
    document.getElementById('userInfo').classList.remove('hide');
    document.getElementById('userDisplay').innerHTML = `<b>${currentUser.name}</b> (${currentUser.permission})`;
    
    // 進來後預設切換到儀表板
    switchPane('pane-dashboard2'); 
}
function logout(){
    localStorage.removeItem('ddcc_user_token');
    location.reload();
}

/* ============ DATA FETCHING & RENDERING (Simplified) ============ */
/* 這裡保留您原有的核心邏輯，僅適配新 UI */

// 1. 打卡頁 Tabs
function buildTabs(){
    const box = document.getElementById('sheetTabs');
    box.innerHTML = '';
    SHEET_CONFIGS.forEach(cfg => {
        const btn = document.createElement('button');
        btn.className = 'btn-tab' + (cfg.key===currentSheetKey ? ' active' : '');
        btn.textContent = cfg.key;
        btn.onclick = () => {
            currentSheetKey = cfg.key;
            buildTabs(); // 重繪 active
            loadSheetData(cfg.key);
        };
        box.appendChild(btn);
    });
}

// 2. 儀表板渲染 (Dashboard 2)
async function buildDashboard2(silent){
    if(!silent) showLoading();
    try {
        const requests = SHEET_CONFIGS.map(cfg => 
            fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}&idToken=${idToken}`)
            .then(r=>r.json())
            .then(j=> ({ key:cfg.key, cfg, values:j.values||[] }))
        );
        const results = await Promise.all(requests);
        
        // 整理資料
        ALL_SHEETS = {};
        results.forEach(res => {
            const headIdx = res.values.findIndex(r => r[0]==='編號' && String(r[1]).startsWith('區域'));
            ALL_SHEETS[res.key] = {
                cfg: res.cfg,
                header: headIdx>=0 ? res.values[headIdx] : [],
                rows: headIdx>=0 ? res.values.slice(headIdx+1) : [],
                headerIdx: headIdx
            };
        });

        renderDashboardUI();
    } catch(e) { console.error(e); }
    if(!silent) hideLoading();
}

function renderDashboardUI(){
    const container = document.getElementById('dashboard2');
    container.innerHTML = '';

    SHEET_CONFIGS.forEach(cfg => {
        // 篩選邏輯
        if(currentDashFilter2 !== 'ALL' && currentDashFilter2 !== cfg.key) return;

        const data = ALL_SHEETS[cfg.key];
        if(!data || !data.rows.length) return;

        const section = document.createElement('section');
        section.className = 'card';
        // 標題帶顏色條
        section.style.borderTop = `4px solid var(--primary-600)`;
        if(cfg.colorClass === 'theme-teal') section.style.borderTopColor = '#059669';
        if(cfg.colorClass === 'theme-orange') section.style.borderTopColor = '#d97706';
        if(cfg.colorClass === 'theme-purple') section.style.borderTopColor = '#7c3aed';
        if(cfg.colorClass === 'theme-pink') section.style.borderTopColor = '#db2777';

        const title = document.createElement('h3');
        title.textContent = cfg.key;
        title.style.margin = '0 0 16px 0';
        section.appendChild(title);

        // 統計邏輯 (簡化版：只算完成/未完成)
        const grid = document.createElement('div');
        grid.className = 'stat-grid';
        
        cfg.steps.forEach(step => {
            if(step === '車暫停位置') return; // 跳過位置
            const colIdx = data.header.indexOf(step);
            let done=0, todo=0;
            data.rows.forEach(r => {
                const val = r[colIdx];
                (val && val !== '—') ? done++ : todo++;
            });

            const card = document.createElement('div');
            card.className = 'stat-card';
            card
