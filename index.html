<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è»Šè¼›è³‡è¨Šå„€è¡¨æ¿ï½œæ•´é«”æƒ…å ±ï¼‹å€‹åˆ¥æƒ…å ±</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* ===== åŸºç¤è‰²ç¥¨ï¼ˆæ²¿ç”¨ï¼Œå¯æŒ‰éœ€æ›¿æ›ï¼‰ ===== */
    :root{
      --bg:#ffffff;
      --fg:#111214;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --primary-50:#edf5ff;
      --primary-100:#d7e7ff;
      --primary-200:#b7d3ff;
      --primary-300:#8db7ff;
      --primary-400:#5e96ff;
      --primary-500:#3b82f6;
      --primary-600:#1f6fe5;
      --primary-700:#1a58bb;
      --accent:#10b981;
      --danger:#ef4444;

      --radius:14px;

      --btn-hover-bg: rgba(31,111,229,.06);
      --btn-active-bg: rgba(31,111,229,.12);
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg:#0b0c0e;
        --fg:#e8eaed;
        --muted:#a9b0bb;
        --border:#20242a;
        --card:#0f1115;
        --btn-hover-bg: rgba(99,132,255,.12);
        --btn-active-bg: rgba(99,132,255,.18);
      }
    }
    body{
      margin:0;
      font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei","å¾®è»Ÿæ­£é»‘é«”",Roboto,Helvetica,Arial,"Noto Sans CJK TC","PingFang TC","Noto Sans",sans-serif;
      color:var(--fg);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    *{ box-sizing:border-box; }

    /* ===== Layout ===== */
    header{
      position:sticky; top:0; z-index:50;
      background:var(--card);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; gap:16px;
      padding:12px 16px;
    }
    .brand{ font-weight:700; letter-spacing:.3px; }
    .spacer{ flex:1; }
    .btn, button{
      appearance:none; border:1px solid var(--border);
      background:#fff0; color:var(--fg);
      border-radius:10px; padding:8px 12px; cursor:pointer;
      transition:.15s ease;
    }
    .btn:hover{ background:var(--btn-hover-bg); }
    .btn:active{ background:var(--btn-active-bg); }
    .btn--primary{
      border-color:var(--primary-600);
      color:var(--primary-600);
    }
    .btn--danger{
      border-color:var(--danger);
      color:var(--danger);
    }
    .btn--secondary{
      border-color:var(--border); color:var(--muted);
    }
    .seg, .tabs{
      display:flex; align-items:center; gap:8px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px; padding:6px;
    }
    .seg .seg-btn, .tabs .tab{
      border:none; padding:8px 12px; border-radius:8px; cursor:pointer;
      color:var(--muted); background:transparent;
    }
    .seg .seg-btn.active, .tabs .tab.active{
      color:var(--primary-600); background:var(--btn-hover-bg);
    }

    main{ padding:16px; max-width:1200px; margin:0 auto; }

    /* ===== é€šç”¨å¡ç‰‡ ===== */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .section{ margin:16px 0 24px; }
    .section .hd{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    .hd .title{ font-weight:700; font-size:16px; }
    .hd .muted{ color:var(--muted); }

    /* ===== å–®å¡ï¼ˆå€‹åˆ¥æƒ…å ±ã€é€šç”¨åç‰‡ï¼‰ ===== */
    .single-list{
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
    }
    .single-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px 14px;
      display:flex; flex-direction:column; gap:6px;
      cursor:pointer; transition:transform .08s ease, background .15s ease;
      min-height:96px; justify-content:center; align-items:center; text-align:center;
    }
    .single-card:hover{ background:var(--btn-hover-bg); transform:translateY(-1px); }
    .single-line{ font-size:15px; }
    .single-line:nth-child(1){ font-weight:700; }
    .single-line:nth-child(2){ letter-spacing:.2px; }
    .single-line:nth-child(3){ color:var(--muted); }

    /* ===== å„€è¡¨æ¿ç°¡å¡ï¼ˆç¾¤çµ„çµ±è¨ˆç”¨ï¼‰ ===== */
    .veh-grid{
      display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
      gap:12px;
    }
    .veh-card{
      background:var(--card); border:1px solid var(--border);
      border-radius:14px; padding:14px;
      display:flex; flex-direction:column; gap:8px;
    }
    .veh-top{ display:flex; align-items:center; justify-content:space-between; }
    .veh-title{ font-weight:700; }
    .veh-stat{ display:flex; gap:8px; color:var(--muted); font-size:13px; }
    .veh-actions{ display:flex; gap:8px; justify-content:flex-end; }

    /* ===== è¡¨å–®/é¸å–® ===== */
    .row{ display:flex; flex-wrap:wrap; gap:8px; }
    select, input{
      border:1px solid var(--border); background:transparent; color:var(--fg);
      border-radius:10px; padding:8px 10px;
    }
    label{ color:var(--muted); font-size:13px; }
    .field{ display:flex; gap:6px; align-items:center; }

    /* ===== é€šçŸ¥èˆ‡ Loading ===== */
    .notif{
      position: fixed; right:12px; bottom:12px; z-index:100;
      display:flex; flex-direction:column; gap:8px; width:min(360px,90vw);
    }
    .toast{
      background:var(--card); border:1px solid var(--border);
      border-radius:12px; padding:10px 12px; box-shadow:0 2px 12px rgba(0,0,0,.08);
    }
    .loading-mask{
      position:fixed; inset:0; background:rgba(0,0,0,.15);
      display:flex; align-items:center; justify-content:center; z-index:90;
      backdrop-filter: blur(2px);
    }
    .loading-box{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px 18px; }

    /* ===== Modalï¼ˆä»¥ createModal + openModal æ§åˆ¶ï¼‰ ===== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:80; display:flex; align-items:center; justify-content:center;
    }
    .modal{
      width:min(520px,90vw); background:var(--card); color:var(--fg);
      border:1px solid var(--border); border-radius:16px; padding:16px;
      max-height:80vh; overflow:auto;
    }
    .modal h3{ margin:0 0 10px; font-size:18px; }
    .modal .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }

    /* ===== Tabs ===== */
    .tabs-bar{ display:flex; gap:8px; margin-left:4px; }
    .tab{ border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer; }
    .tab.active{ color:var(--primary-600); background:var(--btn-hover-bg); border-color:var(--primary-600); }

    /* ===== å°å·¥å…· ===== */
    .muted{ color:var(--muted); }
    .hidden{ display:none !important; }

  </style>
</head>
<body>
<header>
  <div class="brand">ğŸš— è»Šè¼›è³‡è¨Šå„€è¡¨æ¿</div>
  <div class="tabs-bar" id="mainTabs">
    <button class="tab active main-tab" data-target="pane-dashboard">æ•´é«”æƒ…å ±</button>
    <button class="tab main-tab" data-target="pane-single">å€‹åˆ¥æƒ…å ±</button>
  </div>
  <div class="spacer"></div>
  <div id="clock" class="muted"></div>
  <button id="btnLogin" class="btn btn--primary">ç™»å…¥ Google</button>
  <button id="btnLogout" class="btn btn--secondary hidden">ç™»å‡º</button>
</header>

<main>
  <!-- ç™»å…¥è¦–åœ–ï¼ˆåƒ…åœ¨æœªç™»å…¥æ™‚é¡¯ç¤ºï¼›ç°¡åŒ–æç¤ºï¼‰ -->
  <section id="pane-login" class="section hidden">
    <div class="card" style="padding:16px;">
      <div class="hd">
        <div class="title">ç™»å…¥</div>
        <div class="muted">è«‹å…ˆä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ä»¥è®€å–è³‡æ–™</div>
      </div>
      <div><button id="btnLogin2" class="btn btn--primary">ç™»å…¥ Google</button></div>
    </div>
  </section>

  <!-- æ•´é«”æƒ…å ± -->
  <section id="pane-dashboard" class="section">
    <div class="hd">
      <div class="title">æ•´é«”æƒ…å ±</div>
      <div id="dashInfo" class="muted">â€”</div>
      <div class="spacer"></div>

      <div class="field">
        <label>è‡ªå‹•åˆ·æ–°</label>
        <div class="seg" id="refreshSeg">
          <button class="seg-btn active" data-ms="0">é—œé–‰</button>
          <button class="seg-btn" data-ms="15000">15s</button>
          <button class="seg-btn" data-ms="30000">30s</button>
          <button class="seg-btn" data-ms="60000">60s</button>
        </div>
      </div>
      <button id="btnForceRefresh" class="btn">ç«‹å³æ›´æ–°</button>
    </div>

    <div id="dashboard" class="veh-grid"></div>
  </section>

  <!-- å€‹åˆ¥æƒ…å ± -->
  <section id="pane-single" class="section hidden">
    <div class="card" style="padding:16px;">
      <div class="hd">
        <div class="title">å€‹åˆ¥æƒ…å ±</div>
        <div class="muted">ä¸‰é¸å–®æŸ¥è©¢ â†’ é¡¯ç¤ºä¸‰è¡Œç½®ä¸­åç‰‡</div>
        <div class="spacer"></div>
        <button id="btnClearSingle" class="btn btn--secondary">æ¸…ç©ºæ¢ä»¶</button>
      </div>

      <div class="row" style="margin-bottom:12px;">
        <div class="field">
          <label for="selSheet">å·¥ä½œè¡¨</label>
          <select id="selSheet"></select>
        </div>
        <div class="field">
          <label for="selArea">å€åŸŸ</label>
          <select id="selArea"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div class="field">
          <label for="selCar">è»Šè™Ÿ</label>
          <select id="selCar"><option value="">å…¨éƒ¨</option></select>
        </div>
        <button id="btnQuery" class="btn btn--primary">æŸ¥è©¢</button>
      </div>

      <div id="singleList" class="single-list"></div>
    </div>
  </section>
</main>

<!-- é€šçŸ¥å®¹å™¨ -->
<div id="notif" class="notif"></div>

<script>
/* ========================== å¯èª¿æ•´è¨­å®š ========================== */
const CONFIG = {
  GOOGLE_CLIENT_ID: 'REPLACE_WITH_YOUR_CLIENT_ID',
  API_BASE: 'REPLACE_WITH_YOUR_APPS_SCRIPT_ENDPOINT' // e.g., https://script.google.com/macros/s/.../exec
};

/* =========================== å…¨åŸŸç‹€æ…‹ =========================== */
let currentUser = null;                       // ç™»å…¥ç‹€æ…‹
let currentPane = 'pane-dashboard';           // ç›®å‰é ç±¤
let DASHBOARD_TIMER = null;                   // æ•´é«”æƒ…å ±è‡ªå‹•åˆ·æ–°è¨ˆæ™‚å™¨

// å¿«å–ï¼ˆæ ¸å¿ƒï¼‰
let ALL_SHEET_DATA_CACHE = null;  // { key: {key,cfg,header,rows}, ... }
let ALL_SHEETS = {};              // èˆ‡ CACHE åŒæ­¥ï¼Œä¾›å…¶ä»–è™•ä½¿ç”¨
let SINGLE_ITEMS = [];            // å€‹åˆ¥æƒ…å ±è³‡æ–™æ”¤å¹³ï¼ˆå« sheetKey/cfg/header/rowï¼‰

// çµ„æ…‹ï¼šä½ çš„å·¥ä½œè¡¨æ¸…å–®ï¼ˆç¤ºä¾‹ï¼‰
const SHEET_CONFIGS = [
  // { key:'A', sheet:'è¡¨1' }, { key:'B', sheet:'è¡¨2' } ...
  // è«‹æ”¹æˆä½ çš„å¯¦éš›æ¸…å–®
  { key: 'A', sheet: 'ç™»éŒ„è¡¨-åŒ—å€' },
  { key: 'B', sheet: 'ç™»éŒ„è¡¨-ä¸­å€' },
  { key: 'C', sheet: 'ç™»éŒ„è¡¨-å—å€' }
];

// è‡ªå‹•åˆ·æ–°é è¨­ï¼ˆå¯æ­é… localStorage ä¿å­˜ï¼‰
const REFRESH_PRESETS = [0, 15000, 30000, 60000];
const STORAGE_KEYS = {
  token: 'APP_ID_TOKEN',
  refresh: 'APP_REFRESH_MS'
};

/* =========================== å·¥å…·æ–¹æ³• =========================== */
function showNotif(msg, type='info', ttl=2400){
  const host = document.getElementById('notif');
  const el = document.createElement('div');
  el.className = 'toast';
  el.innerHTML = `<div>${msg}</div>`;
  host.appendChild(el);
  setTimeout(()=>{ el.remove(); }, ttl);
}

async function withLoading(fn, text='è™•ç†ä¸­â€¦'){
  const mask = document.createElement('div');
  mask.className = 'loading-mask';
  mask.innerHTML = `<div class="loading-box">${text}</div>`;
  document.body.appendChild(mask);
  try { return await fn(); }
  finally { mask.remove(); }
}

// ä»¥ backdrop + å…§å®¹ç¯€é»é¡¯ç¤º Modalï¼Œå›å‚³ cleanup
function openModal(contentEl){
  const wrap = document.createElement('div');
  wrap.className = 'modal-backdrop';
  wrap.appendChild(contentEl);
  document.body.appendChild(wrap);

  const onKey = (e)=>{ if(e.key==='Escape'){ cleanup(); } };
  const onClick = (e)=>{ if(e.target===wrap){ cleanup(); } };

  function cleanup(){
    document.removeEventListener('keydown', onKey);
    wrap.removeEventListener('click', onClick);
    wrap.remove();
  }
  document.addEventListener('keydown', onKey);
  wrap.addEventListener('click', onClick);
  return cleanup;
}

// æŠ½è±¡ï¼šé€šç”¨ Modal å·¥å» ï¼ˆå–ä»£å¤šå€‹ open*Dialog é‡è¤‡ï¼‰
function createModal({ title, contentHTML, buttons = [], onClose }){
  const box = document.createElement('div');
  box.className = 'modal';
  const btnHTML = buttons.map((b,i)=>`<button class="${b.class||'btn'}" data-idx="${i}">${b.label}</button>`).join('');
  box.innerHTML = `
    <h3>${title}</h3>
    <div>${contentHTML||''}</div>
    <div class="actions">${btnHTML}</div>
  `;
  const close = openModal(box);
  box.querySelectorAll('.actions button').forEach(btn=>{
    btn.onclick = async () => {
      const idx = +btn.dataset.idx;
      try { await buttons[idx]?.onClick?.(); }
      finally { close(); onClose?.(); }
    };
  });
  return close;
}

// è§£æ Google Sheet values â†’ header/rowsï¼ˆæŠ½å…±ç”¨ï¼‰
function parseSheetData(values){
  const headerIdx = values.findIndex(r =>
    Array.isArray(r) &&
    String(r[0]||'').trim()==='ç·¨è™Ÿ' &&
    String(r[1]||'').trim().startsWith('å€åŸŸ') &&
    String(r[2]||'').trim()==='è»Šè™Ÿ'
  );
  if (headerIdx === -1) return { header: [], rows: [] };
  const header = values[headerIdx].map(c => String(c||'').trim());
  const rows = values.slice(headerIdx+1).filter(r =>
    String(r[0]||'').trim() && String(r[1]||'').trim() && String(r[2]||'').trim()
  );
  return { header, rows };
}

// ä¸€æ¬¡æŠ“æ‰€æœ‰å·¥ä½œè¡¨ï¼ˆå¸¶å¿«å–ï¼‰
async function getOrFetchAllSheetData(force=false){
  if (ALL_SHEET_DATA_CACHE && !force) return ALL_SHEET_DATA_CACHE;

  const results = await Promise.all(
    SHEET_CONFIGS.map(async cfg => {
      const r = await fetch(CONFIG.API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
      const j = await r.json();
      if (j.error) throw new Error(j.error);
      const { header, rows } = parseSheetData(j.values || []);
      return { key: cfg.key, cfg, header, rows };
    })
  );

  const map = {};
  results.forEach(x => { map[x.key] = x; });
  ALL_SHEET_DATA_CACHE = map;
  return ALL_SHEET_DATA_CACHE;
}

// åç‰‡å·¥å» ï¼ˆçµ±ä¸€æ¨£å¼/é»æ“Šè¡Œç‚ºï¼‰
function createCard({ area, car, latest, onClick }){
  const el = document.createElement('div');
  el.className = 'single-card';
  el.innerHTML = `
    <div class="single-line">${area}</div>
    <div class="single-line">${car}</div>
    ${latest ? `<div class="single-line" style="opacity:.85">${latest}</div>` : ''}
  `;
  if (onClick) el.addEventListener('click', onClick);
  return el;
}

// èšåˆ appendï¼Œé¿å…å¤§é‡é‡ç¹ª
function appendMany(parent, nodes){
  const frag = document.createDocumentFragment();
  nodes.forEach(n => frag.appendChild(n));
  parent.innerHTML = '';
  parent.appendChild(frag);
}

/* ========================= ç™»å…¥/ç™»å‡ºï¼ˆç¤ºæ„ï¼‰ ========================= */
// ä½ è‹¥å·²æœ‰ Google Identity å¯¦ä½œï¼Œå¯æŠŠæ­¤æ®µæ›¿æ›ç‚ºå¯¦éš›æµç¨‹
async function fakeLogin(){
  // TODO: æ›æˆ Google One Tap / OAuthï¼Œå–å› idToken
  currentUser = { name:'Demo User', email:'demo@example.com' };
  localStorage.setItem(STORAGE_KEYS.token, 'FAKE_TOKEN');
  toggleLoginState(true);
  await enterDashboard();
}
function logout(){
  currentUser = null;
  localStorage.removeItem(STORAGE_KEYS.token);
  toggleLoginState(false);
}
function toggleLoginState(isLoggedIn){
  document.getElementById('btnLogin').classList.toggle('hidden', !!isLoggedIn);
  document.getElementById('btnLogout').classList.toggle('hidden', !isLoggedIn);
  document.getElementById('pane-login').classList.toggle('hidden', !!isLoggedIn);
  document.getElementById('pane-dashboard').classList.toggle('hidden', !isLoggedIn && currentPane==='pane-dashboard' ? true : false);
  document.getElementById('pane-single').classList.toggle('hidden', !isLoggedIn && currentPane==='pane-single' ? true : false);
}

/* ============================== åˆ†é  ============================== */
function switchPane(id){
  if (currentPane === id) return;
  document.querySelectorAll('[id^="pane-"]').forEach(p => p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.main-tab').forEach(t=>t.classList.toggle('active', t.dataset.target===id));
  currentPane = id;

  if (!currentUser){
    document.getElementById('pane-login').classList.remove('hidden');
    return;
  }

  if (id==='pane-dashboard'){
    enterDashboard();
  } else if (id==='pane-single'){
    initSinglePage();
  }
}

/* ============================ æ•´é«”æƒ…å ± ============================ */
let currentDashRefreshMs = Number(localStorage.getItem(STORAGE_KEYS.refresh) || 0);

async function enterDashboard(){
  stopDashboardAutoRefresh();
  await buildDashboard(false);
  if (currentDashRefreshMs>0) startDashboardAutoRefresh(currentDashRefreshMs);
}

function startDashboardAutoRefresh(ms){
  if (DASHBOARD_TIMER) clearInterval(DASHBOARD_TIMER);
  DASHBOARD_TIMER = setInterval(()=>{
    if (document.hidden) return; // ä¸å¯è¦‹æ™‚ä¸åˆ·æ–°
    buildDashboard(true);
  }, ms);
}
function stopDashboardAutoRefresh(){
  if (DASHBOARD_TIMER){ clearInterval(DASHBOARD_TIMER); DASHBOARD_TIMER=null; }
}

async function buildDashboard(silent=false){
  const dash = document.getElementById('dashboard');
  const dashInfo = document.getElementById('dashInfo');

  const work = async ()=>{
    const all = await getOrFetchAllSheetData();
    ALL_SHEETS = all;

    dashInfo.textContent = `å…± ${Object.keys(all).length} å¼µè¡¨`;

    // æ¯å¼µè¡¨åšä¸€å¼µã€Œç¾¤çµ„å¡ã€
    const cards = Object.values(all).map(({ cfg, rows })=>{
      const done = rows.length;
      const el = document.createElement('div');
      el.className = 'veh-card';
      el.innerHTML = `
        <div class="veh-top">
          <div class="veh-title">${cfg.sheet}</div>
          <div class="veh-stat"><span>ç­†æ•¸ï¼š${done}</span></div>
        </div>
        <div class="veh-actions">
          <button class="btn btn--primary" data-key="${cfg.key}" data-act="open">æŸ¥çœ‹æ¸…å–®</button>
          <button class="btn" data-key="${cfg.key}" data-act="preview">é è¦½å‰ 12 ç­†</button>
        </div>
      `;
      return el;
    });

    appendMany(dash, cards);
  };

  if (silent) await work();
  else await withLoading(work, 'æ›´æ–°æ•´é«”æƒ…å ±â€¦');
}

/* å„€è¡¨æ¿äº‹ä»¶å§”æ´¾ï¼šæŸ¥çœ‹æ¸…å–®/é è¦½ */
document.getElementById('dashboard').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act]');
  if (!btn) return;
  const key = btn.dataset.key;
  const act = btn.dataset.act;

  if (act==='open'){
    // åˆ‡æ›åˆ°å€‹åˆ¥æƒ…å ±ä¸¦é–å®šè©²å·¥ä½œè¡¨
    switchPane('pane-single');
    const sel = document.getElementById('selSheet');
    sel.value = key;
    onSingleSheetChange();
    showNotif('å·²å¥—ç”¨å·¥ä½œè¡¨ï¼š' + key);
  }else if (act==='preview'){
    const pack = ALL_SHEETS[key];
    if (!pack) return;
    const { rows } = pack;
    const top = rows.slice(0, 12);
    const html = `
      <div class="single-list" style="margin-top:8px;">
        ${top.map(r=>`
          <div class="single-card">
            <div class="single-line">${r[1]||''}</div>
            <div class="single-line">${r[2]||''}</div>
            <div class="single-line" style="opacity:.85">${r[3]||''}</div>
          </div>
        `).join('')}
      </div>
    `;
    createModal({
      title: 'é è¦½ï¼ˆå‰ 12 ç­†ï¼‰',
      contentHTML: html,
      buttons:[{label:'é—œé–‰', class:'btn btn--primary', onClick:()=>{}}]
    });
  }
});

/* è‡ªå‹•åˆ·æ–° UI */
document.getElementById('refreshSeg').addEventListener('click', (e)=>{
  const b = e.target.closest('.seg-btn'); if(!b) return;
  document.querySelectorAll('#refreshSeg .seg-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  currentDashRefreshMs = +b.dataset.ms;
  localStorage.setItem(STORAGE_KEYS.refresh, String(currentDashRefreshMs));
  stopDashboardAutoRefresh();
  if (currentDashRefreshMs>0) startDashboardAutoRefresh(currentDashRefreshMs);
});
document.getElementById('btnForceRefresh').addEventListener('click', async ()=>{
  await withLoading(async ()=>{
    await getOrFetchAllSheetData(true);
    await buildDashboard(true);
  }, 'å¼·åˆ¶é‡æ–°è®€å–â€¦');
  showNotif('è³‡æ–™å·²æ›´æ–°');
});

/* ============================ å€‹åˆ¥æƒ…å ± ============================ */
async function initSinglePage(){
  await loadSingleData(); // å¾å¿«å–å±•é–‹ SINGLE_ITEMS èˆ‡ä¸‹æ‹‰
}

async function loadSingleData(){
  const all = await getOrFetchAllSheetData();
  ALL_SHEETS = all;

  // æº–å‚™ä¸‹æ‹‰ï¼šå·¥ä½œè¡¨
  const selSheet = document.getElementById('selSheet');
  selSheet.innerHTML = SHEET_CONFIGS.map(cfg=>`<option value="${cfg.key}">${cfg.sheet}</option>`).join('');

  // æ”¤å¹³
  SINGLE_ITEMS = [];
  Object.values(all).forEach(({ cfg, header, rows })=>{
    rows.forEach(row => SINGLE_ITEMS.push({ sheetKey: cfg.key, cfg, header, row }));
  });

  // åˆå§‹ï¼šä¾ç¬¬ä¸€å¼µè¡¨å¡«å…¥ Area/Car
  onSingleSheetChange();
}

function onSingleSheetChange(){
  const selSheet = document.getElementById('selSheet').value;
  const selArea = document.getElementById('selArea');
  const selCar = document.getElementById('selCar');

  const items = SINGLE_ITEMS.filter(x => !selSheet || x.sheetKey===selSheet);

  // ä¾ header æ‰¾æ¬„ä½
  const any = items[0];
  let idxArea = 1, idxCar = 2; // é è¨­ä½ç½®ï¼ˆä¾ä½ çš„è¡¨ï¼š0=ç·¨è™Ÿ,1=å€åŸŸ*,2=è»Šè™Ÿï¼‰
  if (any && any.header?.length){
    idxArea = any.header.findIndex(h=> String(h||'').includes('å€åŸŸ')); if(idxArea<0) idxArea=1;
    idxCar  = any.header.findIndex(h=> String(h||'')==='è»Šè™Ÿ');         if(idxCar<0) idxCar=2;
  }

  const unique = (arr)=>[...new Set(arr.filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b)));
  const areas = unique(items.map(x=>String(x.row[idxArea]||'').trim()));
  const cars  = unique(items.map(x=>String(x.row[idxCar]||'').trim()));

  selArea.innerHTML = `<option value="">å…¨éƒ¨</option>` + areas.map(a=>`<option>${a}</option>`).join('');
  selCar.innerHTML  = `<option value="">å…¨éƒ¨</option>` + cars.map(c=>`<option>${c}</option>`).join('');
}

document.getElementById('selSheet').addEventListener('change', onSingleSheetChange);

document.getElementById('btnClearSingle').addEventListener('click', ()=>{
  document.getElementById('selSheet').selectedIndex = 0;
  onSingleSheetChange();
  document.getElementById('selArea').value = '';
  document.getElementById('selCar').value = '';
  document.getElementById('singleList').innerHTML = '';
});

document.getElementById('btnQuery').addEventListener('click', ()=>{
  onSingleQuery();
});

function onSingleQuery(){
  const selSheet = document.getElementById('selSheet').value;
  const selArea  = document.getElementById('selArea').value.trim();
  const selCar   = document.getElementById('selCar').value.trim();

  const items = SINGLE_ITEMS.filter(x => (!selSheet || x.sheetKey===selSheet));

  // æ¬„ä½ç´¢å¼•
  let idxArea = 1, idxCar = 2, idxLatest = 3;
  const any = items[0];
  if (any && any.header?.length){
    idxArea  = any.header.findIndex(h=> String(h||'').includes('å€åŸŸ')); if(idxArea<0) idxArea=1;
    idxCar   = any.header.findIndex(h=> String(h||'')==='è»Šè™Ÿ');         if(idxCar<0) idxCar=2;
    idxLatest= 3; // è‹¥ä½ æœ‰ã€Œæœ€æ–°ç‹€æ…‹/æ™‚é–“ã€æ¬„ä½å¯æ”¹é€™è£¡
  }

  const filtered = items.filter(x=>{
    const a = String(x.row[idxArea] || '').trim();
    const c = String(x.row[idxCar] || '').trim();
    return (!selArea || a===selArea) && (!selCar || c===selCar);
  });

  const nodes = filtered.map(x=>{
    const area = String(x.row[idxArea] || '').trim();
    const car  = String(x.row[idxCar] || '').trim();
    const latest = String(x.row[idxLatest] || '').trim();
    return createCard({
      area, car, latest,
      onClick: ()=> openDetailModal(x)
    });
  });

  appendMany(document.getElementById('singleList'), nodes);
}

function openDetailModal(item){
  const { cfg, header, row } = item;
  const rows = header.map((h,i)=>`<tr><td style="padding:6px 8px;border-bottom:1px solid var(--border);color:var(--muted);">${h}</td><td style="padding:6px 8px;border-bottom:1px solid var(--border);">${row[i]??''}</td></tr>`).join('');
  const html = `
    <div class="card" style="padding:8px;">
      <div class="muted" style="margin-bottom:6px;">ä¾†æºå·¥ä½œè¡¨ï¼š${cfg.sheet}</div>
      <table style="width:100%;border-collapse:collapse;">${rows}</table>
    </div>
  `;
  createModal({
    title: 'è©³ç´°è³‡æ–™',
    contentHTML: html,
    buttons: [
      { label:'é—œé–‰', class:'btn btn--primary', onClick:()=>{} }
    ]
  });
}

/* ============================== æ™‚é˜ ============================== */
function tickClock(){
  const d = new Date();
  const s = d.toLocaleString('zh-TW', { hour12:false });
  document.getElementById('clock').textContent = s;
}
setInterval(tickClock, 1000); tickClock();

/* ============================ äº‹ä»¶ç¶å®š ============================ */
document.getElementById('mainTabs').addEventListener('click', (e)=>{
  const t = e.target.closest('.main-tab');
  if (!t) return;
  switchPane(t.dataset.target);
});

document.getElementById('btnLogin').addEventListener('click', fakeLogin);
document.getElementById('btnLogin2').addEventListener('click', fakeLogin);
document.getElementById('btnLogout').addEventListener('click', ()=>{
  createModal({
    title:'ç¢ºèªç™»å‡º',
    contentHTML:'ç¢ºå®šè¦ç™»å‡ºç›®å‰å¸³è™Ÿå—ï¼Ÿ',
    buttons:[
      {label:'å–æ¶ˆ', class:'btn btn--secondary', onClick:()=>{}},
      {label:'ç™»å‡º', class:'btn btn--danger', onClick:()=>{ logout(); showNotif('å·²ç™»å‡º'); }}
    ]
  });
});

/* ============================ é¦–æ¬¡é€²å…¥ ============================ */
(async function boot(){
  // è‹¥åµæ¸¬åˆ° tokenï¼ˆç¤ºæ„ï¼‰ï¼Œç›´æ¥è¦–ç‚ºç™»å…¥
  const tk = localStorage.getItem(STORAGE_KEYS.token);
  if (tk){ currentUser = { name:'Demo User', email:'demo@example.com' }; }
  toggleLoginState(!!currentUser);

  // é è¨­é¡¯ç¤ºæ•´é«”æƒ…å ±
  if (currentUser){
    await enterDashboard();
  }else{
    document.getElementById('pane-login').classList.remove('hidden');
  }

  // é é¢éš±è—æ™‚ç¯€æµï¼šè‡ªå‹•åˆ·æ–°ä¸æ¸…æ‰ï¼Œä½†æ¯ tick æœƒæª¢æŸ¥ hidden
  document.addEventListener('visibilitychange', ()=>{ /* noopï¼Œä¿ç•™ hooks */ });
})();
</script>
</body>
</html>
