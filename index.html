<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ´»å‹•è»Šæµäººæµé€€å ´ç®¡ç†ç³»çµ±</title>
  <!-- ä¸€å®šè¦æœ‰é€™è¡Œï¼Œå…ˆè®“ GSI è¼‰é€²ä¾† -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
      --card-bg: rgba(255,255,255,0.75);
      --text: #0f172a;
    }
    body.dark{
      --bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
      --card-bg: rgba(15,23,42,0.55);
      --text: #e2e8f0;
    }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      backdrop-filter: blur(14px);
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      color:var(--text);
    }
    .wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
    h1{margin:0 0 16px;}
    .card{background:var(--card-bg);border:1px solid rgba(255,255,255,0.3);border-radius:16px;padding:16px;margin:12px 0;}
    .hide{display:none;}
    .sheet-tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;}
    .btn-tab{background:transparent;border:1px solid rgba(255,255,255,0.2);border-radius:14px;padding:6px 10px;font-size:.78rem;cursor:pointer;color:inherit;}
    .btn-tab.active{background:rgba(255,255,255,.25);}
    /* ä¸€åˆ—å…©å°è»Š */
    .veh-list{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(480px, 1fr));
      gap:12px;
    }
    .veh-card{
      background:rgba(255,255,255,0.85);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.25);
      padding:14px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    body.dark .veh-card{background:rgba(15,23,42,0.28);}
    .veh-title-main{
      font-weight:600;
      font-size:1rem;
      margin-bottom:2px;
    }
    .veh-title-sub{
      font-size:.85rem;
      opacity:.7;
    }
    .step-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:3px;   /* æ¯é¡†æŒ‰éˆ•ä¸‹é¢ 3px */
    }
    .step-row:last-child{
      margin-bottom:0;
    }

    .step-btn{
      border:0;
      border-radius:10px;
      padding:6px 12px 7px;
      background:#0f6efc;
      color:#fff;
      font-size:.74rem;
      cursor:pointer;
      flex:0 0 auto;
      min-width:150px;
    }
    .step-btn.done{
      background:#d1d5db;
      color:#0f172a;
      cursor:pointer;
    }
    .step-time{
      font-size:.7rem;
      color:rgba(15,23,42,.55);
      min-width:90px;
      text-align:right;
    }
    .notif{position:fixed;right:16px;bottom:16px;background:rgba(15,23,42,.85);color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transform:translateY(20px);transition:.2s;}
    .notif.show{opacity:1;transform:translateY(0);}
    @media(max-width:768px){
      .veh-list{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
      <div>
        <h1>æ´»å‹•è»Šæµäººæµé€€å ´ç®¡ç†ç³»çµ±</h1>
        <div style="font-size:.7rem;opacity:.6;">(å¤–éƒ¨å‰ç«¯ç‰ˆï¼Œçµ¦ Google Sites åµŒ URL ç”¨)</div>
      </div>
      <!-- é€™è£¡å…ˆæ”¾å€‹æ–‡å­—ï¼Œç­‰ GSI è¼‰å¥½å†ç•«æŒ‰éˆ• -->
      <div id="signin">è¼‰å…¥ç™»å…¥ä¸­â€¦</div>
      <div id="userInfo" class="hide" style="font-size:.75rem;"></div>
    </div>

    <div id="tabs" class="card hide">
      <div class="sheet-tabs" id="sheetTabs"></div>
    </div>

    <div id="content" class="hide">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:.85rem;">ç›®å‰å·¥ä½œè¡¨ï¼š<b id="currentSheet"></b></div>
          <div style="font-size:.7rem;opacity:.6;">é»ä¸€ä¸‹ç‹€æ…‹ï¼å¯«å…¥æ™‚é–“ï¼Œæœ‰å€¼å†é»æœƒå•ä½ è¦ä¸è¦æ”¹æ™‚é–“</div>
        </div>
        <button onclick="reloadSheet()">é‡æ–°è¼‰å…¥</button>
      </div>
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <div id="notif" class="notif"></div>

<script>
/* â‘  é€™è£¡æ›æˆä½ çš„ client ID */
const GOOGLE_CLIENT_ID = '368914333961-504cujbloe9n3v28p4bjsc8c1lh5pg0o.apps.googleusercontent.com';
/* â‘¡ é€™è£¡æ›æˆä½ éƒ¨ç½²å‡ºä¾†çš„ Apps Script Web App URL */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxbeknXeJ2s2NnIqTwIwNdZnsbiI9UlGkQpSGfHq2TlmnITZ75Ub4ySwn6UGmJk3AXjNg/exec';

/* ä½ çš„ 5 å¼µ sheet */
const SHEET_CONFIGS = [
  {
    key: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰',
    sheet: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰',
    steps: [
      'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š',
      'Call è»Šä¸Šè¡Œæ',
      'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå‰å¾€æ’è»ŠéšŠ',
      'è»Šæš«åœä½ç½®',
      'é€€å ´äººå“¡å·²åˆ°é½Š',
      'å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°',
      'äººå·²å‰å¾€å¹³å°',
      'è»Šç¬¬äºŒæ¬¡ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
    ]
  },
  {
    key: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰',
    sheet: 'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰',
    steps: [
      'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š',
      'Call è»Šä¸Šè¡Œæ',
      'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå‰å¾€æ’è»ŠéšŠ',
      'è»Šå·²é›¢é–‹ç¦ªå ‚å¹³å°'
    ]
  },
  {
    key: 'æ°´é™¸å°ˆè»Šé€€å ´',
    sheet: 'æ°´é™¸å°ˆè»Šé€€å ´',
    steps: [
      'å·² Call è»Šæ’è»ŠéšŠ',
      'å·²æ’å¥½è»ŠéšŠ',
      'é€€å ´äººå“¡å·²åˆ°é½Š',
      'å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
    ]
  },
  {
    key: 'åœ‹å…‰è™Ÿé€€å ´',
    sheet: 'åœ‹å…‰è™Ÿé€€å ´',
    steps: [
      'æ˜¯å¦ç¶“éé•·åºš',
      'é€€å ´äººå“¡å·²åˆ°é½Š',
      'è»Šå·²ç¶“ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå·²ç¶“é›¢é–‹éŠè¦½è»Šå¹³å°',
      'ä¸Šè»Šäººæ•¸'
    ]
  },
  {
    key: '288æ³•é’é€€å ´',
    sheet: '288æ³•é’é€€å ´',
    steps: [
      'é€€å ´äººå“¡å·²åˆ°é½Š',
      'è»Šå·²ç¶“ä¸ŠéŠè¦½è»Šå¹³å°',
      'è»Šå·²ç¶“é›¢é–‹éŠè¦½è»Šå¹³å°'
    ]
  }
];

let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = [];

/* ğŸš€ ä¸€é€²ä¾†å°±å…ˆè·‘ï¼Œä¸ç”¨ç­‰ onload */
initApp();

function initApp(){
  buildTabs();
  // é€™è£¡é–‹å§‹åè¦†æª¢æŸ¥ GSI æ˜¯å¦è¼‰å¥½
  waitForGSI(0);
}

/* é‡é»ï¼šé€™ä¸€æ®µæœƒ 300ms æª¢æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤š 20 æ¬¡ */
function waitForGSI(count){
  if (window.google && google.accounts && google.accounts.id) {
    console.log('[GSI] loaded');
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleCredential
    });
    google.accounts.id.renderButton(
      document.getElementById('signin'),
      { theme:'outline', size:'large' }
    );
    return;
  }
  if (count > 20) {
    console.warn('[GSI] still not loaded after tries');
    document.getElementById('signin').textContent = 'ç„¡æ³•è¼‰å…¥ Google ç™»å…¥ï¼ˆè«‹æª¢æŸ¥ iframe ç¶²åŸŸæ˜¯å¦å…è¨±ï¼‰';
    return;
  }
  setTimeout(()=>waitForGSI(count+1), 300);
}

/* === ç™»å…¥æˆåŠŸå¾Œ === */
async function handleCredential(resp){
  try {
    const r = await fetch(API_BASE + '?action=verify', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ idToken: resp.credential })
    });
    const j = await r.json();
    if (j.error) {
      showNotif('ç™»å…¥å¤±æ•—ï¼š' + j.error, true);
      return;
    }
    currentUser = j;
    document.getElementById('signin').classList.add('hide');
    const ui = document.getElementById('userInfo');
    ui.classList.remove('hide');
    ui.innerHTML = `${j.name||''} &lt;${j.email}&gt; ï½œ æ¬Šé™ï¼š<b>${j.permission}</b>`;
    document.getElementById('tabs').classList.remove('hide');
    document.getElementById('content').classList.remove('hide');
    loadSheetData(currentSheetKey);
  } catch (err) {
    showNotif('ç™»å…¥éŒ¯èª¤ï¼š' + err.message, true);
  }
}

/* ä¸Šé¢çš„ tabs */
function buildTabs(){
  const box = document.getElementById('sheetTabs');
  box.innerHTML = '';
  SHEET_CONFIGS.forEach(cfg=>{
    const b = document.createElement('button');
    b.className = 'btn-tab' + (cfg.key===currentSheetKey?' active':'');
    b.textContent = cfg.key;
    b.onclick = () => {
      currentSheetKey = cfg.key;
      document.querySelectorAll('.btn-tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      if (currentUser) loadSheetData(currentSheetKey);
    };
    box.appendChild(b);
  });
}

/* è®€æŸå¼µè¡¨ */
async function loadSheetData(key){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  document.getElementById('currentSheet').textContent = cfg.key;
  document.getElementById('vehList').textContent = 'è®€å–ä¸­...';
  const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
  const j = await r.json();
  if (j.error){ document.getElementById('vehList').textContent = 'âŒ '+j.error; return; }
  sheetData = j.values || [];
  renderVehicles(cfg, sheetData);
}

// æŠŠä»»ä½•æ™‚é–“å­—ä¸²ï¼ˆå°¤å…¶æ˜¯ 2025-11-02T10:11:34.000Zï¼‰è½‰æˆå°åŒ—æ™‚é–“ hh:mm:ss
function formatToTWTime(val) {
  if (!val) return '';
  // æœ‰å¯èƒ½æœ¬ä¾†å°±æ˜¯ hh:mm:ssï¼Œå°±ç›´æ¥å›å‚³
  if (/^\d{2}:\d{2}:\d{2}$/.test(val)) return val;

  const d = new Date(val);
  if (isNaN(d.getTime())) return val; // çœŸçš„ä¸æ˜¯æ—¥æœŸå°±åŸæ¨£ä¸Ÿå›å»

  // è½‰æˆå°åŒ—
  const utcMs = d.getTime() + d.getTimezoneOffset() * 60000;
  const tw = new Date(utcMs + 8 * 60 * 60 * 1000);

  const hh = String(tw.getHours()).padStart(2, '0');
  const mm = String(tw.getMinutes()).padStart(2, '0');
  const ss = String(tw.getSeconds()).padStart(2, '0');
  return `${hh}:${mm}:${ss}`;
}

// ä½ å‰é¢å¯«å…¥ç”¨çš„ï¼šç”¢ç”Ÿç¾åœ¨çš„å°åŒ—æ™‚é–“ hh:mm:ss
//function getTWTime() {
  //const now = new Date();
  //const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
  //const tw = new Date(utcMs + 8 * 60 * 60 * 1000);
  //const hh = String(tw.getHours()).padStart(2, '0');
  //const mm = String(tw.getMinutes()).padStart(2, '0');
  //const ss = String(tw.getSeconds()).padStart(2, '0');
  //return `${hh}:${mm}:${ss}`;
//}

// å–å¾—ã€Œå°åŒ—ç¾åœ¨æ™‚é–“ã€çš„ hh:mm:ss
function getTWTime() {
  const now = new Date();
  const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
  const tw = new Date(utcMs + 8 * 60 * 60 * 1000);
  const hh = String(tw.getHours()).padStart(2, '0');
  const mm = String(tw.getMinutes()).padStart(2, '0');
  const ss = String(tw.getSeconds()).padStart(2, '0');
  return `${hh}:${mm}:${ss}`;
}

// å–å¾—ã€Œå°åŒ—ä»Šå¤©ã€çš„å¹´æœˆæ—¥
function getTWDateParts() {
  const now = new Date();
  const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
  const tw = new Date(utcMs + 8 * 60 * 60 * 1000);
  return {
    year: tw.getFullYear(),
    month: tw.getMonth() + 1,
    day: tw.getDate()
  };
}

// æŠŠã€Œä»Šå¤©å°åŒ— + hh:mm:ssã€è½‰æˆ ISOï¼ˆâ€¦Zï¼‰å­˜é€² sheet
function buildISOFromTodayTW(hms) {
  const m = hms.match(/^(\d{2}):(\d{2}):(\d{2})$/);
  if (!m) return hms;   // ä¸ç¬¦åˆ hh:mm:ssï¼Œå°±åŸæ¨£å›å»
  const { year, month, day } = getTWDateParts();
  const hh = Number(m[1]);
  const mm = Number(m[2]);
  const ss = Number(m[3]);
  // å°åŒ—æ™‚é–“ -> UTC è¦æ‰£ 8 å°æ™‚
  const utcMs = Date.UTC(year, month - 1, day, hh - 8, mm, ss);
  return new Date(utcMs).toISOString();
}

  
/* ç”¢ç”Ÿè»Šå¡ */
function renderVehicles(cfg, data){
  const box = document.getElementById('vehList');
  box.innerHTML = '';

  // æ‰¾å‡ºã€Œç·¨è™Ÿ | å€åŸŸè»Šæ¬¡ç·¨è™Ÿ | è»Šè™Ÿã€é‚£ä¸€åˆ—
  const headerRowIdx = data.findIndex(row =>
    Array.isArray(row) &&
    String(row[0] || '').trim() === 'ç·¨è™Ÿ' &&
    String(row[1] || '').trim().startsWith('å€åŸŸ') &&
    String(row[2] || '').trim() === 'è»Šè™Ÿ'
  );

  if (headerRowIdx === -1) {
    box.textContent = 'âŒ æ‰¾ä¸åˆ°è¡¨é ­ï¼ˆè¦æœ‰ã€Œç·¨è™Ÿ / å€åŸŸè»Šæ¬¡ç·¨è™Ÿ / è»Šè™Ÿã€é‚£ä¸€åˆ—ï¼‰';
    return;
  }

  const header = data[headerRowIdx].map(c => String(c || '').trim());

  // åªç•™ A/B/C éƒ½æœ‰è³‡æ–™çš„
  const rows = data
    .slice(headerRowIdx + 1)
    .filter(r => {
      if (!Array.isArray(r)) return false;
      const no   = String(r[0] || '').trim();
      const area = String(r[1] || '').trim();
      const car  = String(r[2] || '').trim();
      return no && area && car;
    });

  if (!rows.length){
    box.textContent = '(é€™å¼µè¡¨ç›®å‰æ²’æœ‰è»Šè¼›è³‡æ–™)';
    return;
  }

  rows.forEach((row, idx) => {
    const area = String(row[1] || '').trim();  // å€åŸŸè»Šæ¬¡ç·¨è™Ÿ
    const car  = String(row[2] || '').trim();  // è»Šè™Ÿ

    const card = document.createElement('div');
    card.className = 'veh-card';

    const title = document.createElement('div');
    title.innerHTML = `
      <div class="veh-title-main">${area}</div>
      <div class="veh-title-sub">${car}</div>
    `;
    card.appendChild(title);

    const stepsBox = document.createElement('div');

    cfg.steps.forEach(st => {
      const colIdx = header.indexOf(st);
      const rowEl = document.createElement('div');
      rowEl.className = 'step-row';

      const btn = document.createElement('button');
      btn.className = 'step-btn';
      btn.textContent = st;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'step-time';

      const curVal = (colIdx !== -1 && row[colIdx]) ? String(row[colIdx]).trim() : '';

      if (curVal) {
        btn.classList.add('done');
        timeSpan.textContent = formatToTWTime(curVal);

      }

      const prevOk = prevDone(cfg, header, row, st);
      if (!prevOk && !curVal) {
        btn.classList.add('done');
        btn.disabled = true;
      }

      const sheetRow = headerRowIdx + 1 + 1 + idx;

      btn.onclick = () => onStepClick(cfg, sheetRow, header, st, curVal, btn, timeSpan);

      rowEl.appendChild(btn);
      rowEl.appendChild(timeSpan);
      stepsBox.appendChild(rowEl);
    });

    card.appendChild(stepsBox);
    box.appendChild(card);
  });
}

function prevDone(cfg, header, row, st){
  const idx = cfg.steps.indexOf(st);
  if (idx === 0) return true;
  const prevName = cfg.steps[idx-1];
  const colIdx = header.indexOf(prevName);
  if (colIdx === -1) return true;
  return !!row[colIdx];
}

async function onStepClick(cfg, rowNumber, header, st, oldVal, btn, span){
  if (!currentUser) return alert('è«‹å…ˆç™»å…¥');
  if (!['è¼¸å…¥','å…¨åŠŸèƒ½'].includes(currentUser.permission)) return alert('æ¬Šé™ä¸è¶³');

  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('æ­¤æ¬„ä½ä¸å­˜åœ¨ï¼š'+st);

  let valueToWrite;

  if (oldVal) {
    // âœ… å·²ç¶“æœ‰æ™‚é–“ â†’ çµ¦ä»–ä¸€å€‹ã€Œç¾åœ¨å°åŒ—æ™‚é–“ã€ç•¶é è¨­
    const def = getTWTime();
    const m = prompt('æ­¤ç‹€æ…‹å·²æœ‰æ™‚é–“ï¼Œè¦ä¿®æ”¹å—ï¼Ÿ(æ¸…ç©ºå°±ç•™ç™½)', def);
    if (m === null) return;                 // æŒ‰ã€Œå–æ¶ˆã€â†’ ä¸å‹•
    const v = m.trim();
    if (v === '') {
      // âœ… æ¸…ç©º
      valueToWrite = '';
    } else if (/^\d{2}:\d{2}:\d{2}$/.test(v)) {
      // âœ… åªå¡« hh:mm:ss â†’ è½‰æˆã€Œä»Šå¤©å°åŒ— + é€™å€‹æ™‚é–“ã€çš„ ISO
      valueToWrite = buildISOFromTodayTW(v);
    } else {
      // âœ… ä½¿ç”¨è€…è‡ªå·±äº‚å¡«åˆ¥çš„æ ¼å¼ï¼Œå°±ç…§ä»–å¡«çš„å­˜
      valueToWrite = v;
    }
  } else {
    // âœ… åŸæœ¬æ²’æ™‚é–“ â†’ ç›´æ¥å¯«ç¾åœ¨å°åŒ—æ™‚é–“ (è½‰ ISO)
    const nowHHMMSS = getTWTime();
    valueToWrite = buildISOFromTodayTW(nowHHMMSS);
  }

  const body = {
    sheet: cfg.sheet,
    email: currentUser.email,
    writes: [{ row: rowNumber, col: colIdx+1, value: valueToWrite }]
  };

  const r = await fetch(API_BASE + '?action=update', {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(body)
  });

  const j = await r.json();
  if (!j.ok){
    showNotif('å¯«å…¥å¤±æ•—ï¼š'+(j.error||'unknown'), true);
    return;
  }

  // âœ… å‰ç«¯é¡¯ç¤ºä¸€å¾‹è½‰æˆå°åŒ— hh:mm:ss
  span.textContent = valueToWrite ? formatToTWTime(valueToWrite) : '';
  // ç°è‰²æ¨£å¼ä¿æŒ
  btn.classList.add('done');

  showNotif('å·²å¯«å…¥ã€Œ'+st+'ã€', false);
  // å¦‚æœä½ è¦å³æ™‚é‡æŠ“ä¹Ÿå¯ä»¥ç•™ä¸‹é¢é€™è¡Œï¼Œä¸è¦å°±æ‹¿æ‰
  // loadSheetData(currentSheetKey);
}


function reloadSheet(){
  if (currentUser) loadSheetData(currentSheetKey);
}

function showNotif(msg, isErr){
  const box = document.getElementById('notif');
  box.textContent = msg;
  box.style.background = isErr ? 'rgba(248,113,113,.9)' : 'rgba(15,23,42,.85)';
  box.classList.add('show');
  setTimeout(()=>box.classList.remove('show'), 2500);
}

function getTWTime() {
  // 1. å…ˆæ‹¿ç¾åœ¨çš„ UTC æ™‚é–“
  const now = new Date();
  const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
  // 2. åŠ ä¸Šå°åŒ— +8 å°æ™‚
  const tw = new Date(utcMs + 8 * 60 * 60 * 1000);
  // 3. çµ„æˆ hh:mm:ss
  const hh = String(tw.getHours()).padStart(2, '0');
  const mm = String(tw.getMinutes()).padStart(2, '0');
  const ss = String(tw.getSeconds()).padStart(2, '0');
  return `${hh}:${mm}:${ss}`;
}

  
</script>
</body>
</html>
