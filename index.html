<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è»Šæµäººæµé€€å ´æƒ…å ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
/* =========== Design Tokensï¼ˆPreferred ç‰ˆï¼‰ =========== */
:root{
  /* åŠå¾‘ */
  --radius-xs:6px;  --radius-sm:8px;  --radius-md:10px; --radius-lg:12px;

  /* è‰²ç¥¨ï¼ˆlightï¼‰ */
  --primary-600:#1f6fe5; --primary-700:#165bd1; --primary-800:#1249ad;
  --success-600:#22c55e; --success-700:#16a34a; --success-800:#15803d;
  --danger-600:#ef4444;  --danger-700:#dc2626;  --danger-800:#b91c1c;
  --gray-50:#f8fafc;  --gray-100:#f1f5f9; --gray-200:#e5e7eb;
  --gray-300:#cbd5e1; --gray-400:#94a3b8; --gray-500:#64748b;
  --gray-600:#475569; --gray-700:#334155; --gray-800:#1f2937; --gray-900:#0f172a;

  --surface: rgba(255,255,255,.78);
  --page-bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
  --text-strong: var(--gray-900);
  --text: var(--gray-800);
  --text-muted: var(--gray-600);
  --border: rgba(148,163,184,0.35);
  --focus:#93c5fd;

  /* å­—ç´šï¼ˆpx/line-height, weightï¼‰ */
  --fz-display:28px; --lh-display:36px; --fw-display:700;  /* é é¢å¤§æ¨™é¡Œ */
  --fz-title:18px;   --lh-title:24px;   --fw-title:700;   /* å¡ç‰‡ä¸»æ¨™ */
  --fz-sub:14px;     --lh-sub:20px;     --fw-sub:600;     /* è»Šç‰Œ/å‰¯æ¨™ */
  --fz-label:14px;   --lh-label:20px;   --fw-label:600;   /* æ­¥é©Ÿ/è¡¨é ­ */
  --fz-body:14px;    --lh-body:20px;    --fw-body:400;    /* å…§æ–‡/æŒ‰éˆ• */
  --fz-note:12px;    --lh-note:16px;    --fw-note:400;    /* å‚™è¨»æç¤º */

  --shadow-card:0 8px 24px rgba(0,0,0,.08);
}
body.dark{
  --surface: rgba(15,23,42,.55);
  --page-bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
  --text-strong:#e5eaf3; --text:#e2e8f0; --text-muted:#93a3b5;
  --border: rgba(148,163,184,0.25);
  --shadow-card:0 8px 24px rgba(0,0,0,.35);
}

/* =========== Base =========== */
body{
  margin:0; min-height:100vh;
  background:var(--page-bg); color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;
}
.wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
h1{margin:0 0 16px;font-size:var(--fz-display);line-height:var(--lh-display);font-weight:var(--fw-display);color:var(--text-strong);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-card);padding:16px;margin:12px 0;}
.hide{ display:none !important; }

/* =========== Segmented Tabsï¼ˆä¸Šæ–¹å·¥ä½œè¡¨ï¼‰ =========== */
.sheet-tabs{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }
.tab,.btn-tab{
  background:#fff;color:var(--primary-600);
  border:1px solid var(--primary-600);border-radius:var(--radius-lg);
  padding:6px 18px;font-size:var(--fz-body);font-weight:600;cursor:pointer;min-width:170px;text-align:center;
}
body.dark .tab, body.dark .btn-tab{background:transparent}
.tab:hover,.btn-tab:hover{background:rgba(31,111,229,.06)}
.tab.active,.btn-tab.active{background:var(--primary-600);color:#fff;border-color:var(--primary-600)}
.tab:focus-visible,.btn-tab:focus-visible{outline:2px solid var(--focus);outline-offset:2px}

/* ======= ä¸Šæ–¹æ™‚é˜ + æ›´æ–°é »ç‡ ======= */
.refresh-bar{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin:4px 0 6px; }
.clock{ font-weight:900; letter-spacing:.5px; font-variant-numeric: tabular-nums; }
.seg-group{ display:flex; gap:8px; flex-wrap:wrap; }
.seg-btn{
  background:#fff; color:var(--primary-600);
  border:1px solid var(--primary-600); border-radius:var(--radius-lg);
  padding:6px 14px; font-size:var(--fz-body); font-weight:700; cursor:pointer; min-width:72px; text-align:center;
}
body.dark .seg-btn{ background:transparent; }
.seg-btn:hover{ background:rgba(31,111,229,.06); }
.seg-btn.active{ background:var(--primary-600); color:#fff; border-color:var(--primary-600); }
.seg-btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }
.seg-btn[disabled]{ cursor:not-allowed; }

/* =========== åŸã€Œç™»éŒ„ã€é å¡ç‰‡ =========== */
.veh-list{display:grid;grid-template-columns:repeat(auto-fit, minmax(480px,1fr));gap:12px;margin-top:16px;}
.veh-card{background:rgba(255,255,255,0.85);border-radius:var(--radius-lg);border:1px solid var(--border);padding:14px 14px 10px;display:flex;flex-direction:column;gap:10px;}
body.dark .veh-card{background:rgba(15,23,42,0.28);}
.veh-title-main{font-weight:700;font-size:var(--fz-title);line-height:var(--lh-title);color:var(--text-strong);}
.veh-title-sub{font-size:var(--fz-sub);line-height:var(--lh-sub);color:var(--text-muted);}
.step-row{display:grid;grid-template-columns:180px 1fr auto;align-items:center;gap:10px;margin-bottom:6px;}
.step-time{font-size:var(--fz-label);line-height:var(--lh-label);font-weight:600;color:rgba(15,23,42,.75);text-align:right;min-width:70px;font-feature-settings:"tnum" 1, "lnum" 1; font-variant-numeric:tabular-nums lining-nums;}
body.dark .step-time{color:#cbd5e1}
.step-select{min-width:170px;padding:6px 8px;border-radius:var(--radius-sm);border:1px solid var(--border);background:#fff;font-size:var(--fz-body);}
.step-select:disabled{background:#e2e8f0;cursor:not-allowed;}
.textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;background:#fff;font-size:var(--fz-body);}
.textarea:focus-visible{outline:2px solid var(--focus);outline-offset:2px}

/* =========== Buttons =========== */
.btn,.step-btn{
  border:0;border-radius:var(--radius-md);padding:8px 14px;
  background:#0f6efc;color:#fff;font-size:var(--fz-body);font-weight:600;cursor:pointer;
  transition:background-color .12s ease,border-color .12s ease,filter .12s ease;
  min-width:64px;text-align:center;
}
.btn--sm{padding:6px 12px}
.btn--lg{padding:10px 18px;font-size:15px}
.btn:focus-visible,.step-btn:focus-visible{outline:2px solid var(--focus);outline-offset:2px;}
.btn[disabled],.step-btn[disabled]{background:var(--gray-300)!important;color:var(--gray-700)!important;cursor:not-allowed}
.btn--primary{background:var(--primary-600);} .btn--primary:hover{background:var(--primary-700);} .btn--primary:active{background:var(--primary-800);}
.btn--success{background:var(--success-600);} .btn--success:hover{background:var(--success-700);} .btn--success:active{background:var(--success-800);}
.btn--danger{background:var(--danger-600);}  .btn--danger:hover{background:var(--danger-700);}  .btn--danger:active{background:var(--danger-800);}
.btn--secondary{background:#fff;color:var(--primary-600);border:1px solid var(--primary-600);} 
body.dark .btn--secondary{background:transparent}
.btn--secondary:hover{background:rgba(31,111,229,.06)}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}

/* é€šçŸ¥ & Modal & Loading */
.notif{position:fixed;right:16px;bottom:16px;background:rgba(15,23,42,.85);color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transform:translateY(20px);transition:.2s;z-index:9990;}
.notif.show{opacity:1;transform:translateY(0);}
.modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: block; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 16px; border-radius: 12px; min-width: 280px; max-width: 90vw; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 10001; display: block; }
body.dark .modal{ background:#0b1325; color:#e2e8f0 }
.modal h3{ margin:0 0 10px; font-size:16px }
.modal .row{ display:flex; gap:8px; align-items:center; margin:8px 0 }
.modal input{ width:56px; padding:6px 8px; border:1px solid var(--border); border-radius:8px }
.modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
.modal .time-edit{ display:flex; align-items:center; justify-content:center; gap:10px; margin:8px 0 4px; }
.modal .time-input{ width:64px; text-align:center; padding:6px 8px; border:1px solid var(--border); border-radius:10px; font-weight:600; }
.modal .colon{ font-size:20px; line-height:1; opacity:.5; margin:0 2px; user-select:none; }
.modal .hint{ font-size:.9rem; line-height:1.6; opacity:.8; margin:2px 0; }
body.modal-open{ overflow:hidden; touch-action:none; }

/* Loading Overlay */
#loading.loading{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 2147483000; }
#loading.loading.show{ display: flex; }
.loading-box{ display:flex; align-items:center; gap:10px; background: var(--surface); color: var(--text); border:1px solid var(--border); border-radius:12px; padding:12px 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); backdrop-filter: blur(8px); }
.spinner{ width:20px; height:20px; border-radius:50%; border:2.5px solid #cbd5e1; border-top-color: var(--primary-600); animation: spin 1s linear infinite; }
@keyframes spin{ to{ transform: rotate(360deg); } }
@media (prefers-reduced-motion: reduce){ .spinner{ animation: none; border-top-color:#cbd5e1; } }
body.loading-open{ overflow:hidden; touch-action:none; overscroll-behavior: contain; }
@supports (height: 100dvh){ .modal-backdrop{ height: 100dvh; } }

/* ===== ç™»å…¥ç•«é¢ï¼ˆä¸å†è¦†è“‹ .wrap > div:first-childï¼‰ ===== */
body.login{ height: 100dvh; overflow: hidden; }
body.login .wrap{ height: 100%; display: grid; place-items: center; }
body.login #tabs, body.login #content, body.login #userInfo{ display: none !important; }
body.login #signin{ display:block; }
body.login .topbar-grid{
  display:grid;
  grid-template-columns: 1fr auto;
  grid-template-rows: auto auto;
  gap: 12px;
  align-items:center;
  justify-items:center;     /* è®“ç™»å…¥æŒ‰éˆ•ç½®ä¸­ */
  text-align:center;
}
body.login .left-title h1{
  font-size: clamp(36px, 8vw, 64px);
  line-height: 1.15;
  margin: 0;
}
#logoutBtn { white-space: nowrap; }
#logoutBtn:hover { background:rgba(239,68,68,.1) !important; }  

/* ===== é ‚å±¤ä¸‰é  Tab ===== */
.main-tabs{ display:flex; gap:12px; margin:6px 0 8px; flex-wrap:wrap; }
.main-tab{ background:#fff; color:var(--primary-600); border:1px solid var(--primary-600); border-radius:var(--radius-lg); padding:8px 20px; font-size:15px; font-weight:700; cursor:pointer; min-width:120px; text-align:center; }
body.dark .main-tab{ background:transparent; }
.main-tab:hover{ background:rgba(31,111,229,.06) }
.main-tab.active{ background:var(--primary-600); color:#fff }
.tab-pane{ margin-top:8px; }

/* ======= æ•´é«”æƒ…å ±ï¼ˆå„€è¡¨æ¿ï¼‰æ¨£å¼ ======= */
.dash-section{ margin:16px 0 24px; }
.dash-title{ font-size:18px; font-weight:800; color:var(--text-strong); margin:0 0 8px; }
.stat-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:12px; }
.stat-card{ border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.9); padding:12px; box-shadow:var(--shadow-card); }
body.dark .stat-card{ background:rgba(15,23,42,.30); }
.stat-head{ font-weight:800; margin-bottom:8px; color:var(--text-strong); }
.stat-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat-pill{ border:1px solid var(--border); border-radius:10px; padding:10px 8px; background:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; }
body.dark .stat-pill{ background:rgba(2,6,23,.5); }
.stat-pill:hover{ filter:brightness(1.02); }
.stat-num{ font-size:26px; font-weight:800; line-height:1; }
.stat-num.done{ color:#2563eb; }
.stat-num.todo{ color:#ef4444; }
.stat-label{ font-size:12px; color:var(--text-muted); margin-top:4px; }

/* åœè»Šä½ç½®å¡ç‰‡ï¼ˆå–®æ¬„å¯¬ï¼‰ */
.loc-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:10px; margin-top:8px; }
.loc-pill{ border:1px dashed var(--border); border-radius:12px; padding:10px; background:rgba(255,255,255,.85); display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer; }
body.dark .loc-pill{ background:rgba(15,23,42,.28); }
.loc-name{ font-weight:700; }
.loc-num{ font-size:22px; font-weight:900; color:#2563eb; }

/* æ¸…å–®ï¼è©³æƒ…å½ˆçª—å…§éƒ¨ */
.modal .dash-close{ position:absolute; right:10px; top:8px; font-size:22px; line-height:1; cursor:pointer; opacity:.7; }
.modal .dash-close:hover{ opacity:1; }
.list-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px dashed var(--border); }
.list-left{ display:flex; flex-direction:column; gap:2px; }
.list-title{ font-weight:800; }
.list-sub{ font-size:13px; opacity:.85; }
.detail-table{ width:100%; border-collapse:collapse; }
.detail-table th, .detail-table td{ border:1px solid var(--border); padding:8px 10px; text-align:center; }
.detail-table th{ background:#0f172a; color:#fff; }

/* RWD */
@media(max-width:768px){
  .veh-list{ grid-template-columns:1fr; }
  .sheet-tabs{ gap:10px; }
}

/* ====== é ‚éƒ¨å…©åˆ—æ’ç‰ˆï¼ˆæ¨™é¡Œ/åˆ†é  â†â†’ ä½¿ç”¨è€…/æ™‚é˜+æ›´æ–°ï¼‰ ====== */
.topbar-grid{
  display:grid;
  grid-template-columns: 1fr auto;   /* å·¦å¯¬å³çª„ */
  grid-template-rows: auto auto;     /* ä¸Šï¼šæ¨™é¡Œ/ä½¿ç”¨è€…ï¼Œä¸‹ï¼šåˆ†é /æ™‚é˜ */
  gap:6px 12px;
  align-items:center;
}
.topbar-grid .left-title{ grid-area: 1 / 1 / 2 / 2; }
.topbar-grid .left-tabs{  grid-area: 2 / 1 / 3 / 2; }
.topbar-grid .right-user{
  grid-area: 1 / 2 / 2 / 3;
  display:flex; align-items:center; gap:12px; justify-content:flex-end;
}
.topbar-grid .right-refresh{ grid-area: 2 / 2 / 3 / 3; }

/* è®“æ™‚é˜èˆ‡é »ç‡éˆ•é å³ï¼Œé–“è·æ›´ç·Šä¸€äº› */
.refresh-bar{ margin:0; display:flex; gap:8px; align-items:center; justify-content:flex-end; }
.clock{ font-weight:800; font-variant-numeric: tabular-nums; letter-spacing:.5px; }

/* ç™»å…¥é ä¸é¡¯ç¤ºå³å´çš„æ›´æ–°åˆ—ï¼Œä½†ä¿ç•™æ¨™é¡Œ */
body.login .right-refresh{ display:none !important; }

/* Modal ç‰ˆé¢å®‰å…¨é«˜åº¦èˆ‡é…è‰² */
.modal{ max-height: calc(100dvh - 48px); overflow:auto; padding-right:44px !important; max-width:96vw !important; border-radius:12px; }
@supports not (height: 100dvh){ .modal{ max-height: 90vh; } }
.detail-table th{ background: var(--primary-700) !important; color:#fff; }
body.dark .detail-table th{ background: var(--primary-600) !important; }
.detail-table, .detail-table th, .detail-table td{ border-color: var(--border); }
.detail-table thead th:first-child{ border-top-left-radius:10px; }
.detail-table thead th:last-child{  border-top-right-radius:10px; }
/* ç™»å…¥æ¨¡å¼ï¼šåªç•™ Google ç™»å…¥æŒ‰éˆ•èˆ‡å¤§æ¨™é¡Œï¼Œå…¶ä»–ä¸€å¾‹éš±è— */
body.login #mainTabs,
body.login .right-refresh,
body.login #userInfo,
body.login #tabs,
body.login #content,
body.login .tab-pane {
  display: none !important;
}
.user-info{ display:flex; align-items:center; gap:12px; font-size:.875rem; }

/* ===== å€‹åˆ¥æƒ…å ±æ¨£å¼ ===== */
.indiv-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
.indiv-row select{ min-width:240px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; }
.indiv-row select[disabled]{ opacity:.6; cursor:not-allowed; }
.indiv-actions .btn{ min-width:96px; }
.indiv-cards-grid{ display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:12px; margin-top:8px; }
.indiv-card{ border:1px solid var(--border); background:#fff; border-radius:12px; padding:12px; box-shadow:var(--shadow-card); cursor:pointer; }
body.dark .indiv-card{ background:rgba(15,23,42,.30); }
.indiv-card .top{ font-weight:600; margin-bottom:6px; }
.mini-badge{ display:inline-block; font-size:12px; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; }
.indiv-card .mid{ font-size:20px; font-weight:800; letter-spacing:.5px; margin-bottom:6px; }
.indiv-card .bot{ color:#334155; font-size:14px; }
.step-grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
.step-cell{ background:#1d4ed8; color:#fff; padding:8px; border-radius:8px; text-align:center; font-size:14px; }
@media (max-width: 1200px){ .indiv-cards-grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
@media (max-width: 680px){ .indiv-cards-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } .indiv-row select{ min-width:180px; } }
/* å€‹åˆ¥æƒ…å ±ï¼šç²¾ç°¡åç‰‡æ¨£å¼ï¼ˆç½®ä¸­ã€ä¸‰è¡ŒåŒå­—ç´šï¼‰ */
.single-list{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
.single-card{
  border:1px solid var(--border);
  background:rgba(255,255,255,.9);
  border-radius:12px; padding:14px;
  box-shadow:var(--shadow-card);
  text-align:center; cursor:pointer;
}
body.dark .single-card{ background:rgba(15,23,42,.30); }
.single-card:hover{ filter:brightness(1.015); }
.single-line{
  font-size:var(--fz-title);
  line-height:var(--lh-title);
  font-weight:var(--fw-title);
  color:var(--text-strong);
}
.single-line + .single-line{ margin-top:6px; }


</style>
</head>
<body>
<div class="wrap">
  <!-- å…©åˆ—å…©æ¬„çš„é ‚éƒ¨æ’ç‰ˆ -->
  <div class="topbar-grid">
    <!-- å·¦ä¸Šï¼šæ¨™é¡Œï¼ˆç™»å…¥èˆ‡ç™»å…¥å¾Œçš†é¡¯ç¤ºï¼‰ -->
    <div class="left-title">
      <h1 id="pageTitle">è»Šæµäººæµé€€å ´æƒ…å ±</h1>
    </div>

    <!-- å³ä¸Šï¼šç™»å…¥è³‡è¨Š -->
    <div class="right-user">
      <div id="signin"></div>
      <div id="userInfo" class="hide user-info">
      <span id="userDisplay"></span>
        <button id="logoutBtn" class="btn btn--secondary btn--sm" style="padding:6px 12px;">ç™»å‡º</button>
      </div>
    </div>

    <!-- å·¦ä¸‹ï¼šä¸‰å€‹ä¸»é ç±¤ -->
    <div class="left-tabs">
      <div id="mainTabs" class="main-tabs">
        <button class="main-tab active" data-target="pane-punch">ç™»éŒ„</button>
        <button class="main-tab" data-target="pane-dashboard">æ•´é«”æƒ…å ±</button>
        <button class="main-tab" data-target="pane-single">å€‹åˆ¥æƒ…å ±</button>
      </div>
    </div>

    <!-- å³ä¸‹ï¼šæ™‚é˜ + è‡ªå‹•æ›´æ–°é »ç‡ -->
    <div class="right-refresh">
      <div class="refresh-bar">
        <div class="clock" id="clockDisplay" aria-live="polite">--:--:--</div>
        <div class="seg-group" id="refreshControls"></div>
      </div>
    </div>
  </div>

  <!-- ç¬¬ 1 é ï¼šæ²¿ç”¨ï¼ˆæ‰“å¡ + è»Šå¡ï¼‰ -->
  <div id="pane-punch" class="tab-pane">
    <div id="tabs" class="card hide" style="padding-bottom:6px;">
      <div class="sheet-tabs" id="sheetTabs"></div>
    </div>
    <div id="content" class="hide">
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <!-- ç¬¬ 2 é ï¼šæ•´é«”æƒ…å ± -->
  <div id="pane-dashboard" class="tab-pane hide">
  <!-- æ•´é«”æƒ…å ±çš„ 5 å€‹å­åˆ†é  -->
  <div class="card" id="dashTabsBar" style="padding-bottom:6px;">
    <div class="sheet-tabs" id="dashboardTabs"></div>
  </div>
  <!-- å…§å®¹å®¹å™¨ -->
  <div id="dashboard"></div>
</div>


  <!-- ç¬¬ 3 é ï¼šå€‹åˆ¥æƒ…å ± -->
  <div id="pane-single" class="tab-pane hide">
  <div class="card" id="singleControlsCard" style="padding-bottom:10px;">
    <div class="single-controls" id="singleControls">
      <select id="selSheet" class="step-select" aria-label="Tabï¼ˆå¯ä¸é¸ï¼‰">
        <option value="">â€” å…¨éƒ¨ Tab â€”</option>
      </select>
      <select id="selArea" class="step-select" aria-label="å€åŸŸè»Šæ¬¡ç·¨è™Ÿï¼ˆå¯ä¸é¸ï¼‰">
        <option value="">â€” å…¨éƒ¨ å€åŸŸè»Šæ¬¡ç·¨è™Ÿ â€”</option>
      </select>
      <select id="selCar" class="step-select" aria-label="è»Šè™Ÿï¼ˆå¯ä¸é¸ï¼‰">
        <option value="">â€” å…¨éƒ¨ è»Šè™Ÿ â€”</option>
      </select>
    </div>
    <div class="single-actions">
      <button id="btnQuery" class="btn btn--primary btn--sm">æŸ¥è©¢</button>
      <button id="btnReset" class="btn btn--secondary btn--sm">å…¨éƒ¨é‡è¨­</button>
    </div>
  </div>

  <div class="card" id="singleResultsCard">
    <div id="singleResults" class="single-list" aria-live="polite"></div>
  </div>
</div>

</div>

<div id="notif" class="notif"></div>

<!-- å…¨è¢å¹• Loading Overlay -->
<div id="loading" class="loading" role="status" aria-live="polite" aria-busy="true">
  <div class="loading-box">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text">è™•ç†ä¸­â€¦</div>
  </div>
</div>
  

<script>
const GOOGLE_CLIENT_ID = '368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbyXrPj7mmkzlxuIae-MkIvH6vSDHPXrV9qjKXQpdyf5T4aUgymHDpMTzAr7w-QFyiLTYQ/exec';

/* åœè»Šä½ç½®é¸å–® */
const STOP_OPTIONS = [
  'ç¦ªå ‚å¹³å°','æ³•å¿ƒåŒ—è·¯','æ³•å¿ƒå—è·¯ï¼ˆè¥¿ï¼‰','æ³•å¿ƒå—è·¯ï¼ˆæ±ï¼‰','æ³•å¤§è·¯','é›™ç’°è·¯åˆ°ä¸‰é–€','ä¸‰é–€åˆ°å¤§åœè»Šå ´','éˆå±±å‹å¢ƒçŸ³å¾€å¤–','é›™ç’°è·¯è‡³æ³•å¤§ä¸€æ©‹'
];

/* å››å€‹å·¥ä½œè¡¨ */
const SHEET_CONFIGS = [
  { key:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰', sheet:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰', steps:[
    'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š','Call è»Šä¸Šè¡Œæ','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå‰å¾€æ’è»ŠéšŠ','è»Šæš«åœä½ç½®',
    'é€€å ´äººå“¡å·²åˆ°é½Š','å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°','äººå·²å‰å¾€å¹³å°','è»Šç¬¬äºŒæ¬¡ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
  ]},
  { key:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰', sheet:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰', steps:[
    'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š','Call è»Šä¸Šè¡Œæ','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå‰å¾€æ’è»ŠéšŠ','è»Šæš«åœä½ç½®','è»Šå·²é›¢é–‹ç¦ªå ‚å¹³å°'
  ]},
  { key:'æ°´é™¸å°ˆè»Šé€€å ´', sheet:'æ°´é™¸å°ˆè»Šé€€å ´', steps:[
    'å·² Call è»Šæ’è»ŠéšŠ','å·²æ’å¥½è»ŠéšŠ','é€€å ´äººå“¡å·²åˆ°é½Š','å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šæš«åœä½ç½®','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
  ]},
  { key:'288æ³•é’é€€å ´', sheet:'288æ³•é’é€€å ´', steps:[
    'é€€å ´äººå“¡å·²åˆ°é½Š','è»Šå·²ç¶“ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²ç¶“é›¢é–‹éŠè¦½è»Šå¹³å°'
  ]}
];

/* ===== æ–°å¢ï¼šæ™‚é˜ + è‡ªå‹•æ›´æ–°é »ç‡è¨­å®š ===== */
const REFRESH_PRESETS = [
  { label:'5åˆ†',  ms: 5*60*1000 },
  { label:'2åˆ†',  ms: 2*60*1000 },
  { label:'60ç§’', ms: 60*1000 },
  { label:'30ç§’', ms: 30*1000 }
];
const REFRESH_STORAGE_KEY = 'dash_refresh_ms';
let refreshMs = parseInt(localStorage.getItem(REFRESH_STORAGE_KEY) || '', 10);
if (!Number.isFinite(refreshMs) || refreshMs <= 0) refreshMs = 2*60*1000; // é è¨­ 30 ç§’

/* åŸæœ¬çš„ dashboard è¨ˆæ™‚å™¨ */
let dashTimer = null;
let currentDashFilter = 'ALL'; // 'ALL' æˆ–æŸä¸€å€‹ SHEET_CONFIGS[i].key

let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = []; // æ‰“å¡é ä½¿ç”¨
const TOKEN_STORAGE_KEY = 'ddcc_user_token';
let idToken = null;

/* ---------------- åˆå§‹ç™»å…¥èˆ‡é ç±¤ ---------------- */
window.onload = function(){
  // å•Ÿå‹•æ™‚é˜ & å»ºç«‹æ›´æ–°é »ç‡æ§åˆ¶åˆ—
  startClock();
  buildRefreshControls();
  updateRefreshControlsVisibility();

  const saved = sessionStorage.getItem(TOKEN_STORAGE_KEY);
  if (saved) {
    idToken = saved;
    fetch(API_BASE + '?action=verify', {
      method: 'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify({ idToken })
    })
    .then(r => r.json())
    .then(j => {
      if (j.error) throw new Error(j.error);
      currentUser = j;
      finishLoginUI();
      buildTabs();
      loadSheetData(currentSheetKey);
    })
    .catch(() => {
      logout();
      initGoogleSignIn();
    });
  } else {
    initGoogleSignIn();
  }

  document.getElementById('logoutBtn').addEventListener('click', logout);
};



/* ===== æ™‚é˜ï¼ˆæ™‚å€ +8ã€hh:mm:ssï¼‰ ===== */
function getTaipeiHHMMSS(){ return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date()); }
function startClock(){
  const el = document.getElementById('clockDisplay');
  const tick = ()=>{ if (el) el.textContent = getTaipeiHHMMSS(); };
  tick();
  setInterval(tick, 1000);
}

/* ===== è‡ªå‹•æ›´æ–°é »ç‡æ§åˆ¶åˆ— ===== */
function buildRefreshControls(){
  const box = document.getElementById('refreshControls');
  if (!box) return;
  box.innerHTML = '';

  // é »ç‡æŒ‰éˆ•
  REFRESH_PRESETS.forEach(p=>{
    const btn = document.createElement('button');
    btn.className = 'seg-btn';
    btn.textContent = p.label;
    btn.dataset.ms = String(p.ms);
    if (p.ms === refreshMs){
      btn.classList.add('active');
      btn.disabled = true; // ç•¶å‰é¸æ“‡ï¼šä¸å¯æŒ‰ã€è®Šè‰²
    }
    btn.onclick = ()=> openRefreshSaveDialog(p.ms, p.label);
    box.appendChild(btn);
  });

  // ç«‹å³æ›´æ–°
  const nowBtn = document.createElement('button');
  nowBtn.className = 'seg-btn';
  nowBtn.textContent = 'ç«‹å³æ›´æ–°';
  nowBtn.title = 'ç«‹åˆ»é‡æ–°æ•´ç†æ•´é«”æƒ…å ±';
  nowBtn.onclick = ()=> {
    if (isDashboardVisible()) buildDashboard(false);
    else showNotif('åˆ‡åˆ°ã€Œæ•´é«”æƒ…å ±ã€å³å¯çœ‹åˆ°æœ€æ–°è³‡æ–™', false);
  };
  box.appendChild(nowBtn);
}

/* ===== åªåœ¨ã€Œæ•´é«”æƒ…å ±ã€é¡¯ç¤ºæ›´æ–°æ™‚é–“æŒ‰éˆ• ===== */
function updateRefreshControlsVisibility(){
  try{
    const controls = document.getElementById('refreshControls');
    if (!controls) return;
    const show = isDashboardVisible() && !document.body.classList.contains('login');
    controls.classList.toggle('hide', !show);
  }catch(e){ /* noop */ }
}

function openRefreshSaveDialog(ms, label){
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3>å„²å­˜è‡ªå‹•æ›´æ–°é »ç‡</h3>
    <div class="modal-msg" style="font-size:15px;line-height:1.7;margin:6px 0 10px;">
      å°‡è‡ªå‹•æ›´æ–°é »ç‡è¨­å®šç‚º <b>${label}</b>ã€‚æŒ‰ã€Œå„²å­˜ã€å¾Œå³åˆ»ç”Ÿæ•ˆã€‚
    </div>
    <div class="actions">
      <button class="btn" style="background:#e5e7eb;color:#111827;">å–æ¶ˆ</button>
      <button class="btn btn--primary">å„²å­˜</button>
    </div>
  `;
  const close = openModal(box);
  const [btnCancel, btnOK] = box.querySelectorAll('button');
  btnCancel.onclick = close;
  btnOK.onclick = ()=>{
    try{
      refreshMs = ms;
      localStorage.setItem(REFRESH_STORAGE_KEY, String(refreshMs));
      updateRefreshButtonsUI();
      if (isDashboardVisible()){
        startDashboardAutoRefresh();     // é‡å•Ÿå®šæ™‚ï¼ˆæ–°é »ç‡ï¼‰
      }
      showNotif(`å·²è¨­å®šç‚ºæ¯ ${label} è‡ªå‹•æ›´æ–°`, false);
    } finally{ close(); }
  };
}

function updateRefreshButtonsUI(){
  const btns = document.querySelectorAll('#refreshControls .seg-btn');
  btns.forEach(btn=>{
    if (btn.textContent === 'ç«‹å³æ›´æ–°') return; // æ°¸é ä¸è®Šè‰²
    const ms = parseInt(btn.dataset.ms||'0',10);
    const isActive = (ms === refreshMs);
    btn.classList.toggle('active', isActive);
    btn.disabled = isActive;
  });
}

/* ---------------- Google Sign-Inï¼ˆåŸï¼‰ ---------------- */
function initGoogleSignIn() {
  enterLoginView(); // ç¢ºä¿æ‰€æœ‰é¢æ¿éƒ½é—œæ‰
  google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredential });
  google.accounts.id.renderButton(document.getElementById('signin'), { theme:'outline', size:'large' });

  // åªæ˜¯å»ºç«‹æŒ‰éˆ• DOMï¼Œç™»å…¥æ¨¡å¼ä¸‹æœƒè¢« CSS éš±è—
  buildTabs();
}

function buildTabs(){
  const box = document.getElementById('sheetTabs');
  box.innerHTML = '';
  if (!SHEET_CONFIGS.length) return;

  const prevKey = currentSheetKey;
  if (!SHEET_CONFIGS.some(s => s.key === currentSheetKey)) currentSheetKey = SHEET_CONFIGS[0].key;
  const keyChanged = (prevKey !== currentSheetKey);

  SHEET_CONFIGS.forEach(cfg => {
    const btn = document.createElement('button');
    btn.className = 'btn-tab tab' + (cfg.key === currentSheetKey ? ' active' : '');
    btn.textContent = cfg.key;
    btn.onclick = () => {
      currentSheetKey = cfg.key;
      box.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      loadSheetData(currentSheetKey);
    };
    box.appendChild(btn);
  });

  const contentShown = !document.getElementById('content').classList.contains('hide');
  if (keyChanged && contentShown) loadSheetData(currentSheetKey);
}
function buildDashboardTabs(){
  const box = document.getElementById('dashboardTabs');
  if (!box) return;
  box.innerHTML = '';

  const makeBtn = (label, key) => {
    const btn = document.createElement('button');
    btn.className = 'btn-tab' + (currentDashFilter === key ? ' active' : '');
    btn.textContent = label;
    btn.dataset.key = key;              // ç”¨ data-key ä¾†è¾¨è­˜
    btn.onclick = () => {
      if (currentDashFilter === key) return;
      currentDashFilter = key;
      updateDashTabActive();
      buildDashboard(false);            // ä¾æ–°ç¯©é¸é‡ç¹ª
    };
    box.appendChild(btn);
  };

  makeBtn('æ‰€æœ‰è»Šè¼›', 'ALL');
  SHEET_CONFIGS.forEach(cfg => makeBtn(cfg.key, cfg.key));
}

function updateDashTabActive(){
  const box = document.getElementById('dashboardTabs');
  if (!box) return;
  box.querySelectorAll('.btn-tab').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.key === String(currentDashFilter));
  });
}

  
async function handleCredential(resp) {
  idToken = resp.credential;
  localStorage.setItem(TOKEN_STORAGE_KEY, idToken);
  try {
    const r = await fetch(API_BASE + '?action=verify', { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify({ idToken }) });
    const j = await r.json(); if (j.error) throw new Error(j.error);
    currentUser = j; finishLoginUI(); loadSheetData(currentSheetKey);
  } catch (err) { showNotif('ç™»å…¥å¤±æ•—ï¼š' + err.message, true); logout(); }
}
function finishLoginUI() {
  updateRefreshControlsVisibility();
  document.body.classList.remove('login');
  document.getElementById('signin').classList.add('hide');
  const ui = document.getElementById('userInfo'); ui.classList.remove('hide');
  ui.style.display = ''; // é‚„åŸç”± CSS æ§åˆ¶
const nameSafe  = escapeHtml(currentUser.name || '');
const emailSafe = escapeHtml(currentUser.email || '');
const permSafe  = escapeHtml(currentUser.permission || '');
document.getElementById('userDisplay').innerHTML =
  `${nameSafe} &lt;${emailSafe}&gt; ï½œ æ¬Šé™ï¼š<b>${permSafe}</b>`;
document.getElementById('tabs').classList.remove('hide');
document.getElementById('content').classList.remove('hide');

  if (currentUser.permission === 'æª¢è¦–') showNotif('ç›®å‰ç‚ºã€Œæª¢è¦–ã€æ¬Šé™ï¼šæ‰€æœ‰æŒ‰éˆ•èˆ‡ä¸‹æ‹‰çš†ç‚ºå”¯è®€', false);
  // â˜… é€²å…¥å¾Œçµ±ä¸€åˆ‡å›ã€Œç™»éŒ„ã€é ï¼Œé¿å…ä¸Šæ¬¡åœåœ¨æ•´é«”æƒ…å ±
  switchPane('pane-punch');

  // ï¼ˆå¯é¸ï¼‰æ¢å¾©é ç±¤å¯èšç„¦
  document.querySelectorAll('#mainTabs .main-tab')
    .forEach(b => { b.tabIndex = 0; b.removeAttribute('aria-disabled'); });
}
function logout() {
  localStorage.removeItem(TOKEN_STORAGE_KEY);
  idToken = null;
  currentUser = null;

  enterLoginView();           // å…ˆåˆ‡å›ç™»å…¥ç‰ˆé¢ï¼Œçµ±ä¸€éš±è—æ‰€æœ‰ pane
  stopDashboardAutoRefresh(); // é—œæ‰å„€è¡¨æ¿è‡ªå‹•åˆ·æ–°

  const signinDiv = document.getElementById('signin');
  signinDiv.classList.remove('hide');
  signinDiv.innerHTML = '';

  google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: handleCredential });
  google.accounts.id.renderButton(signinDiv, { theme:'outline', size:'large' });

  showNotif('å·²ç™»å‡º', false);
}

/* ---------------- å·¥å…· ---------------- */
function escapeHtml(str){
  if (str == null) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}


/* ---------------- å·¥å…· ---------------- */
function formatSheetTime(val){
  if (!val) return '';
  const s = String(val).trim();
  if (/^\d{1,2}:\d{2}:\d{2}$/.test(s)) return s.split(':').map(p=>p.padStart(2,'0')).join(':');
  if (/^\d{4}\/\d{1,2}\/\d{1,2} \d{1,2}:\d{2}:\d{2}$/.test(s)) return s.split(' ')[1].split(':').map(p=>p.padStart(2,'0')).join(':');
  const m = s.match(/^(ä¸Šåˆ|ä¸‹åˆ)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (m){ let h=+m[2]; const mm=m[3], ss=m[4]||'00'; if (m[1]==='ä¸‹åˆ'&&h<12) h+=12; if (m[1]==='ä¸Šåˆ'&&h===12) h=0; return `${String(h).padStart(2,'0')}:${mm}:${ss}`;}
  if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(s)){ const d=new Date(s); const tw=new Date(d.getTime()+8*3600*1000); const hh=String(tw.getUTCHours()).padStart(2,'0'); const mm=String(tw.getUTCMinutes()).padStart(2,'0'); const ss=String(tw.getUTCSeconds()).padStart(2,'0'); return `${hh}:${mm}:${ss}`;}
  return s;
}
const pad2 = n => String(n).padStart(2,'0');
const splitHMS = v => { const s=String(v||'').trim(); const m=s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/); return m?[pad2(m[1]),m[2],m[3]?m[3]:'00']:['','','']; };
const isValidHMS = (h,m,s) => (/^\d{2}$/.test(h)&&/^\d{2}$/.test(m)&&/^\d{2}$/.test(s) && +h<=23 && +m<=59 && +s<=59);
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
function showLoading(msg='è™•ç†ä¸­â€¦'){ const el=document.getElementById('loading'); if(!el) return; const t=el.querySelector('.loading-text'); if(t) t.textContent=msg; el.classList.add('show'); document.body.classList.add('loading-open'); }
function hideLoading(){ const el=document.getElementById('loading'); if(!el) return; el.classList.remove('show'); document.body.classList.remove('loading-open'); }
async function withLoading(fn,msg='è™•ç†ä¸­â€¦'){ showLoading(msg); try{ return await fn(); } finally{ hideLoading(); } }
function showNotif(msg,isErr){ const box=document.getElementById('notif'); box.textContent=msg; box.style.background=isErr?'rgba(248,113,113,.9)':'rgba(15,23,42,.85)'; box.classList.add('show'); setTimeout(()=>box.classList.remove('show'), 2500); }
function enterLoginView(){
  updateRefreshControlsVisibility();
  // æ¨™è¨˜ç‚ºç™»å…¥ç•«é¢
  document.body.classList.add('login');

  // åœæ­¢ä»»ä½•è‡ªå‹•åˆ·æ–°ï¼Œä¸¦æ¸…ç©ºå„€è¡¨æ¿
  stopDashboardAutoRefresh?.();
  try { document.getElementById('dashboard').innerHTML = ''; } catch {}

  // é—œæ‰æ‰€æœ‰å·¥ä½œé 
  ['pane-punch','pane-dashboard','pane-single'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.classList.add('hide');
  });

  // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•ã€éš±è—ä½¿ç”¨è€…è³‡è¨Š
  const signinDiv = document.getElementById('signin');
  if (signinDiv) signinDiv.classList.remove('hide');
  const ui = document.getElementById('userInfo');
  if (ui) {
    ui.classList.add('hide');
    ui.style.display = 'none'; // ç¢ºä¿éš±è—è©²å€å¡Š
  }

  // ï¼ˆå¯é¸ï¼‰é¿å…éµç›¤ Tab åˆ°éš±è—çš„é ç±¤
  document.querySelectorAll('#mainTabs .main-tab')
    .forEach(b => { b.tabIndex = -1; b.setAttribute('aria-disabled','true'); });
}


/* Modalï¼šè¦†è“‹é  */
function closeAllModals(){ document.querySelectorAll('.modal, .modal-backdrop').forEach(el=>{ try{el.remove()}catch{} }); document.body.classList.remove('modal-open'); }
function openModal(element){
  const MAX_Z = 2147483647; // æœ€é«˜å±¤
  const layer = document.createElement('div');

  // å…¨è¢å¹•è¦†è“‹å±¤ï¼šå›ºå®šåœ¨å¯è¦–å€ã€ç½®ä¸­é¡¯ç¤º
  Object.assign(layer.style, {
    position:'fixed',
    inset:'0',
    width:'100vw',
    height:'100vh',
    background:'rgba(0,0,0,.45)',
    zIndex: String(MAX_Z),
    display:'grid',
    placeItems:'center'
  });

  // å°è©±æ¡†æœ¬é«”ï¼šä½¿ç”¨ç›¸å°å®šä½ã€é™åˆ¶æœ€å¤§å°ºå¯¸ï¼ˆä¿®æ­£å°‘é€—è™Ÿçš„ bugï¼‰
  element.classList.add('modal');
  Object.assign(element.style, {
    position:'relative',
    top:'auto',
    left:'auto',
    transform:'none',
    margin:'0',
    maxWidth:'min(1300px,96vw)',
    maxHeight:'min(86dvh, 640px)',
    overflow:'auto'
  });

  // æ’å…¥ DOM
  layer.appendChild(element);
  document.body.appendChild(layer);
  document.body.classList.add('modal-open');

  // é‡å°è¡Œå‹•è£ç½®éµç›¤/å‹•æ…‹è¦–å£ï¼šè·Ÿéš¨ VisualViewport
  function syncToVisualViewport(){
    const vv = window.visualViewport;
    if(!vv) return;
    layer.style.width  = vv.width + 'px';
    layer.style.height = vv.height + 'px';
    layer.style.left   = vv.offsetLeft + 'px';
    layer.style.top    = vv.offsetTop + 'px';
  }
  if (window.visualViewport){
    syncToVisualViewport();
    window.visualViewport.addEventListener('resize', syncToVisualViewport);
    window.visualViewport.addEventListener('scroll', syncToVisualViewport);
  }

  // Esc é—œé–‰
  const onEsc = e => { if (e.key === 'Escape') cleanup(); };
  document.addEventListener('keydown', onEsc);

  function cleanup(){
    document.body.classList.remove('modal-open');
    document.removeEventListener('keydown', onEsc);
    if (window.visualViewport){
      window.visualViewport.removeEventListener('resize', syncToVisualViewport);
      window.visualViewport.removeEventListener('scroll', syncToVisualViewport);
    }
    try{ layer.remove(); }catch{}
  }
  return cleanup;
}

/* ---------------- æ‰“å¡é ï¼šè¼‰å…¥è³‡æ–™ & æ¸²æŸ“ ---------------- */
async function loadSheetData(key){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  document.getElementById('vehList').textContent = 'è®€å–ä¸­...';

  const r = await fetch(
    API_BASE + `?action=get&idToken=${encodeURIComponent(idToken || '')}&sheet=${encodeURIComponent(cfg.sheet)}`
  );
  const j = await r.json();
  if (j.error){
    document.getElementById('vehList').textContent = 'âŒ ' + j.error;
    return;
  }
  sheetData = j.values || [];
  renderVehicles(cfg, sheetData);
}

  
function isCompletedValue(v){ if (v==null) return false; const s=String(v).trim(); return !!s && s!=='â€”' && s!=='-'; }

/* ====== æ‰“å¡é  renderVehicles ====== */
function renderVehicles(cfg, data) {
    const box = document.getElementById('vehList'); box.innerHTML = '';
  const canWrite = currentUser?.permission === 'å…¨åŠŸèƒ½';
  const headerRowIdx = data.findIndex(row => Array.isArray(row) && String(row[0]||'').trim()==='ç·¨è™Ÿ' && String(row[1]||'').trim().startsWith('å€åŸŸ') && String(row[2]||'').trim()==='è»Šè™Ÿ');
  if (headerRowIdx === -1){ box.textContent='æ‰¾ä¸åˆ°è¡¨é ­'; return; }
  const header = data[headerRowIdx].map(c=>String(c||'').trim());
  const rows = data.slice(headerRowIdx+1).filter(r => Array.isArray(r) && String(r[0]||'').trim() && String(r[1]||'').trim() && String(r[2]||'').trim());
  if (!rows.length){ box.textContent='(é€™å¼µè¡¨ç›®å‰æ²’æœ‰è»Šè¼›è³‡æ–™)'; return; }

  const cards=[];
  rows.forEach((row, idx) => {
    const area=String(row[1]||'').trim(); const car=String(row[2]||'').trim(); const baseRow = headerRowIdx+2+idx;
    const {completed,total} = computeCompletion(cfg, header, row);
    const card = document.createElement('div');
    card.className = 'veh-card';
    card.innerHTML =
      `<div>
         <div class="veh-title-main">${escapeHtml(area)}</div>
         <div class="veh-title-sub">${escapeHtml(car)}</div>
       </div>`;

    // è®“åç‰‡ä¸Šæ–¹æ¨™é¡Œå€å¯é»æ“Šçœ‹è©³æƒ…ï¼ˆæ¡ç”¨æ•´é«”æƒ…å ±æ¨£å¼ï¼‰
    const headWrap = card.querySelector(':scope > div:first-child');
    if (headWrap){
      headWrap.style.cursor = 'pointer';
      headWrap.setAttribute('title','é»æˆ‘çœ‹è©³æƒ…');
      headWrap.addEventListener('click', (e)=>{
        // ç”¨ã€Œcfg + header + rowã€ç›´æ¥å‘¼å«æ–°çš„ openDetailModal
        openDetailModal(cfg, row, header);
      });
    }

    const stepsBox=document.createElement('div');

    cfg.steps.forEach(st=>{
      const colIdx=header.indexOf(st);
      const rawVal = (colIdx!==-1 && row[colIdx]!=null) ? String(row[colIdx]).trim(): '';
      const displayVal = rawVal?formatSheetTime(rawVal):'';
      const rowEl=document.createElement('div'); rowEl.className='step-row';
      const labelEl=document.createElement('div'); labelEl.className='step-label'; labelEl.textContent=st; rowEl.appendChild(labelEl);

      if (st==='è»Šæš«åœä½ç½®'){
        const valueEl=document.createElement('div');
        const sel=document.createElement('select'); sel.className='step-select select';
        const optEmpty=document.createElement('option'); optEmpty.value=''; optEmpty.textContent='â€” è«‹é¸æ“‡ â€”'; sel.appendChild(optEmpty);
        STOP_OPTIONS.forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; sel.appendChild(o); });
        if (rawVal) sel.value=rawVal;
        const ghost=document.createElement('span'); ghost.style.display='none';
        valueEl.appendChild(sel); valueEl.appendChild(ghost); rowEl.appendChild(valueEl);
        const btnG=document.createElement('div'); btnG.className='btn-group'; rowEl.appendChild(btnG);
        if (!canWrite){ sel.disabled=true; rowEl.classList.add('locked'); }
        else {
          const prevOk=prevDone(cfg, header, row, st); if (!prevOk && !rawVal) sel.disabled=true;
          sel.onchange=()=>onStopSelect(cfg, baseRow, header, st, sel.value, ghost);
        }
        stepsBox.appendChild(rowEl); return;
      }

      const timeSpan=document.createElement('span'); timeSpan.className='step-time'; timeSpan.textContent=displayVal||'â€”'; rowEl.appendChild(timeSpan);
      const btnG=document.createElement('div'); btnG.className='btn-group';
      const btnPunch=document.createElement('button'); btnPunch.className='btn btn--primary btn--sm btn-punch'; btnPunch.textContent='æ‰“å¡';
      const btnEdit=document.createElement('button'); btnEdit.className='btn btn--success btn--sm btn-edit'; btnEdit.textContent='ä¿®æ”¹';
      const btnDel=document.createElement('button'); btnDel.className='btn btn--danger btn--sm btn-del'; btnDel.textContent='åˆªé™¤';
      btnG.appendChild(btnPunch); btnG.appendChild(btnEdit); btnG.appendChild(btnDel); rowEl.appendChild(btnG);

      if (!canWrite){ btnPunch.disabled=btnEdit.disabled=btnDel.disabled=true; rowEl.classList.add('locked'); }
      else{
        const prevOk=prevDone(cfg, header, row, st); const hasVal=!!rawVal;
        if (!prevOk && !hasVal){ btnPunch.disabled=btnEdit.disabled=btnDel.disabled=true; }
        else{
          btnPunch.disabled=hasVal; btnEdit.disabled=btnDel.disabled=!hasVal;
          btnPunch.onclick=()=>onPunchClick(cfg, baseRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl);
          btnEdit.onclick =()=>onEditTimeClick(cfg, baseRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl, displayVal);
          btnDel.onclick  =()=>onDeleteTimeClick(cfg, baseRow, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl);
        }
      }
      stepsBox.appendChild(rowEl);
    });

    card.appendChild(stepsBox);

    // å‚™è¨»
    const memoWrap=document.createElement('div'); memoWrap.style.marginTop='8px';
    const memoRow=document.createElement('div'); memoRow.style.cssText='display:flex;gap:8px;align-items:flex-start;';
    const memoTA=document.createElement('textarea'); memoTA.className='textarea'; memoTA.placeholder='å‚™è¨»'; memoTA.style.flex='1';
    let memoColIdx=header.indexOf('å‚™è¨»'); if (memoColIdx===-1) memoColIdx=header.length-1;
    memoTA.value=(memoColIdx!==-1 && row[memoColIdx]) ? String(row[memoColIdx]):'';
    const memoBtn=document.createElement('button'); memoBtn.className='btn btn--primary'; memoBtn.textContent='å„²å­˜'; memoBtn.disabled=!canWrite;

    // ğŸ”½ é€™è£¡æ˜¯æ›´æ–°å¾Œçš„å‚™è¨»å„²å­˜é‚è¼¯
        memoBtn.onclick = async () => {
      if (!canWrite) return;

      try {
        await postUpdate(
          cfg,
          [{ row: baseRow, col: memoColIdx + 1, value: memoTA.value }],
          { mode: 'memo', loadingText: 'å„²å­˜å‚™è¨»â€¦' }
        );

        showNotif('å‚™è¨»å·²å„²å­˜', false);
      } catch (err) {
        console.error('å‚™è¨»å„²å­˜å¤±æ•—ï¼š', err);
        showNotif('å‚™è¨»å„²å­˜å¤±æ•—ï¼š' + err.message, true);
      }
    };


    memoRow.appendChild(memoTA); memoRow.appendChild(memoBtn); memoWrap.appendChild(memoRow); card.appendChild(memoWrap);

    cards.push({ el:card, completed, total, origOrder:idx });
  });

  cards.sort((a,b)=> (a.completed!==b.completed ? a.completed-b.completed : a.origOrder-b.origOrder));
  cards.forEach(c=>box.appendChild(c.el));
}
// å…±ç”¨ï¼šé€å‡ºå¯«å…¥è«‹æ±‚ï¼ˆæ‰€æœ‰å¯«å…¥éƒ½èµ°é€™è£¡ï¼‰
async function postUpdate(cfg, writes, options = {}) {
  const { mode, loadingText } = options;

  // åŸºæœ¬æ¬Šé™æª¢æŸ¥ï¼ˆå‰ç«¯å…ˆæ“‹ä¸€å±¤ï¼Œä½†çœŸæ­£æ±ºå®šæ¬Šåœ¨å¾Œç«¯ï¼‰
  if (!currentUser) {
    alert('è«‹å…ˆç™»å…¥');
    throw new Error('not_logged_in');
  }
  if (currentUser.permission !== 'å…¨åŠŸèƒ½') {
    alert('æ¬Šé™ä¸è¶³');
    throw new Error('no_permission');
  }
  if (!idToken) {
    alert('ç™»å…¥ç‹€æ…‹å·²å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥');
    throw new Error('missing_idToken');
  }

  await withLoading(async () => {
    const body = {
      sheet: cfg.sheet,
      email: currentUser.email || '',
      idToken: idToken,
      writes: writes
    };
    if (mode) body.mode = mode;   // åªæœ‰æ‰“å¡ç­‰éœ€è¦æ‰å¸¶ mode

    const r = await fetch(API_BASE + '?action=update', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });

    let j;
    try {
      j = await r.json();
    } catch (e) {
      throw new Error('ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤ï¼ˆé JSONï¼‰ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²æˆ–æ¬Šé™è¨­å®š');
    }

    if (!j.ok) {
      throw new Error(j.error || 'æ›´æ–°å¤±æ•—');
    }

    await sleep(200);
    await reloadSheet();
  }, loadingText || 'æ›´æ–°ä¸­â€¦');
}

  
function prevDone(cfg, header, row, st){ const idx=cfg.steps.indexOf(st); if (idx===0) return true; const prev=cfg.steps[idx-1]; const col=header.indexOf(prev); if (col===-1) return true; return !!row[col]; }

async function onStopSelect(cfg, rowNumber, header, st, value, span) {
  const colIdx = header.indexOf(st);
  if (colIdx === -1) {
    alert('æ­¤æ¬„ä½ä¸å­˜åœ¨ï¼š' + st);
    return;
  }

  try {
    await postUpdate(
      cfg,
      [{ row: rowNumber, col: colIdx + 1, value }],
      { mode: 'stop', loadingText: 'æ›´æ–°è»Šæš«åœä½ç½®â€¦' }
    );

    // å¾Œç«¯æˆåŠŸå¾Œæ‰æ›´æ–°ç•«é¢
    span.textContent = value || '';
    showNotif(value ? 'å·²æ›´æ–°è»Šæš«åœä½ç½®' : 'å·²æ¸…é™¤è»Šæš«åœä½ç½®', false);
  } catch (err) {
    console.error('è»Šæš«åœä½ç½®æ›´æ–°å¤±æ•—ï¼š', err);
    showNotif('è»Šæš«åœä½ç½®æ›´æ–°å¤±æ•—ï¼š' + err.message, true);
  }
}
  
  
// æ‰“å¡æŒ‰éˆ•äº‹ä»¶
async function onPunchClick(cfg, rowNumber, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl) {
  const colIdx = header.indexOf(st);
  if (colIdx === -1) {
    alert('æ­¤æ¬„ä½ä¸å­˜åœ¨ï¼š' + st);
    return;
  }

  // å–å¾—å°åŒ—æ™‚é–“ HH:mm:ss
  const now = getTaipeiHHMMSS();

  try {
    await postUpdate(
      cfg,
      [{ row: rowNumber, col: colIdx + 1, value: now }],
      { mode: 'punch', loadingText: 'æ‰“å¡ä¸­â€¦' }
    );

    // å¾Œç«¯å¯«å…¥æˆåŠŸï¼Œæ›´æ–° UI
    const wasEmpty = !timeSpan.textContent || timeSpan.textContent.trim() === 'â€”';
    timeSpan.textContent = formatSheetTime(now);
    btnPunch.disabled = true;
    btnEdit.disabled  = false;
    btnDel.disabled   = false;
    if (wasEmpty) {
      unlockNext(rowEl);   // è§£é–ä¸‹ä¸€æ­¥
    }

    showNotif('å·²æ‰“å¡', false);
  } catch (err) {
    console.error('æ‰“å¡å¤±æ•—ï¼š', err);
    showNotif('æ‰“å¡å¤±æ•—ï¼š' + err.message, true);
  }
}





async function onEditTimeClick(cfg, rowNumber, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl, currentVal) {
  const colIdx = header.indexOf(st);
  if (colIdx === -1) {
    alert('æ­¤æ¬„ä½ä¸å­˜åœ¨ï¼š' + st);
    return;
  }

  const initial = currentVal || timeSpan.textContent || getTaipeiHHMMSS();

  openEditTimeDialog(initial, async (newHHMMSS) => {
    try {
      await postUpdate(
        cfg,
        [{ row: rowNumber, col: colIdx + 1, value: newHHMMSS }],
        { mode: 'edit', loadingText: 'å„²å­˜ä¸­â€¦' }
      );

      const wasEmpty = !timeSpan.textContent || timeSpan.textContent.trim() === 'â€”';
      timeSpan.textContent = formatSheetTime(newHHMMSS);
      if (wasEmpty) {
        unlockNext(rowEl);
      }

      btnPunch.disabled = true;
      btnEdit.disabled  = false;
      btnDel.disabled   = false;

      showNotif('å·²ä¿®æ”¹æ™‚é–“', false);
    } catch (err) {
      console.error('ä¿®æ”¹æ™‚é–“å¤±æ•—ï¼š', err);
      showNotif('ä¿®æ”¹æ™‚é–“å¤±æ•—ï¼š' + err.message, true);
    }
  });
}


async function onDeleteTimeClick(cfg, rowNumber, header, st, timeSpan, btnPunch, btnEdit, btnDel, rowEl) {
  const colIdx = header.indexOf(st);
  if (colIdx === -1) {
    alert('æ­¤æ¬„ä½ä¸å­˜åœ¨ï¼š' + st);
    return;
  }

  openConfirmDialog('ç¢ºå®šè¦åˆªé™¤æ™‚é–“è³‡æ–™å—ï¼Ÿ', async () => {
    try {
      await postUpdate(
        cfg,
        [{ row: rowNumber, col: colIdx + 1, value: '' }],
        { mode: 'delete', loadingText: 'åˆªé™¤ä¸­â€¦' }
      );

      timeSpan.textContent = '';
      btnPunch.disabled = false;
      btnEdit.disabled  = true;
      btnDel.disabled   = true;
      lockFollowing(rowEl);

      showNotif('å·²åˆªé™¤', false);
    } catch (err) {
      console.error('åˆªé™¤æ™‚é–“å¤±æ•—ï¼š', err);
      showNotif('åˆªé™¤æ™‚é–“å¤±æ•—ï¼š' + err.message, true);
    }
  });
}


  
function reloadSheet(){ loadSheetData(currentSheetKey); }
function unlockNext(rowEl){
  const nextRow=rowEl?.nextElementSibling; if(!nextRow) return;
  const sel=nextRow.querySelector('.step-select'); const timeSpan=nextRow.querySelector('.step-time');
  const btnPunch=nextRow.querySelector('.btn-punch'); const btnEdit=nextRow.querySelector('.btn-edit'); const btnDel=nextRow.querySelector('.btn-del');
  if (currentUser?.permission!=='å…¨åŠŸèƒ½') return;
  if (sel){ sel.disabled=false; return; }
  if (btnPunch){ const hasVal=!!(timeSpan && timeSpan.textContent.trim() && timeSpan.textContent.trim()!=='â€”'); btnPunch.disabled=hasVal; if(btnEdit) btnEdit.disabled=!hasVal; if(btnDel) btnDel.disabled=!hasVal; }
}
function lockFollowing(rowEl){
  let it=rowEl?.nextElementSibling;
  while(it){
    const sel=it.querySelector('.step-select'); const timeSpan=it.querySelector('.step-time');
    const btnPunch=it.querySelector('.btn-punch'); const btnEdit=it.querySelector('.btn-edit'); const btnDel=it.querySelector('.btn-del');
    if (sel && !sel.value) sel.disabled=true;
    if (btnPunch){ const hasVal=!!(timeSpan && timeSpan.textContent.trim() && timeSpan.textContent.trim()!=='â€”'); if(!hasVal){ btnPunch.disabled=true; if(btnEdit) btnEdit.disabled=true; if(btnDel) btnDel.disabled=true; } }
    it=it.nextElementSibling;
  }
}
function computeCompletion(cfg, header, row) {
  const usableSteps = cfg.steps.filter(st => header.indexOf(st) !== -1);
  let completed = 0;
  for (const st of usableSteps) {
    const colIdx = header.indexOf(st);
    const val = (colIdx !== -1 && colIdx < row.length) ? row[colIdx] : '';
    if (isCompletedValue(val)) completed++;
  }
  return { completed, total: usableSteps.length };
}

/* ===== é ‚å±¤ä¸‰é åˆ‡æ› ===== */
const PANE_IDS=['pane-punch','pane-dashboard','pane-single'];
function switchPane(targetId){
  // æœªç™»å…¥å°±ä¸è¦åˆ‡æ›
  if (!currentUser) {
    showNotif('è«‹å…ˆç™»å…¥', true);
    return;
  }

  // åˆ‡æ› tab æ¨£å¼èˆ‡é¡¯ç¤ºå°æ‡‰é¢æ¿
  document.querySelectorAll('#mainTabs .main-tab')
    .forEach(btn => btn.classList.toggle('active', btn.dataset.target === targetId));
  PANE_IDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.toggle('hide', id !== targetId);
  });

  updateRefreshControlsVisibility();

  // æ•´é«”æƒ…å ±ï¼šå•Ÿå‹•è‡ªå‹•åˆ·æ–°ï¼›å…¶ä»–é åœæ‰
  if (targetId === 'pane-dashboard') {
    buildDashboardTabs();
    buildDashboard(false);
    startDashboardAutoRefresh();
  } else {
    stopDashboardAutoRefresh();
  }

  // å€‹åˆ¥æƒ…å ±ï¼šåˆå§‹åŒ–ï¼ˆå…§éƒ¨æœ‰ singleInitialized é˜²é‡è¤‡ï¼‰
  if (targetId === 'pane-single') {
    initSinglePage();
  }
}



function isDashboardVisible() {
  return !document.getElementById('pane-dashboard').classList.contains('hide');
}
function startDashboardAutoRefresh() {
  stopDashboardAutoRefresh();
  dashTimer = setInterval(() => {
    if (isDashboardVisible()) buildDashboard(true); // éœé»˜åˆ·æ–°
  }, refreshMs);
}
function stopDashboardAutoRefresh() {
  if (dashTimer) { clearInterval(dashTimer); dashTimer = null; }
}
// é é¢å¯è¦‹æ€§åˆ‡æ›æ™‚è‡ªå‹•æš«åœ/æ¢å¾©
document.addEventListener('visibilitychange', () => {
  updateRefreshControlsVisibility();
  if (document.hidden) stopDashboardAutoRefresh();
  else if (isDashboardVisible()) startDashboardAutoRefresh();
});

document.getElementById('mainTabs').addEventListener('click', (e)=>{
  const btn=e.target.closest('.main-tab'); if(!btn) return; switchPane(btn.dataset.target);
});

/* ======================= æ•´é«”æƒ…å ± ======================= */
let ALL_SHEETS = {}; // { key: { cfg, headerIdx, header, rows } }

// æ”¯æ´éœé»˜åˆ·æ–°ï¼šbuildDashboard(true) æœƒä¸é¡¯ç¤º Loading
async function buildDashboard(silent = false){
  if (!currentUser) return;                              // â˜… æœªç™»å…¥ç›´æ¥é€€å‡º
  if (document.body.classList.contains('login')) return; // â˜… ä¿éšª

  const dash = document.getElementById('dashboard');
  dash.innerHTML = '';
    const work = async () => {
    // å–å›å››å¼µè¡¨
    const results = await Promise.all(
  SHEET_CONFIGS.map(async cfg => {
    const r = await fetch(
      API_BASE + `?action=get&idToken=${encodeURIComponent(idToken || '')}&sheet=${encodeURIComponent(cfg.sheet)}`
    );
    const j = await r.json();
    const values = j.values || [];
        const headerIdx = values.findIndex(
          r => Array.isArray(r) &&
               String(r[0]||'').trim() === 'ç·¨è™Ÿ' &&
               String(r[1]||'').trim().startsWith('å€åŸŸ') &&
               String(r[2]||'').trim() === 'è»Šè™Ÿ'
        );
        const header = headerIdx >= 0 ? values[headerIdx].map(c => String(c||'').trim()) : [];
        const rows   = headerIdx >= 0 ? values.slice(headerIdx+1)
                          .filter(r => String(r[0]||'').trim() && String(r[1]||'').trim() && String(r[2]||'').trim())
                          : [];
        return { key: cfg.key, cfg, headerIdx, header, rows };
      })
    );

    // çµ¦æ¸…å–®/æ˜ç´°ç”¨
    ALL_SHEETS = {};
    results.forEach(x => ALL_SHEETS[x.key] = x);

    // é€å¼µè¡¨ç”Ÿæˆå€å¡Š
results.forEach(({ cfg, header, rows }) => {
  // â˜… ä¾å­åˆ†é ç¯©é¸ï¼›ALL é¡¯ç¤ºå…¨éƒ¨
  const filterKey = (typeof currentDashFilter === 'undefined' || !currentDashFilter)
    ? 'ALL'
    : String(currentDashFilter);
  if (filterKey !== 'ALL' && String(cfg.key) !== filterKey) return;

      const sec   = document.createElement('section'); sec.className = 'dash-section card';
      const title = document.createElement('div');     title.className = 'dash-title'; title.textContent = cfg.key;
      sec.appendChild(title);

      // 1) æ­¥é©Ÿå®Œæˆ/æœªå®Œæˆçµ±è¨ˆï¼ˆã€Œè»Šæš«åœä½ç½®ã€ä¸åœ¨æ­¤çµ±è¨ˆï¼‰
      const statWrap = document.createElement('div'); statWrap.className = 'stat-grid';
      const stepsForCount = cfg.steps.filter(st => st !== 'è»Šæš«åœä½ç½®');
      stepsForCount.forEach(st => {
        const col = header.indexOf(st);
        let done = 0, todo = 0;
        rows.forEach(r => {
          const v = col >= 0 ? r[col] : '';
          isCompletedValue(v) ? done++ : todo++;
        });

        const card = document.createElement('div'); card.className = 'stat-card';
        card.innerHTML = `
          <div class="stat-head">${st}</div>
          <div class="stat-row">
            <div class="stat-pill" data-type="done">
              <div class="stat-num done">${done}</div>
              <div class="stat-label">å®Œæˆ</div>
            </div>
            <div class="stat-pill" data-type="todo">
              <div class="stat-num todo">${todo}</div>
              <div class="stat-label">æœªå®Œæˆ</div>
            </div>
          </div>`;
        // é»å®Œæˆ/æœªå®Œæˆ â†’ é–‹æ¸…å–®
        card.querySelectorAll('.stat-pill').forEach(pill => {
          pill.addEventListener('click', () => openListModal(cfg.key, st, pill.dataset.type));
        });
        statWrap.appendChild(card);
      });
      sec.appendChild(statWrap);

      // 2) åœè»Šä½ç½®åˆ†ä½ˆï¼ˆåªæœ‰è¡¨é ­å«ã€Œè»Šæš«åœä½ç½®ã€æ‰é¡¯ç¤ºï¼‰
      const stopCol = header.indexOf('è»Šæš«åœä½ç½®');
      if (stopCol >= 0) {
        const locTitle = document.createElement('div');
        locTitle.className = 'dash-title';
        locTitle.style.marginTop = '12px';
        locTitle.textContent = 'åœè»Šä½ç½®';
        sec.appendChild(locTitle);

        const locWrap = document.createElement('div'); locWrap.className = 'loc-grid';

        const counter = new Map();
        STOP_OPTIONS.forEach(n => counter.set(n, 0));

        rows.forEach(r => {
          const v = String(r[stopCol] || '').trim();
          if (counter.has(v)) counter.set(v, counter.get(v) + 1);
        });

        STOP_OPTIONS.forEach(name => {
          const n = counter.get(name) || 0;
          const pill = document.createElement('div'); pill.className = 'loc-pill';
          pill.innerHTML = `
            <div class="loc-name">${name}</div>
            <div class="loc-num">${n}</div>
            <div class="stat-label">å°</div>`;
          pill.addEventListener('click', () =>
            openListModal(cfg.key, 'è»Šæš«åœä½ç½®', 'loc', name)
          );
          locWrap.appendChild(pill);
        });
        sec.appendChild(locWrap);
      }

      dash.appendChild(sec);
    });
  };

  if (silent) { await work(); }
  else { await withLoading(work, 'æ•´ç†æ•´é«”æƒ…å ±â€¦'); }
}

/* =================== å€‹åˆ¥æƒ…å ±ï¼šä¸‹æ‹‰/éæ¿¾/é–å®š =================== */
/* éœ€æ±‚ï¼š
   - ä¸‰å€‹ä¸‹æ‹‰ï¼šåˆ†é (Tab) / å€åŸŸè»Šæ¬¡ç·¨è™Ÿ / è»Šè™Ÿ
   - é¸äº†ã€Œå€åŸŸã€â†’ è»Šè™Ÿåªé¡¯ç¤ºè©²å€åŸŸçš„è»Šï¼›é–ä½ã€Œåˆ†é ã€
   - é¸äº†ã€Œè»Šè™Ÿã€â†’ åå‘ç´„æŸåˆ°å°æ‡‰çš„å€åŸŸèˆ‡åˆ†é ï¼Œä¸”ã€Œå€åŸŸï¼‹åˆ†é ã€è¢«é–ä½
   - ã€Œå€åŸŸã€èˆ‡ã€Œè»Šè™Ÿã€éƒ½å®šæ¡ˆå¾Œï¼Œæƒ³æ›´æ”¹å¿…é ˆé»ã€Œå…¨éƒ¨é‡è¨­ã€
   - Tab æœªé¸ä¹Ÿå¯æŒ‘å…¶å®ƒå…©å€‹ï¼ˆè·¨è¡¨æŸ¥è©¢ï¼‰
*/

const SINGLE_IDS = {
  sheet:  'selSheet',
  area:   'selArea',
  car:    'selCar',
  search: 'btnSingleSearch',
  reset:  'btnSingleReset',
  result: 'singleResult',
};

let SINGLE_STORE = {};        // {key: {cfg, header, rows, byArea:Map, byCar:Map}}
let singleInitialized = false;
let singleLockedBy = null;    // 'area' | 'car' | null

async function initSinglePage(){
  if (singleInitialized) return;
  singleInitialized = true;
  buildSingleSkeleton();
  await loadSingleData();
  fillSheetOptions();
  bindSingleEvents();
}

function buildSingleSkeleton(){
  const pane = document.getElementById('pane-single');
  pane.innerHTML = `
    <div class="card" style="padding-bottom:10px;">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <select id="${SINGLE_IDS.sheet}" class="step-select">
          <option value="">â€” å…¨éƒ¨åˆ†é  â€”</option>
        </select>
        <select id="${SINGLE_IDS.area}" class="step-select">
          <option value="">â€” å€åŸŸè»Šæ¬¡ç·¨è™Ÿ â€”</option>
        </select>
        <select id="${SINGLE_IDS.car}" class="step-select">
          <option value="">â€” å…¨éƒ¨ è»Šè™Ÿ â€”</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
        <button id="${SINGLE_IDS.search}" class="btn btn--primary">æŸ¥è©¢</button>
        <button id="${SINGLE_IDS.reset}"  class="btn btn--secondary">å…¨éƒ¨é‡è¨­</button>
      </div>
    </div>
    <div id="${SINGLE_IDS.result}" class="veh-list" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));"></div>
  `;
}

async function loadSingleData(){
  const results = await Promise.all(
    SHEET_CONFIGS.map(async cfg => {
      const r = await fetch(
        API_BASE + `?action=get&idToken=${encodeURIComponent(idToken || '')}&sheet=${encodeURIComponent(cfg.sheet)}`
      );
      const j = await r.json();
      const values = j.values || [];
      const headerIdx = values.findIndex(
        r => Array.isArray(r) &&
             String(r[0]||'').trim() === 'ç·¨è™Ÿ' &&
             String(r[1]||'').trim().startsWith('å€åŸŸ') &&
             String(r[2]||'').trim() === 'è»Šè™Ÿ'
      );
      const header = headerIdx >= 0 ? values[headerIdx].map(c => String(c||'').trim()) : [];
      const rows   = headerIdx >= 0 ? values.slice(headerIdx+1)
                        .filter(r => String(r[0]||'').trim() && String(r[1]||'').trim() && String(r[2]||'').trim())
                        : [];
      const byArea = new Map(), byCar = new Map();
      rows.forEach(r=>{
        const area = String(r[1]||'').trim();
        const car  = String(r[2]||'').trim();
        if (!byArea.has(area)) byArea.set(area, []);
        byArea.get(area).push(car);
        if (!byCar.has(car)) byCar.set(car, []);
        byCar.get(car).push(area);
      });
      return { key: cfg.key, cfg, header, rows, byArea, byCar };
    })
  );
  SINGLE_STORE = {};
  results.forEach(x => SINGLE_STORE[x.key] = x);
}

function fillSheetOptions(){
  const selSheet = document.getElementById(SINGLE_IDS.sheet);
  selSheet.innerHTML = `<option value="">â€” å…¨éƒ¨åˆ†é  â€”</option>` +
    SHEET_CONFIGS.map(s=>`<option value="${s.key}">${s.key}</option>`).join('');
  refreshAreaOptions();
  refreshCarOptions();
}

function getActiveScope(){
  const k = document.getElementById(SINGLE_IDS.sheet).value;
  return k ? [k] : SHEET_CONFIGS.map(s=>s.key);
}

function refreshAreaOptions(keep=false){
  const selArea = document.getElementById(SINGLE_IDS.area);
  const selCar  = document.getElementById(SINGLE_IDS.car);
  const chosenCar = selCar.value;
  const keys = getActiveScope();
  const items = [];
  const seen = new Set();
  keys.forEach(k=>{
    const st = SINGLE_STORE[k]; if (!st) return;
    const list = chosenCar ? (st.byCar.get(chosenCar)||[]) : Array.from(st.byArea.keys());
    list.forEach(a=>{
      const id = `${k}:::${a}`;
      if (!seen.has(id)){ seen.add(id); items.push({k,a}); }
    });
  });
  const prev = selArea.value;
  selArea.innerHTML = `<option value="">â€” å€åŸŸè»Šæ¬¡ç·¨è™Ÿ â€”</option>` +
    items.sort((x,y)=>x.a.localeCompare(y.a,'zh-Hant')).map(({k,a})=>`<option data-sheet="${k}" value="${a}">${a}</option>`).join('');
  if (keep && prev) selArea.value = prev;
}

function refreshCarOptions(keep=false){
  const selArea = document.getElementById(SINGLE_IDS.area);
  const selCar  = document.getElementById(SINGLE_IDS.car);
  const chosenArea = selArea.value;
  const chosenSheet = selArea.options[selArea.selectedIndex]?.dataset?.sheet || '';
  const keys = chosenArea ? [chosenSheet] : getActiveScope();
  const cars = new Set();
  keys.forEach(k=>{
    const st = SINGLE_STORE[k]; if (!st) return;
    if (chosenArea) (st.byArea.get(chosenArea)||[]).forEach(c=>cars.add(c));
    else st.byCar.forEach((_areas,c)=>cars.add(c));
  });
  const prev = selCar.value;
  selCar.innerHTML = `<option value="">â€” å…¨éƒ¨ è»Šè™Ÿ â€”</option>` +
    [...cars].sort((a,b)=>a.localeCompare(b,'zh-Hant')).map(c=>`<option value="${c}">${c}</option>`).join('');
  if (keep && prev) selCar.value = prev;
}

function bindSingleEvents(){
  const selSheet = document.getElementById(SINGLE_IDS.sheet);
  const selArea  = document.getElementById(SINGLE_IDS.area);
  const selCar   = document.getElementById(SINGLE_IDS.car);
  const btnSearch= document.getElementById(SINGLE_IDS.search);
  const btnReset = document.getElementById(SINGLE_IDS.reset);

  selSheet.onchange = ()=>{
    if (singleLockedBy){
      showNotif('å·²é¸å®šå€åŸŸ/è»Šè™Ÿï¼Œè«‹å…ˆé»ã€Œå…¨éƒ¨é‡è¨­ã€å†æ›´æ”¹åˆ†é ', true);
      selSheet.value = selSheet.dataset.prev || '';
      return;
    }
    selSheet.dataset.prev = selSheet.value;
    selArea.disabled = false;
    selArea.value = '';
    selCar.disabled = false;
    selCar.value = '';
    refreshAreaOptions();
    refreshCarOptions();
  };

  selArea.onchange = ()=>{
    if (singleLockedBy === 'car'){
      showNotif('å·²é¸å®šè»Šè™Ÿï¼›è¦æ›´æ›è«‹é»ã€Œå…¨éƒ¨é‡è¨­ã€', true);
      return;
    }
    // é¸äº†å€åŸŸ â†’ è»Šè™Ÿæ”¶æ–‚ï¼›ä¸”é–ä½ã€Œåˆ†é ã€
    refreshCarOptions();
    selSheet.disabled = !!selArea.value;
    if (!selArea.value){
      selSheet.disabled = false;
      singleLockedBy = null;
    }
  };

  selCar.onchange = ()=>{
    if (!selCar.value){
      // æ¸…æ‰è»Š â†’ è§£é™¤é–å®š
      selArea.disabled = false;
      selSheet.disabled = !!selArea.value;
      singleLockedBy = null;
      refreshAreaOptions();
      return;
    }
    // é¸äº†è»Š â†’ åå‘æ”¶æ–‚åˆ°è©²è»Šæ‰€å±¬çš„å”¯ä¸€å€åŸŸèˆ‡åˆ†é ä¸¦é–å®š
    const keys = getActiveScope();
    let firstArea='', firstSheet='';
    keys.forEach(k=>{
      (SINGLE_STORE[k]?.byCar.get(selCar.value)||[]).forEach(a=>{
        if (!firstArea){ firstArea=a; firstSheet=k; }
      });
    });
    // å¥—ç”¨æ”¶æ–‚çµæœ
    if (firstArea){
      selArea.disabled = true;
      selArea.value = firstArea;
      refreshAreaOptions(true);
    }
    selSheet.value   = firstSheet;
    selSheet.disabled= true;
    singleLockedBy = 'car';
  };

  btnSearch.onclick = ()=> runSingleQuery();
  btnReset.onclick  = ()=> resetSingleUI();
}

function runSingleQuery(){
  const resBox  = document.getElementById(SINGLE_IDS.result);
  const selSheet= document.getElementById(SINGLE_IDS.sheet).value;
  const selArea = document.getElementById(SINGLE_IDS.area).value;
  const selCar  = document.getElementById(SINGLE_IDS.car).value;

  resBox.innerHTML = '';
  const keys = selSheet ? [selSheet] : SHEET_CONFIGS.map(s=>s.key);
  const items = [];

  keys.forEach(k=>{
    const st = SINGLE_STORE[k]; if (!st) return;
    st.rows.forEach(r=>{
      const area=String(r[1]||'').trim();
      const car =String(r[2]||'').trim();
      if ((selArea && area!==selArea) || (selCar && car!==selCar)) return;
      const latest = getLatestStatus(st.cfg, st.header, r);
const card = document.createElement('div');
card.className = 'veh-card';
Object.assign(card.style,{display:'flex',alignItems:'center',justifyContent:'center',textAlign:'center'});
card.innerHTML = `
  <div style="display:flex;flex-direction:column;gap:6px;">
    <div class="veh-title-sub" style="font-weight:700;">${escapeHtml(area)}</div>
    <div class="veh-title-sub" style="font-weight:700;">${escapeHtml(car)}</div>
    <div class="veh-title-sub" style="font-weight:700;">${escapeHtml(latest)}</div>
  </div>`;

      card.onclick = ()=> openDetailModal(k, r);
      items.push({k, idx: Number(r[0]||0), el:card});
    });
  });

  // ä¾ã€Œsheeté †åº â†’ ç·¨è™Ÿã€æ’åº
  items.sort((a,b)=>{
    const si = SHEET_CONFIGS.findIndex(s=>s.key===a.k) - SHEET_CONFIGS.findIndex(s=>s.key===b.k);
    return si!==0 ? si : (a.idx - b.idx);
  });
  items.forEach(x=>resBox.appendChild(x.el));
}

function resetSingleUI(){
  const selSheet = document.getElementById(SINGLE_IDS.sheet);
  const selArea  = document.getElementById(SINGLE_IDS.area);
  const selCar   = document.getElementById(SINGLE_IDS.car);
  singleLockedBy = null;
  selSheet.disabled = selArea.disabled = selCar.disabled = false;
  selSheet.value = ''; selArea.value=''; selCar.value='';
  refreshAreaOptions(); refreshCarOptions();
  document.getElementById(SINGLE_IDS.result).innerHTML = '';
}
  

/* å–å¾—ä¸€å°è»Šç›®å‰ã€Œæœ€æ–°ç‹€æ…‹ã€ */
function getLatestStatus(cfg, header, row){
  for (let i=cfg.steps.length-1; i>=0; i--){
    const st=cfg.steps[i]; const col=header.indexOf(st);
    if (col>=0 && isCompletedValue(row[col])) {
      if (st==='è»Šæš«åœä½ç½®') return `è»Šæš«åœä½ç½®ï¼š${row[col]}`;
      return st;
    }
  }
  return 'å°šæœªé–‹å§‹';
}

/* --------------- Overlay 1ï¼šæ¸…å–® --------------- */
/* --------------- Overlay 1ï¼šæ¸…å–® --------------- */
function openListModal(sheetKey, step, type, locValue){
  const {cfg, header, rows} = ALL_SHEETS[sheetKey];
  const list = [];

  if (type==='loc'){ // åœè»Šä½ç½®
    const c = header.indexOf('è»Šæš«åœä½ç½®');
    rows.forEach(r=>{ if (c>=0 && String(r[c]||'').trim()===locValue) list.push(r); });
  } else if (type==='done' || type==='todo'){
    const c = header.indexOf(step);
    rows.forEach(r=>{
      const v = c>=0 ? r[c] : '';
      if ((type==='done' && isCompletedValue(v)) || (type==='todo' && !isCompletedValue(v))) list.push(r);
    });
  }

  const box=document.createElement('div');
  box.className='modal';
  const titleText = (type==='loc')
    ? `${sheetKey}ï¼š${step}ï¼${locValue}`
    : `${sheetKey}ï¼š${step}ï¼ˆ${type==='done'?'å®Œæˆ':'æœªå®Œæˆ'}ï¼‰`;

  box.innerHTML = `
    <div class="dash-close">âœ•</div>
    <h3 style="font-size:18px;margin:0 0 8px;">${escapeHtml(titleText)}</h3>
    <div style="max-height:70vh; overflow:auto; padding-right:6px;">
      ${list.length? '' : '<div style="opacity:.7">ç›®å‰æ²’æœ‰è³‡æ–™</div>'}
    </div>
  `;
  const close = openModal(box);
  box.querySelector('.dash-close').onclick = close;

  const scroller = box.querySelector('div[style*="overflow:auto"]');
  list.forEach(r=>{
    const area  = String(r[1]||'').trim();
    const car   = String(r[2]||'').trim();
    const latest = getLatestStatus(ALL_SHEETS[sheetKey].cfg, ALL_SHEETS[sheetKey].header, r);

    const row = document.createElement('div'); row.className='list-item';
    row.innerHTML = `
      <div class="list-left">
        <div class="list-title">${escapeHtml(area)}ã€€<span style="font-weight:900">${escapeHtml(car)}</span></div>
        <div class="list-sub">æœ€æ–°ç‹€æ…‹ï¼š${escapeHtml(latest)}</div>
      </div>
      <div><button class="btn btn--primary btn--sm">è©³ç´°è³‡æ–™</button></div>
    `;
    row.querySelector('button').onclick = ()=> openDetailModal(sheetKey, r);
    scroller.appendChild(row);
  });
}


/* --------------- Overlay 2ï¼šå–®è»Šè©³æƒ… --------------- */
/* --------------- Overlay 2ï¼šå–®è»Šè©³æƒ… --------------- */
// - openDetailModal(sheetKey, row)
// - openDetailModal(cfgObject, row, headerArray)
function openDetailModal(sheetOrKey, row, headerOverride){
  // å–å¾— cfg / header
  let cfg, header;
  if (typeof sheetOrKey === 'string') {
    const pack = ALL_SHEETS[sheetOrKey] || {};
    cfg    = pack.cfg;
    header = pack.header;
    if (!cfg || !header) return;
  } else {
    cfg    = sheetOrKey;
    header = headerOverride;
  }

  const area = String(row[1]||'').trim();
  const car  = String(row[2]||'').trim();

  // ä¾ã€Œè»Šæš«åœä½ç½®ã€åˆ‡æˆé€²/é€€å ´å…©æ®µï¼ˆè‹¥ç„¡æ­¤æ¬„å°±å…¨éƒ¨ä¸€æ®µï¼‰
  const cutIdx = cfg.steps.indexOf('è»Šæš«åœä½ç½®');
  const groups = [];
  if (cutIdx >= 0){
    groups.push({ title:'é€²å ´', cols: cfg.steps.slice(0, cutIdx+1) });
    if (cutIdx+1 < cfg.steps.length) groups.push({ title:'é€€å ´', cols: cfg.steps.slice(cutIdx+1) });
  } else {
    groups.push({ title:'ç‹€æ…‹', cols: cfg.steps });
  }

  const box = document.createElement('div');
  box.className = 'modal';
  let html = `
    <div class="dash-close">âœ•</div>
    <div style="font-weight:900;margin-bottom:8px;">${escapeHtml(cfg.key)}</div>
    <div style="margin-bottom:10px;"><b>${escapeHtml(area)}</b>ã€€<span style="font-weight:900">${escapeHtml(car)}</span></div>
  `;

  groups.forEach(g=>{
    html += `<div style="font-weight:800;margin:6px 0 4px;">${escapeHtml(g.title)}</div>
      <table class="detail-table">
        <thead><tr>${g.cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead>
        <tbody><tr>${
          g.cols.map(c=>{
            const idx = header.indexOf(c);
            const v   = idx>=0 ? String(row[idx]||'').trim() : '';
            const cellText = (c === 'è»Šæš«åœä½ç½®')
              ? (v || '')
              : (v ? formatSheetTime(v) : '');
            return `<td>${escapeHtml(cellText)}</td>`;
          }).join('')
        }</tr></tbody>
      </table>`;
  });

  box.innerHTML = html;
  const close = openModal(box);
  box.querySelector('.dash-close').onclick = close;
}



/* ====== å…¶é¤˜èˆŠæœ‰çš„ã€Œç¢ºèª/ä¿®æ”¹æ™‚é–“ã€å°è¦–çª— ====== */
function openConfirmDialog(msg, onOK){
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3>ç¢ºèªåˆªé™¤</h3>
    <div class="modal-msg" style="font-size:15px;line-height:1.6;margin:4px 0 8px;">${msg}</div>
    <div class="actions">
      <button class="btn" style="background:#e5e7eb;color:#111827;">å–æ¶ˆ</button>
      <button class="btn btn-del">ç¢ºå®š</button>
    </div>`;
  const close = openModal(box);
  const [btnCancel, btnOK] = box.querySelectorAll('button');
  btnCancel.onclick = close;
  btnOK.onclick = ()=>{ try{ onOK && onOK(); } finally{ close(); } };
}
function openEditTimeDialog(initialHHMMSS, onOK){
  const [h0,m0,s0] = splitHMS(initialHHMMSS);
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3>ä¿®æ”¹æ™‚é–“</h3>
    <div class="time-edit">
      <input id="hh" class="time-input" type="text" inputmode="numeric" maxlength="2" value="${h0}" aria-label="å°æ™‚">
      <span class="colon">:</span>
      <input id="mm" class="time-input" type="text" inputmode="numeric" maxlength="2" value="${m0}" aria-label="åˆ†é˜">
      <span class="colon">:</span>
      <input id="ss" class="time-input" type="text" inputmode="numeric" maxlength="2" value="${s0}" aria-label="ç§’">
    </div>
    <div class="hint">è«‹è¼¸å…¥ 2 ä½æ•¸ï¼ä¸‹åˆå…©é»è«‹è¼¸å…¥ 14ã€‚</div>
    <div class="actions">
      <button class="btn" style="background:#e5e7eb;color:#111827;">å–æ¶ˆ</button>
      <button class="btn btn-edit">ç¢ºå®š</button>
    </div>`;
  const close = openModal(box);
  const hh = box.querySelector('#hh'), mm = box.querySelector('#mm'), ss = box.querySelector('#ss');
  const [btnCancel, btnOK] = box.querySelectorAll('button');
  setTimeout(()=>{ try{ hh.focus({ preventScroll:true }); }catch{} }, 80);

  [hh,mm,ss].forEach(inp=>inp.addEventListener('input', ()=>{ inp.value = inp.value.replace(/\D/g,'').slice(0,2); }));
  btnCancel.onclick = close;
  btnOK.onclick = ()=>{
    const H = pad2(hh.value||''), M = pad2(mm.value||''), S = pad2(ss.value||'');
    if (!isValidHMS(H,M,S)){ showNotif('æ ¼å¼éœ€ç‚º HH(00â€“23) / MM(00â€“59) / SS(00â€“59)', true); return; }
    try{ onOK(`${H}:${M}:${S}`); } finally{ close(); }
  };
}

/* ================= å€‹åˆ¥æƒ…å ± ================= */
let __indivInited__ = false;
let INDIV_ROWS = []; // {tabKey, sheetOrder, areaSeq, plate, latest, stepsIn[], stepsOut[]}

function indivNorm(v){ return String(v ?? '').trim(); }

function initIndividual(){
  // é¦–æ¬¡æ› UI
  indivMountUI();
  // è¼‰å…¥å››è¡¨è³‡æ–™
  withLoading(indivLoadAllSheets, 'è®€å–è³‡æ–™â€¦').then(()=>{
    indivFillTabOptions();
    indivApplyFilter(); // ä¾ç›®å‰é¸é …ï¼ˆéƒ½æ˜¯ç©ºï¼‰å›å¡«å€™é¸
    __indivInited__ = true;
  });
  // ç¶äº‹ä»¶
  ['indiv-sel-tab','indiv-sel-area','indiv-sel-plate'].forEach(id=>{
    document.getElementById(id).addEventListener('change', indivApplyFilter);
  });
  document.getElementById('indiv-btn-query').addEventListener('click', indivDoQuery);
  document.getElementById('indiv-btn-reset').addEventListener('click', indivReset);
}

function indivMountUI(){
  // æŠŠå››å€‹ Tab åç¨±å…ˆæ”¾åˆ°ç¬¬ä¸€å€‹ä¸‹æ‹‰ï¼ˆå…¶é¤˜å…©å€‹ç­‰è¼‰å…¥è³‡æ–™å¾Œå›å¡«ï¼‰
  const selTab = document.getElementById('indiv-sel-tab');
  selTab.innerHTML = '<option value="">å…¨éƒ¨ï¼ˆå››å€‹Tabï¼‰</option>';
  SHEET_CONFIGS.forEach(cfg=>{
    const opt=document.createElement('option'); opt.value=cfg.key; opt.textContent=cfg.key; selTab.appendChild(opt);
  });
}

async function indivLoadAllSheets(){
  const results = await Promise.all(SHEET_CONFIGS.map(async (cfg, idx)=>{
    const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
    const j = await r.json();
    const values = j.values || [];
    // æ‰¾è¡¨é ­ï¼ˆåªè¦æœ‰ã€Œç·¨è™Ÿ / å€åŸŸ* / è»Šè™Ÿã€ï¼‰
    const headIdx = values.findIndex(row =>
      Array.isArray(row) &&
      indivNorm(row[0])==='ç·¨è™Ÿ' &&
      indivNorm(row[1]).startsWith('å€åŸŸ') &&
      indivNorm(row[2])==='è»Šè™Ÿ'
    );
    if (headIdx < 0) return [];
    const header = values[headIdx].map(indivNorm);
    const rows = values.slice(headIdx+1).filter(r => indivNorm(r[0]) && indivNorm(r[1]) && indivNorm(r[2]));
    const pack = [];
    rows.forEach(row=>{
      const area = indivNorm(row[1]);
      const plate = indivNorm(row[2]);
      // æœ€æ–°ç‹€æ…‹ï¼ˆç”¨ä½ åŸæœ¬çš„æ­¥é©Ÿé †åºå›æ¨ï¼‰
      let latest = '';
      for (let i=cfg.steps.length-1;i>=0;i--){
        const st = cfg.steps[i];
        const ci = header.indexOf(st);
        if (ci>=0 && indivNorm(row[ci])) { latest = (st==='è»Šæš«åœä½ç½®') ? `è»Šæš«åœä½ç½®ï¼š${indivNorm(row[ci])}` : st; break; }
      }
      // é€²/é€€å ´æ­¥é©Ÿå€¼ï¼ˆå½ˆçª—ç”¨ï¼‰
      const cut = cfg.steps.indexOf('è»Šæš«åœä½ç½®');
      const stepsIn = cfg.steps.slice(0, cut>=0 ? cut+1 : cfg.steps.length).map(name=>{
        const i=header.indexOf(name); const val = i>=0 ? indivNorm(row[i]) : '';
        return {name, val};
      });
      const stepsOut = (cut>=0 ? cfg.steps.slice(cut+1) : []).map(name=>{
        const i=header.indexOf(name); const val = i>=0 ? indivNorm(row[i]) : '';
        return {name, val};
      });

      pack.push({
        tabKey: cfg.key,
        sheetOrder: idx,
        areaSeq: area,
        plate,
        latest,
        stepsIn,
        stepsOut
      });
    });
    return pack;
  }));

  INDIV_ROWS = results.flat();
}

function indivCurrentFilter(){
  const tab   = indivNorm(document.getElementById('indiv-sel-tab').value);
  const area  = indivNorm(document.getElementById('indiv-sel-area').value);
  const plate = indivNorm(document.getElementById('indiv-sel-plate').value);
  return {tab, area, plate};
}
function indivFillTabOptions(){
  // å·²åœ¨ mount æ”¾å…¥ï¼Œé€™è£¡é ç•™å¦‚éœ€å‹•æ…‹æ›´æ–°
}

function indivApplyFilter(){
  const selTab   = document.getElementById('indiv-sel-tab');
  const selArea  = document.getElementById('indiv-sel-area');
  const selPlate = document.getElementById('indiv-sel-plate');
  const {tab, area, plate} = indivCurrentFilter();

  // ä¾ç›®å‰é¸æ“‡åšäº¤é›†
  const filtered = INDIV_ROWS.filter(r =>
    (!tab   || r.tabKey  === tab) &&
    (!area  || r.areaSeq === area) &&
    (!plate || r.plate   === plate)
  );

  // å€™é¸é›†åˆï¼ˆè‡ªç„¶æ’åºï¼Œä¸­æ–‡/æ•¸å­—å‹å–„ï¼‰
  const sortNat = (a,b)=> a.localeCompare(b,'zh-Hant-u-kn-true');
  const areas  = [...new Set(filtered.map(r=>r.areaSeq))].sort(sortNat);
  const plates = [...new Set(filtered.map(r=>r.plate))].sort(sortNat);

  // å›å¡«ä¸‹æ‹‰ï¼ˆä¿ç•™å·²é¸å€¼ï¼‰
  const fill = (sel, items, ph, keep)=>{
    const cur = keep || '';
    sel.innerHTML = '';
    const op0 = document.createElement('option'); op0.value=''; op0.textContent=ph; sel.appendChild(op0);
    items.forEach(v=>{
      const op=document.createElement('option'); op.value=v; op.textContent=v; if (v===cur) op.selected=true; sel.appendChild(op);
    });
  };
  fill(selArea , areas , 'å…¨éƒ¨å€åŸŸè»Šæ¬¡ç·¨è™Ÿ', area );
  fill(selPlate, plates, 'å…¨éƒ¨è»Šè™Ÿ'      , plate);

  // é–å®šè¦å‰‡ï¼šé¸äº†ã€Œè»Šè™Ÿã€æˆ–ã€Œå€åŸŸè»Šæ¬¡ç·¨è™Ÿã€ä»»ä¸€è€… â†’ å…¶ä»–å…©å€‹é–å®š
  const lockByPlate = !!plate;
  const lockByArea  = !!area;
  selTab.disabled   = lockByPlate || lockByArea;
  selArea.disabled  = lockByPlate || (lockByArea && !plate);
  selPlate.disabled = lockByArea  || (lockByPlate && !area);
}

function indivDoQuery(){
  const {tab, area, plate} = indivCurrentFilter();
  const data = INDIV_ROWS
    .filter(r =>
      (!tab   || r.tabKey  === tab) &&
      (!area  || r.areaSeq === area) &&
      (!plate || r.plate   === plate)
    )
    .sort((a,b)=>{
      if (a.sheetOrder !== b.sheetOrder) return a.sheetOrder - b.sheetOrder;
      if (a.areaSeq !== b.areaSeq) return a.areaSeq.localeCompare(b.areaSeq,'zh-Hant-u-kn-true');
      return a.plate.localeCompare(b.plate,'zh-Hant-u-kn-true');
    });
  indivRenderCards(data);
}

function indivRenderCards(list){
  const box = document.getElementById('indiv-cards');
  box.innerHTML = '';
  if (!list.length){
    box.innerHTML = `<div style="color:#64748b;padding:8px 2px;">ï¼ˆæ²’æœ‰ç¬¦åˆçš„è³‡æ–™ï¼‰</div>`;
    return;
  }
  list.forEach(item=>{
    const el = document.createElement('div');
    el.className = 'indiv-card';
    el.innerHTML = `
      <div class="top"><span class="mini-badge">${item.tabKey}</span> <span style="margin-left:6px;">${item.areaSeq}</span></div>
      <div class="mid">${item.plate}</div>
      <div class="bot">${item.latest || 'â€”'}</div>
    `;
    el.addEventListener('click', ()=> indivOpenDetail(item));
    box.appendChild(el);
  });
}

function indivOpenDetail(item){
  // ä»¥æ­¥é©Ÿåˆ‡å…©çµ„ï¼šé€²å ´ / é€€å ´
  const box = document.createElement('div');
  box.className = 'modal';
  box.innerHTML = `
    <h3 style="margin:0 0 6px;">${item.tabKey}</h3>
    <div style="margin-bottom:10px;"><b>${item.areaSeq}</b>ã€€<span style="font-weight:900">${item.plate}</span></div>

    <h4 style="margin:12px 0 6px;font-weight:800;">é€²å ´</h4>
    <div class="step-grid" id="__in"></div>

    <h4 style="margin:12px 0 6px;font-weight:800;">é€€å ´</h4>
    <div class="step-grid" id="__out"></div>
  `;
  const close = openModal(box);

  const fill = (wrapId, arr)=>{
    const w = box.querySelector(wrapId);
    arr.forEach(s=>{
      const cell = document.createElement('div');
      cell.className = 'step-cell';
      const v = s.name==='è»Šæš«åœä½ç½®' ? (s.val||'â€”') : (s.val ? formatSheetTime(s.val) : 'â€”');
      cell.innerHTML = `<div style="font-weight:700;margin-bottom:4px;">${s.name}</div><div>${v}</div>`;
      w.appendChild(cell);
    });
  };
  fill('#__in',  item.stepsIn  || []);
  fill('#__out', item.stepsOut || []);
}

function indivReset(){
  document.getElementById('indiv-sel-tab').value   = '';
  document.getElementById('indiv-sel-area').value  = '';
  document.getElementById('indiv-sel-plate').value = '';
  document.getElementById('indiv-sel-tab').disabled   = false;
  document.getElementById('indiv-sel-area').disabled  = false;
  document.getElementById('indiv-sel-plate').disabled = false;
  indivApplyFilter();
  document.getElementById('indiv-cards').innerHTML = '';
}
// åªé¡¯ç¤ºï¼šå€åŸŸè»Šæ¬¡ç·¨è™Ÿï¼è»Šè™Ÿï¼æœ€æ–°ç‹€æ…‹ï¼›é»å¡ç‰‡é–‹è©³æƒ…ï¼ˆæ²¿ç”¨æ•´é«”æƒ…å ±è¡¨æ ¼æ¨£å¼ï¼‰
function buildSingleCard(cfg, header, row){
  const area   = String(row[1]||'').trim();             // å€åŸŸè»Šæ¬¡ç·¨è™Ÿ
  const car    = String(row[2]||'').trim();             // è»Šè™Ÿ
  const latest = getLatestStatus(cfg, header, row);      // æœ€æ–°ç‹€æ…‹ï¼ˆå·²æœ‰çš„å·¥å…·ï¼‰

  const card = document.createElement('div');
  card.className = 'single-card';
  card.innerHTML = `
    <div class="single-line">${area}</div>
    <div class="single-line">${car}</div>
    <div class="single-line">${latest}</div>
  `;
  card.addEventListener('click', ()=> openDetailModal(cfg, row, header));
  return card;
}
/* ======================= å€‹åˆ¥æƒ…å ±ï¼ˆä¸‰é¸å–® + ä¸‰è¡Œç½®ä¸­åç‰‡ï¼‰ ======================= */
let SINGLE_INITTED = false;
let SINGLE_ITEMS = [];  // æ¯ç­†ï¼š{ sheetKey, cfg, header, row }

/* å‹•æ…‹å¡å…¥é€™é å°ˆç”¨æ¨£å¼ï¼ˆåªæœƒæ’ä¸€æ¬¡ï¼‰ */
(function ensureSingleStyles(){
  if (document.getElementById('singleCardStyles')) return;
  const css = document.createElement('style');
  css.id = 'singleCardStyles';
  css.textContent = `
    .single-controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .single-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
    .single-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .single-card{
      border:1px solid var(--border);background:rgba(255,255,255,.9);
      border-radius:12px;padding:14px;text-align:center;cursor:pointer;box-shadow:var(--shadow-card)
    }
    body.dark .single-card{background:rgba(15,23,42,.30)}
    .single-card:hover{filter:brightness(1.015)}
    .single-line{font-size:var(--fz-title);line-height:var(--lh-title);font-weight:var(--fw-title);color:var(--text-strong)}
    .single-line + .single-line{margin-top:6px}
  `;
  document.head.appendChild(css);
})();

/* åˆå§‹åŒ–é é¢ï¼ˆåªåšä¸€æ¬¡ï¼‰ */
function initSinglePage(){
  if (SINGLE_INITTED){ return; }
  SINGLE_INITTED = true;

  // ç¶å®šäº‹ä»¶
  document.getElementById('btnQuery').addEventListener('click', onSingleQuery);
  document.getElementById('btnReset').addEventListener('click', onSingleReset);
  ['selSheet','selArea','selCar'].forEach(id=>{
    document.getElementById(id).addEventListener('change', rebuildSelectOptions);
  });

  // è¼‰å…¥å››å¼µè¡¨è³‡æ–™
  withLoading(loadSingleData, 'è®€å–è³‡æ–™â€¦');
}

/* è®€å››å¼µè¡¨ï¼Œæ•´ç†ç‚ºå¯ç¯©é¸çš„ items */
async function loadSingleData(){
  SINGLE_ITEMS = [];
  const results = await Promise.all(
    SHEET_CONFIGS.map(async cfg => {
      const r = await fetch(
        API_BASE + `?action=get&idToken=${encodeURIComponent(idToken || '')}&sheet=${encodeURIComponent(cfg.sheet)}`
      );
      const j = await r.json();
      const values = j.values || [];
      const headerIdx = values.findIndex(
        r => Array.isArray(r) &&
             String(r[0]||'').trim() === 'ç·¨è™Ÿ' &&
             String(r[1]||'').trim().startsWith('å€åŸŸ') &&
             String(r[2]||'').trim() === 'è»Šè™Ÿ'
      );
      const header = headerIdx>=0 ? values[headerIdx].map(c=>String(c||'').trim()) : [];
      const rows   = headerIdx>=0 ? values.slice(headerIdx+1)
                        .filter(r=>String(r[0]||'').trim() && String(r[1]||'').trim() && String(r[2]||'').trim())
                        : [];
      // ç¢ºä¿ openDetailModal ä¹Ÿèƒ½ç”¨ï¼ˆè‹¥ä½¿ç”¨è€…æ²’å…ˆå»æ•´é«”æƒ…å ±ï¼‰
      ALL_SHEETS[cfg.key] = { cfg, header, rows };
      rows.forEach(row => SINGLE_ITEMS.push({ sheetKey: cfg.key, cfg, header, row }));
      return { cfg, header, rows };
    })
  );

  // å¡«å…¥ã€ŒTabã€é¸å–®ï¼ˆå››å¼µè¡¨ï¼‰
  const selSheet = document.getElementById('selSheet');
  selSheet.innerHTML = '<option value="">â€” å…¨éƒ¨ Tab â€”</option>' +
    SHEET_CONFIGS.map(s=>`<option value="${s.key}">${s.key}</option>`).join('');

  // ä¾ç›®å‰æ¢ä»¶é‡å»ºå¦å¤–å…©å€‹é¸å–®
  rebuildSelectOptions();
}

/* ä¾ç•¶å‰æ¢ä»¶ï¼Œé‡å»ºä¸‰å€‹é¸å–®çš„å¯é¸å€¼ï¼ˆä¿ç•™ä»æœ‰æ•ˆçš„æ—¢æœ‰é¸æ“‡ï¼‰ */
function rebuildSelectOptions(){
  const selSheet = document.getElementById('selSheet');
  const selArea  = document.getElementById('selArea');
  const selCar   = document.getElementById('selCar');

  const keepSheet = selSheet.value || '';
  const keepArea  = selArea.value  || '';
  const keepCar   = selCar.value   || '';

  const filtered = filterItems(keepSheet, '', ''); // å…ˆçœ‹ç›®å‰é¸çš„ Tabï¼Œå¦å¤–å…©å€‹å…ˆæ”¾å¯¬
  const areas = uniq(filtered.map(it => String(it.row[1]||'').trim())).sort(localeCmp);
  const cars  = uniq(filtered.map(it => String(it.row[2]||'').trim())).sort(localeCmp);

  selArea.innerHTML = '<option value="">â€” å…¨éƒ¨ å€åŸŸè»Šæ¬¡ç·¨è™Ÿ â€”</option>' + areas.map(a=>`<option value="${a}">${a}</option>`).join('');
  selCar.innerHTML  = '<option value="">â€” å…¨éƒ¨ è»Šè™Ÿ â€”</option>' + cars.map(c=>`<option value="${c}">${c}</option>`).join('');

  // è‹¥èˆŠé¸é …ä»åœ¨åˆ—è¡¨ä¸­å°±ä¿ç•™
  if (keepArea && areas.includes(keepArea)) selArea.value = keepArea;
  if (keepCar  && cars.includes(keepCar))   selCar.value  = keepCar;
}

/* é»ã€ŒæŸ¥è©¢ã€â†’ æ¸²æŸ“åç‰‡ */
function onSingleQuery(){
  const sheet = document.getElementById('selSheet').value || '';
  const area  = document.getElementById('selArea').value  || '';
  const car   = document.getElementById('selCar').value   || '';

  const items = filterItems(sheet, area, car)
    .slice()
    .sort((a,b)=>{
      // ä¾æ¯å¼µè¡¨çš„ã€Œç·¨è™Ÿã€æ¬„ä½æ’åºï¼ˆå‡å†ªï¼‰
      const ai = parseInt(String(a.row?.[0]||''),10);
      const bi = parseInt(String(b.row?.[0]||''),10);
      if (isNaN(ai) && isNaN(bi)) return 0;
      if (isNaN(ai)) return 1;
      if (isNaN(bi)) return -1;
      return ai - bi;
    });

  renderSingleCards(items);
}

/* é»ã€Œå…¨éƒ¨é‡è¨­ã€ */
function onSingleReset(){
  document.getElementById('selSheet').value = '';
  document.getElementById('selArea').value  = '';
  document.getElementById('selCar').value   = '';
  rebuildSelectOptions();
  renderSingleCards([]); // æ¸…ç©ºé¡¯ç¤º
}

/* ä»¥æ¢ä»¶ç¯©é¸ items */
function filterItems(sheetKey, area, car){
  return SINGLE_ITEMS.filter(it =>
    (!sheetKey || it.sheetKey === sheetKey) &&
    (!area  || String(it.row[1]||'').trim() === area) &&
    (!car   || String(it.row[2]||'').trim() === car)
  );
}

/* æ¸²æŸ“ä¸‰è¡Œç½®ä¸­åç‰‡ï¼ˆåªé¡¯ç¤ºï¼šå€åŸŸè»Šæ¬¡ç·¨è™Ÿã€è»Šè™Ÿã€æœ€æ–°ç‹€æ…‹ï¼‰ */
function renderSingleCards(items){
  const box = document.getElementById('singleResults');
  box.innerHTML = '';
  if (!items || items.length===0){
    box.innerHTML = '<div style="opacity:.6;text-align:center;padding:10px 0;">ï¼ˆæ²’æœ‰ç¬¦åˆé …ç›®ï¼‰</div>';
    return;
  }

  for (const it of items){
    const area = String(it.row?.[1]||'').trim();
    const car  = String(it.row?.[2]||'').trim();
    const latest = getLatestStatus(it.cfg, it.header, it.row);

    const card = document.createElement('div');
    card.className = 'single-card';
    card.innerHTML = `
      <div class="single-line">${escapeHtml(area)}</div>
      <div class="single-line">${escapeHtml(car)}</div>
      <div class="single-line">${escapeHtml(latest)}</div>
    `;
    card.addEventListener('click', () => openDetailModal(it.sheetKey, it.row));
    box.appendChild(card);
  }
}


/* å°å·¥å…· */
const uniq = arr => Array.from(new Set(arr.filter(Boolean)));
const localeCmp = (a,b)=> a.localeCompare(b,'zh-Hant-u-nu-hanidec',{numeric:true, sensitivity:'base'});
/* ======================= å€‹åˆ¥æƒ…å ± end ======================= */
  

/* ===== è¦†å¯«ï¼šå€‹åˆ¥æƒ…å ± ä¸‰é¸å–®æœ€çµ‚è¦æ ¼ï¼ˆä¸æ”¹å‹•ä»»ä½• Web å‘ˆç¾ï¼‰ ===== */

/* å·¥å…·ï¼šä¾æ¢ä»¶æŠ“å– items */
function _single_getItems(sheet, area, car){
  return SINGLE_ITEMS.filter(it =>
    (!sheet || it.sheetKey === sheet) &&
    (!area  || String(it.row[1]||'').trim() === area) &&
    (!car   || String(it.row[2]||'').trim() === car)
  );
}
/* å·¥å…·ï¼šå¾ items å–å”¯ä¸€é›†åˆï¼ˆä»¥åœ¨åœ°èªç³»æ’åºï¼‰ */
function _single_unique(items, pick){
  const arr = Array.from(new Set(items.map(pick).filter(Boolean)));
  return arr.sort((a,b)=> a.localeCompare(b,'zh-Hant-u-nu-hanidec',{numeric:true, sensitivity:'base'}));
}
/* å·¥å…·ï¼šå»ºç«‹ <option> æ¸…å–®ï¼Œç›¡é‡ä¿ç•™æ—¢æœ‰å€¼ï¼›è‹¥åªå‰©å”¯ä¸€å€™é¸å‰‡è‡ªå‹•é¸å– */
function _single_applyOptions(selectEl, candidates, placeholder, keepVal){
  const oldVal = selectEl.value;
  const options = ['<option value=\"\">' + placeholder + '</option>']
    .concat(candidates.map(v=>`<option value="${v}">${v}</option>`));
  selectEl.innerHTML = options.join('');

  let newVal = '';
  if (keepVal && candidates.includes(keepVal)) newVal = keepVal;
  else if (candidates.length === 1) newVal = candidates[0]; // å”¯ä¸€ â†’ è‡ªå‹•å¸¶å…¥
  // å¦å‰‡ç¶­æŒç©ºç™½ï¼ˆâ€” å…¨éƒ¨ â€”ï¼‰

  selectEl.value = newVal;
  return oldVal !== newVal;
}

/* è‡ªå‹•æŸ¥è©¢ï¼šä¸‰è€…çš†éç©ºä¸”å”¯ä¸€çµ„åˆæ™‚è§¸ç™¼ */
function _single_maybeAutoQuery(){
  const s = document.getElementById('selSheet').value || '';
  const a = document.getElementById('selArea').value  || '';
  const c = document.getElementById('selCar').value   || '';
  if (!s || !a || !c) return;
  const items = _single_getItems(s,a,c);
  if (items.length === 1){
    try{ onSingleQuery(); }catch(e){ /* ignore */ }
  }
}

/* è¦†å¯« rebuildSelectOptionsï¼š
   â€” ä¸‰é¸å–®æ°¸ä¸é–å®š
   â€” å€™é¸ä¾å…¶å®ƒæ¢ä»¶å³æ™‚æ”¶æ–‚
   â€” åªå‰©å”¯ä¸€å€™é¸æ™‚è‡ªå‹•é¸å–
   â€” é¸è»Šè™Ÿâ†’å¯å”¯ä¸€åå¸¶ Tab/å€åŸŸï¼›é¸å€åŸŸâ†’å¯å”¯ä¸€åå¸¶ Tabï¼Œä¸”åœ¨è©² Tab ä¸‹è‹¥è»Šè™Ÿå”¯ä¸€ä¹Ÿè‡ªå‹•å¸¶å…¥
   â€” ä»»ä¸€æ™‚åˆ»å€™é¸å”¯ä¸€çš†è‡ªå‹•å¸¶å…¥
   â€” ä¸‰è€…è½åœ¨å”¯ä¸€çµ„åˆæ™‚è‡ªå‹•æŸ¥è©¢
*/
function rebuildSelectOptions(){
  const selSheet = document.getElementById('selSheet');
  const selArea  = document.getElementById('selArea');
  const selCar   = document.getElementById('selCar');

  // è®€å–ç›®å‰å€¼
  let sheet = selSheet.value || '';
  let area  = selArea.value  || '';
  let car   = selCar.value   || '';

  let changed = true;
  let guard = 0;
  while (changed && guard < 5){  // æœ€å¤šè¿­ä»£ 5 æ¬¡ä»¥æ”¶æ–‚
    changed = false; guard++;

    // 1) é¸äº†ã€Œè»Šè™Ÿã€â†’ è‹¥å”¯ä¸€åå¸¶ Tab/å€åŸŸ
    if (car){
      const carItems = _single_getItems('', '', car);
      const uniqueSheets = _single_unique(carItems, it=>it.sheetKey);
      const uniqueAreas  = _single_unique(carItems, it=>String(it.row[1]||'').trim());
      if (uniqueSheets.length === 1 && sheet !== uniqueSheets[0]){ sheet = uniqueSheets[0]; changed = true; }
      if (uniqueAreas.length  === 1 && area  !== uniqueAreas[0]) { area  = uniqueAreas[0];  changed = true; }
    }

    // 2) é¸äº†ã€Œå€åŸŸã€â†’ è‹¥å”¯ä¸€åå¸¶ Tabï¼›åœ¨è©²/ç›®å‰ Tab ä¸‹è‹¥è»Šè™Ÿå”¯ä¸€ä¹Ÿå¸¶å…¥
    if (area){
      const areaItems = _single_getItems('', area, '');
      const uniqueSheetsByArea = _single_unique(areaItems, it=>it.sheetKey);
      if (uniqueSheetsByArea.length === 1 && sheet !== uniqueSheetsByArea[0]){ sheet = uniqueSheetsByArea[0]; changed = true; }

      // åœ¨æ±ºå®šå¾Œçš„ sheet ç¯„åœå…§ï¼Œå¦‚æœè»Šè™Ÿå”¯ä¸€ â†’ è‡ªå‹•é¸
      const carInScope = _single_unique(_single_getItems(sheet, area, ''), it=>String(it.row[2]||'').trim());
      if (!car && carInScope.length === 1){ car = carInScope[0]; changed = true; }
    }

    // 3) ä¸€èˆ¬æ”¶æ–‚ï¼šæ ¹æ“š (sheet, area, car) è¨ˆç®—ä¸‰é¸å–®å€™é¸ä¸¦å¥—ç”¨ï¼ˆå”¯ä¸€è‡ªå‹•å¸¶å…¥ï¼‰
    const itemsScopeForSheet = _single_getItems('', area, car); // å— area+car é™åˆ¶
    const itemsScopeForArea  = _single_getItems(sheet, '', car); // å— sheet+car é™åˆ¶
    const itemsScopeForCar   = _single_getItems(sheet, area, ''); // å— sheet+area é™åˆ¶

    const sheets = _single_unique(itemsScopeForSheet, it=>it.sheetKey);
    const areas  = _single_unique(itemsScopeForArea,  it=>String(it.row[1]||'').trim());
    const cars   = _single_unique(itemsScopeForCar,   it=>String(it.row[2]||'').trim());

    const ch1 = _single_applyOptions(selSheet, sheets, 'â€” å…¨éƒ¨ Tab â€”', sheet);
    const ch2 = _single_applyOptions(selArea,  areas,  'â€” å…¨éƒ¨ å€åŸŸè»Šæ¬¡ç·¨è™Ÿ â€”', area);
    const ch3 = _single_applyOptions(selCar,   cars,   'â€” å…¨éƒ¨ è»Šè™Ÿ â€”', car);

    // åŒæ­¥å›å…§å­˜è®Šæ•¸
    sheet = selSheet.value || '';
    area  = selArea.value  || '';
    car   = selCar.value   || '';

    if (ch1 || ch2 || ch3) changed = true;
  }

  // æœ€çµ‚ï¼šå¦‚ä¸‰è€…å”¯ä¸€çµ„åˆ â†’ è‡ªå‹•æŸ¥è©¢
  _single_maybeAutoQuery();
}

/* è¦†å¯« initSinglePageï¼šä¸æ”¹è¦–è¦ºï¼Œåªç¶å®šåˆ°æ–°çš„ rebuildSelectOptions æµç¨‹ */
(function(){
  const _origInit = initSinglePage;
  initSinglePage = function(){
    // å…ˆè·‘åŸæœ¬çš„ï¼Œç¢ºä¿è³‡æ–™è®€å–èˆ‡æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š
    try{ _origInit(); }catch(e){ /* ignore */ }
    // å†æŠŠ change äº‹ä»¶éƒ½å°å‘æ–°çš„æ”¶æ–‚å™¨
    ['selSheet','selArea','selCar'].forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('change', rebuildSelectOptions);
    });
    // åˆå§‹ä¸€æ¬¡æ”¶æ–‚ï¼ˆè‹¥è³‡æ–™å·²åˆ°ï¼‰
    try{ rebuildSelectOptions(); }catch(e){ /* ignore */ }
  };
})();

/* ===== è¦†å¯«çµæŸ ===== */

</script>
</body>
</html>
