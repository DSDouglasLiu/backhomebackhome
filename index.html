<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>車流人流退場情報</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
/* =========== Design Tokens（Preferred 版） =========== */
:root{
  /* 半徑 */
  --radius-xs:6px;  --radius-sm:8px;  --radius-md:10px; --radius-lg:12px;

  /* 色票（light） */
  --primary-600:#1f6fe5; --primary-700:#165bd1; --primary-800:#1249ad;
  --success-600:#22c55e; --success-700:#16a34a; --success-800:#15803d;
  --danger-600:#ef4444;  --danger-700:#dc2626;  --danger-800:#b91c1c;
  --gray-50:#f8fafc;  --gray-100:#f1f5f9; --gray-200:#e5e7eb;
  --gray-300:#cbd5e1; --gray-400:#94a3b8; --gray-500:#64748b;
  --gray-600:#475569; --gray-700:#334155; --gray-800:#1f2937; --gray-900:#0f172a;

  --surface: rgba(255,255,255,.78);
  --page-bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
  --text-strong: var(--gray-900);
  --text: var(--gray-800);
  --text-muted: var(--gray-600);
  --border: rgba(148,163,184,0.35);
  --focus:#93c5fd;

  /* 字級（px/line-height, weight） */
  --fz-display:28px; --lh-display:36px; --fw-display:700;  /* 頁面大標題 */
  --fz-title:18px;   --lh-title:24px;   --fw-title:700;   /* 卡片主標 */
  --fz-sub:14px;     --lh-sub:20px;     --fw-sub:600;     /* 車牌/副標 */
  --fz-label:14px;   --lh-label:20px;   --fw-label:600;   /* 步驟/表頭 */
  --fz-body:14px;    --lh-body:20px;    --fw-body:400;    /* 內文/按鈕 */
  --fz-note:12px;    --lh-note:16px;    --fw-note:400;    /* 備註提示 */

  --shadow-card:0 8px 24px rgba(0,0,0,.08);
}
body.dark{
  --surface: rgba(15,23,42,.55);
  --page-bg: radial-gradient(circle at 10% 20%,#081528 0%,#020617 90%);
  --text-strong:#e5eaf3; --text:#e2e8f0; --text-muted:#93a3b5;
  --border: rgba(148,163,184,0.25);
  --shadow-card:0 8px 24px rgba(0,0,0,.35);
}

/* =========== Base =========== */
body{
  margin:0; min-height:100vh;
  background:var(--page-bg); color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif;
}
.wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
h1{margin:0 0 16px;font-size:var(--fz-display);line-height:var(--lh-display);font-weight:var(--fw-display);color:var(--text-strong);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-card);padding:16px;margin:12px 0;}
.hide{ display:none !important; }

/* =========== Segmented Tabs（上方工作表） =========== */
.sheet-tabs{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:flex-start; }
.tab,.btn-tab{
  background:#fff;color:var(--primary-600);
  border:1px solid var(--primary-600);border-radius:var(--radius-lg);
  padding:6px 18px;font-size:var(--fz-body);font-weight:600;cursor:pointer;min-width:170px;text-align:center;
}
body.dark .tab, body.dark .btn-tab{background:transparent}
.tab:hover,.btn-tab:hover{background:rgba(31,111,229,.06)}
.tab.active,.btn-tab.active{background:var(--primary-600);color:#fff;border-color:var(--primary-600)}
.tab:focus-visible,.btn-tab:focus-visible{outline:2px solid var(--focus);outline-offset:2px}

/* ======= 上方時鐘 + 更新頻率 ======= */
.refresh-bar{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin:4px 0 6px; }
.clock{ font-weight:900; letter-spacing:.5px; font-variant-numeric: tabular-nums; }
.seg-group{ display:flex; gap:8px; flex-wrap:wrap; }
.seg-btn{
  background:#fff; color:var(--primary-600);
  border:1px solid var(--primary-600); border-radius:var(--radius-lg);
  padding:6px 14px; font-size:var(--fz-body); font-weight:700; cursor:pointer; min-width:72px; text-align:center;
}
body.dark .seg-btn{ background:transparent; }
.seg-btn:hover{ background:rgba(31,111,229,.06); }
.seg-btn.active{ background:var(--primary-600); color:#fff; border-color:var(--primary-600); }
.seg-btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; }
.seg-btn[disabled]{ cursor:not-allowed; }

/* =========== 原「登錄」頁卡片 =========== */
.veh-list{display:grid;grid-template-columns:repeat(auto-fit, minmax(480px,1fr));gap:12px;margin-top:16px;}
.veh-card{background:rgba(255,255,255,0.85);border-radius:var(--radius-lg);border:1px solid var(--border);padding:14px 14px 10px;display:flex;flex-direction:column;gap:10px;}
body.dark .veh-card{background:rgba(15,23,42,0.28);}
.veh-title-main{font-weight:700;font-size:var(--fz-title);line-height:var(--lh-title);color:var(--text-strong);}
.veh-title-sub{font-size:var(--fz-sub);line-height:var(--lh-sub);color:var(--text-muted);}
.step-row{display:grid;grid-template-columns:180px 1fr auto;align-items:center;gap:10px;margin-bottom:6px;}
.step-time{font-size:var(--fz-label);line-height:var(--lh-label);font-weight:600;color:rgba(15,23,42,.75);text-align:right;min-width:70px;font-feature-settings:"tnum" 1, "lnum" 1; font-variant-numeric:tabular-nums lining-nums;}
body.dark .step-time{color:#cbd5e1}
.step-select{min-width:170px;padding:6px 8px;border-radius:var(--radius-sm);border:1px solid var(--border);background:#fff;font-size:var(--fz-body);}
.step-select:disabled{background:#e2e8f0;cursor:not-allowed;}
.textarea{width:100%;min-height:120px;border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;background:#fff;font-size:var(--fz-body);}
.textarea:focus-visible{outline:2px solid var(--focus);outline-offset:2px}

/* =========== Buttons =========== */
.btn,.step-btn{
  border:0;border-radius:var(--radius-md);padding:8px 14px;
  background:#0f6efc;color:#fff;font-size:var(--fz-body);font-weight:600;cursor:pointer;
  transition:background-color .12s ease,border-color .12s ease,filter .12s ease;
  min-width:64px;text-align:center;
}
.btn--sm{padding:6px 12px}
.btn--lg{padding:10px 18px;font-size:15px}
.btn:focus-visible,.step-btn:focus-visible{outline:2px solid var(--focus);outline-offset:2px;}
.btn[disabled],.step-btn[disabled]{background:var(--gray-300)!important;color:var(--gray-700)!important;cursor:not-allowed}
.btn--primary{background:var(--primary-600);} .btn--primary:hover{background:var(--primary-700);} .btn--primary:active{background:var(--primary-800);}
.btn--success{background:var(--success-600);} .btn--success:hover{background:var(--success-700);} .btn--success:active{background:var(--success-800);}
.btn--danger{background:var(--danger-600);}  .btn--danger:hover{background:var(--danger-700);}  .btn--danger:active{background:var(--danger-800);}
.btn--secondary{background:#fff;color:var(--primary-600);border:1px solid var(--primary-600);} 
body.dark .btn--secondary{background:transparent}
.btn--secondary:hover{background:rgba(31,111,229,.06)}
.btn-group{display:flex;gap:8px;flex-wrap:wrap}

/* 通知 & Modal & Loading */
.notif{position:fixed;right:16px;bottom:16px;background:rgba(15,23,42,.85);color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transform:translateY(20px);transition:.2s;z-index:9990;}
.notif.show{opacity:1;transform:translateY(0);}
.modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: block; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 16px; border-radius: 12px; min-width: 280px; max-width: 90vw; box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 10001; display: block; }
body.dark .modal{ background:#0b1325; color:#e2e8f0 }
.modal h3{ margin:0 0 10px; font-size:16px }
.modal .row{ display:flex; gap:8px; align-items:center; margin:8px 0 }
.modal input{ width:56px; padding:6px 8px; border:1px solid var(--border); border-radius:8px }
.modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }
.modal .time-edit{ display:flex; align-items:center; justify-content:center; gap:10px; margin:8px 0 4px; }
.modal .time-input{ width:64px; text-align:center; padding:6px 8px; border:1px solid var(--border); border-radius:10px; font-weight:600; }
.modal .colon{ font-size:20px; line-height:1; opacity:.5; margin:0 2px; user-select:none; }
.modal .hint{ font-size:.9rem; line-height:1.6; opacity:.8; margin:2px 0; }
body.modal-open{ overflow:hidden; touch-action:none; }

/* Loading Overlay */
#loading.loading{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 2147483000; }
#loading.loading.show{ display: flex; }
.loading-box{ display:flex; align-items:center; gap:10px; background: var(--surface); color: var(--text); border:1px solid var(--border); border-radius:12px; padding:12px 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); backdrop-filter: blur(8px); }
.spinner{ width:20px; height:20px; border-radius:50%; border:2.5px solid #cbd5e1; border-top-color: var(--primary-600); animation: spin 1s linear infinite; }
@keyframes spin{ to{ transform: rotate(360deg); } }
@media (prefers-reduced-motion: reduce){ .spinner{ animation: none; border-top-color:#cbd5e1; } }
body.loading-open{ overflow:hidden; touch-action:none; overscroll-behavior: contain; }
@supports (height: 100dvh){ .modal-backdrop{ height: 100dvh; } }

/* ===== 登入畫面（不再覆蓋 .wrap > div:first-child） ===== */
body.login{ height: 100dvh; overflow: hidden; }
body.login .wrap{ height: 100%; display: grid; place-items: center; }
body.login #tabs, body.login #content, body.login #userInfo{ display: none !important; }
body.login #signin{ display:block; }
body.login .topbar-grid{
  display:grid;
  grid-template-columns: 1fr auto;
  grid-template-rows: auto auto;
  gap: 12px;
  align-items:center;
  justify-items:center;     /* 讓登入按鈕置中 */
  text-align:center;
}
body.login .left-title h1{
  font-size: clamp(36px, 8vw, 64px);
  line-height: 1.15;
  margin: 0;
}
#logoutBtn { white-space: nowrap; }
#logoutBtn:hover { background:rgba(239,68,68,.1) !important; }  

/* ===== 頂層三頁 Tab ===== */
.main-tabs{ display:flex; gap:12px; margin:6px 0 8px; flex-wrap:wrap; }
.main-tab{ background:#fff; color:var(--primary-600); border:1px solid var(--primary-600); border-radius:var(--radius-lg); padding:8px 20px; font-size:15px; font-weight:700; cursor:pointer; min-width:120px; text-align:center; }
body.dark .main-tab{ background:transparent; }
.main-tab:hover{ background:rgba(31,111,229,.06) }
.main-tab.active{ background:var(--primary-600); color:#fff }
.tab-pane{ margin-top:8px; }

/* ======= 整體情報（儀表板）樣式 ======= */
.dash-section{ margin:16px 0 24px; }
.dash-title{ font-size:18px; font-weight:800; color:var(--text-strong); margin:0 0 8px; }
.stat-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr)); gap:12px; }
.stat-card{ border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.9); padding:12px; box-shadow:var(--shadow-card); }
body.dark .stat-card{ background:rgba(15,23,42,.30); }
.stat-head{ font-weight:800; margin-bottom:8px; color:var(--text-strong); }
.stat-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat-pill{ border:1px solid var(--border); border-radius:10px; padding:10px 8px; background:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; }
body.dark .stat-pill{ background:rgba(2,6,23,.5); }
.stat-pill:hover{ filter:brightness(1.02); }
.stat-num{ font-size:26px; font-weight:800; line-height:1; }
.stat-num.done{ color:#2563eb; }
.stat-num.todo{ color:#ef4444; }
.stat-label{ font-size:12px; color:var(--text-muted); margin-top:4px; }

/* 停車位置卡片（單欄寬） */
.loc-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(170px,1fr)); gap:10px; margin-top:8px; }
.loc-pill{ border:1px dashed var(--border); border-radius:12px; padding:10px; background:rgba(255,255,255,.85); display:flex; flex-direction:column; align-items:center; gap:4px; cursor:pointer; }
body.dark .loc-pill{ background:rgba(15,23,42,.28); }
.loc-name{ font-weight:700; }
.loc-num{ font-size:22px; font-weight:900; color:#2563eb; }

/* 清單／詳情彈窗內部 */
.modal .dash-close{ position:absolute; right:10px; top:8px; font-size:22px; line-height:1; cursor:pointer; opacity:.7; }
.modal .dash-close:hover{ opacity:1; }
.list-item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px dashed var(--border); }
.list-left{ display:flex; flex-direction:column; gap:2px; }
.list-title{ font-weight:800; }
.list-sub{ font-size:13px; opacity:.85; }
.detail-table{ width:100%; border-collapse:collapse; }
.detail-table th, .detail-table td{ border:1px solid var(--border); padding:8px 10px; text-align:center; }
.detail-table th{ background:#0f172a; color:#fff; }

/* ====== 頂部兩列排版（標題/分頁 ←→ 使用者/時鐘+更新） ====== */
.topbar-grid{
  display:grid;
  grid-template-columns: 1fr auto;   /* 左寬右窄 */
  grid-template-rows: auto auto;     /* 上：標題/使用者，下：分頁/時鐘 */
  gap:6px 12px;
  align-items:center;
}
.topbar-grid .left-title{ grid-area: 1 / 1 / 2 / 2; }
.topbar-grid .left-tabs{  grid-area: 2 / 1 / 3 / 2; }
.topbar-grid .right-user{
  grid-area: 1 / 2 / 2 / 3;
  display:flex; align-items:center; gap:12px; justify-content:flex-end;
}
.topbar-grid .right-refresh{ grid-area: 2 / 2 / 3 / 3; }

/* 讓時鐘與頻率鈕靠右，間距更緊一些 */
.refresh-bar{ margin:0; display:flex; gap:8px; align-items:center; justify-content:flex-end; }
.clock{ font-weight:800; font-variant-numeric: tabular-nums; letter-spacing:.5px; }

/* 登入頁不顯示右側的更新列，但保留標題 */
body.login .right-refresh{ display:none !important; }

/* Modal 版面安全高度與配色 */
.modal{ max-height: calc(100dvh - 48px); overflow:auto; padding-right:44px !important; max-width:96vw !important; border-radius:12px; }
@supports not (height: 100dvh){ .modal{ max-height: 90vh; } }
.detail-table th{ background: var(--primary-700) !important; color:#fff; }
body.dark .detail-table th{ background: var(--primary-600) !important; }
.detail-table, .detail-table th, .detail-table td{ border-color: var(--border); }
.detail-table thead th:first-child{ border-top-left-radius:10px; }
.detail-table thead th:last-child{  border-top-right-radius:10px; }
/* 登入模式：只留 Google 登入按鈕與大標題，其他一律隱藏 */
body.login #mainTabs,
body.login .right-refresh,
body.login #userInfo,
body.login #tabs,
body.login #content,
body.login .tab-pane {
  display: none !important;
}
.user-info{ display:flex; align-items:center; gap:12px; font-size:.875rem; }

/* ===== 個別情報樣式 ===== */
.indiv-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
.indiv-row select{ min-width:240px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; }
.indiv-row select[disabled]{ opacity:.6; cursor:not-allowed; }
.indiv-actions .btn{ min-width:96px; }
.indiv-cards-grid{ display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:12px; margin-top:8px; }
.indiv-card{ border:1px solid var(--border); background:#fff; border-radius:12px; padding:12px; box-shadow:var(--shadow-card); cursor:pointer; }
body.dark .indiv-card{ background:rgba(15,23,42,.30); }
.indiv-card .top{ font-weight:600; margin-bottom:6px; }
.mini-badge{ display:inline-block; font-size:12px; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; }
.indiv-card .mid{ font-size:20px; font-weight:800; letter-spacing:.5px; margin-bottom:6px; }
.indiv-card .bot{ color:#334155; font-size:14px; }
.step-grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
.step-cell{ background:#1d4ed8; color:#fff; padding:8px; border-radius:8px; text-align:center; font-size:14px; }
.single-list{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
.single-card{
  border:1px solid var(--border);
  background:rgba(255,255,255,.9);
  border-radius:12px; padding:14px;
  box-shadow:var(--shadow-card);
  text-align:center; cursor:pointer;
}
body.dark .single-card{ background:rgba(15,23,42,.30); }
.single-card:hover{ filter:brightness(1.015); }
.single-line{
  font-size:var(--fz-title);
  line-height:var(--lh-title);
  font-weight:var(--fw-title);
  color:var(--text-strong);
}
.single-line + .single-line{ margin-top:6px; }


/* ======================= 最終統一美化（數字更大 + 字體完全一致）======================= */
/* 主要統計數字（完成/未完成 + 停車位置）全部放大、更粗 */
.stat-num,
.loc-num {
  font-size: 32px !important;
  font-weight: 900 !important;
  line-height: 1 !important;
}

/* 「完成」「未完成」「台」字統一：14px、非粗體 */
.stat-label,
.loc-pill .stat-label {
  font-size: 14px !important;
  font-weight: normal !important;
  color: var(--text-muted);
  margin-top: 4px;
}

/* 停車位置名稱稍微放大（手機更清楚） */
.loc-name {
  font-size: 15px;
  font-weight: 700;
}
 
</style>
</head>
<body>
<div class="wrap">
  <!-- 兩列兩欄的頂部排版 -->
  <div class="topbar-grid">
    <!-- 左上：標題（登入與登入後皆顯示） -->
    <div class="left-title">
      <h1 id="pageTitle">車流人流退場情報</h1>
    </div>

    <!-- 右上：登入資訊 -->
    <div class="right-user">
      <div id="signin"></div>
      <div id="userInfo" class="hide user-info">
      <span id="userDisplay"></span>
        <button id="logoutBtn" class="btn btn--secondary btn--sm" style="padding:6px 12px;">登出</button>
      </div>
    </div>

    <!-- 左下：三個主頁籤 -->
    <div class="left-tabs">
      <div id="mainTabs" class="main-tabs" style="justify-content: space-between;">
  <!-- 最左邊：最新狀態（原本的整體情報 II） -->
  <button class="main-tab active" data-target="pane-dashboard2">最新狀態</button>
  <button class="main-tab" data-target="pane-single">個別情報</button>
  <button class="main-tab" data-target="pane-punch">登錄與修改</button>
</div>

<!-- 完全隱藏原本的「整體情報」按鈕（不會出現在畫面上） -->
<style>
  /* 隱藏原本的整體情報按鈕（pane-dashboard） */
  #mainTabs .main-tab[data-target="pane-dashboard"] {
    display: none !important;
  }

/* 「完成」「未完成」「台」三個字 → 完全跟小標題（.stat-head）一樣大、一樣粗、一樣顏色 */
.stat-label,
.loc-pill .stat-label {
  font-size: 14px !important;
  font-weight: 800 !important;        /* 跟小標題一樣粗 */
  color: var(--text-strong) !important; /* 跟小標題一樣黑 */
  margin-top: 4px !important;
  line-height: 1.4 !important;        /* 與小標題視覺一致 */
}
/* 其他組負責的步驟 → 橘色底標示（極簡、專業） */
.step-card.personnel {
  background: #fff7ed !important;      /* 極淺橘底 */
  border: 1px solid #fed7aa !important;
}
.step-card.personnel .stat-num.done   { color: #c2410c !important; }  /* 完成的數字變深橘 */
.step-card.personnel .stat-num.todo   { color: #ea580c !important; }  /* 未完成的數字變更深橘 */
.step-card.personnel .stat-head       { color: #c2410c !important; font-weight: 800; }  
</style>
    </div>

    <!-- 右下：時鐘 + 自動更新頻率 -->
    <div class="right-refresh">
      <div class="refresh-bar">
        <div class="clock" id="clockDisplay" aria-live="polite">--:--:--</div>
        <div class="seg-group" id="refreshControls"></div>
      </div>
    </div>
  </div>

  <!-- 第 1 頁：沿用（打卡 + 車卡） -->
  <div id="pane-punch" class="tab-pane">
    <div id="tabs" class="card hide" style="padding-bottom:6px;">
      <div class="sheet-tabs" id="sheetTabs"></div>
    </div>
    <div id="content" class="hide">
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <!-- 第 2 頁：整體情報 -->
  <div id="pane-dashboard" class="tab-pane hide">
  <!-- 整體情報的 5 個子分頁 -->
  <div class="card" id="dashTabsBar" style="padding-bottom:6px;">
    <div class="sheet-tabs" id="dashboardTabs"></div>
  </div>
  <!-- 內容容器 -->
  <div id="dashboard"></div>
</div>


  <!-- 第 3 頁：個別情報 -->
  <div id="pane-single" class="tab-pane hide">
  <div class="card" id="singleControlsCard" style="padding-bottom:10px;">
    <div class="single-controls" id="singleControls">
      <select id="selSheet" class="step-select" aria-label="Tab（可不選）">
        <option value="">— 全部 Tab —</option>
      </select>
      <select id="selArea" class="step-select" aria-label="區域車次編號（可不選）">
        <option value="">— 全部 區域車次編號 —</option>
      </select>
      <select id="selCar" class="step-select" aria-label="車號（可不選）">
        <option value="">— 全部 車號 —</option>
      </select>
    </div>
    <div class="single-actions">
      <button id="btnQuery" class="btn btn--primary btn--sm">查詢</button>
      <button id="btnReset" class="btn btn--secondary btn--sm">全部重設</button>
    </div>
  </div>

  <div class="card" id="singleResultsCard">
    <div id="singleResults" class="single-list" aria-live="polite"></div>
  </div>
</div>

<div id="pane-dashboard2" class="tab-pane hide">
  <div class="card" id="dashTabsBar2" style="padding-bottom:6px;">
    <div class="sheet-tabs" id="dashboardTabs2"></div>
  </div>
  <div id="dashboard2"></div>
</div>
  
</div>

<div id="notif" class="notif"></div>

<!-- 全螢幕 Loading Overlay -->
<div id="loading" class="loading" role="status" aria-live="polite" aria-busy="true">
  <div class="loading-box">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text">處理中…</div>
  </div>
</div>
<script>
const GOOGLE_CLIENT_ID = '368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbxjGHiVKpNMG84OIHIvX4tGYgJ7gksxT0PItegG-7bpSeumnqgMPfwo-1Ocs1l9rMxC/exec';

const STOP_OPTIONS = [
  '禪堂平台','法心北路','法心南路（西）','法心南路（東）','法大路','雙環路到三門','三門到大停車場','靈山勝境石往外','雙環路至法大一橋'
];

const SHEET_CONFIGS = [
  { key:'地區專車退場（遊覽車平台）', sheet:'地區專車退場（遊覽車平台）', steps:[
    '車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置',
    '退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台','車第二次上遊覽車平台','車已離開遊覽車平台'
  ]},
  { key:'地區專車退場（禪堂平台）', sheet:'地區專車退場（禪堂平台）', steps:[
    '車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','車已離開禪堂平台'
  ]},
  { key:'水陸專車退場', sheet:'水陸專車退場', steps:[
    '已 Call 車排車隊','已排好車隊','退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台','車已上遊覽車平台','車暫停位置','車已離開遊覽車平台'
  ]},
  { key:'288法青退場', sheet:'288法青退場', steps:[
    '退場人員已到齊','車已經上遊覽車平台','車已經離開遊覽車平台'
  ]}
];

// 其他組負責步驟 → 橘色底（極簡優雅）
const PERSONNEL_STEPS = {
  '地區專車退場（遊覽車平台）': ['退場人員已到齊', '人已前往平台'],
  '地區專車退場（禪堂平台）'  : ['車已離開禪堂平台'],
  '水陸專車退場'            : ['退場人員已到齊', '人已前往平台'],
  '288法青退場'             : ['退場人員已到齊']
};

const REFRESH_PRESETS = [
  { label:'5分',  ms: 5*60*1000 },
  { label:'2分',  ms: 2*60*1000 },
  { label:'60秒', ms: 60*1000 },
  { label:'30秒', ms: 30*1000 }
];
const REFRESH_STORAGE_KEY = 'dash_refresh_ms';
let refreshMs = parseInt(localStorage.getItem(REFRESH_STORAGE_KEY) || '', 10) || 2*60*1000;

let dashTimer = null;
let currentDashFilter2 = 'ALL';
let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = [];
const TOKEN_STORAGE_KEY = 'ddcc_user_token';
let idToken = null;

window.onload = function(){
  startClock(); buildRefreshControls(); updateRefreshControlsVisibility();
  const saved = localStorage.getItem(TOKEN_STORAGE_KEY);
  if (saved) {
    idToken = saved;
    fetch(API_BASE + '?action=verify', {method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({idToken})})
    .then(r=>r.json()).then(j=>{if(j.error)throw new Error(j.error);currentUser=j;finishLoginUI();buildTabs();loadSheetData(currentSheetKey);})
    .catch(()=>{logout();initGoogleSignIn();});
  } else initGoogleSignIn();
  document.getElementById('logoutBtn').addEventListener('click', logout);
};

function getTaipeiHHMMSS(){
  return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());
}
function startClock(){
  const el = document.getElementById('clockDisplay');
  const tick = ()=>{ if(el) el.textContent = getTaipeiHHMMSS(); };
  tick(); setInterval(tick, 1000);
}

function buildRefreshControls(){
  const box = document.getElementById('refreshControls'); if(!box) return; box.innerHTML='';
  REFRESH_PRESETS.forEach(p=>{
    const btn=document.createElement('button'); btn.className='seg-btn'; btn.textContent=p.label; btn.dataset.ms=p.ms;
    if(p.ms===refreshMs){btn.classList.add('active');btn.disabled=true;}
    btn.onclick=()=>openRefreshSaveDialog(p.ms,p.label); box.appendChild(btn);
  });
  const nowBtn=document.createElement('button'); nowBtn.className='seg-btn'; nowBtn.textContent='立即更新';
  nowBtn.onclick=()=>{if(isDashboardVisible()){buildDashboard(false);buildDashboard2(true);refreshAllActiveTodoModals();}
    else showNotif('切到「最新狀態」即可看到最新資料',false);};
  box.appendChild(nowBtn);
}

function updateRefreshControlsVisibility(){
  const controls=document.getElementById('refreshControls');
  if(!controls)return;
  const show=isDashboardVisible() && !document.body.classList.contains('login');
  controls.classList.toggle('hide',!show);
}

function openRefreshSaveDialog(ms,label){
  const box=document.createElement('div'); box.className='modal';
  box.innerHTML=`<h3>儲存自動更新頻率</h3>
    <div class="modal-msg" style="font-size:15px;line-height:1.7;margin:6px 0 10px;">將自動更新頻率設定為 <b>${label}</b>。按「儲存」後即刻生效。</div>
    <div class="actions"><button class="btn" style="background:#e5e7eb;color:#111827;">取消</button><button class="btn btn--primary">儲存</button></div>`;
  const close=openModal(box);
  const [btnCancel,btnOK]=box.querySelectorAll('button');
  btnCancel.onclick=close;
  btnOK.onclick=()=>{refreshMs=ms;localStorage.setItem(REFRESH_STORAGE_KEY,String(refreshMs));updateRefreshButtonsUI();
    if(isDashboardVisible())startDashboardAutoRefresh();showNotif(`已設定為每 ${label} 自動更新`,false);close();};
}

function updateRefreshButtonsUI(){
  document.querySelectorAll('#refreshControls .seg-btn').forEach(btn=>{
    if(btn.textContent==='立即更新')return;
    const ms=parseInt(btn.dataset.ms||'0',10);
    const active=(ms===refreshMs);
    btn.classList.toggle('active',active); btn.disabled=active;
  });
}

function initGoogleSignIn(){enterLoginView();google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID,callback:handleCredential});
  google.accounts.id.renderButton(document.getElementById('signin'),{theme:'outline',size:'large'});buildTabs();}
function buildTabs(){
  const box=document.getElementById('sheetTabs');box.innerHTML='';
  SHEET_CONFIGS.forEach(cfg=>{const btn=document.createElement('button');
    btn.className='btn-tab tab'+(cfg.key===currentSheetKey?' active':'');
    btn.textContent=cfg.key;
    btn.onclick=()=>{currentSheetKey=cfg.key;box.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));btn.classList.add('active');loadSheetData(currentSheetKey);};
    box.appendChild(btn);});
}

async function handleCredential(resp){
  idToken=resp.credential;localStorage.setItem(TOKEN_STORAGE_KEY,idToken);
  try{const r=await fetch(API_BASE+'?action=verify',{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({idToken})});
    const j=await r.json();if(j.error)throw new Error(j.error);currentUser=j;finishLoginUI();loadSheetData(currentSheetKey);}
  catch(err){showNotif('登入失敗：'+err.message,true);logout();}
}
function finishLoginUI(){
  updateRefreshControlsVisibility();document.body.classList.remove('login');document.getElementById('signin').classList.add('hide');
  const ui=document.getElementById('userInfo');ui.classList.remove('hide');ui.style.display='';
  document.getElementById('userDisplay').innerHTML=`${escapeHtml(currentUser.name||'')} &lt;${escapeHtml(currentUser.email||'')}&gt; ｜ 權限：<b>${escapeHtml(currentUser.permission||'')}</b>`;
  document.getElementById('tabs').classList.remove('hide');document.getElementById('content').classList.remove('hide');
  switchPane('pane-dashboard2');
  document.querySelectorAll('#mainTabs .main-tab').forEach(btn=>btn.classList.toggle('active',btn.dataset.target==='pane-dashboard2'));
}
function logout(){
  localStorage.removeItem(TOKEN_STORAGE_KEY);idToken=null;currentUser=null;enterLoginView();stopDashboardAutoRefresh();
  const signinDiv=document.getElementById('signin');signinDiv.classList.remove('hide');signinDiv.innerHTML='';
  google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID,callback:handleCredential});
  google.accounts.id.renderButton(signinDiv,{theme:'outline',size:'large'});showNotif('已登出',false);
}

function escapeHtml(str){if(str==null)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function formatSheetTime(val){
  if(!val)return'';
  const s=String(val).trim();
  if(/^\d{1,2}:\d{2}:\d{2}$/.test(s))return s.split(':').map(p=>p.padStart(2,'0')).join(':');
  if(/^\d{4}\/\d{1,2}\/\d{1,2} \d{1,2}:\d{2}:\d{2}$/.test(s))return s.split(' ')[1].split(':').map(p=>p.padStart(2,'0')).join(':');
  const m=s.match(/^(上午|下午)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if(m){let h=+m[2];const mm=m[3],ss=m[4]||'00';if(m[1]==='下午'&&h<12)h+=12;if(m[1]==='上午'&&h===12)h=0;return `${String(h).padStart(2,'0')}:${mm}:${ss}`;}
  if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(s)){const d=new Date(s);const tw=new Date(d.getTime()+8*3600*1000);
    return `${String(tw.getUTCHours()).padStart(2,'0')}:${String(tw.getUTCMinutes()).padStart(2,'0')}:${String(tw.getUTCSeconds()).padStart(2,'0')}`;}
  return s;
}
function showLoading(msg='處理中…'){const el=document.getElementById('loading');if(!el)return;const t=el.querySelector('.loading-text');if(t)t.textContent=msg;el.classList.add('show');document.body.classList.add('loading-open');}
function hideLoading(){const el=document.getElementById('loading');if(!el)return;el.classList.remove('show');document.body.classList.remove('loading-open');}
async function withLoading(fn,msg='處理中…'){showLoading(msg);try{return await fn();}finally{hideLoading();}}
function showNotif(msg,isErr){const box=document.getElementById('notif');box.textContent=msg;box.style.background=isErr?'rgba(248,113,113,.9)':'rgba(15,23,42,.85)';box.classList.add('show');setTimeout(()=>box.classList.remove('show'),2500);}
function enterLoginView(){
  updateRefreshControlsVisibility();document.body.classList.add('login');stopDashboardAutoRefresh?.();
  ['pane-punch','pane-dashboard','pane-single','pane-dashboard2'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('hide');});
  document.getElementById('signin')?.classList.remove('hide');
  const ui=document.getElementById('userInfo');if(ui){ui.classList.add('hide');ui.style.display='none';}
}
function openModal(element){/* 保持原本完整 openModal 函式不變 */ /* 省略以節省篇幅，保留你原本的 */ }
function closeAllModals(){document.querySelectorAll('.modal, .modal-backdrop').forEach(el=>{try{el.remove()}catch{}});document.body.classList.remove('modal-open');}

/* 登錄頁面載入（已加入 silent） */
async function loadSheetData(key, silent = false){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  if (!silent) document.getElementById('vehList').textContent = '讀取資料中';
  const r = await fetch(API_BASE + `?action=get&idToken=${encodeURIComponent(idToken || '')}&sheet=${encodeURIComponent(cfg.sheet)}`);
  const j = await r.json();
  if (j.error){document.getElementById('vehList').textContent = '錯誤 ' + j.error;return;}
  sheetData = j.values || [];
  renderVehicles(cfg, sheetData);
}
function reloadSheet(silent = false){loadSheetData(currentSheetKey, silent);}

/* 最新狀態（關鍵重點：自動找表頭 + 分隔線 + 橘色底） */
let ALL_SHEETS = {};
async function buildDashboard2(silent = false){
  if (!currentUser || document.body.classList.contains('login')) return;
  const dash = document.getElementById('dashboard2'); dash.innerHTML = '';
  const work = async () => {
    const results = await Promise.all(SHEET_CONFIGS.map(async cfg => {
      const r = await fetch(API_BASE + `?action=get&idToken=${encodeURIComponent(idToken || '')}&sheet=${encodeURIComponent(cfg.sheet)}`);
      const j = await r.json(); const values = j.values || [];

      // 自動找表頭（從第1行開始，避免合併儲存格）
      let headerIdx = -1;
      for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (Array.isArray(row) &&
            String(row[0]||'').trim()==='編號' &&
            String(row[1]||'').trim().startsWith('區域') &&
            String(row[2]||'').trim()==='車號') {
          headerIdx = i; break;
        }
      }
      if (headerIdx === -1) return {key:cfg.key,cfg,headerIdx:-1,header:[],rows:[]};
      const header = values[headerIdx].map(c=>String(c||'').trim());
      const rows = values.slice(headerIdx+1).filter(r=>String(r[0]||'').trim() && String(r[1]||'').trim() && String(r[2]||'').trim());
      return {key:cfg.key,cfg,headerIdx,header,rows};
    }));

    ALL_SHEETS = {}; results.forEach(x=>ALL_SHEETS[x.key]=x);

    results.forEach(({cfg,header,rows})=>{
      if (!rows.length) return;
      const filterKey = currentDashFilter2==='ALL' ? 'ALL' : currentDashFilter2;
      if (filterKey!== 'ALL' && cfg.key!==filterKey) return;

      const sec = document.createElement('section'); sec.className='dash-section card';
      const title = document.createElement('div'); title.className='dash-title'; title.textContent=cfg.key; sec.appendChild(title);

      let topSteps = [], botSteps = [];
      const stopColIdx = header.indexOf('車暫停位置');
      if (cfg.key==='水陸專車退場'){
        topSteps = ['已 Call 車排車隊','已排好車隊'];
        botSteps = cfg.steps.filter(s=>topSteps.indexOf(s)===-1 && s!=='車暫停位置');
      } else if (stopColIdx>=0){
        const split = cfg.steps.indexOf('車暫停位置');
        topSteps = cfg.steps.slice(0,split);
        botSteps = cfg.steps.slice(split+1);
      } else {
        topSteps = cfg.steps;
      }

      const renderGrid = (steps) => {
        if (!steps.length) return;
        const grid = document.createElement('div'); grid.className='stat-grid';
        steps.forEach(st=>{
          const col = header.indexOf(st);
          if (col===-1) return;
          let done=0,todo=0;
          rows.forEach(r=>{isCompletedValue(r[col])?done++:todo++;});
          const card=document.createElement('div'); card.className='stat-card';
          if (PERSONNEL_STEPS[cfg.key]?.includes(st)) card.classList.add('personnel');
          card.innerHTML = `<div class="stat-head">${st}</div>
            <div class="stat-row">
              <div class="stat-pill" data-type="done"><div class="stat-num done">${done}</div><div class="stat-label">完成</div></div>
              <div class="stat-pill" data-type="todo"><div class="stat-num todo">${todo}</div><div class="stat-label">未完成</div></div>
            </div>`;
          card.querySelectorAll('.stat-pill').forEach(p=>p.addEventListener('click',()=>openListModal2(cfg.key,st,p.dataset.type)));
          grid.appendChild(card);
        });
        sec.appendChild(grid);
      };

      renderGrid(topSteps);

      if (stopColIdx>=0){
        const locTitle=document.createElement('div'); locTitle.className='dash-title';
        locTitle.style.margin='20px 0 8px 0'; locTitle.style.fontSize='16px'; locTitle.textContent='停車位置';
        sec.appendChild(locTitle);
        const locWrap=document.createElement('div'); locWrap.className='loc-grid'; locWrap.style.marginBottom='20px';
        const counter=new Map(); STOP_OPTIONS.forEach(n=>counter.set(n,0));
        rows.forEach(r=>{const v=String(r[stopColIdx]||'').trim();if(counter.has(v))counter.set(v,counter.get(v)+1);});
        STOP_OPTIONS.forEach(name=>{
          const n=counter.get(name)||0;
          const pill=document.createElement('div'); pill.className='loc-pill';
          pill.innerHTML=`<div class="loc-name">${name}</div><div class="loc-num">${n}</div><div class="stat-label">台</div>`;
          pill.addEventListener('click',()=>openListModal(cfg.key,'車暫停位置','loc',name));
          locWrap.appendChild(pill);
        });
        sec.appendChild(locWrap);

        // 分隔線（僅有停車位置的表）
        const divider=document.createElement('div');
        divider.style.height='1px'; divider.style.background='var(--border)'; divider.style.margin='8px 0 20px 0';
        sec.appendChild(divider);
      }

      renderGrid(botSteps);
      dash.appendChild(sec);
    });
  };
  if (silent) await work(); else await withLoading(work,'讀取資料中');
}

/* 其餘所有函式保持不變（renderVehicles、onPunchClick、switchPane、buildDashboard、個別情報等） */
/* 為了篇幅我全部保留你原本的，只是把關鍵的 buildDashboard2 換成上面這段即可 */

function isCompletedValue(v){if(v==null)return false;const s=String(v).trim();return !!s && s!=='—' && s!=='-';}
function isDashboardVisible(){return !document.getElementById('pane-dashboard2').classList.contains('hide');}
function startDashboardAutoRefresh(){stopDashboardAutoRefresh();dashTimer=setInterval(()=>{if(isDashboardVisible())buildDashboard2(true);},refreshMs);}
function stopDashboardAutoRefresh(){if(dashTimer){clearInterval(dashTimer);dashTimer=null;}}
document.addEventListener('visibilitychange',()=>{if(document.hidden)stopDashboardAutoRefresh();else if(isDashboardVisible())startDashboardAutoRefresh();});
document.getElementById('mainTabs').addEventListener('click',e=>{const btn=e.target.closest('.main-tab');if(!btn)return;switchPane(btn.dataset.target);});
buildDashboardTabs2(); // 初始化最新狀態的子分頁

// 其餘所有你原本的函式（renderVehicles、onPunchClick、openListModal2 等）全部保留不變
// （我這裡省略，只需把上面這段完整貼上去即可）

</script>

</body>
</html>
