<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>活動車流人流退場管理系統</title>
  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
      --card-bg: rgba(255,255,255,0.75);
      --text: #0f172a;
      --blue: #0f6efc;
      --gray-btn: #cbd5e1;
      --gray-btn-dark: #94a3b8;
    }
    body{
      margin:0;
      min-height:100vh;
      background:var(--bg);
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
      color:var(--text);
    }
    .wrap{max-width:1080px;margin:0 auto;padding:16px 16px 48px;}
    h1{margin:0 0 16px;font-size:1.35rem;}
    .hide{display:none;}

    /* tabs */
    .tabs-bar{
      display:flex;
      gap:14px;
      align-items:flex-end;
      margin-top:16px;
      margin-bottom:16px;
    }
    .tab-btn{
      border:1px solid #cbd5e1;
      background:#e2e8f0;
      border-radius:6px 6px 0 0;
      padding:6px 18px;
      font-size:.8rem;
      cursor:pointer;
    }
    .tab-btn.active{
      background:var(--blue);
      color:#fff;
      border-color:var(--blue);
    }
    .reload-bar{
      flex:1;
      text-align:right;
    }
    .reload-btn{
      border:1px solid #94a3b8;
      background:#fff;
      border-radius:6px;
      padding:4px 12px;
      cursor:pointer;
      font-size:.75rem;
    }

    /* list */
    .veh-list{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(460px, 1fr));
      gap:12px;
    }
    .veh-card{
      background:rgba(255,255,255,0.85);
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.35);
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .veh-title-main{font-weight:600;font-size:1rem;margin-bottom:2px;}
    .veh-title-sub{font-size:.85rem;opacity:.7;}

    .step-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin:3px 0;   /* ← 上下 3px */
    }
    .step-btn{
      border:0;
      border-radius:10px;
      padding:6px 12px 7px;
      background:var(--gray-btn);
      color:#0f172a;
      font-size:.74rem;
      cursor:pointer;
      min-width:160px;
      text-align:center;
    }
    .step-btn.done{
      background:var(--gray-btn);
      color:#0f172a;
    }
    .step-btn.locked{
      background:var(--gray-btn-dark);
      color:#e2e8f0;
      cursor:not-allowed;
    }
    .step-btn.active-doing{
      background:var(--blue);
      color:#fff;
    }
    .step-time{
      font-size:.7rem;
      color:rgba(15,23,42,.65);
      min-width:90px;
      text-align:right;
    }

    .notif{
      position:fixed;
      right:16px;
      bottom:16px;
      background:rgba(15,23,42,.9);
      color:#fff;
      padding:10px 14px;
      border-radius:14px;
      opacity:0;
      transform:translateY(20px);
      transition:.2s;
    }
    .notif.show{
      opacity:1;
      transform:translateY(0);
    }

    @media(max-width:768px){
      .veh-list{grid-template-columns:1fr;}
      .tabs-bar{flex-wrap:wrap;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
      <h1>活動車流人流退場管理系統</h1>
      <div id="signin"></div>
      <div id="userInfo" class="hide" style="font-size:.75rem;"></div>
    </div>

    <!-- tabs + reload -->
    <div id="tabs" class="tabs-bar hide">
      <div id="sheetTabs" style="display:flex;gap:14px;"></div>
      <div class="reload-bar">
        <button class="reload-btn" onclick="reloadSheet()">重新載入</button>
      </div>
    </div>

    <!-- content -->
    <div id="content" class="hide">
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <div id="notif" class="notif"></div>

<script>
// ① 換成你的 client ID
const GOOGLE_CLIENT_ID = '368914333961-504cujbloe9n3v28p4bjsc8c1lh5pg0o.apps.googleusercontent.com';
// ② 換成你的 apps script
const API_BASE = 'https://script.google.com/macros/s/AKfycbxbeknXeJ2s2NnIqTwIwNdZnsbiI9UlGkQpSGfHq2TlmnITZ75Ub4ySwn6UGmJk3AXjNg/exec';

// 你的五張 sheet
const SHEET_CONFIGS = [
  {
    key:'地區專車退場（遊覽車平台）',
    sheet:'地區專車退場（遊覽車平台）',
    steps:[
      '車長通知行李到齊',
      'Call 車上行李',
      '車已上遊覽車平台',
      '車前往排車隊',
      '車暫停位置',
      '退場人員已到齊',
      '已 Call 車上遊覽車平台',
      '人已前往平台',
      '車第二次上遊覽車平台',
      '車已離開遊覽車平台'
    ]
  },
  {
    key:'地區專車退場（禪堂平台）',
    sheet:'地區專車退場（禪堂平台）',
    steps:[
      '車長通知行李到齊',
      'Call 車上行李',
      '車已上遊覽車平台',
      '車前往排車隊',
      '車已離開禪堂平台'
    ]
  },
  {
    key:'水陸專車退場',
    sheet:'水陸專車退場',
    steps:[
      '已 Call 車排車隊',
      '已排好車隊',
      '退場人員已到齊',
      '已 Call 車上遊覽車平台',
      '車已上遊覽車平台',
      '車已離開遊覽車平台'
    ]
  },
  {
    key:'國光號退場',
    sheet:'國光號退場',
    steps:[
      '是否經過長庚',
      '退場人員已到齊',
      '車已經上遊覽車平台',
      '車已經離開遊覽車平台',
      '上車人數'
    ]
  },
  {
    key:'288法青退場',
    sheet:'288法青退場',
    steps:[
      '退場人員已到齊',
      '車已經上遊覽車平台',
      '車已經離開遊覽車平台'
    ]
  }
];

let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let sheetData = [];

window.onload = function(){
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredential
  });
  google.accounts.id.renderButton(
    document.getElementById('signin'),
    { theme:'outline', size:'large' }
  );
  buildTabs();
};

// 登入 callback
async function handleCredential(resp){
  try{
    const r = await fetch(API_BASE + '?action=verify', {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({ idToken: resp.credential })
    });
    const j = await r.json();
    if (j.error){
      showNotif('登入失敗：' + j.error, true);
      return;
    }
    currentUser = j;
    document.getElementById('signin').classList.add('hide');
    const ui = document.getElementById('userInfo');
    ui.classList.remove('hide');
    ui.innerHTML = `${j.name||''} &lt;${j.email}&gt; ｜ 權限：<b>${j.permission}</b>`;
    document.getElementById('tabs').classList.remove('hide');
    document.getElementById('content').classList.remove('hide');
    loadSheetData(currentSheetKey);
  }catch(err){
    showNotif('登入錯誤：' + err.message, true);
  }
}

// tabs
function buildTabs(){
  const box = document.getElementById('sheetTabs');
  box.innerHTML = '';
  SHEET_CONFIGS.forEach(cfg=>{
    const b = document.createElement('button');
    b.className = 'tab-btn' + (cfg.key===currentSheetKey?' active':'');
    b.textContent = cfg.key;
    b.onclick = () => {
      currentSheetKey = cfg.key;
      document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      loadSheetData(currentSheetKey);
    };
    box.appendChild(b);
  });
}

// 把 sheet 撈回來
async function loadSheetData(key){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  document.getElementById('vehList').textContent = '讀取中...';
  const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}`);
  const j = await r.json();
  if (j.error){
    document.getElementById('vehList').textContent = '❌ ' + j.error;
    return;
  }
  sheetData = j.values || [];
  renderVehicles(cfg, sheetData);
}

// 解析：找到真正的表頭 + 有資料的列
function parseSheetData(raw){
  const headerIndex = raw.findIndex(row =>
    Array.isArray(row) &&
    String(row[0]||'').trim() === '編號' &&
    String(row[1]||'').trim().length>0 &&
    String(row[2]||'').trim() === '車號'
  );
  if (headerIndex === -1){
    return {header:[], rows:[], headerIndex:-1};
  }
  const header = raw[headerIndex].map(c => String(c||'').trim());
  const rows = raw.slice(headerIndex+1).filter(r=>{
    if (!Array.isArray(r)) return false;
    const no   = String(r[0]||'').trim();
    const area = String(r[1]||'').trim();
    const car  = String(r[2]||'').trim();
    return no && area && car;
  });
  return {header, rows, headerIndex};
}

// 把 sheet 的內容轉成畫面
function renderVehicles(cfg, data){
  const box = document.getElementById('vehList');
  box.innerHTML = '';
  const { header, rows, headerIndex } = parseSheetData(data);
  if (!rows.length){
    box.textContent = '(這張表目前沒有車輛資料)';
    return;
  }

  rows.forEach((row, idx)=>{
    const area = String(row[1]||'').trim();
    const car  = String(row[2]||'').trim();

    const card = document.createElement('div');
    card.className = 'veh-card';

    const title = document.createElement('div');
    title.innerHTML = `<div class="veh-title-main">${area}</div><div class="veh-title-sub">${car}</div>`;
    card.appendChild(title);

    const stepsBox = document.createElement('div');

    cfg.steps.forEach(st=>{
      const colIdx = header.indexOf(st);
      const rowEl = document.createElement('div');
      rowEl.className = 'step-row';

      const btn = document.createElement('button');
      btn.className = 'step-btn';
      btn.textContent = st;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'step-time';

      const rawVal = (colIdx !== -1 && row[colIdx]) ? String(row[colIdx]).trim() : '';
      const displayVal = formatSheetTime(rawVal);

      if (rawVal){
        btn.classList.add('done');
        timeSpan.textContent = displayVal;
      }

      // 前一個沒做就鎖住
      const prevOk = prevDone(cfg, header, row, st);
      if (!prevOk && !rawVal){
        btn.classList.add('locked');
        btn.disabled = true;
      }

      // 真正試算表 row
      const sheetRow = (headerIndex + 1) + 1 + idx;  // header 是 0-based → +1，資料從 header 下一列 → 再 +1，再加 idx

      btn.onclick = () => onStepClick(
        cfg,
        sheetRow,
        header,
        st,
        rawVal,          // 注意這裡傳原始的
        btn,
        timeSpan
      );

      rowEl.appendChild(btn);
      rowEl.appendChild(timeSpan);
      stepsBox.appendChild(rowEl);
    });

    card.appendChild(stepsBox);
    box.appendChild(card);
  });
}

// 判斷上一個狀態是否完成
function prevDone(cfg, header, row, st){
  const idx = cfg.steps.indexOf(st);
  if (idx === 0) return true;
  const prevName = cfg.steps[idx-1];
  const colIdx = header.indexOf(prevName);
  if (colIdx === -1) return true;
  return !!row[colIdx];
}

// 把各種格式轉成 hh:mm:ss
function formatSheetTime(raw){
  if (!raw) return '';
  const s = String(raw).trim();

  // 1) 有 T 的 → 當成 ISO，轉 +8
  if (s.includes('T')){
    const d = new Date(s);
    if (!isNaN(d.getTime())){
      const tw = new Date(d.getTime() + 8*60*60*1000);
      return tw.toISOString().substring(11,19); // hh:mm:ss
    }
  }

  // 2) 純 hh:mm or hh:mm:ss → 直接回
  if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(s)){
    const parts = s.split(':');
    while (parts.length < 3) parts.push('00');
    const [hh,mm,ss] = parts;
    return `${hh.padStart(2,'0')}:${mm}:${ss}`;
  }

  // 3) Google Sheet 中文時間：上午/下午
  const m = s.match(/^(上午|下午)\s*(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if (m){
    let h = parseInt(m[2],10);
    const mm = m[3];
    const ss = m[4] || '00';
    if (m[1] === '下午' && h < 12) h += 12;
    if (m[1] === '上午' && h === 12) h = 0;
    return `${String(h).padStart(2,'0')}:${mm}:${ss}`;
  }

  // 其他 → 原樣回去
  return s;
}

// 取得現在台灣時間 hh:mm:ss
function getNowTwHMS(){
  const now = new Date();
  // 直接加 8hr → 用 UTC 做
  const tw = new Date(now.getTime() + (8 - now.getTimezoneOffset()/60)*60*60*1000);
  // 其實上面寫成這樣是為了萬一主機不是 +8
  const h = String(tw.getUTCHours()).padStart(2,'0');
  const m = String(tw.getUTCMinutes()).padStart(2,'0');
  const s = String(tw.getUTCSeconds()).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// 點按鈕 → 寫入或修改
async function onStepClick(cfg, rowNumber, header, st, oldRawVal, btn, span){
  if (!currentUser) return alert('請先登入');
  if (!['輸入','全功能'].includes(currentUser.permission)) return alert('權限不足');

  const colIdx = header.indexOf(st);
  if (colIdx === -1) return alert('此欄位不存在：' + st);

  let valueToWrite = '';

  if (oldRawVal){  // 已有值 → 問要不要改
    const userInput = prompt('此狀態已有時間，要修改嗎？\n(清空就會刪除)', getNowTwHMS());
    if (userInput === null) return;  // 取消
    const t = userInput.trim();
    if (t === ''){
      valueToWrite = '';             // 清空
    } else {
      // 使用者自己輸入的 → 不處理 AM/PM，一律視為 24hr
      // 轉成 00:00:00 格式
      const parts = t.split(':');
      const hh = (parts[0]||'00').padStart(2,'0');
      const mm = (parts[1]||'00').padStart(2,'0');
      const ss = (parts[2]||'00').padStart(2,'0');
      valueToWrite = `${hh}:${mm}:${ss}`;
    }
  } else {        // 沒有值 → 直接寫現在時間
    valueToWrite = getNowTwHMS();
  }

  const body = {
    sheet: cfg.sheet,
    email: currentUser.email,
    writes: [{ row: rowNumber, col: colIdx+1, value: valueToWrite }]
  };

  const r = await fetch(API_BASE + '?action=update', {
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(body)
  });
  const j = await r.json();
  if (!j.ok){
    showNotif('寫入失敗：' + (j.error || 'unknown'), true);
    return;
  }

  // 前端立即更新
  span.textContent = valueToWrite;
  btn.classList.remove('locked');
  btn.classList.add('done');

  // 重新抓一次（怕後面有新的欄位）
  loadSheetData(currentSheetKey);
  showNotif('已寫入「'+st+'」', false);
}

function reloadSheet(){ loadSheetData(currentSheetKey); }

function showNotif(msg, isErr){
  const box = document.getElementById('notif');
  box.textContent = msg;
  box.style.background = isErr ? 'rgba(248,113,113,.9)' : 'rgba(15,23,42,.9)';
  box.classList.add('show');
  setTimeout(()=>box.classList.remove('show'), 2500);
}
</script>
</body>
</html>
