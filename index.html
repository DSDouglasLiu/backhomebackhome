<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è»Šæµäººæµé€€å ´æƒ…å ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
/* =========== Design Tokens =========== */
:root{
  --radius-md:10px; --radius-lg:12px; --radius-pill: 50px;
  --primary-600:#1f6fe5;
  --gray-50:#f8fafc;  --gray-100:#f1f5f9; --gray-200:#e5e7eb;
  --gray-500:#64748b; --gray-800:#1f2937; --gray-900:#0f172a;
  
  /* ç‰¹æ®Šæ“ä½œçµ„åˆ¥é¡è‰² (æ©˜ç´…) */
  --alt-600: #f97316; 
  --alt-bg: #fff7ed;

  --surface: rgba(255,255,255,.95);
  --text-strong: var(--gray-900);
  --text: var(--gray-800);
  --text-muted: var(--gray-500);
  --border: rgba(148,163,184,0.4);
  --page-bg: linear-gradient(135deg,#eef2f3,#dfe9f3);
  --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

body.dark{
  --surface: rgba(30, 41, 59, 0.7); /* Slightly lighter than page-bg for cards */
  --page-bg: radial-gradient(circle at 10% 20%,#0f172a 0%,#020617 90%);
  --text-strong:#f1f5f9; --text:#cbd5e1; --text-muted:#64748b;
  --border: rgba(148,163,184,0.2);
}

/* =========== Base =========== */
body{
  margin:0; min-height:100vh;
  background:var(--page-bg); color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
}
.wrap{max-width:1200px; margin:0 auto; padding:16px 16px 48px;}
h1{margin:0;font-size:28px;font-weight:700;color:var(--text-strong);}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow-card);padding:16px;margin:12px 0;}
.hide{ display:none !important; }

/* =========== UI Components =========== */
.tab-container-styled {
  background: #fff; border: 1px solid var(--border); border-radius: var(--radius-pill);
  padding: 8px 10px; display: inline-flex; gap: 8px; align-items: center; flex-wrap: wrap;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
body.dark .tab-container-styled { background: rgba(15, 23, 42, 0.6); }

.btn-tab {
  background: #fff; color: var(--gray-500);
  border: 1px solid transparent; border-radius: var(--radius-pill);
  padding: 8px 20px; font-size: 0.9rem; font-weight: 800; cursor: pointer;
  transition: all 0.2s ease; white-space: nowrap;
}
.btn-tab:hover { background: var(--gray-50); color: var(--primary-600); }
.btn-tab.active { background: var(--primary-600); color: #fff; border-color: var(--primary-600); box-shadow: 0 2px 4px rgba(31, 111, 229, 0.3); }

/* Main Tabs (ä¸Šæ’) */
.main-tab {
  background: #fff; color: var(--primary-600);
  border: 1px solid var(--primary-600); border-radius: var(--radius-pill);
  padding: 8px 22px; font-size: 0.9rem; font-weight: 800; cursor: pointer;
}
.main-tab.active { background: var(--primary-600); color: #fff; box-shadow: 0 4px 6px rgba(31, 111, 229, 0.25); }

/* Colors (ä¸‹æ’) */
.theme-teal   { --theme-color: #059669; }
.theme-orange { --theme-color: #d97706; }
.theme-purple { --theme-color: #7c3aed; }
.theme-pink   { --theme-color: #db2777; }

.btn-tab.colored-btn { color: var(--theme-color); border: 1px solid var(--theme-color); background: #fff; }
.btn-tab.colored-btn.active { background: var(--theme-color); color: #fff; border-color: var(--theme-color); }

/* Controls */
.refresh-bar{ display:flex; gap:12px; align-items:center; justify-content:flex-end; }
.clock{ font-weight:800; font-variant-numeric: tabular-nums; letter-spacing:1px; font-size: 1.1rem; }
.seg-group{ display:flex; gap:6px; background: #fff; border:1px solid var(--border); padding:4px; border-radius: var(--radius-pill); }
.seg-btn{ background:transparent; color:var(--text-muted); border:none; border-radius:var(--radius-pill); padding:4px 12px; font-weight:600; cursor:pointer; }
.seg-btn.active{ background: #fff; color:var(--primary-600); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.seg-btn.now-btn { color: var(--primary-600); border: 1px solid var(--primary-600); margin-left: 4px; }

/* Layout */
.topbar-grid { display: grid; grid-template-columns: auto 1fr; gap: 12px 24px; align-items: center; margin-bottom: 8px; }
.topbar-grid .left-title { grid-area: 1 / 1 / 2 / 2; }
.topbar-grid .right-clock { grid-area: 1 / 2 / 2 / 3; justify-self: end; display:flex; align-items:center; gap:16px; } 
.topbar-grid .left-tabs { grid-area: 2 / 1 / 3 / 3; }

@media (min-width: 768px) {
    .topbar-grid { grid-template-columns: auto 1fr auto; }
    .topbar-grid .left-title { grid-area: 1 / 1 / 2 / 2; }
    .topbar-grid .right-clock { grid-area: 1 / 2 / 2 / 3; }
    .topbar-grid .left-tabs { grid-area: 2 / 1 / 3 / 4; display: flex; justify-content: space-between; align-items: center; }
}

/* Login View */
#login-center { display: none; }
body.login:not(.auto-login) #login-center {
  display: flex !important; 
  flex-direction: column; 
  align-items: center; 
  justify-content: center; 
  min-height: 85vh;
}
body.login #dash-topbar, body.login #mainTabs, body.login .tab-pane { display: none !important; }
.login-card { background: rgba(255,255,255,0.95); padding: 48px 60px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.8); text-align: center; backdrop-filter: blur(8px); }

/* Cards & Lists */
.veh-list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
@media (max-width: 768px) { .veh-list { grid-template-columns: 1fr; } }

.single-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 12px; margin-top: 12px; }

.veh-card, .indiv-card { 
  background:#fff; border-radius:12px; border:1px solid var(--border); padding:16px; 
  box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
  transition: all 0.2s ease;
}

.indiv-card { cursor: pointer !important; }
.indiv-card:hover { border-color: var(--primary-600); transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
.veh-title-main{font-weight:700;font-size:1.25rem;}

/* ä¸‰æ¬„å¼æ’ç‰ˆ */
.step-row {
  display: grid;
  grid-template-columns: 38% 32% 30%;
  align-items: center;
  gap: 4px;
  padding: 6px 0;
  border-bottom: 1px dashed var(--gray-200);
}
.step-row:last-child { border-bottom: none; }

/* ç‰¹æ®Šé¡è‰²æ¨™ç¤º (æ©˜è‰²) */
.step-row.alt-group {
  background-color: var(--alt-bg);
  margin: 0 -16px; padding: 6px 16px;
  border-bottom: 1px solid rgba(249, 115, 22, 0.2);
  border-left: 4px solid var(--alt-600);
}
.stat-card.alt-group-card {
    border-color: var(--alt-600);
    background-color: var(--alt-bg);
}
.stat-card.alt-group-card .stat-head { color: #c2410c; }

.step-label { font-weight: 600; color: var(--text); text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
.step-middle { display: flex; justify-content: center; align-items: center; text-align: center; }
.btn-group { display: flex; justify-content: flex-end; gap: 4px; }

.step-time{ font-family: monospace; font-weight: 600; color: var(--primary-600); font-size: 1rem; }
.step-select { width: 100%; padding: 6px 2px; border-radius: 6px; border: 1px solid var(--border); background: #fff; font-size: 14px; text-align: center; }

.btn{ border:0;border-radius:6px;padding:6px 12px; color:#fff;font-weight:500;cursor:pointer; transition:.2s; }
.btn:hover{ filter: brightness(1.1); }
.btn--primary{background:var(--primary-600);}
.btn--success{background:#22c55e;}
.btn--danger{background:#ef4444;}
.btn--warning{background: var(--alt-600);} 
.btn--warning:hover{background: #ea580c;}
.btn--secondary{background:#fff;color:var(--primary-600);border:1px solid var(--border);} 
.btn--sm{ padding: 4px 10px; font-size: 13px; }
.btn[disabled] { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

/* Dashboard Stats */
.stat-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-top: 10px;}
.stat-card{ border:1px solid var(--border); border-radius:12px; background:#fff; padding:12px; text-align: center; }
.stat-head{ font-weight:700; margin-bottom:8px; }
.stat-row{ display:flex; gap:8px; justify-content: center; }

.stat-pill { 
  flex: 1; padding: 4px; cursor: pointer; 
  background: transparent; border: none; 
  transition: all 0.2s; 
}
.stat-pill:hover { transform: scale(1.1); }

.stat-num{ font-size: 28px; font-weight: 800; line-height: 1; }
.stat-num.done{ color:#2563eb; }
.stat-num.todo{ color:#ef4444; }
.stat-label{ font-size: 13px; color: var(--text-muted); margin-top: 4px; font-weight: 600; }

.loc-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-top:16px; margin-bottom:16px; }
.loc-pill{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; display:flex; flex-direction:column; align-items:center; cursor:pointer; position: relative; overflow: hidden; }
.loc-pill:hover { border-color: var(--primary-600); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
.loc-name{ font-weight:700; font-size: 15px; }
.loc-num{ font-size:32px; font-weight:900; color:#2563eb; margin: 4px 0; }

/* Modal */
.modal-backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); z-index: 9998; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 24px; border-radius: 16px; min-width: 320px; max-width: 90vw; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 9999; max-height: 90vh; overflow-y: auto; }
.modal .dash-close{ position:absolute; right:16px; top:16px; font-size:24px; color: var(--gray-400); cursor:pointer; }
.notif{position:fixed;right:16px;bottom:16px;background:#1f2937;color:#fff;padding:10px 14px;border-radius:14px;opacity:0;transition:.2s;z-index:10000;}
.notif.show{opacity:1;transform:translateY(-10px);}
#loading.loading{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); z-index: 10000; }
#loading.loading.show{ display: flex; }
.spinner{ width:30px; height:30px; border:3px solid var(--gray-200); border-top-color: var(--primary-600); border-radius: 50%; animation: spin .8s linear infinite; }
@keyframes spin{ to{ transform: rotate(360deg); } }

.list-item { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 8px 0; border-bottom: 1px dashed var(--border); }
.detail-table{ width:100%; border-collapse:collapse; margin-top:8px; }
.detail-table th, .detail-table td{ border:1px solid var(--border); padding:8px 10px; text-align:center; }
.detail-table th{ background:var(--primary-600); color:#fff; }
.single-line { text-align: center; margin-bottom: 6px; }

/* =========== Dark Mode Overrides =========== */
body.dark .veh-card, 
body.dark .indiv-card,
body.dark .stat-card,
body.dark .loc-pill {
  background: var(--surface);
  border-color: var(--border);
}

body.dark .login-card {
  background: rgba(30, 41, 59, 0.9);
  border-color: var(--border);
  box-shadow: 0 20px 40px rgba(0,0,0,0.5);
}
body.dark .login-card h1 { color: #60a5fa; }
body.dark .login-card p { color: #94a3b8; }

body.dark .step-row { border-bottom-color: var(--border); }

/* Orange/Alt Group in Dark Mode */
body.dark .step-row.alt-group {
  background-color: rgba(124, 45, 18, 0.2);
  border-bottom-color: rgba(234, 88, 12, 0.3);
  border-left-color: #ea580c;
}
body.dark .stat-card.alt-group-card {
  background-color: rgba(124, 45, 18, 0.2);
  border-color: #ea580c;
}
body.dark .stat-card.alt-group-card .stat-head { color: #fb923c; }

/* Inputs & Controls */
body.dark .step-select {
  background: var(--surface);
  color: var(--text);
  border-color: var(--border);
}
body.dark .step-select option { background: #0f172a; }

body.dark .seg-group { background: rgba(15, 23, 42, 0.6); border-color: var(--border); }
body.dark .seg-btn { color: var(--text-muted); }
body.dark .seg-btn.active { background: var(--surface); color: #60a5fa; box-shadow: none; border: 1px solid var(--border); }
body.dark .seg-btn:hover { color: var(--text-strong); }

/* Tabs */
body.dark .main-tab { color: var(--text-muted); border-color: var(--border); background: transparent; }
body.dark .main-tab.active { color: #fff; border-color: var(--primary-600); background: var(--primary-600); }

body.dark .btn-tab.colored-btn { background: transparent; border-color: var(--border); color: var(--text-muted); }
body.dark .btn-tab.colored-btn.active { background: var(--theme-color); border-color: var(--theme-color); color: #fff; }

/* Modal */
body.dark .modal { background: #1e293b; border: 1px solid var(--border); color: var(--text-strong); }
body.dark .list-item { border-bottom-color: var(--border); }

/* Table */
body.dark .detail-table th { background: #1e3a8a; border-color: var(--border); }
body.dark .detail-table td { border-color: var(--border); }
</style>
</head>
<body class="login">

<div class="wrap">
  <!-- Login -->
  <div id="login-center">
    <div class="login-card">
      <h1 style="margin:0; color:#1f6fe5; font-size:32px;">è»Šæµäººæµé€€å ´æƒ…å ±</h1>
      <p style="margin:16px 0 32px; color:#64748b;">è«‹ç™»å…¥ä»¥ç¹¼çºŒä½¿ç”¨ç³»çµ±</p>
      <div id="signin"></div>
    </div>
  </div>

  <!-- Topbar -->
  <div class="topbar-grid" id="dash-topbar">
    <div class="left-title"><h1 id="pageTitle">è»Šæµäººæµé€€å ´æƒ…å ±</h1></div>
    <div class="right-clock">
        <div class="clock" id="clockDisplay">--:--:--</div>
        <div id="userInfo" class="hide" style="font-size: 14px; text-align: right;">
           <span id="userDisplay"></span>
           <button id="logoutBtn" class="btn btn--secondary btn--sm" style="margin-left: 8px;">ç™»å‡º</button>
        </div>
    </div>
    <div class="left-tabs">
        <div class="tab-container-styled">
            <button class="main-tab active" data-target="pane-dashboard2">æœ€æ–°ç‹€æ…‹</button>
            <button class="main-tab" data-target="pane-single">å€‹åˆ¥æƒ…å ±</button>
            <button class="main-tab" data-target="pane-punch">ç™»éŒ„èˆ‡ä¿®æ”¹</button>
        </div>
        <div class="refresh-bar">
             <div class="seg-group" id="refreshControls"></div>
        </div>
    </div>
  </div>

  <!-- Content -->
  <div id="mainTabs" class="hide"></div>

  <!-- Pane 1: Punch -->
  <div id="pane-punch" class="tab-pane hide">
    <div style="margin: 16px 0;">
      <div class="tab-container-styled" id="sheetTabs"></div>
    </div>
    <div id="content" class="hide"> <!-- Default hidden -->
      <div id="vehList" class="veh-list"></div>
    </div>
  </div>

  <!-- Pane 2: Dashboard -->
  <div id="pane-dashboard2" class="tab-pane hide">
    <div style="margin: 16px 0;">
        <div class="tab-container-styled" id="dashboardTabs2"></div>
    </div>
    <div id="dashboard2"></div>
  </div>

  <!-- Pane 3: Single -->
  <div id="pane-single" class="tab-pane hide">
    <div class="card" id="singleControlsCard">
      <div class="single-controls" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="selSheet" class="step-select" style="flex:1"><option value="">â€” å…¨éƒ¨ Tab â€”</option></select>
        <select id="selArea" class="step-select" style="flex:1"><option value="">â€” å…¨éƒ¨ å€åŸŸè»Šæ¬¡ç·¨è™Ÿ â€”</option></select>
        <select id="selCar" class="step-select" style="flex:1"><option value="">â€” å…¨éƒ¨ è»Šè™Ÿ â€”</option></select>
      </div>
      <div class="single-actions" style="margin-top: 12px; text-align: right;">
        <button id="btnQuery" class="btn btn--primary">æŸ¥è©¢</button>
        <button id="btnReset" class="btn btn--secondary">å…¨éƒ¨é‡è¨­</button>
      </div>
    </div>
    <div id="singleResults" class="single-list"></div>
  </div>
</div>

<div id="notif" class="notif"></div>
<div id="loading" class="loading"><div class="spinner"></div></div>

<script>
/* ============ CONFIG ============ */
const GOOGLE_CLIENT_ID = '368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const API_BASE = 'https://script.google.com/macros/s/AKfycbyet306bK0Tufby0083U05rZS_DwswPD62YQIMIjT154irK_nS1n9Iuf2TEZvnXjmUgGw/exec';
const SHEET_CONFIGS = [
  { 
    key:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰', 
    sheet:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰', 
    colorClass: 'theme-teal', 
    steps:[
      'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š','Call è»Šä¸Šè¡Œæ','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå‰å¾€æ’è»ŠéšŠ','è»Šæš«åœä½ç½®',
      'é€€å ´äººå“¡å·²åˆ°é½Š','å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°','äººå·²å‰å¾€å¹³å°','è»Šç¬¬äºŒæ¬¡ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
    ],
    // æ¨™ç¤ºéä¸»è¦æ“ä½œçš„æ­¥é©Ÿ (ç¬¬äºŒçµ„ - æ©˜è‰²)
    secondarySteps: ['é€€å ´äººå“¡å·²åˆ°é½Š','äººå·²å‰å¾€å¹³å°']
  },
  { 
    key:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰', 
    sheet:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰', 
    colorClass: 'theme-orange', 
    steps:[
      'è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š','Call è»Šä¸Šè¡Œæ','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå‰å¾€æ’è»ŠéšŠ','è»Šæš«åœä½ç½®',
      'äººå·²å‰å¾€ç¦ªå ‚å¹³å°','è»Šå·²é›¢é–‹ç¦ªå ‚å¹³å°'
    ],
    // æ¨™ç¤ºéä¸»è¦æ“ä½œçš„æ­¥é©Ÿ (ç¬¬äºŒçµ„ - æ©˜è‰²)
    secondarySteps: ['äººå·²å‰å¾€ç¦ªå ‚å¹³å°','è»Šå·²é›¢é–‹ç¦ªå ‚å¹³å°']
  },
  { 
    key:'æ°´é™¸å°ˆè»Šé€€å ´', 
    sheet:'æ°´é™¸å°ˆè»Šé€€å ´', 
    colorClass: 'theme-purple', 
    steps:[
      'å·² Call è»Šæ’è»ŠéšŠ','å·²æ’å¥½è»ŠéšŠ','è»Šæš«åœä½ç½®',
      'é€€å ´äººå“¡å·²åˆ°é½Š','å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','äººå·²å‰å¾€å¹³å°','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'
    ],
    // æ¨™ç¤ºéä¸»è¦æ“ä½œçš„æ­¥é©Ÿ (ç¬¬äºŒçµ„ - æ©˜è‰²)
    secondarySteps: ['é€€å ´äººå“¡å·²åˆ°é½Š','äººå·²å‰å¾€å¹³å°']
  },
  { 
    key:'288æ³•é’é€€å ´', 
    sheet:'288æ³•é’é€€å ´', 
    colorClass: 'theme-pink', 
    steps:[
      'é€€å ´äººå“¡å·²åˆ°é½Š','è»Šå·²ç¶“ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²ç¶“é›¢é–‹éŠè¦½è»Šå¹³å°'
    ],
    // å…¨éƒ¨éƒ½æ˜¯ä¸»è¦æ“ä½œ (è—è‰²)
    secondarySteps: []
  }
];

const STOP_OPTIONS = ['ğŸ…¿ï¸ ç¦ªå ‚å¹³å°','ğŸ…¿ï¸ æ³•å¿ƒåŒ—è·¯','ğŸ…¿ï¸ æ³•å¿ƒå—è·¯ï¼ˆè¥¿ï¼‰','ğŸ…¿ï¸ æ³•å¿ƒå—è·¯ï¼ˆæ±ï¼‰','ğŸ…¿ï¸ ç¦ªå ‚å¹³å°'];
const REFRESH_PRESETS = [{ label:'5åˆ†', ms:300000 }, { label:'2åˆ†', ms:120000 }, { label:'60ç§’', ms:60000 }, { label:'30ç§’', ms:30000 }];

let currentUser = null;
let idToken = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let currentDashFilter2 = 'ALL';
let dashTimer = null;
let ALL_SHEETS = {};
let SINGLE_ITEMS = [];
let refreshMs = 120000;
// â˜…â˜…â˜… NEW: å¿«å–æ™‚é–“æˆ³è¨˜ â˜…â˜…â˜…
let lastFetchTime = 0;

/* ============ HELPER FUNCTIONS ============ */
function showLoading(){ document.getElementById('loading').classList.add('show'); }
function hideLoading(){ document.getElementById('loading').classList.remove('show'); }
async function withLoading(fn){ showLoading(); try{ await fn(); }finally{ hideLoading(); } }
function showNotif(m,e){ const b=document.getElementById('notif'); b.textContent=m; b.className='notif show'; b.style.background=e?'#ef4444':'#1f2937'; setTimeout(()=>b.className='notif',3000); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
function getTaipeiHHMMSS(){ return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date()); }
function formatSheetTime(v){ if(v&&v.includes('T')) return new Date(v).toLocaleTimeString('zh-TW',{hour12:false}); return v; }

/* ============ DATA PARSER (SMART) ============ */
function parseSheetData(values, cfg) {
    if (!values || values.length === 0) return null;
    
    let headIdx = -1;
    for (let i = 0; i < Math.min(values.length, 10); i++) {
        const rowStr = values[i].join(' ').toLowerCase();
        if (rowStr.includes('è»Šè™Ÿ') || rowStr.includes('ç·¨è™Ÿ')) {
            headIdx = i;
            break;
        }
    }
    if (headIdx === -1) return null; 
    
    const header = values[headIdx].map(s => String(s).trim());
    
    let areaIdx = header.findIndex(c => c.includes('å€åŸŸ'));
    if (areaIdx === -1) areaIdx = header.findIndex(c => c.includes('ç·¨è™Ÿ')); 
    const carIdx = header.findIndex(c => c.includes('è»Šè™Ÿ'));
    
    const validItems = [];
    
    for(let i = headIdx + 1; i < values.length; i++) {
        const row = values[i];
        // â˜…â˜…â˜… ä¿®æ­£: åœ¨ Parse éšæ®µå°±è™•ç† area/carï¼Œæ¸›å°‘é‡è¤‡æ“ä½œ â˜…â˜…â˜…
        const area = String(row[areaIdx] || '').trim();
        const car = String(row[carIdx] || '').trim();
        
        if (area && car) {
            let completed = 0;
            cfg.steps.forEach(st => {
                const colIdx = header.indexOf(st);
                const val = (colIdx !== -1) ? String(row[colIdx]||'').trim() : '';
                if(val && val !== 'â€”') completed++;
            });

            validItems.push({
                data: row,
                rowIndex: i + 1, 
                areaIdx,
                carIdx,
                area, // New: é å­˜å€åŸŸ
                car,  // New: é å­˜è»Šè™Ÿ
                completed 
            });
        }
    }
    
    return { 
        cfg, 
        header, 
        rows: validItems, 
        headIdx,
        areaIdx, 
        carIdx 
    };
}

/* ============ UI CREATORS ============ */
function createBtn(text, cls, onClick){
    const b = document.createElement('button'); b.className=cls; b.textContent=text; b.addEventListener('click', onClick); return b;
}
function createPill(num, label, type, onClick){
    const div = document.createElement('div');
    div.className = 'stat-pill';
    div.innerHTML = `<div class="stat-num ${type}">${num}</div><div class="stat-label">${label}</div>`;
    div.addEventListener('click', onClick);
    return div;
}

function startClock(){
  const el = document.getElementById('clockDisplay');
  // â˜…â˜…â˜… ä¿®æ­£ï¼šä½¿ç”¨ getTaipeiHHMMSS() çµ±ä¸€æ™‚å€é¡¯ç¤º â˜…â˜…â˜…
  if(el) setInterval(() => { el.textContent = getTaipeiHHMMSS(); }, 1000);
}

function buildRefreshControls(){
  const box = document.getElementById('refreshControls'); if(!box) return;
  box.innerHTML = '';
  REFRESH_PRESETS.forEach(p=>{
    const btn = createBtn(p.label, 'seg-btn', ()=>{ refreshMs=p.ms; updateRefreshButtonsUI(); if(isDashboardVisible()) startDashboardAutoRefresh(); });
    btn.dataset.ms = p.ms; box.appendChild(btn);
  });
  // â˜…â˜…â˜… FIX: ç«‹å³æ›´æ–°æŒ‰éˆ•å¢åŠ é»æ“Šè¦–è¦ºå›é¥‹ï¼Œä¸¦å¼·åˆ¶æ›´æ–°(force=true) â˜…â˜…â˜…
  const nowBtn = createBtn('ç«‹å³æ›´æ–°','seg-btn now-btn', (e)=>{ 
      const btn = e.target.closest('button') || e.target;
      btn.classList.add('active');
      setTimeout(() => btn.classList.remove('active'), 200);
      buildDashboard2(true, true); // Force Refresh
      showNotif('å·²æ›´æ–°',false); 
  });
  box.appendChild(nowBtn);
}
function updateRefreshButtonsUI(){
    document.querySelectorAll('#refreshControls .seg-btn').forEach(b => { if(!b.classList.contains('now-btn')) b.classList.toggle('active', parseInt(b.dataset.ms)===refreshMs); });
}

/* ============ NAVIGATION ============ */
function switchPane(targetId){
  if(!currentUser) return;
  
  document.querySelectorAll('.tab-container-styled .main-tab').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.target === targetId);
  });
  document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hide'));
  const target = document.getElementById(targetId);
  if(target) target.classList.remove('hide');

  const refreshBar = document.querySelector('.refresh-bar');
  if(refreshBar) refreshBar.style.display = (targetId === 'pane-dashboard2') ? 'flex' : 'none';

  if(targetId === 'pane-dashboard2'){
      if(!document.getElementById('dashboardTabs2').hasChildNodes()) buildDashboardTabs2();
      buildDashboard2(false); // force=false by default, so it uses cache
      startDashboardAutoRefresh();
  } 
  else if (targetId === 'pane-punch') {
      stopDashboardAutoRefresh();
      buildTabs();
      loadSheetData(currentSheetKey);
  } 
  else if (targetId === 'pane-single') {
      stopDashboardAutoRefresh();
      if(SINGLE_ITEMS.length === 0) loadSingleData();
      else rebuildSelectOptions();
  } 
  else {
      stopDashboardAutoRefresh();
  }
}

function isDashboardVisible(){ return !document.getElementById('pane-dashboard2').classList.contains('hide'); }
function startDashboardAutoRefresh(){ stopDashboardAutoRefresh(); dashTimer = setInterval(()=> { if(isDashboardVisible()) buildDashboard2(true); }, refreshMs); }
function stopDashboardAutoRefresh(){ clearInterval(dashTimer); }

/* ============ AUTH ============ */
function initGoogleSignIn() {
    document.body.classList.add('login');
    const d = document.getElementById('signin'); 
    if(d) {
        d.innerHTML='';
        google.accounts.id.initialize({ client_id: GOOGLE_CLIENT_ID, callback: (r)=>{ idToken=r.credential; localStorage.setItem('ddcc_user_token',idToken); location.reload(); } });
        google.accounts.id.renderButton(d, { theme:'outline', size:'large', shape:'pill', width: 250 });
    }
}
function finishLoginUI(){
    document.body.classList.remove('login');
    document.getElementById('userInfo').classList.remove('hide');
    document.getElementById('userDisplay').textContent = `${currentUser.name} (${currentUser.permission})`;
    switchPane('pane-dashboard2');
}
function logout(){ localStorage.removeItem('ddcc_user_token'); location.reload(); }

/* ============ API ============ */
async function fetchSheetData(cfg){
    const r = await fetch(API_BASE + `?action=get&sheet=${encodeURIComponent(cfg.sheet)}&idToken=${idToken}`);
    const j = await r.json();
    return { key:cfg.key, cfg, values:j.values||[] };
}
async function doUpdate(cfg, row, col, value, callback){
    await withLoading(async()=>{
        await fetch(API_BASE+'?action=update', {method:'POST', body:JSON.stringify({sheet:cfg.sheet, idToken, writes:[{row, col, value}]})});
        if(callback) await callback();
    });
}

/* ============ DASHBOARD ============ */
function buildDashboardTabs2(){
  const box = document.getElementById('dashboardTabs2'); box.innerHTML = '';
  const allBtn = createBtn('æ‰€æœ‰è»Šè¼›', 'btn-tab active', () => onDashTabClick(allBtn, 'ALL'));
  box.appendChild(allBtn);
  SHEET_CONFIGS.forEach(cfg => {
    const btn = createBtn(cfg.key, `btn-tab colored-btn ${cfg.colorClass||''}`, () => onDashTabClick(btn, cfg.key));
    box.appendChild(btn);
  });
}
function onDashTabClick(btn, key) {
    if (currentDashFilter2 === key) return;
    currentDashFilter2 = key;
    document.getElementById('dashboardTabs2').querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    buildDashboard2(false); // force=false, allows cache
}
// â˜…â˜…â˜… NEW: å¢åŠ  force åƒæ•¸ä»¥æ”¯æ´å¿«å–é‚è¼¯ â˜…â˜…â˜…
async function buildDashboard2(silent, force = false){
    // å¿«å–æª¢æŸ¥ï¼šå¦‚æœä¸å¼·åˆ¶æ›´æ–°ï¼Œä¸”è·é›¢ä¸Šæ¬¡å°æ–¼4ç§’ï¼Œä¸”å·²æœ‰è³‡æ–™
    if(!force && (Date.now() - lastFetchTime < 4000) && Object.keys(ALL_SHEETS).length > 0) {
        console.log('Using Cache');
        renderDashboardUI();
        if(!silent) hideLoading();
        return;
    }

    if(!silent) showLoading();
    const dash = document.getElementById('dashboard2');
    try {
        const requests = SHEET_CONFIGS.map(cfg => fetchSheetData(cfg));
        const results = await Promise.all(requests);
        ALL_SHEETS = {}; // Clear AFTER deciding to fetch
        results.forEach(res => {
            const parsed = parseSheetData(res.values, res.cfg);
            if(parsed) ALL_SHEETS[res.key] = parsed;
        });
        dash.innerHTML = '';
        renderDashboardUI();
        lastFetchTime = Date.now(); // Update timestamp
    } catch(e) { console.error(e); }
    if(!silent) hideLoading();
}
function renderDashboardUI(){
    const container = document.getElementById('dashboard2');
    container.innerHTML = ''; // Ensure clean slate
    SHEET_CONFIGS.forEach(cfg => {
        if(currentDashFilter2 !== 'ALL' && currentDashFilter2 !== cfg.key) return;
        const data = ALL_SHEETS[cfg.key];
        if(!data || !data.rows.length) return;

        const section = document.createElement('section'); section.className = 'card';
        section.style.borderTop = `4px solid var(--primary-600)`;
        if(cfg.colorClass === 'theme-teal') section.style.borderTopColor = '#059669';
        if(cfg.colorClass === 'theme-orange') section.style.borderTopColor = '#d97706';
        if(cfg.colorClass === 'theme-purple') section.style.borderTopColor = '#7c3aed';
        if(cfg.colorClass === 'theme-pink') section.style.borderTopColor = '#db2777';

        const title = document.createElement('h3'); title.textContent = cfg.key; title.style.margin = '0 0 16px 0';
        section.appendChild(title);

        // â˜… æ‹†åˆ†é€²å ´èˆ‡é€€å ´æ­¥é©Ÿ â˜…
        const steps = cfg.steps;
        const stopIdx = steps.indexOf('è»Šæš«åœä½ç½®');
        
        const inboundSteps = stopIdx >= 0 ? steps.slice(0, stopIdx) : steps; // é€²å ´
        const outboundSteps = stopIdx >= 0 ? steps.slice(stopIdx + 1) : []; // é€€å ´ (æ’é™¤è»Šæš«åœä½ç½®)

        // 1. æ¸²æŸ“é€²å ´ (Top)
        if(inboundSteps.length > 0) {
            const grid = document.createElement('div'); grid.className = 'stat-grid';
            inboundSteps.forEach(step => renderStatCard(step, data, grid, cfg));
            section.appendChild(grid);
        }

        // 2. æ¸²æŸ“åœè»Šä½ç½® (Middle)
        if(stopIdx >= 0) {
            const stopColIdx = data.header.indexOf('è»Šæš«åœä½ç½®');
            const locWrap = document.createElement('div'); locWrap.className = 'loc-grid'; 
            
            const counter = new Map(); STOP_OPTIONS.forEach(n => counter.set(n, 0));
            data.rows.forEach(item => { 
                const r = item.data;
                const v = String(r[stopColIdx] || '').trim(); 
                if(counter.has(v)) counter.set(v, counter.get(v)+1); 
            });
            
            STOP_OPTIONS.forEach(name => {
                const pill = document.createElement('div'); pill.className = 'loc-pill';
                pill.innerHTML = `<div class="loc-name">${name}</div><div class="loc-num">${counter.get(name)||0}</div><div class="stat-label">å°</div>`;
                pill.addEventListener('click', () => openListModal2(cfg.key, 'è»Šæš«åœä½ç½®', 'loc', name));
                locWrap.appendChild(pill);
            });
            section.appendChild(locWrap);
        }

        // 3. æ¸²æŸ“é€€å ´ (Bottom)
        if(outboundSteps.length > 0) {
            const grid = document.createElement('div'); grid.className = 'stat-grid';
            // grid.style.marginTop = '16px'; // ç¨å¾®åˆ†é–‹
            outboundSteps.forEach(step => renderStatCard(step, data, grid, cfg));
            section.appendChild(grid);
        }

        container.appendChild(section);
    });
}

// è¼”åŠ©å‡½å¼ï¼šæ¸²æŸ“å–®å€‹çµ±è¨ˆå¡ç‰‡
function renderStatCard(step, data, container, cfg) {
    const colIdx = data.header.indexOf(step);
    let done=0, todo=0;
    data.rows.forEach(item => { 
        const r = item.data;
        // â˜…â˜…â˜… ä¿®æ­£: Dashboard çµ±è¨ˆä¹Ÿè¦ trimï¼Œé¿å…æ•¸æ“šä¸ä¸€è‡´ â˜…â˜…â˜…
        const v = colIdx>=0 ? String(r[colIdx]||'').trim() : ''; 
        (v && v !== 'â€”') ? done++ : todo++; 
    });

    // åˆ¤æ–·æ˜¯å¦ç‚ºç¬¬äºŒçµ„ (è®Šè‰²)
    const isSecondary = cfg.secondarySteps.includes(step);

    const card = document.createElement('div'); 
    card.className = isSecondary ? 'stat-card alt-group-card' : 'stat-card';
    
    // â˜…â˜…â˜… ä¿®æ”¹ï¼šæ–¹æ¡†å»èƒŒ â˜…â˜…â˜…
    card.innerHTML = `<div class="stat-head">${step}</div><div class="stat-row"></div>`;
    const row = card.querySelector('.stat-row');
    row.appendChild(createPill(done, 'å®Œæˆ', 'done', () => openListModal2(cfg.key, step, 'done')));
    row.appendChild(createPill(todo, 'æœªå®Œæˆ', 'todo', () => openListModal2(cfg.key, step, 'todo')));
    container.appendChild(card);
}

/* ============ PUNCH PAGE ============ */
function buildTabs(){
    const box = document.getElementById('sheetTabs'); box.innerHTML = '';
    SHEET_CONFIGS.forEach(cfg => {
        const active = (cfg.key===currentSheetKey ? ' active' : '');
        const btn = createBtn(cfg.key, `btn-tab colored-btn ${cfg.colorClass||''}${active}`, () => {
            currentSheetKey = cfg.key;
            buildTabs();
            loadSheetData(cfg.key);
        });
        box.appendChild(btn);
    });
}
async function loadSheetData(key, silent = false){
  const cfg = SHEET_CONFIGS.find(s=>s.key===key);
  if (!silent) showLoading();
  
  document.getElementById('content').classList.remove('hide');

  try {
      const res = await fetchSheetData(cfg);
      const parsed = parseSheetData(res.values, cfg);
      if(!parsed) { 
          document.getElementById('vehList').textContent = 'ç„¡è³‡æ–™ (æœªåµæ¸¬åˆ°æœ‰æ•ˆè³‡æ–™)'; 
      } else {
          renderVehicles(parsed);
      }
  } catch(e) { 
      document.getElementById('vehList').textContent = 'è¼‰å…¥å¤±æ•—'; 
  } finally {
      if (!silent) hideLoading();
  }
}

function renderVehicles(data) {
  const { cfg, header, rows } = data; // areaIdx, carIdx ä¸å†éœ€è¦
  const box = document.getElementById('vehList'); box.innerHTML = '';
  if (!rows.length){ box.textContent='(ç›®å‰æ²’æœ‰è³‡æ–™)'; return; }
  const canWrite = currentUser?.permission === 'å…¨åŠŸèƒ½';

  rows.sort((a, b) => {
      if(a.completed !== b.completed) return a.completed - b.completed;
      return a.rowIndex - b.rowIndex;
  });

  rows.forEach((item) => {
    const row = item.data;
    // â˜…â˜…â˜… ä¿®æ­£ï¼šç›´æ¥è®€å–é å­˜è®Šæ•¸ â˜…â˜…â˜…
    const { area, car } = item;
    const baseRow = item.rowIndex; 
    
    const card = document.createElement('div'); card.className = 'veh-card';
    
    // â˜…â˜…â˜… Header: Grid Layout (Left: Area, Middle: Car) â˜…â˜…â˜…
    const headerRow = document.createElement('div');
    headerRow.className = 'step-row'; 
    headerRow.style.borderBottom = '2px solid var(--gray-200)'; 
    headerRow.style.marginBottom = '10px';
    headerRow.style.paddingBottom = '10px';
    headerRow.style.alignItems = 'flex-end';
    
    const areaEl = document.createElement('div');
    areaEl.className = 'step-label';
    areaEl.style.fontSize = '1.25rem'; 
    areaEl.style.fontWeight = '800';
    areaEl.style.color = 'var(--text-strong)';
    areaEl.textContent = area;
    
    const carEl = document.createElement('div');
    carEl.className = 'step-middle'; 
    carEl.style.fontSize = '1.25rem'; 
    carEl.style.fontWeight = '800';
    carEl.style.justifyContent = 'flex-start'; // é å·¦å°é½Š (å¹³è¡Œ)
    carEl.style.color = 'var(--text-strong)';
    carEl.textContent = car;
    
    const rightEl = document.createElement('div'); // ä½”ä½ç”¨
    
    headerRow.appendChild(areaEl);
    headerRow.appendChild(carEl);
    headerRow.appendChild(rightEl);
    headerRow.style.cursor = 'pointer';
    // â˜…â˜…â˜… ä¿®æ­£ï¼šå‚³å…¥é å­˜è®Šæ•¸çµ¦ Modal â˜…â˜…â˜…
    headerRow.addEventListener('click', () => openDetailModal(cfg, row, header, area, car));
    
    card.appendChild(headerRow);

    const stepsBox=document.createElement('div');
    cfg.steps.forEach(st=>{
        const colIdx = header.indexOf(st);
        const rawVal = (colIdx!==-1) ? String(row[colIdx]||'').trim(): '';
        
        const isSecondary = cfg.secondarySteps.includes(st);
        const rowEl = document.createElement('div'); 
        rowEl.className = isSecondary ? 'step-row alt-group' : 'step-row';
        
        const labelEl = document.createElement('div');
        labelEl.className = 'step-label';
        labelEl.textContent = st;
        rowEl.appendChild(labelEl);
        
        const middleEl = document.createElement('div');
        middleEl.className = 'step-middle';
        
        if (st==='è»Šæš«åœä½ç½®'){
            const sel=document.createElement('select'); sel.className='step-select';
            sel.innerHTML = '<option value="">â€” è«‹é¸æ“‡ â€”</option>' + STOP_OPTIONS.map(o=>`<option value="${o}">${o}</option>`).join('');
            if(rawVal) sel.value = rawVal;
            sel.disabled = !canWrite;
            if(canWrite) sel.addEventListener('change', () => doUpdate(cfg, baseRow, colIdx+1, sel.value, () => loadSheetData(cfg.key, true)));
            middleEl.appendChild(sel);
        } else {
            const timeSpan=document.createElement('span'); timeSpan.className='step-time'; timeSpan.textContent=rawVal?formatSheetTime(rawVal):'â€”';
            middleEl.appendChild(timeSpan);
        }
        rowEl.appendChild(middleEl);

        const btnG = document.createElement('div'); btnG.className='btn-group';
        
        if (st !== 'è»Šæš«åœä½ç½®' && canWrite) { 
             if(!rawVal) {
                const stepIdx = cfg.steps.indexOf(st);
                const prevStep = stepIdx>0 ? cfg.steps[stepIdx-1] : null;
                const prevCol = prevStep ? header.indexOf(prevStep) : -1;
                
                const prevVal = prevCol >= 0 ? String(row[prevCol] || '').trim() : '';
                // â˜…â˜…â˜… ä¿®æ­£: å¢åŠ æª¢æŸ¥ 'â€”' (ç ´æŠ˜è™Ÿ)ï¼Œé¿å…è¢«è¦–ç‚ºå®Œæˆ â˜…â˜…â˜…
                const prevDone = !prevStep || (prevVal !== '' && prevVal !== 'â€”');

                const btnClass = isSecondary ? 'btn btn--warning btn--sm' : 'btn btn--primary btn--sm';
                const btn = createBtn('æ‰“å¡', btnClass, ()=>doUpdate(cfg, baseRow, colIdx+1, getTaipeiHHMMSS(), ()=>loadSheetData(cfg.key, true)));
                
                if(!prevDone) { btn.disabled=true; btn.style.opacity=0.5; btn.title='å‰ä¸€æ­¥é©Ÿæœªå®Œæˆ'; }
                btnG.appendChild(btn);
            } else {
                const btnEdit=createBtn('ä¿®æ”¹','btn btn--success btn--sm', ()=>{
                    const nv=prompt('è¼¸å…¥æ™‚é–“',rawVal); if(nv) doUpdate(cfg, baseRow, colIdx+1, nv, ()=>loadSheetData(cfg.key, true));
                });
                const btnDel=createBtn('åˆªé™¤','btn btn--danger btn--sm', ()=>{
                    if(confirm('åˆªé™¤?')) doUpdate(cfg, baseRow, colIdx+1, '', ()=>loadSheetData(cfg.key, true));
                });
                btnG.appendChild(btnEdit); btnG.appendChild(btnDel);
            }
        }
        rowEl.appendChild(btnG);

        stepsBox.appendChild(rowEl);
    });
    card.appendChild(stepsBox);
    box.appendChild(card);
  });
}

/* ============ MODAL LIST ============ */
function openListModal2(sheetKey, step, type, locValue) {
    const data = ALL_SHEETS[sheetKey];
    if(!data) return;
    const list = [];
    const colIdx = data.header.indexOf(step);
    
    if(type==='loc'){
        const c = data.header.indexOf('è»Šæš«åœä½ç½®');
        data.rows.forEach(item => { if(String(item.data[c]||'').trim() === locValue) list.push(item); });
    } else {
        data.rows.forEach(item => { 
            const v = colIdx>=0 ? String(item.data[colIdx]||'').trim() : ''; 
            const ok = (v && v !== 'â€”' && v !== ''); 
            if((type==='done'&&ok)||(type==='todo'&&!ok)) list.push(item); 
        });
    }
    
    const box = document.createElement('div'); box.className = 'modal';
    const title = `${sheetKey} - ${step} (${type==='loc'?locValue:(type==='done'?'å®Œæˆ':'æœªå®Œæˆ')})`;
    box.innerHTML = `<div class="dash-close">âœ•</div><h3>${title}</h3><div style="max-height:60vh;overflow:auto" id="mList"></div>`;
    
    box.querySelector('.dash-close').onclick = () => { 
        box.remove(); 
        const bg = document.querySelector('.modal-backdrop');
        if(bg) bg.remove();
    };

    const c = box.querySelector('#mList');
    if(!list.length) c.innerHTML='<div style="text-align:center;opacity:0.5">ç„¡è³‡æ–™</div>';
    
    const canWrite = currentUser?.permission === 'å…¨åŠŸèƒ½';

    list.forEach(item => {
        const r = item.data;
        // â˜…â˜…â˜… ä¿®æ­£ï¼šä½¿ç”¨é å­˜è®Šæ•¸ â˜…â˜…â˜…
        const { area, car } = item;
        const d = document.createElement('div'); d.className='list-item';
        d.innerHTML = `<div class="list-left"><div class="list-title">${area} ${car}</div></div>`;
        
        const btnGroup = document.createElement('div');
        btnGroup.style.display='flex'; btnGroup.style.gap='8px';

        if(type === 'todo' && step !== 'è»Šæš«åœä½ç½®' && canWrite) {
             const stepIdx = data.cfg.steps.indexOf(step);
             const prevStep = stepIdx>0 ? data.cfg.steps[stepIdx-1] : null;
             const prevCol = prevStep ? data.header.indexOf(prevStep) : -1;
             
             const prevVal = prevCol >= 0 ? String(r[prevCol] || '').trim() : '';
             // â˜…â˜…â˜… ä¿®æ­£: å¢åŠ æª¢æŸ¥ 'â€”' (ç ´æŠ˜è™Ÿ) â˜…â˜…â˜…
             const prevDone = !prevStep || (prevVal !== '' && prevVal !== 'â€”');
             
             const btnPunch = createBtn('æ‰“å¡', 'btn btn--primary btn--sm', async () => {
                 await doUpdate(data.cfg, item.rowIndex, colIdx+1, getTaipeiHHMMSS(), async () => {
                      box.remove(); 
                      const bg = document.querySelector('.modal-backdrop');
                      if(bg) bg.remove();
                      await buildDashboard2(true);
                 });
             });
             
             if(!prevDone) { btnPunch.disabled=true; btnPunch.style.opacity=0.5; btnPunch.title='å‰ä¸€æ­¥é©Ÿæœªå®Œæˆ'; }
             btnGroup.appendChild(btnPunch);
        }

        const bDetail = createBtn('è©³ç´°', 'btn btn--secondary btn--sm', ()=>openDetailModal(data.cfg, r, data.header, area, car));
        btnGroup.appendChild(bDetail);
        d.appendChild(btnGroup);
        c.appendChild(d);
    });
    
    if (step === 'è»Šæš«åœä½ç½®' && type === 'loc' && currentUser?.permission === 'å…¨åŠŸèƒ½') {
        const stepIdx = data.cfg.steps.indexOf(step);
        const prevStep = stepIdx > 0 ? data.cfg.steps[stepIdx - 1] : null;
        
        if (prevStep) {
            const prevColIdx = data.header.indexOf(prevStep);
            const stopColIdx = data.header.indexOf(step);
            
            const candidates = data.rows.filter(item => {
                const r = item.data;
                const prevVal = String(r[prevColIdx] || '').trim();
                const stopVal = String(r[stopColIdx] || '').trim();
                return (prevVal !== '' && prevVal !== 'â€”') && (stopVal === '' || stopVal === 'â€”');
            });

            const addSection = document.createElement('div');
            addSection.style.marginTop = '20px';
            addSection.style.paddingTop = '15px';
            addSection.style.borderTop = '1px solid #eee';
            
            if (candidates.length > 0) {
                addSection.innerHTML = `<div style="font-weight:bold; margin-bottom:8px;">æ–°å¢è»Šè¼›è‡³ ${locValue}</div>`;
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.gap = '8px';
                
                const sel = document.createElement('select');
                sel.className = 'step-select'; 
                sel.style.flex = '1';
                sel.innerHTML = '<option value="">è«‹é¸æ“‡è»Šè¼›...</option>';
                
                candidates.forEach(c => {
                    // â˜…â˜…â˜… ä¿®æ­£ï¼šä½¿ç”¨é å­˜è®Šæ•¸ â˜…â˜…â˜…
                    const opt = document.createElement('option');
                    opt.value = c.rowIndex; 
                    opt.textContent = `${c.area} ${c.car}`;
                    sel.appendChild(opt);
                });
                
                const btnAdd = createBtn('ç¢ºå®š', 'btn btn--primary btn--sm', async () => {
                    if(!sel.value) return;
                    const targetRowIndex = parseInt(sel.value);
                    await doUpdate(data.cfg, targetRowIndex, stopColIdx + 1, locValue, async () => {
                        box.remove(); 
                        const bg = document.querySelector('.modal-backdrop');
                        if(bg) bg.remove();
                        await buildDashboard2(true); 
                    });
                });
                
                row.appendChild(sel);
                row.appendChild(btnAdd);
                addSection.appendChild(row);
            } else {
                 const noCand = document.createElement('div');
                 noCand.style.fontSize = '0.9rem';
                 noCand.style.color = '#999';
                 noCand.textContent = `(ç„¡å¯æ–°å¢è»Šè¼› - éœ€å®Œæˆã€Œ${prevStep}ã€)`;
                 addSection.appendChild(noCand);
            }
            box.appendChild(addSection);
        }
    }
    
    openModal(box);
}

/* ============ SINGLE PAGE ============ */
async function loadSingleData(silent=false){
  if(!silent) showLoading();
  SINGLE_ITEMS = [];
  try {
      const requests = SHEET_CONFIGS.map(cfg => fetchSheetData(cfg));
      const results = await Promise.all(requests);
      results.forEach(res => {
          const parsed = parseSheetData(res.values, res.cfg);
          if(parsed) {
              parsed.rows.forEach(item => {
                  SINGLE_ITEMS.push({ 
                      sheetKey: res.key, cfg: res.cfg, 
                      header: parsed.header, 
                      row: item.data, 
                      // â˜…â˜…â˜… ä¿®æ­£ï¼šè½‰å­˜é å­˜è®Šæ•¸ â˜…â˜…â˜…
                      area: item.area, 
                      car: item.car,
                      areaIdx: parsed.areaIdx, carIdx: parsed.carIdx 
                  });
              });
          }
      });
      fillSheetOptions();
      rebuildSelectOptions();
  } catch(e) { console.error(e); }
  if(!silent) hideLoading();
}
function fillSheetOptions(){
  const sel = document.getElementById('selSheet');
  sel.innerHTML = '<option value="">â€” å…¨éƒ¨ Tab â€”</option>' + SHEET_CONFIGS.map(s=>`<option value="${s.key}">${s.key}</option>`).join('');
}
function rebuildSelectOptions(){
  const sheetVal = document.getElementById('selSheet').value;
  const areaVal = document.getElementById('selArea').value;
  const carVal = document.getElementById('selCar').value;
  // â˜…â˜…â˜… ä¿®æ­£ï¼šä½¿ç”¨é å­˜è®Šæ•¸ç¯©é¸ â˜…â˜…â˜…
  const filtered = SINGLE_ITEMS.filter(it => (!sheetVal || it.sheetKey === sheetVal) && (!areaVal || it.area === areaVal) && (!carVal || it.car === carVal));
  const areas = [...new Set(filtered.map(it => it.area))].sort();
  const cars = [...new Set(filtered.map(it => it.car))].sort();
  updateSelect('selArea', areas, 'â€” å…¨éƒ¨ å€åŸŸè»Šæ¬¡ç·¨è™Ÿ â€”', areaVal);
  updateSelect('selCar', cars, 'â€” å…¨éƒ¨ è»Šè™Ÿ â€”', carVal);
}
function updateSelect(id, options, placeholder, currentVal){
    const sel = document.getElementById(id);
    sel.innerHTML = `<option value="">${placeholder}</option>` + options.map(o=>`<option value="${o}">${o}</option>`).join('');
    if(options.includes(currentVal)) sel.value = currentVal;
}
function onSingleQuery(){
  const sheetVal = document.getElementById('selSheet').value;
  const areaVal = document.getElementById('selArea').value;
  const carVal = document.getElementById('selCar').value;
  // â˜…â˜…â˜… ä¿®æ­£ï¼šä½¿ç”¨é å­˜è®Šæ•¸ç¯©é¸ â˜…â˜…â˜…
  const filtered = SINGLE_ITEMS.filter(it => (!sheetVal || it.sheetKey === sheetVal) && (!areaVal || it.area === areaVal) && (!carVal || it.car === carVal));
  const box = document.getElementById('singleResults'); box.innerHTML = '';
  if(filtered.length === 0) { box.innerHTML = '<div style="text-align:center;opacity:0.6;grid-column:1/-1">ç„¡ç¬¦åˆè³‡æ–™</div>'; return; }
  filtered.forEach(it => {
      const card = document.createElement('div'); card.className = 'indiv-card';
      let status = 'å°šæœªé–‹å§‹';
      for(let i=it.cfg.steps.length-1; i>=0; i--){
          const idx = it.header.indexOf(it.cfg.steps[i]);
          if(it.row[idx] && it.row[idx] !== 'â€”') { status = (it.cfg.steps[i] === 'è»Šæš«åœä½ç½®') ? `ä½ç½®ï¼š${it.row[idx]}` : it.cfg.steps[i]; break; }
      }
      // â˜…â˜…â˜… ä¿®æ­£ï¼šé¡¯ç¤ºä½¿ç”¨é å­˜è®Šæ•¸ â˜…â˜…â˜…
      card.innerHTML = `<div class="single-line" style="color:var(--primary-600)">${it.sheetKey}</div><div class="single-line" style="font-size:1.2rem;font-weight:800">${it.area}</div><div class="single-line">${it.car}</div><div class="single-line" style="color:var(--text-muted)">${status}</div>`;
      card.addEventListener('click', () => openDetailModal(it.cfg, it.row, it.header, it.area, it.car));
      box.appendChild(card);
  });
}
function onSingleReset(){
    ['selSheet','selArea','selCar'].forEach(id=>document.getElementById(id).value='');
    rebuildSelectOptions();
    document.getElementById('singleResults').innerHTML = '';
}

/* ============ MODAL DETAIL ============ */
// â˜…â˜…â˜… ä¿®æ­£ï¼šæ¥æ”¶é å­˜è®Šæ•¸ï¼Œä¸å†é‡è¤‡è¨ˆç®— Index â˜…â˜…â˜…
function openDetailModal(cfg, row, header, area, car){
    const box = document.createElement('div'); box.className = 'modal';
    
    // Fallback safety (in case called without area/car)
    if (!area) {
       let areaIdx = header.findIndex(c => c.includes('å€åŸŸ'));
       if(areaIdx<0) areaIdx = header.findIndex(c => c.includes('ç·¨è™Ÿ'));
       area = row[areaIdx>=0?areaIdx:1] || '';
    }
    if (!car) {
       let carIdx = header.findIndex(c => c.includes('è»Šè™Ÿ'));
       car = row[carIdx>=0?carIdx:2] || '';
    }

    let html = `<div class="dash-close">âœ•</div><h3>${area} ${car}</h3><table class="detail-table">`;
    cfg.steps.forEach(st => {
        const idx = header.indexOf(st);
        html += `<tr><th>${st}</th><td>${row[idx]||''}</td></tr>`;
    });
    html += `</table>`;
    box.innerHTML = html;
    // FIX: close modal safely
    box.querySelector('.dash-close').onclick = () => { 
        box.remove(); 
        const bg = document.querySelector('.modal-backdrop');
        if(bg) bg.remove();
    };
    openModal(box);
}
function openModal(el){
    const bg = document.createElement('div'); bg.className='modal-backdrop';
    // é€™è£¡åŸæœ¬çš„ onclick æ˜¯å®‰å…¨çš„ï¼Œå› ç‚º bg æ˜¯é–‰åŒ…è®Šæ•¸ï¼Œä½†ç‚ºäº†çµ±ä¸€é‚è¼¯ï¼Œä¿ç•™åŸæ¨£å³å¯
    bg.onclick = () => { el.remove(); bg.remove(); };
    document.body.appendChild(bg); document.body.appendChild(el);
}

/* ============ ENTRY ============ */
window.onload = function(){
  startClock();
  buildRefreshControls();
  updateRefreshButtonsUI();
  document.querySelectorAll('.tab-container-styled .main-tab').forEach(btn => btn.addEventListener('click', () => switchPane(btn.dataset.target)));
  
  const saved = localStorage.getItem('ddcc_user_token');
  if (saved) {
    idToken = saved;
    document.body.classList.add('login'); 
    document.body.classList.add('auto-login'); 
    showLoading();

    fetch(API_BASE + '?action=verify', { method: 'POST', headers: { 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify({ idToken }) })
    .then(r=>r.json())
    .then(j=>{
       if(j.error) throw new Error(j.error);
       currentUser = j;
       finishLoginUI(); 
       buildTabs(); 
       loadSheetData(currentSheetKey, true); 
       loadSingleData(true); 
    })
    .catch(e=>{ 
       document.body.classList.remove('auto-login'); 
       logout(); 
       initGoogleSignIn(); 
    })
    .finally(() => {
       hideLoading();
    });
  } else { 
    initGoogleSignIn(); 
  }
  
  document.getElementById('logoutBtn').addEventListener('click', logout);
  document.getElementById('btnQuery').addEventListener('click', onSingleQuery);
  document.getElementById('btnReset').addEventListener('click', onSingleReset);
  ['selSheet','selArea','selCar'].forEach(id=>document.getElementById(id).addEventListener('change', rebuildSelectOptions));
};
</script>
</body>
</html>
